@page "/calender"
@using EvictionFiler.Application.DTOs
@using EvictionFiler.Application.DTOs.CalanderDto
@using EvictionFiler.Application.DTOs.CaseHearing
@using EvictionFiler.Application.DTOs.CourtDto
@using EvictionFiler.Application.DTOs.CourtPart
@using EvictionFiler.Domain.Entities.Master
@using System.ComponentModel.DataAnnotations
@using System.Linq.Expressions
@using EvictionFiler.Application.DTOs.ApartmentDto
@using EvictionFiler.Application.DTOs.ClientDto
@using EvictionFiler.Application.DTOs.LandLordDto
@using EvictionFiler.Application.DTOs.LegalCaseDto
@using EvictionFiler.Application.DTOs.PaginationDto
@using EvictionFiler.Application.DTOs.TenantDto
@using EvictionFiler.Application.Interfaces.IRepository.MasterRepository
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Client.Components.Cases
@* @using EvictionFiler.Client.Jwt *@
@attribute [Authorize]

<PageTitle> Calender - Housing Court Filer</PageTitle>
@inject ICaseTypeRepository CaseTypeRepository
@inject ICalanderService CalanderService
@inject ICaseHearingService CaseHearingService

@using EvictionFiler.Client.SpinnerService
@using EvictionFiler.Domian.Enums
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject SpinnerService spinnerservice
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization;
@using EvictionFiler.Domain.Entities
@inject ICourtService _courtService

@using System.Security.Claims
@inject AuthenticationStateProvider _authStateProvider
@{
    var groupedCases = (CasesHearing?.Items ?? Enumerable.Empty<CaseHearingDto>())
        .GroupBy(x => new
        {
            x.CourtPart,
            x.RoomNo,
            x.CountyName
        })
        .ToList();
}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

<style>
    /* ===== EvictionFiler Light Theme (cards + rounded + blue/yellow accents) ===== */
    :root {
        --bg: #f5f7fb;
        --card: #ffffff;
        --ink: #0e1726;
        --muted: #5c6a82;
        --line: #e5eaf3;
        --chip: #f1f4fa;
        --accent: #2463eb; /* blue */
        --accent-2: #0ea5e9; /* teal-blue */
        --accent-ink: #0b1a34;
        --warn: #f5b500; /* golden */
        --good: #16a34a;
        --shadow: 0 2px 10px rgba(8, 15, 35, .06);
        --radius: 16px;
    }

    * {
        box-sizing: border-box
    }

    html,
    body {
        height: 100%
    }

    body {
        margin: 0;
        background: var(--bg);
        color: var(--ink);
        font: 500 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    .wrap {
        max-width: 100%;
        margin: auto;
        padding: 22px
    }

    /* Top bar */
    header {
        display: flex;
        gap: 14px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin: 4px 0 16px
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 12px
    }

    .logo {
        width: 34px;
        height: 34px;
        border-radius: 8px;
        background: linear-gradient(135deg, #0b3a91, #2b6be6)
    }

    h1 {
        font-size: 20px;
        margin: 0
    }

    .sub {
        color: var(--muted)
    }

    /* Card */
    .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: var(--radius);
        box-shadow: var(--shadow)
    }

    .card-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 14px;
        border-bottom: 1px solid var(--line);
        background: #fbfdff;
        border-top-left-radius: var(--radius);
        border-top-right-radius: var(--radius);
        color: #3b4a66
    }

    .card-body {
        padding: 14px
    }

    /* Filters */
    .panel .filters {
        display: grid;
        grid-template-columns: repeat(6, minmax(170px, 1fr));
        gap: 12px
    }

    .control label {
        display: block;
        font-size: 16px;
        text-transform: uppercase;
        letter-spacing: .06em;
        color: var(--muted);
        margin: 2px 0 6px
    }

    .control input,
    .control select {
        width: 100%;
        background: #fff;
        color: var(--ink);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px 12px;
        outline: none;
        font-size:16px;
        box-shadow: 0 1px 0 rgba(10, 20, 40, .02);
    }

        .control input:focus,
        .control select:focus {
            border-color: #cdd7ee;
            box-shadow: 0 0 0 3px rgba(36, 99, 235, .08)
        }

    /* Buttons */
    .bar {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        margin-top: 12px
    }

    .btn {
        background: var(--accent);
        color: #fff;
        border: 0;
        border-radius: 12px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(36, 99, 235, .22)
    }

        .btn.secondary {
            background: #fff;
            color: var(--accent-ink);
            border: 1px solid var(--line);
            box-shadow: none
        }

        .btn.ghost {
            background: var(--chip);
            color: var(--accent-ink);
            border: 1px dashed var(--line);
            box-shadow: none
        }

    .badge {
        font-size:14px;
        font-family:'poppins';
        font-weight:400;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #fff;
        border: 1px solid var(--line);
        padding: 11px 13px;
        border-radius: 12px;
        color: var(--muted)
    }

    /* Stats */
    .stats {
        display: flex;
        gap: 12px;
        flex-wrap: wrap
    }

    .stat {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 8px 12px;
        color: var(--muted);
        box-shadow: var(--shadow)
        font-size:16px;
    }

        .stat b {
            color: var(--ink)
        }

    /* Table */
    .table-wrap {
        overflow: auto;
        max-height: 70vh
    }

    .table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0
    }

        .table thead th {
            position: sticky;
            top: 0;
            background: #fbfdff;
            color: #7383a1;
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--line);
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: .06em;
        }

        .table tbody td {
            padding: 12px;
            border-bottom: 1px solid var(--line);
            vertical-align: top;
            font-size:16px;
        }

    .caption {
        font-weight: 700
    }

    .label {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 999px;
        font-size: 12px;
        background: #fff5d6;
        color: #8a6400;
        border: 1px solid #ffe9a3
    }

        .label.holdover {
            background: #e8f0ff;
            color: #153e91;
            border-color: #d7e5ff
        }

        .label.np {
            background: #e6fbff;
            color: #055d66;
            border-color: #c8f5ff
        }




    /* Responsive */
    @@media (max-width:1100px) {
        .panel .filters {
            grid-template-columns: repeat(3, minmax(170px, 1fr))
        }
    }

    @@media (max-width:640px) {
        .panel .filters {
            grid-template-columns: 1fr
        }

        .table .hide-sm {
            display: none
        }
    }


     @@media screen {
            #myPrintableContent {
                display: none !important;
            }
        }
    
    /* PRINT: show only printable content */


    .print-container {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #fff;
        color: #000;
        /*  padding: 20px 30px; */
    }

    /* HEADER */
    .print-header {
        background: linear-gradient(180deg, #0b1626, #111827);
        color: #fff;
        padding: 25px 30px;
        margin-bottom: 30px;
    }

        .print-header h2 {
            margin: 0 0 10px 0;
            font-size: 22px;
        }

    .header-meta {
        display: flex;
        gap: 25px;
        font-size: 14px;
    }

    .print-link {
        margin-top: 15px;
        font-size: 14px;
        text-decoration: underline;
        cursor: pointer;
    }

    /* PART HEADER */
    .part-box {
        margin: 0px 50px;
        background: #f4f6f8;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 10px;
    }

    .part-title {
        font-size: 18px;
        font-weight: 600;
    }

    .judge {
        font-size: 14px;
        margin-top: 5px;
    }

    /* CASE */
    .case-box {
        border-top: 2px solid #111;
        padding: 15px 0;
        margin: 0px 50px;
    }

    .case-title {
        font-size: 17px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .case-row {
        display: flex;
        gap: 25px;
        font-size: 14px;
        margin-bottom: 6px;
    }

    .last-action {
        margin-top: 20px;
        font-size: 14px;
    }

    .print-header {
        position: relative;
    }

        .print-header .page-number {
            position: absolute;
            right: 30px; /* adjust as needed */
            top: 25px; /* adjust as needed */
            font-size: 14px;
            color: #ffffff;
            font-weight: 400;
        }

    .btn:disabled{
        cursor:pointer;
        pointer-events:auto;
    }

    /* ================================
           CLEAN & CONSOLIDATED PRINT CSS
           ================================ */
    @@media print {
        /* Hide everything except the printable container */
        body * {
            visibility: hidden !important;
        }

        #myPrintableContent,
        #myPrintableContent * {
            visibility: visible !important;
        }

        #myPrintableContent {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: #ffffff;
            padding: 0px;
            margin: 0px;
        }
        /* Remove UI elements meant for screen */
        header,
        nav,
        .btn,
        .bar,
        .table-wrap,
        .pagination {
            display: none !important;
        }
        /* Header */
        .print-header {
            background: linear-gradient(180deg, #0b1626, #111827);
            color: #ffffff;
            padding: 25px 30px;
            margin-bottom: 30px;
        }


            .print-header h2 {
                margin: 0 0 10px 0;
                font-size: 22px;
            }

        .header-meta {
            display: flex;
            gap: 25px;
            font-size: 14px;
        }
        /* Part box */
        .part-box {
            margin: 0px 50px;
            background: #f4f6f8;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            page-break-inside: avoid !important;
        }

        .part-title {
            font-size: 18px;
            font-weight: 600;
        }

        .judge {
            font-size: 14px;
            margin-top: 5px;
        }
        /* Case box */
        .case-box {
            border-top: 2px solid #111;
            padding: 15px 0;
            page-break-inside: avoid !important;
            margin: 0px 50px;
        }

        .case-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .case-row {
            display: flex;
            gap: 25px;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .last-action {
            margin-top: 20px;
            font-size: 14px;
        }
        /* Column layout during print */
        .row {
            display: flex !important;
            flex-wrap: nowrap !important;
        }

        .col-6, .col-4, .col-3, .col-2, .col-12 {
            float: none !important;
            display: block !important;
        }

        .case-row .col-6 {
            width: 60% !important;
        }

        .case-row .col-4 {
            width: 40% !important;
            text-align: right !important;
        }
        /* Status button colors */
        .status-button {
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-block;
        }

        .holdover {
            background-color: #e0e4ff;
            color: #3a4bb3;
        }

        .nonpayment {
            background-color: #d9f6f6;
            color: #2c8c8c;
        }

        .perdiem {
            background-color: #fff4cc;
            color: #b38a00;
        }

        .default-status {
            background-color: #f0f0f0;
            color: #555555;
        }
        /* Page break every 5 rows (optional toggle using body.per5) */
        body.per5 .table tbody tr {
            page-break-inside: avoid;
        }

            body.per5 .table tbody tr:nth-child(5n) {
                page-break-after: always;
            }

        .print-header {
            background: linear-gradient(180deg, #0b1626, #111827) !important;
            -webkit-print-color-adjust: exact !important;
        }

        .part-box {
            background: #f4f6f8 !important;
            -webkit-print-color-adjust: exact !important;
        }

        .case-box {
            background: #ffffff !important;
            -webkit-print-color-adjust: exact !important;
        }
        /* .print-header-group {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
            } */
        /* Now force ONLY subsequent part-boxes to new pages */
        /* .part-box {
                page-break-before: always !important;
                break-before: page !important;
            } */
        /* But NOT the very first part-box */
        /* .print-header-group  {
                page-break-before: avoid !important;
                break-before: avoid !important;
            } */
        /* Make every print-header-group start a new printed page */
        .print-header-group {
            page-break-before: always !important;
            break-before: page !important;
        }
            /* EXCEPTION: The very first header should NOT break before */
            .print-header-group:first-of-type {
                page-break-before: avoid !important;
                break-before: avoid !important;
            }
    }

    .page-link {
        color: #1F365D;
    }

        .page-link.active {
            background: #1F365D;
            color: white;
        }

    .page-item.active .page-link {
        background: #1F365D;
        border-color: #1F365D;
        color: white;
    }

    @@media print {
        .print-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: end;
            font-size: 14px;
            padding: 6px 0;
            margin: 0px 50px;
            margin-bottom: 50px;
            /* border-top: 1px solid #000; */
            background: #fff;
        }
    }

    .print-footer {
        display: none;
    }

    @@media print {
        .print-footer {
            display: block !important;
        }

        @@page {
            /* size: auto; */
            margin: 0;
        }
    }

    @@media print {
        .print-header

    {
        position: relative;
    }

    .print-header .page-number {
        position: absolute;
        right: 30px; /* adjust as needed */
        top: 40px; /* adjust as needed */
        font-size: 14px;
        color: #ffffff;
        font-weight: 400;
    }

    }
</style>


    <div class="wrap">
        <header>
            <div class="brand">
                <div class="logo"></div>
                <h1>HousingCourtFiler • Court Calendars</h1>
            </div>
            <div class="sub">Generate, filter, and print housing court calendars</div>
        </header>

        <!-- Filters -->
        <section class="card panel ">
            <div class="card-head mb-3 d-flex gap-2">
                <div class="badge ">Case Search & Filters</div>
                <div class="badge">New Action</div>
            </div>
            <div class="card-body">
                <EditForm EditContext="_editContext">
                    <div class="row g-3">
                        <div class="col-md-2 control">
                            <label>County</label>
                            <InputSelect @bind-Value="hearingDto.CountyId" @bind-Value:after="SelectCounty">
                                <option value="">-- Select --</option>
                                @foreach (var l in CountyList)
                                {
                                    <option value="@l.Id">@l.Name</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="col-md-2 control">
                            <label class="">Date From</label>
                            <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="hearingDto.HearingDate" @bind-Value:after="ApplyFilters" />
                        </div>
                        <div class="col-md-2 control">
                            <label>Date To</label>
                            <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="hearingDto.HearingDateTo" @bind-Value:after="ApplyFilters" />
                        </div>
                        <div class="col-md-2 control">
                            <label>Court <span class="text-danger">*</span></label>
                            <InputSelect @bind-Value="hearingDto.CourtLocationId" style="cursor:pointer;" @onmousedown="ShowAllCourts" @bind-Value:after="SelectCourt">
                                <option value="">-- Select --</option>
                                @foreach (var l in filteredCourts)
                                {
                                    <option value="@l.Id">@l.Court</option>
                                }
                            </InputSelect>
                            <ValidationMessage For="() => hearingDto.CourtLocationId" />
                        </div>
                        <div class="col-md-2 control">
                            <label>Court Part</label>
                            <InputSelect class="form-select" @bind-Value="hearingDto.CourtPartId" @bind-Value:after="SelectCourtPart">
                                <option value="">-- Select --</option>
                                @foreach (var l in CourtPartList)
                                {
                                    <option value="@l.Id">@l.Part</option>
                                }
                            </InputSelect>
                        </div>

                        <div class="col-md-2 control">
                            <label>Room</label>
                            <InputText placeholder="Enter Room" @bind-Value="hearingDto.RoomNo" @bind-Value:after="ApplyFilters" />
                        </div>


                    </div>
                    <div class="row mt-2 g-3">
                        <div class="col-12">
                            <div class="row">
                                <div class="col-md-2 control">
                                    <label>Case Type</label>
                                    <InputSelect @bind-Value="hearingDto.CaseTypeId" @bind-Value:after="ApplyFilters">
                                        <option value="">-- Select --</option>
                                        @foreach (var l in CaseTypeList)
                                        {
                                            <option value="@l.Id">@l.Name</option>
                                        }
                                    </InputSelect>
                                </div>
                                <div class="col-md-2 control">
                                    <label>Judge</label>
                                    <InputText placeholder="Enter Judge" @bind-Value="hearingDto.Judge" @bind-Value:after="ApplyFilters" />
                                </div>
                                <div class="col-md-2 control">
                                    <label>Status</label>
                                    <InputSelect @bind-Value="hearingDto.CaseStatusId">
                                        <option value="">-- Select --</option>
                                        @foreach (var l in CaseStatusList)
                                        {
                                            <option value="@l.Id">@l.Name</option>
                                        }
                                    </InputSelect>
                                </div>

                                <div class="col-md-3 control">
                                    <label>Search</label>
                                    <InputText @bind-Value="hearingDto.IndexNo" placeholder="Index / #Caption" @bind-Value:after="ApplyFilters" />
                                </div>


                                <div class="col-md-3 d-flex align-items-center">
                                    <div class="control">
                                        <label>5 Rows per printed page</label>
                                        <div class="switch"><input id="f-per5" type="checkbox"><span class="sub">Strict page breaks</span></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <div class="mt-4 d-flex gap-2 flex-wrap align-items-center bar">

                    <button class="btn btn-primary" style="font-size:14px ; background: #1F365D; font-family:'Poppins';" @onclick="SubmitAsync">Generate</button>
                    <button type="reset" class="btn secondary" style="font-size:14px ; font-family:'Poppins';" id="btnReset">Reset</button>
                    <button type="button" class="btn secondary" style="font-size:14px ; font-family:'Poppins';" @onclick="PrintWithQRCodes" disabled="@(CasesHearing == null || CasesHearing.TotalCount <= 0)">Print</button>
                    <button type="button" class="btn secondary" style="font-size:14px ; font-family:'Poppins';" id="btnExport">Export CSV</button>
                        <span class="ms-auto text-muted" id="countInfo">@(CasesHearing != null ? CasesHearing.TotalCount : 0) results</span>
                    </div>
                </EditForm>
            </div>
        </section>


        <!-- Results -->
        <section class="card" style="margin-top:14px">
            <div class="card-head">
                <div class="stats">
                    <div class="stat"><span>Hearings Today:</span> <b id="statToday">0</b></div>
                    <div class="stat"><span>This Week:</span> <b id="statWeek">0</b></div>
                    <div class="stat"><span>Selected Range:</span> <b id="statRange">@(CasesHearing != null ? CasesHearing.TotalCount : 0)</b></div>
                </div>
                <div class="sub" id="printMeta"></div>
            </div>
            <div class="card-body table-wrap" style=" overflow-x:auto;">
                <table class="table" id="table" style="overflow-x:scroll; width:100vw">
                    <thead>
                        <tr>
                            <th>County</th>
                            <th class="hide-sm">Date</th>
                            <th>Part</th>
                            <th>Room</th>
                            <th>Caption</th>
                            <th>Index #</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th class="hide-sm">Judge</th>
                            <th>Last Action</th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                        @if (CasesHearing != null && CasesHearing.Items.Any())
                        {
                            foreach (var c in CasesHearing.Items)
                            {
                                <tr>
                                    <td>@c.CountyName</td>
                                    <td>@c.HearingDate?.ToString("MMM dd, yyyy")</td>
                                    <td>@c.CourtPart</td>
                                    <td>@c.RoomNo</td>
                                    <td>@c.LandlordName vs @c.TenantName</td>
                                    <td>@c.IndexNo</td>
                                    <td>@c.HearingTime</td>
                                    <td>
                                        <span class="status-button @(GetStatusClass(c.CaseTypeName))">
                                            @c.CaseTypeName
                                        </span>
                                    </td>
                                    <td>@c.Judge</td>
                                    <td>@(c.LastAction)</td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr><td colspan="10" class="text-center">No Case Hearing available</td></tr>
                        }
                    </tbody>

                </table>
            </div>
            @if (CasesHearing != null && CasesHearing.TotalCount > 0)
            {
                <div class="d-flex justify-content-between mt-3 p-4 align-items-center">
                    <small style="font-size:14px">
                        Showing @(((currentPage - 1) * pageSize) + 1)
                        to @(Math.Min(currentPage * pageSize, CasesHearing.TotalCount))
                        of @CasesHearing.TotalCount entries
                    </small>
                    <nav>
                        <ul class="pagination mb-0" style="font-size:14px">
                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">←</button>
                            </li>
                            @for (int i = 1; i <= Math.Ceiling((double)CasesHearing.TotalCount / pageSize); i++)
                            {
                                var pageNumber = i;
                                <li class="page-item @(pageNumber == currentPage ? "active" : "")">
                                    <button class="page-link" @onclick="() => ChangePage(pageNumber)">@pageNumber</button>
                                </li>
                            }
                            <li class="page-item @(currentPage == Math.Ceiling((double)CasesHearing.TotalCount / pageSize) ? "disabled" : "")">
                                <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">→</button>
                            </li>
                        </ul>
                    </nav>
                </div>
            }


        </section>


        <div id="myPrintableContent" class="print-container" style="width :890px">

            <!-- HEADER -->
            @* <div class="print-header-group">
            <div class="print-header">
                <h2>Housing Court Calendar -  @countyNameForPrint County</h2>

                @* <div class="header-meta" style="display:flex">
                    <span>
                        <strong>County:</strong>
                        @countyNameForPrint
                    </span>
                    <span>
                        <strong>Court:</strong>
                        @courtNameForPrint
                    </span>
                    
                </div> *
                <div class="header-meta mt-1" style="display:flex">
                   
                    <span>
                        <strong>Court Date From:</strong>
                        @(hearingDto.HearingDate?.ToString(DateFormats.Default) ?? "--")
                    </span>
                    <span>
                        <strong>Court Date To:</strong>
                        @(hearingDto.HearingDateTo?.ToString(DateFormats.Default) ?? "--")
                    </span>
                </div>

            </div>
        </div>
 *@
            @{
                int j = 1;
            }
            @foreach (var part in groupedCases)
            {

                <div class="print-header-group ">
                    <div class="print-header">
                        <div style="display:flex;justify-content:space-between;">
                            <h2>Housing Court Calendar -  @part.First().CountyName County</h2>
                            <span class="page-number" style="font-weight:400"></span>
                        </div>


                        <div class="header-meta mt-1" style="display:flex">

                            <span>
                                <strong>Court Date:</strong>
                                @(hearingDto.HearingDate?.ToString(DateFormats.Default) ?? "--")
                            </span>
                            @* <span>
                            <strong>Court Date To:</strong>
                            @(hearingDto.HearingDateTo?.ToString(DateFormats.Default) ?? "--")
                        </span> *@
                        </div>

                    </div>
                </div>

                <!-- PART HEADER -->
                <div class="part-box">
                    <div class="part-title">
                        First Time on Case - Part @part.Key.CourtPart, Room @part.Key.RoomNo
                    </div>
                    @* <div class="judge">
                    Judge: @(string.IsNullOrWhiteSpace(part.Key.Judge)
                                    ? "Hon. Assigned Judge"
                                    : part.Key.Judge)
            </div> *@
                </div>

                <!-- CASES -->
                @foreach (var c in part)
                {
                    <div class="case-box">
                        <div class="case-title">
                            @j. [@c.IndexNo] @c.LandlordName v. @c.TenantName
                        </div>

                        <div class="case-row row">
                            <div class="col-6">
                                <span>Type: @c.CaseTypeName</span> |  <span>Judge:@c.Judge</span> | <span>Time: @c.HearingTime</span><br />

                                <span>Conty: @c.CountyName</span> | <span>Part: @c.CourtPart</span> | <span>RoomNo: @c.RoomNo</span><br />


                                <span>Opposition Attorney: @(c.OpposingAttorney ?? "Self-Represented")  </span><br />
                                <span style="color:blue">Last action: @c.LastAction</span>
                            </div>
                            <div class="col-4">
                                <div style="text-align:right;">
                                    <img id=@($"qr-@{c.Id}")
                                         data-qr="@BuildQrText(c)"
                                         style="width:80px; height:80px;" />
                                </div>
                            </div>
                        </div>



                        @* <div class="last-action">
                        <strong>Last action:</strong> @c.LastAction
                    </div> *@
                    </div>

                    j++;
                }


                <div class="print-footer">
                    <span>Generated by EvictionFiler • Part @part.First().CourtPart</span>
                </div>
            }

        </div>




    </div>


<script>
    window.generateAllQRCodesForPrint = function () {
        document.querySelectorAll("img[data-qr]").forEach(img => {
            const qrText = img.getAttribute("data-qr");

            const qr = new QRious({
                value: qrText,
                size: 120
            });

            img.src = qr.toDataURL();
        });
    };

    

</script>

<script>
     window.injectPageNumbers = function () {
        const headers = document.querySelectorAll('.print-header-group .print-header');
        headers.forEach((header, i) => {
            const span = header.querySelector('.page-number');
            if (span) span.textContent = `Page ${i + 1}`;
        });
    }
</script>


@code {

    private CalanderDto calanderDto = new CalanderDto();
    private CaseHearingDto hearingDto = new CaseHearingDto();

    private EditContext _editContext;
    private ValidationMessageStore _messages;
    private List<CaseType> CaseTypeList = new();
    private List<CourtPartDto> CourtPartList = new();
    private List<County> CountyList = new();
    private string countyNameForPrint => CountyList?
           .FirstOrDefault(c => c.Id == hearingDto.CountyId)
           ?.Name ?? "--";
    private string courtNameForPrint => CourtLocationList?
           .FirstOrDefault(c => c.Id == hearingDto.CourtLocationId)
           ?.Court ?? "--";
    private List<CaseStatus> CaseStatusList = new();
    private string? loggedInUserId;
    private int currentPage = 1;
    private int pageSize = 10;

    private bool isAdmin = false;
    private bool showprintable = false;
    public List<CourtDto> filteredCourts = new List<CourtDto>();
    private List<CourtDto> CourtLocationList = new();

    private List<CalanderDto> CourtCases { get; set; }
    private PaginationDto<CaseHearingDto> AllCasesHearing = new();
    private PaginationDto<CaseHearingDto> CasesHearing { get; set; }


    protected override async Task OnInitializedAsync()
    {
        spinnerservice.Show();
        hearingDto = new CaseHearingDto();
        // hearingDto.HearingDate = DateTime.Now;
        // hearingDto.HearingDateTo = DateTime.Now;
        _editContext = new EditContext(hearingDto);
        _messages = new ValidationMessageStore(_editContext);


        CaseTypeList = await CaseTypeRepository.GetAllCaseType();
        CaseStatusList = await CaseTypeRepository.GetAllCaseStatus();
        CountyList = await CaseTypeRepository.GetAllCounty();
        // var defaultCourt = CountyList
        // .FirstOrDefault(x => x.Name == "New York");

        //        if (defaultCourt != null)
        //        {
        //            hearingDto.CountyId = defaultCourt.Id;
        //        }

        // countyNameForPrint =

        // CourtPartList = await CaseTypeRepository.GetAllCourtPart();
        // legalcaseDto.ClientId = Guid.Parse(ClientId);
        CourtLocationList = await _courtService.GetAllCourtDataAsync();

        // courtNameForPrint =

        CourtCases = await CalanderService.GetAllCalanderAsync();


        // CasesHearing = AllCasesHearing
        //     .Where(x => x.CountyId == hearingDto.CountyId)
        //     .ToList();

        var authState = await _authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            loggedInUserId = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
            isAdmin = user.Claims.Any(c => c.Type == ClaimTypes.Role && c.Value == "Admin");
        }

        await GetAllCaseHearing();

        spinnerservice.Hide();
    }

    private string GetStatusClass(string caseType)
    {
        return caseType switch
        {
            "Holdover" => "holdover",
            "Non Payment" => "nonpayment",
            "Per Diem" => "perdiem",
            _ => "default-status"
        };
    }

    private string BuildQrText(CaseHearingDto c)
    {
        var judge = c.Judge ?? "Assigned Judge";
        return
            $@"Case Hearing
            Index: {c.IndexNo}
            Landlord: {c.LandlordName}
            Tenant: {c.TenantName}
            Court: {c.CourtLocation}
            Part: {c.CourtPart}
            Room: {c.RoomNo}
            Judge: {judge}
            Date: {c.HearingDate:yyyy-MM-dd}
            Time: {c.HearingTime}";
    }
    private async Task PrintWithQRCodes()
    {
        // Generate QR images in DOM
        await JS.InvokeVoidAsync("generateAllQRCodesForPrint");
        await JS.InvokeVoidAsync("injectPageNumbers");

        // Give browser time to paint images
        await Task.Delay(300);

        // Open print dialog
        await JS.InvokeVoidAsync("eval", "window.print()");
    }

    private async Task GetAllCaseHearing()
    {



        CasesHearing = await CaseHearingService.GetAllCaseHeariingAsync(currentPage, pageSize, loggedInUserId,
               isAdmin);
        AllCasesHearing = await CaseHearingService.GetAllCaseHeariingAsync(currentPage, pageSize, loggedInUserId,
                isAdmin);


    }

    private async Task ChangePage(int page)
    {
        if (page >= 1 && page <= Math.Ceiling((double)CasesHearing.TotalCount / pageSize))
        {
            currentPage = page;
            await GetAllCaseHearing();
        }
    }

    private void SelectCourtPart()
    {
        if (hearingDto.CourtPartId == null || hearingDto.CourtPartId == Guid.Empty)
        {
            CasesHearing = AllCasesHearing;
            return;
        }

        ApplyFilters();
    }






    private void SelectCounty()
    {
        if (hearingDto.CountyId != null && hearingDto.CountyId != Guid.Empty)
        {
            CasesHearing = new PaginationDto<CaseHearingDto>
            {
                Items = AllCasesHearing.Items
                .Where(x => x.CountyId == hearingDto.CountyId)
                .ToList(),

                TotalCount = AllCasesHearing.Items
                .Count(x => x.CountyId == hearingDto.CountyId),

                PageSize = AllCasesHearing.PageSize,
                CurrentPage = 1
            };

            filteredCourts = CourtLocationList
                .Where(x => x.CountyId == hearingDto.CountyId)
                .ToList();
        }
        else
        {
            CasesHearing = AllCasesHearing;
        }

        StateHasChanged();
    }

    private async Task ShowAllCourts()
    {
        if (hearingDto.CountyId != null)
        {
            // Sirf selected county ke courts dikhao
            filteredCourts = CourtLocationList
                                .Where(x => x.CountyId == hearingDto.CountyId)
                                .ToList();
        }
        else
        {

            filteredCourts = await _courtService.GetAllCourtDataAsync();
        }

    }

    private async Task SelectCourt()
    {
        var selectedCourtId = hearingDto.CourtLocationId;

        var court = CourtLocationList.Where(ct => ct.Id == hearingDto.CourtLocationId).FirstOrDefault();


        if (court.CourtPart.Any())
        {

            CourtPartList = court.CourtPart.ToList();
        }

        if ((hearingDto.CountyId == null || hearingDto.CountyId == Guid.Empty) && hearingDto.CountyId != court.CountyId)
        {
            var county = CountyList.FirstOrDefault(cts => cts.Id == court.CountyId);
            // if (court.CountyName.Contains("Nassau") || court.CountyName.Contains("Westchester"))
            // {
            hearingDto.CountyId = county.Id;
            hearingDto.CountyName = county?.Name;

            // }
            SelectCounty();
        }

        await InvokeAsync(StateHasChanged);
        hearingDto.CourtLocationId = null;
        await Task.Delay(10);

        if (filteredCourts.Any(x => x.Id == selectedCourtId))
        {
            hearingDto.CourtLocationId = selectedCourtId;

            hearingDto.CourtLocation = court.Court;


        }
        else
        {

            hearingDto.CourtLocationId = Guid.Empty;
        }
        await ApplyFilters();
        StateHasChanged();
    }



    private async Task ApplyFilters()
    {
        // ✅ Items se query start
        var query = AllCasesHearing.Items.AsQueryable();

        // County
        if (hearingDto.CountyId != null && hearingDto.CountyId != Guid.Empty)
            query = query.Where(x => x.CountyId == hearingDto.CountyId);

        // Hearing Date (single day)
        if (hearingDto.HearingDate.HasValue)
        {
            var fromDate = hearingDto.HearingDate.Value.Date;
            var toDate = fromDate.AddDays(1);

            query = query.Where(x =>
                x.HearingDate >= fromDate);
        }
        if (hearingDto.HearingDateTo.HasValue)
        {
            var ToDate = hearingDto.HearingDateTo.Value.Date;


            query = query.Where(x =>
                x.HearingDate <= ToDate);
        }

        // Court Part
        if (hearingDto.CourtPartId != null && hearingDto.CourtPartId != Guid.Empty)
            query = query.Where(x => x.CourtPartId == hearingDto.CourtPartId);

        if (hearingDto.CourtLocationId != null && hearingDto.CourtLocationId != Guid.Empty)
            query = query.Where(x => x.CourtLocationId == hearingDto.CourtLocationId);

        // Room No
        if (!string.IsNullOrWhiteSpace(hearingDto.RoomNo))
            query = query.Where(x =>
                x.RoomNo != null &&
                x.RoomNo.Contains(hearingDto.RoomNo, StringComparison.OrdinalIgnoreCase));


        if (hearingDto.CaseTypeId != null && hearingDto.CaseTypeId != Guid.Empty)
            query = query.Where(x => x.CaseTypeId == hearingDto.CaseTypeId);


        if (!string.IsNullOrWhiteSpace(hearingDto.Judge))
            query = query.Where(x =>
                x.Judge != null &&
                x.Judge.Contains(hearingDto.Judge, StringComparison.OrdinalIgnoreCase));


        if (!string.IsNullOrWhiteSpace(hearingDto.IndexNo))
        {
            query = query.Where(x =>
                x.IndexNo != null &&
                x.IndexNo.Contains(hearingDto.IndexNo, StringComparison.OrdinalIgnoreCase));
        }


        var filteredList = query.ToList();

        CasesHearing = new PaginationDto<CaseHearingDto>
        {
            Items = filteredList,
            TotalCount = filteredList.Count,
            PageSize = AllCasesHearing.PageSize,
            CurrentPage = 1
        };

        await InvokeAsync(StateHasChanged);
    }



    private async Task SubmitAsync()
    {
        spinnerservice.Show();
        StateHasChanged();
        await Task.Delay(100);

        await ApplyFilters();

        spinnerservice.Hide();
        StateHasChanged();
    }



}




