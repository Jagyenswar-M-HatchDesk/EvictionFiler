@using Blazored.Toast.Services
@using EvictionFiler.Application.DTOs
@using EvictionFiler.Application.DTOs.ClientDto
@using EvictionFiler.Application.Interfaces.IRepository.MasterRepository
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Domain.Entities.Master
@using EvictionFiler.Client.SpinnerService
@inject ILegalCaseService _service
@inject IClientService _clientService
@inject IClientRoleRepository _clientRoleRepository
@inject IToastService ToastService
@inject IJSRuntime JS
@inject SpinnerService spinnerservice

 <!-- Contact Info -->


    

<div class="card shadow-sm p-3 border-0" >
    <div style="position:relative;">
    @if (isLoading)
    {
        <div class="spinnerContainer" style="position:absolute !important">
            <div class="text-center">
                <div class="spinner-border spinnerIcon" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-dark">Loading...</p>
            </div>
        </div>
    }
    <table class="info-table " style="border:none;">
        <thead>
            <tr>
                <th colspan="2" class="info-bar" style="background-color:#DDB156;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="info-bar-title">People & Contact</div>
                        <button type="button" class="btn btn-sm normal p-1" @onclick="ShowClientModal" style="color:white ">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </th>
            </tr>
        </thead>

        <tbody>
            <tr class="info-row">
                <td class="info-cell label">Email:</td>
                <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.ClientEmail) ? "--" : legalcaseDto.ClientEmail)</td>
            </tr>

            <tr class="info-row">
                <td class="info-cell label">Phone No.:</td>
                <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.ClientPhone) ? "--" : legalcaseDto.ClientPhone)</td>
            </tr>

            <tr class="info-row">
                <td class="info-cell label">Address:</td>
                <td class="info-cell value ellipsis">
                    @{
                        var partclient = new List<string>();

                        if (!string.IsNullOrWhiteSpace(legalcaseDto.Address1)) partclient.Add(legalcaseDto.Address1);
                        if (!string.IsNullOrWhiteSpace(legalcaseDto.Address2)) partclient.Add(legalcaseDto.Address2);
                        if (!string.IsNullOrWhiteSpace(legalcaseDto.City)) partclient.Add(legalcaseDto.City);
                        if (!string.IsNullOrWhiteSpace(legalcaseDto.StateName)) partclient.Add(legalcaseDto.StateName);
                        if (!string.IsNullOrWhiteSpace(legalcaseDto.ZipCode)) partclient.Add(legalcaseDto.ZipCode);

                        var fulllClientAddress = partclient.Count() > 0 ? string.Join(", ", partclient) : "--";
                    }
                    @fulllClientAddress
                </td>
            </tr>
        </tbody>
    </table>

    </div>

</div>

<!-- client Edit Modal -->

<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="buildingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title fw-semibold" id="buildingModalLabel">Edit Client Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <EditForm Model="@client">
                <DataAnnotationsValidator />
                <div class="modal-body py-0">
                    <div class="card border-0">
                        <div class="card-body">
                            <div class="row">
                                <!-- Case Type Dropdown -->
                                @if (!newClient)
                                {


                                    <div class="col-5 position-relative">


                                        <label class="form-label required-label">Client</label>

                                        <InputText type="text" class="form-control"
                                                   placeholder="Search by client name or code..."
                                                   @bind-value="searchText"
                                                   @oninput="OnSearchInput" />

                                        @if (filteredClients?.Count() > 0)
                                        {
                                            <ul class="dropdown-menu show" style="position: absolute; width:94% !important; cursor:pointer;">
                                                @foreach (var c in filteredClients)
                                                {
                                                    <li class="dropdown-item" @onclick="() => SelectClient(c)">
                                                        @c.FirstName @c.LastName / @c.ClientCode
                                                    </li>
                                                }
                                            </ul>
                                        }
                                    </div>
                                    @if (!showClientTextbox)
                                    {
                                        <div class="col-3 row">
                                            <div class="col-md-3 d-flex justify-content-center align-items-end" style="padding-bottom:10px;">
                                                <div>
                                                    OR
                                                </div>
                                            </div>
                                            <div class="col-md-9 d-flex align-items-end">
                                                <button type="button" class="btn" style="background-color:#1F365D !important;height:40px; color:white" @onclick="AddClient">+ ADD</button>
                                            </div>
                                        </div>
                                    }
                                }
                                @if (showClientTextbox)
                                {



                                    <div class="card p-3 mt-3 position-relative">
                                        <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                                                aria-label="Clear"
                                                @onclick="ClearSelectedClient">
                                        </button>
                                        <div class="row">
                                            <div class="col-4">
                                                <label class="form-label">First Name</label>
                                                <InputText class="form-control" placeholder="Enter Name" @bind-Value="client.FirstName" />
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label">Last Name</label>
                                                <InputText class="form-control" placeholder="Enter Name" @bind-Value="client.LastName" />
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label">Client Type</label>
                                                <InputSelect class="form-select" @bind-Value="client.ClientTypeId" style="cursor:pointer;">
                                                    <option value="">-- Select --</option>
                                                    @foreach (var Own in ClientTypeList)
                                                    {
                                                        <option value="@Own.Id">@Own.Name</option>
                                                    }
                                                </InputSelect>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-4 mt-3">
                                                <label class="form-label">Email</label>
                                                <InputText class="form-control" placeholder="Enter Email" @bind-Value="client.Email" />
                                            </div>

                                            <div class="col-4 mt-3">
                                                <label class="form-label">Phone</label>
                                                <InputText class="form-control" placeholder="Enter Number" @bind-Value="client.Phone" />
                                            </div>
                                            <div class="col-4 mt-3">
                                                <label class="form-label">Reference #</label>
                                                <InputText class="form-control" placeholder="Enter Reference" @bind-Value="client.Reference" />
                                            </div>
                                        </div>
                                    </div>
                                }

                            </div>


                        </div>
                    </div>
                </div>

                <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                    <button type="button" class="btn btn-secondary buttons" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary base buttons" @onclick="SaveClientChanges">Save</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid? CurrentCaseId { get; set; }
    private Guid caseId { get; set; }
    private IntakeModel legalcaseDto = new IntakeModel();
    public List<ClientRole> ClientTypeList = new List<ClientRole>();
    public string searchText { get; set; }
    public bool showClientTextbox = false;
    public bool newClient = false;
    public bool isLoading = true;
    public List<EditToClientDto> filteredClients = new List<EditToClientDto>();
    public EditToClientDto client = new EditToClientDto();
    public List<EditToClientDto> ClientList = new List<EditToClientDto>();
    protected override async Task OnInitializedAsync()
    {

        isLoading = true;
        await LoadCaseDetails();
        isLoading = false;
    }
    private async Task LoadCaseDetails()
    {

        
        legalcaseDto = await _service.GetClientByCaseIdAsync(CurrentCaseId.Value);



        if (legalcaseDto != null)
        {

            legalcaseDto = new IntakeModel
                {
                    Id = legalcaseDto.Id,
                    ClientId = legalcaseDto.ClientId,
                    Casecode = legalcaseDto.Casecode,
                    CaseTypeId = legalcaseDto.CaseTypeId,




                // for client
                    ClientCode = legalcaseDto.ClientCode,
                    FirstName = legalcaseDto.FirstName,
                    LastName = legalcaseDto.LastName,
                    Address1 = legalcaseDto.Address1,
                    Address2 = legalcaseDto.Address2,
                    StateName = legalcaseDto.StateName,
                    ZipCode = legalcaseDto.ZipCode,
                    ClientEmail = legalcaseDto.ClientEmail,
                    ClientPhone = legalcaseDto.ClientPhone,
                    MarshalId = legalcaseDto.MarshalId,



                };

        }
      ;
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        searchText = e.Value.ToString();
        filteredClients = ClientList
            .Where(c => c.FirstName.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                        || c.LastName.Contains(searchText, StringComparison.OrdinalIgnoreCase)
                        || c.ClientCode.Contains(searchText, StringComparison.OrdinalIgnoreCase))
            .ToList();
    }
    private void SelectClient(EditToClientDto selectedclient)
    {
        showClientTextbox = true;
        searchText = $"{client.FirstName} {client.LastName}";
        filteredClients.Clear();
        newClient = false;
        // Fill card
        legalcaseDto.ClientId = selectedclient.Id;
        client.Id = selectedclient.Id;
        client.FirstName = $"{selectedclient.FirstName}";
        client.LastName = $"{selectedclient.LastName}";
        client.Email = selectedclient.Email;
        client.Phone = selectedclient.Phone;
        client.Address1 = selectedclient.Address1;
        client.Address2 = selectedclient.Address2;
        client.City = selectedclient.City;
        client.StateId = selectedclient.StateId;
        client.ZipCode = selectedclient.ZipCode;
        client.ClientTypeId = selectedclient.ClientTypeId;
        client.Reference = selectedclient.Reference;
    }
    private void ClearSelectedClient()
    {
        searchText = string.Empty;

        newClient = false;
        showClientTextbox = false;
        searchText = null;
        client = new EditToClientDto();

        StateHasChanged();
    }
    private async void AddClient()
    {
        showClientTextbox = true;
        searchText = null;
        newClient = true;
        client = new EditToClientDto();
        StateHasChanged();

    }
    private async Task SaveClientChanges()
    {
        spinnerservice.Show();

        var addorupdate = false;
        if (client.Id == null || client.Id == Guid.Empty)
        {
            var newClient = new CreateToClientDto()
            {
                Address1 = client.Address1,
                //Address2 = address2,
                City = client.City,
                StateId = client.StateId,
                ZipCode = client.ZipCode,
                FirstName = client.FirstName,
                LastName = client.LastName,
                Reference = client.Reference,
                ClientTypeId = client.ClientTypeId,
                Phone = client.Phone,
                Email = client.Email,
            };

            var clientId = await _clientService.CreateOnlyClient(newClient);
            addorupdate = true;
            legalcaseDto.ClientId = clientId;

        }
        else
        {
            if (client.Id != null)
            {

                var updateBuilding = new EditToClientDto()
                {
                    Id = client.Id,
                    Address1 = client.Address1,
                    ClientCode = client.ClientCode,
                    //Address2 = address2,
                    ClientTypeId = client.ClientTypeId,
                    City = client.City,
                    StateId = client.StateId,
                    ZipCode = client.ZipCode,
                    Phone = client.Phone,
                    Email = client.Email,
                    Reference = client.Reference,
                    FirstName = client.FirstName,
                    LastName = client.LastName,

                };

                await _clientService.UpdateClientformCase(updateBuilding);
                addorupdate = true;
            }
        }

        if (addorupdate)
        {
            legalcaseDto.ClientEmail = client.Email;
            legalcaseDto.Reference = client.Reference;
            legalcaseDto.ClientTypeId = client.ClientTypeId;
            legalcaseDto.ClientPhone = client.Phone;
            legalcaseDto.ClientName = $"{client.FirstName} {client.LastName}";
            legalcaseDto.City = client.City;
            legalcaseDto.Address1 = client.Address1;
            legalcaseDto.ZipCode = client.ZipCode;
            legalcaseDto.StateId = client.StateId;

            var success = await _service.UpdateCaseForClientAsync(legalcaseDto);

            if (success.HasValue)
            {
                ToastService.ShowSuccess("Client details updated successfully!");
                await JS.InvokeVoidAsync("hideModal", "clientModal");

                await LoadCaseDetails();
            }
            else
            {
                ToastService.ShowError("Failed to update client details.");
            }
        }
        // Map edited fields


        spinnerservice.Hide();
    }
    private async Task ShowClientModal()
    {
        showClientTextbox = false;
        newClient = false;
        searchText = null;
        client = new EditToClientDto();
        // Copy current data into editable model
        if (legalcaseDto.ClientId != null && legalcaseDto.ClientId!=Guid.Empty)
        {
            client = await _clientService.GetClientByIdAsync(legalcaseDto.ClientId!.Value) ?? new EditToClientDto();

            ClientTypeList = await _clientRoleRepository.GetAllClientRole();
            showClientTextbox = true;
            searchText = $"{client.FirstName} {client.LastName}";
           

        }
        await InvokeAsync(StateHasChanged);
        await JS.InvokeVoidAsync("showModal", "clientModal");
    }
    }
   
