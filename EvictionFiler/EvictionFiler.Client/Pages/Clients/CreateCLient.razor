@using EvictionFiler.Application.DTOs.ApartmentDto
@using EvictionFiler.Application.DTOs.ClientDto
@using EvictionFiler.Application.DTOs.LandLordDto
@using EvictionFiler.Application.DTOs.OccupantDto
@using EvictionFiler.Application.DTOs.TenantDto
@using EvictionFiler.Application.Interfaces.IRepository
@using EvictionFiler.Application.Interfaces.IRepository.MasterRepository
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Application.Services
@using EvictionFiler.Client.SpinnerService
@using EvictionFiler.Domain.Entities.Master
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization;
@using System.Security.Claims
@inject AuthenticationStateProvider _authStateProvider


@* @using EvictionFiler.Client.Jwt *@

@inject SpinnerService spinnerservice

@inject IClientService _clientService
@inject IClientRoleRepository _clientRoleService
@inject ILandlordSevice _landlordService
@inject IBuildingService _apartmentService
@inject ITenantService _tenantService
@inject IStateRepository StateRepository
@inject IPremiseTypeRepository PremiseTypeRepository
@inject ITypeOwnerRepository TypeOwnerRepository
@inject IRegulationStatusRepository RegulationStatusRepository
@inject ILanguageRepository LanguageRepository
@inject IUnitIllegalRepository UnitIllegalRepository
@inject ITenancyTypeRepository TenancyTypeRepository
@inject ILandlordTypeRepository LandlordTypeRepository
@inject IDateRentRepository DateRentRepository
@inject ICaseTypeRepository CaseTypeRepository
@inject ICityRepository cityRepository
@inject ITenancyTypeForBuildingRepository TenancyTypeForBuildingRepository;
@inject IExemptionBasicRepository ExemptionBasicRepository;
@inject IExemptionReasonRepository ExemptionReasonRepository;





@rendermode InteractiveAuto
@inject NavigationManager Navigation
@inject IJSRuntime JS

<style>
    :root {
        --bs-primary: #1F365D;
        --bs-warning: #D4A844;
        --bs-light: #F7F6F3;
    }

    body {
        background-color: var(--bs-light);
    }

    .offcanvas.show {
        transform: translateX(0%);
    }

    .offcanvas {
        transform: translateX(100%);
        width: 900px !important;
        transition: transform 0.5s ease-in-out;
    }

    .color-text {
        color: var(--bs-primary);
    }

    .form-control::placeholder {
        font-size: 0.9rem;
    }

    .input-group-text {
        background-color: var(--bs-light);
        color: var(--bs-primary);
        font-weight: 500;
    }

    .form-wrapper {
        transition: transform 0.5s ease, opacity 0.5s ease;
        will-change: transform, opacity;
    }

    /* .form-wrapper.hidden {
        transform: translateX(-100%);
        opacity: 0;
        pointer-events: none;
        } */

    .overlay-form {
        animation: slideIn 0.5s ease forwards;
        background-color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }

        to {
            opacity: 1;
            transform: translateX(0%);
        }
    }

    .form-wrapper.hidden {
        display: none !important;
    }

    .vertical-buttons button {
        /*  min-width: 100px; */
        text-align: center;
    }

    .vertical-tab-button {
        writing-mode: vertical-rl; /* vertical top-to-bottom */
        text-orientation: upright;
        background-color: #f0f2f5;
        color: #1F365D;
        font-weight: 700;
        font-size: 14px;
        border: none;
        padding: 12px 8px;
        border-radius: 10px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

        .vertical-tab-button:hover {
            background-color: #1F365D;
            color: white;
            transform: translateY(-2px);
        }

    .active-vertical {
        background: linear-gradient(135deg, #1F365D, #2F4F7F);
        color: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .required-label::after {
        content: " *";
        color: red;
    }

    .btn-navy {
        background-color: #020336;
        color: white;
        border: none;
    }


    .btn:focus, .btn:active:focus, .btn-link.nav-link:focus, .form-control:focus, .form-check-input:focus {
        box-shadow: none;
    }

    .form-switch .form-check-input:checked {
        background-color: darkblue;
    }

    .form-switch .form-check-input:not(:checked) {
        --bs-form-switch-bg: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'><circle r='3' fill='%236b84af'/></svg>");
    }

    .form-switch .form-check-input {
        width: 2.5em;
        margin-left: -0.5em;
        border: solid 2px lightgrey;
    }

    .table{
        white-space:nowrap;
    }

</style>
@using System.Collections.Generic
@using System.Linq.Expressions


<div class="offcanvas offcanvas-end show border-start shadow bg-white"
     tabindex="-1" id="createClient"
     aria-labelledby="createUserLabel">

    <div class="offcanvas-header border-bottom">

        <h5 class="offcanvas-title fw-bold color-text" id="createUserLabel">Add Client</h5>

        <button type="button" class="btn-close" @onclick="HideAsync" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body p-0">
        <div class="d-flex align-items-center position-relative">
            <!-- CLIENT FORM -->
            <div class="form-wrapper @(activeTab != string.Empty ? "hidden" : "") flex-grow-1 p-3 pe-5">

                <EditForm Model="@createClient" OnValidSubmit="SubmitClientAsync">
                    <DataAnnotationsValidator />

                    <div class="row">

                        <div class="col-md-4 mb-3">
                            <label class="form-label color-text required-label">First Name</label>
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-person"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.FirstName" placeholder="Enter First Name" />
                            </div>

                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label color-text">Last Name</label>
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-person"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.LastName" placeholder="Enter Last Name" />
                            </div>
                        </div>

                        <div class="col-md-5 mb-3">
                            <label class="form-label color-text required-label">Email</label>
                            <div class="input-group">
                                <span class="input-group-text">@@</span>
                                <InputText class="form-control" @bind-Value="createClient.Email" placeholder="Enter Email" />
                            </div>
                        </div>
                    </div>

                    <div class="row">

                        <div class="col-md-4 mb-3">
                            <label class="form-label color-text">Phone</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.Phone" placeholder="Enter Phone Number" @oninput="@(e => FormatPhone(e, "createClient"))" />
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label color-text">Cell Phone</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.CellPhone" placeholder="Enter cell Phone " oninput="@FormatCellPhone" />
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label color-text ">Fax</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-printer"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.Fax" placeholder="Fax Number" oninput="@FormatFax" />
                            </div>
                        </div>

                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label color-text ">Address </label>
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.Address1" placeholder="Enter First Address" />
                            </div>

                        </div>
                        <div class="col-4 mb-3">
                            <label class="form-label required-label">Client Type</label>
                            <InputSelect class="form-select" @bind-Value="createClient.ClientTypeId" style="cursor:pointer;">
                                <option value="">-- Select --</option>
                                @foreach (var Own in ClientTypeList)
                                {
                                    <option value="@Own.Id">@Own.Name</option>
                                }
                            </InputSelect>
                        </div>
                        @* <div class="col-md-6 mb-3">
                            <label class="form-label color-text">Address Line 2</label>
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.Address2" placeholder="Enter Second Address" />
                            </div>

                        </div> *@
                    </div>

                    <div class="row">

                        @* <div class="col-md-3 mb-3">
                            <label class="form-label color-text ">State</label>
                            <InputSelect class="form-select" @bind-Value="createClient.StateId">
                                <option value="">-- Select State --</option>
                                @foreach (var state in StatesList)
                                {
                                    <option value="@state.Id">@state.Name</option>
                                }
                            </InputSelect>
                        </div> *@
                        @* <div class="col-md-3 mb-3">
                            <label class="form-label color-text">City</label>
                            <!-- City -->
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.City" placeholder="Enter City" />
                            </div>


                        </div> *@

                        @* <div class="col-md-3 mb-3">
                            <label class="form-label color-text ">Zip Code</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-geo"></i></span>
                                <InputText class="form-control" @bind-Value="createClient.ZipCode" />
                            </div>
                        </div> *@

                    </div>


                </EditForm>

            </div>

            <!-- Vertical Overlay Buttons -->
            <div class="vertical-buttons d-flex flex-column align-items-center position-absolute end-0 top-50 translate-middle-y ">
                <button class="vertical-tab-button @(activeTab == "landlord" ? "active-vertical" : "")" @onclick="@(() => SetActiveTab("landlord"))">LANDLORD</button>

            </div>
        </div>

        <!-- LANDLORD Overlay -->
        @if (activeTab == "landlord")
        {
            <div class="overlay-form overlay-landlord">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="color-text fw-bold mb-0">LANDLORD INFORMATION</h5>
                    <div>
                        <button class="btn btn-outline-secondary fw-semibold me-2"
                                @onclick="@BackToPreviousTab">
                            ←
                        </button>
                        @* <button class="btn btn-outline-secondary fw-semibold me-2" @onclick="@(() => SetActiveTab(string.Empty))">←</button> *@
                        <button class="btn bg-navy text-white" style="font-size:14px; background:#1F365D;" @onclick="ToggleLandlordForm">@GetToggleButtonText()</button>
                        @if (showLandlordForm)
                        {
                            <button type="submit" form="landlordForm" class="btn bg-navy text-white me-2" style="font-size:14px; background:#1F365D;margin-left:10px;">Save</button>
                        }
                    </div>
                </div>

                @if (showLandlordForm)
                {
                    <EditForm Id="landlordForm" Model="@landlord"  OnValidSubmit="SaveLandlordAsync">

                        <DataAnnotationsValidator />

                        <div class="row mb-3">

                            <div class="col-md-3">
                                <label class="required-label">First Name</label>

                                <div class="input-group mb-3">
                                    <span class="input-group-text">
                                        <i class="bi bi-person"></i>
                                    </span>
                                    <InputText class="form-control" @bind-Value="landlord.FirstName" placeholder="Enter First Name" />
                                </div>
                                <ValidationMessage For="@(() => landlord.FirstName)" />

                            </div>
                            <div class="col-md-3">
                                <label>Last Name</label>

                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <InputText class="form-control" @bind-Value="landlord.LastName" placeholder="Enter Last Name" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <label>EIN/SSN</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text">
                                        <i class="bi bi-person-vcard"></i> <!-- You can replace with bi-shield-lock too -->
                                    </span>
                                    <InputText class="form-control" @bind-Value="landlord.EINorSSN" placeholder="Enter EIN " />
                                </div>


                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Type of Owner</label>
                                <InputSelect class="form-select" @bind-Value="landlord.TypeOwnerId">
                                    <option value="">-- Select --</option>
                                    @foreach (var Own in TypeOwnerList)
                                    {
                                        <option value="@Own.Id">@Own.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => landlord.TypeOwnerId)" />
                            </div>

                        </div>


                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label>Phone</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                    <InputText class="form-control" @bind-Value="landlord.Phone" placeholder="Enter Phone " @oninput="@(e => FormatPhone(e, "landlord"))" />
                                </div>

                            </div>
                            <div class="col-md-4">
                                <label class="">Email</label>

                                <div class="input-group">
                                    <span class="input-group-text">@@</span>
                                    <InputText class="form-control" @bind-Value="landlord.Email" placeholder="Enter Email" />

                                </div>
                                <ValidationMessage For="@(() => landlord.Email)" />

                            </div>

                            <div class="col-md-4">
                                <label class="required-label">Contact Person Name</label>

                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <InputText class="form-control" @bind-Value="landlord.ContactPersonName" placeholder="Enter  Name " />

                                </div>
                                <ValidationMessage For="@(() => landlord.ContactPersonName)" />

                            </div>

                        </div>



                        <div class="row mb-3">

                            <div class="col">
                                <label>Zip Code</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-geo"></i></span>
                                    <InputText class="form-control" @bind-Value="landlord.Zipcode" placeholder="Enter Zip Code " />
                                </div>

                            </div>
                            <div class="col">
                                <label>City</label>

                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                    <InputText class="form-control" @bind-Value="landlord.CityName" placeholder="Enter City " />
                                </div>


                            </div>


                            <div class="col">
                                <label>State</label>
                                <InputSelect class="form-select" @bind-Value="landlord.StateId">
                                    @foreach (var s in StatesList)
                                    {
                                        <option value="@s.Id">@s.Name</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label class="required-label">Address Line 1</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                    <InputText class="form-control" @bind-Value="landlord.Address1" placeholder="Enter First Address " />

                                </div>
                                <ValidationMessage For="@(() => landlord.Address1)" />

                            </div>
                            <div class="col">
                                <label>Address Line 2</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                    <InputText class="form-control" @bind-Value="landlord.Address2" placeholder="Enter Second Address " />
                                </div>

                            </div>
                        </div>

                        <div class="row mb-3 d-flex align-items-center">
                            <div class="col-lg-6">
                                <label>If purchased at foreclosure: Date of Referee Deed</label>

                            </div>
                            <div class="col-lg-3">
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " 
                                           @bind-Value="landlord.DateOfRefreeDeed"
                                           id="dateRefereeDeed"
                                           placeholder="Select date" />
                            </div>
                        </div>
                        <InputRadioGroup @bind-Value="landlord.LandlordTypeId" class="mb-3 required-label">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <label class="form-label mb-0 " style="margin-top:5px">Are You the:</label>
                                </div>
                                <div class="col">
                                    <div class="d-flex flex-wrap align-items-center gap-4">
                                        @foreach (var role in LandLordTypeList)
                                        {
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="form-check d-flex align-items-center m-0">
                                                    <InputRadio Value="@role.Id" class="form-check-input me-1" />
                                                    <label class="form-check-label ms-1" style="margin-top:5px">
                                                        @role.Name
                                                    </label>
                                                </div>

                                                @if (role.Name == "Other" && landlord.LandlordTypeId == role.Id)
                                                {
                                                    <InputText class="form-control"
                                                               placeholder="Please specify"
                                                               style="max-width: 200px; height: 36px;"
                                                               @bind-Value="landlord.OtherLandlordTypeDescription" />
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </InputRadioGroup>
                        @* <button type="submit" class="btn bg-navy text-white mt-3">Save </button> *@
                    </EditForm>

                }

                @if (!showLandlordForm)
                {
                    <div style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                        <table class="table table-bordered mt-4" style="min-width: 1000px;">
                            <thead class="table-light">
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>EIN</th>
                                    <th>Contact Person Name</th>
                                    <th>Type of Owner</th>
                                    <th>Date of Refree</th>
                                    <th>Address</th>
                                    <th>Status</th>
                                    <th class="sticky">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (savelandlordList.Any())
                                {
                                    @foreach (var l in savelandlordList)
                                    {
                                        <tr>
                                            <td>@(string.IsNullOrWhiteSpace(l.FirstName + l.LastName) ? "-" : l.FirstName + " " + l.LastName)</td>
                                            <td>@(string.IsNullOrWhiteSpace(l.Email) ? "-" : l.Email)</td>
                                            <td>@(string.IsNullOrWhiteSpace(l.Phone) ? "-" : l.Phone)</td>
                                            <td>@(string.IsNullOrWhiteSpace(l.EINorSSN) ? "-" : l.EINorSSN)</td>
                                            <td>@(string.IsNullOrWhiteSpace(l.ContactPersonName) ? "-" : l.ContactPersonName)</td>
                                            <td>@(string.IsNullOrWhiteSpace(l.TypeOwnerName) ? "-" : l.TypeOwnerName)</td>
                                            <td>@(l.DateOfRefreeDeed == DateOnly.MinValue ? "-" : l.DateOfRefreeDeed.ToString(DateFormats.Default))</td>
                                            <td>
                                                @{
                                                    var parts = new List<string>();

                                                    if (!string.IsNullOrWhiteSpace(l.Address1)) parts.Add(l.Address1);
                                                    if (!string.IsNullOrWhiteSpace(l.Address2)) parts.Add(l.Address2);
                                                    if (!string.IsNullOrWhiteSpace(l.CityName)) parts.Add(l.CityName);
                                                    if (!string.IsNullOrWhiteSpace(l.StateName)) parts.Add(l.StateName);
                                                    if (!string.IsNullOrWhiteSpace(l.Zipcode)) parts.Add(l.Zipcode);

                                                    var fullAddress = parts.Any() ? string.Join(", ", parts) : "-";
                                                }
                                                @fullAddress
                                            </td>

                                            <td>Active</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="7" class="text-muted">No landlords added yet.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="vertical-buttons d-flex flex-column align-items-center position-absolute end-0 top-0 translate-middle-y ">
                        <button class="vertical-tab-button @(activeTab == "building" ? "active-vertical" : "")" @onclick="@(() => SetActiveTab("building"))" style="position:relative ; top:15rem">BUILDING</button>
                    </div>
                }

            </div>
        }

        <!-- BUILDING Overlay -->
        @if (activeTab == "building")
        {
            <div class="overlay-form overlay-building">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="color-text fw-bold mb-0">BUILDING INFORMATION</h5>
                    <div>
                        @* <button class="btn btn-outline-secondary fw-semibold me-2" @onclick="@(() => SetActiveTab(string.Empty))">←</button> *@
                        <button class="btn btn-outline-secondary fw-semibold me-2"
                                @onclick="@BackToPreviousTab">
                            ←
                        </button>
                        <button class="btn bg-navy text-white" style="font-size:14px; background:#1F365D;" @onclick="ToggleBuildingForm">@GetToggleButtonText()</button>
                        @if (showBuildingForm)
                        {
                            <button type="submit" form="buildingForm" class="btn bg-navy text-white me-2" style="font-size:14px; background:#1F365D;margin-left:10px">Save</button>
                        }
                    </div>
                </div>

                @if (showBuildingForm)
                {

                    <EditForm id="buildingForm" EditContext="_editContextBuilding" OnSubmit="SaveBuildingAsync">
                        <DataAnnotationsValidator />

                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="required-label">Landlord</label>
                                <InputSelect class="form-select" @bind-Value="building.LandlordId">
                                    <option value="">-- Select --</option>
                                    @foreach (var landlord in savelandlordList)
                                    {
                                        <option value="@landlord.Id">@landlord.FirstName</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => building.LandlordId)" />
                            </div>
                            <div class="col-md-2">
                                <label>Apt Code</label>
                                <InputText class="form-control" @bind-Value="building.ApartmentCode" placeholder="Enter Code" />

                            </div>

                            <div class="col-md-2">
                                <label class="required-label">MDR Num</label>
                                <InputText class="form-control" @bind-Value="building.MDRNumber" Placeholder="Enter Num" />
                                <ValidationMessage For="@(() => building.MDRNumber)" />
                            </div>
                            <div class="col-md-2">
                                <label for="BuildingUnit" class="required-label"> Units</label>
                                <InputText class="form-control" id="BuildingUnit" @bind-Value="building.BuildingUnits" placeholder="Enter  Units" />
                                <ValidationMessage For="@(() => building.BuildingUnits)" />
                            </div>
                            <div class="col-md-3">
                                <label for="BuildingUnit" class="required-label">Premise Type</label>
                                <InputSelect class="form-select" @bind-Value="building.PremiseTypeId">
                                    <option value="">-- Select --</option>
                                    @foreach (var p in premiseTypesList)
                                    {
                                        <option value="@p.Id">@p.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => building.PremiseTypeId)" />
                            </div>
                        </div>

                        <!-- Premise Type & MDR Number -->
                        <div class="row mb-3">

                            <div class="col-md-4" style=@(ShowExemptionOther ? "width:20%" : "")>
                                <label>Petitioner Interest</label>
                                <InputText class="form-control" @bind-Value="building.PetitionerInterest" placeholder="Enter Intrest" />
                            </div>
                           @*  <div class="col-md-4" style=@(ShowExemptionOther ? "width:20%" : "")>
                                <label class="required-label" for="RentStatus">Rent Regulation</label>
                                <InputSelect class="form-select" @bind-Value="building.RegulationStatusId">
                                    <option value="">-- Select --</option>
                                    @foreach (var r in RegulationList)
                                    {
                                        <option value="@r.Id">@r.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => building.RegulationStatusId)" />
                            </div>


                            @if (SelectedRegulationName?.Equals("Exempt", StringComparison.OrdinalIgnoreCase) == true)

                            {
                                <div class="col-md-4" style=@(ShowExemptionOther ? "width:20%" : "")>
                                    <label class="">Exemption Basis</label>
                                    <InputSelect class="form-select"
                                                 @bind-Value="building.ExemptionBasisId">
                                        <option value="">-- Select --</option>
                                        @foreach (var r in ExemptionBasicList)
                                        {
                                            <option value="@r.Id">@r.Name</option>
                                        }
                                    </InputSelect>
                                    @* <ValidationMessage For="@(() => building.ExemptionBasisId)" /> *
                                </div>
                            }
                            @if (SelectedRegulationName?.Equals("Other", StringComparison.OrdinalIgnoreCase) == true)

                            {
                                <div class="col">
                                    <label class="">
                                        Other Regulation
                                    </label>
                                    <InputText class="form-control" @bind-Value="building.RentRegulationOther" placeholder="Enter Other Reulation" />
                                </div>
                            }

                            @if (ShowExemptionOther == true)

                            {
                                <div class="col">
                                    <label class="">
                                        Exemption
                                    </label>
                                    <InputText class="form-control" @bind-Value="building.ExemptionBasisother" placeholder="Enter Exemption" />
                                </div>
                            }
 *@

                            <!-- Rent Regulation -->
                            <div class="@ColumnClass" style=@(ShowExemptionOther ? "width:20%" : "")>
                                <label class="lbl required-label">Rent Regulation</label>
                                <InputSelect class="  form-select"
                                             @bind-Value="building.RegulationStatusId"
                                             @bind-Value:after="BindRentRegulation"
                                             >
                                    <option value="">-- Select --</option>
                                    @foreach (var l in RegulationList)
                                    {
                                        <option value="@l.Id">@l.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => building.RegulationStatusId)" />
                            </div>

                            @if (ShowExemptionBasic)
                            {
                                <!-- Exemption Basic -->
                                <div class="@ColumnClass" style=@(ShowExemptionOther ? "width:20%" : "")>
                                    <label class="lbl required-label">
                                        Exemption Basic
                                    </label>
                                    <InputSelect class="  form-select"
                                                 @bind-Value="building.ExemptionBasisId" @bind-Value:after="BindExemptionBasis"
                                                 >
                                        <option value="">-- Select --</option>
                                        @foreach (var s in ExemptionBasicList)
                                        {
                                            <option value="@s.Id">@s.Name</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => building.ExemptionBasisId)" />
                                </div>
                            }
                            @if (ShowExemptionOther)
                            {
                                <!-- Exemption Basic -->
                                <div class="col">
                                    <label class="lbl required-label">
                                        Exemption
                                    </label>
                                    <InputText class="  form-control" @bind-Value="building.ExemptionBasisother" placeholder="Enter Exemption"  />
                                    <ValidationMessage For="@(() => building.ExemptionBasisother)" />
                                </div>
                            }
                            @if (ShowRentOther)
                            {
                                <!-- Exemption Basic -->
                                <div class="col">
                                    <label class="lbl required-label">
                                        Other Regulation
                                    </label>
                                    <InputText class="  form-control" @bind-Value="building.RentRegulationOther"
                                               @bind-Value:after=@(() => ValidateParticularInput(() => building.RentRegulationOther, nameof(building.RentRegulationOther), "Other Rent Regulation")) placeholder="Enter Other Reulation" />
                                    <ValidationMessage For="@(() => building.RentRegulationOther)" />
                                </div>
                            }
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="required-label">Address Line 1</label>
                                <div class="input-group ">
                                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                    <InputText class="form-control" @bind-Value="building.Address1" placeholder="Enter First Address" />
                                </div>
                                <ValidationMessage For="@(() => building.Address1)" />

                            </div>
                            <div class="col-6">
                                <label>Address Line 2</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                    <InputText class="form-control" @bind-Value="building.Address2" placeholder="Enter Second Address" />
                                </div>

                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="required-label">Registration Status(HPD/DOF)</label>
                                <InputSelect class="form-select" @bind-Value="building.RegistrationStatusId" disabled="@(building.OwnerOccupied == true)">
                                    <option value="">-- Select --</option>
                                    @foreach (var s in RegistrationstatusList)
                                    {
                                        <option value="@s.Id">@s.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => building.RegistrationStatusId)" />
                            </div>
                            <div class="col-6">
                                <label class="required-label">Agent</label>

                                <div class="input-group ">
                                    <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
                                    <InputText class="form-control" @bind-Value="building.ManagingAgent" placeholder="Enter Agent Name " />

                                </div>
                                <ValidationMessage For="@(() => building.ManagingAgent)" />
                            </div>





                        </div>

                        @*  <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="required-label" for="RentStatus">Exemption Reason</label>
                                <InputSelect class="form-select" @bind-Value="building.ExemptionreasonId">
                                    <option value="">-- Select --</option>

                                    @foreach (var r in ExemptionReasonList)
                                    {
                                        <option value="@r.Id">@r.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => building.ExemptionreasonId)" />
                            </div>
                            <div class="col-md-6">
                                <label class="required-label" for="RentStatus">Tenancy Type</label>
                                <InputSelect class="form-select" @bind-Value="building.TenancyTypeForBuildingId">
                                    <option value="">-- Select --</option>

                                    @foreach (var r in TenancyTypeForBuildingList)
                                    {
                                        <option value="@r.Id">@r.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => building.ExemptionreasonId)" />
                            </div>

                             </div>
                         *@
                        <div class="row mb-3">
                            <div class="col-4">
                                <div class="form-check form-switch" style="padding-left:0px;">


                                    <label class="form-check-label form-label mb-0 me-2" for="ownerOccupiedSwitch">
                                        Owner Occupied?
                                        @* <span class="ms-2 fw-semibold">
                                                                @(legalcaseDto.OwnerOccupied ? "Yes" : "No")
                                                            </span> *@
                                    </label>
                                    <input class="form-check-input" style="float:none;"
                                           type="checkbox"
                                           id="ownerOccupiedSwitch"
                                           @bind="building.OwnerOccupied" @bind:after="SelectedOwnerOccupied" />
                                </div>


                            </div>
                            @*  <div class="col-4">
                                <InputRadioGroup @bind-Value="building.PrimaryResidence">
                                    <label class="form-label mb-0 me-2">Primary Residence?:</label>
                                    <div class="d-flex gap-2">

                                        <div class="form-check me-2">
                                            <InputRadio class="form-check-input" Value="true" />
                                            <label class="form-check-label">Yes</label>
                                        </div>

                                        <div class="form-check">
                                            <InputRadio class="form-check-input" Value="false" />
                                            <label class="form-check-label">No</label>
                                        </div>
                                    </div>
                                </InputRadioGroup>
                            </div> *@
                            <div class="col-4">

                                <div class="form-check form-switch" style="padding-left:0px;">


                                    <label class="form-check-label form-label mb-0 me-2" for="goodCauseSwitch">
                                        Does Good Cause Apply?:
                                        @* <span class="ms-2 fw-semibold">
                                                                @(legalcaseDto.OwnerOccupied ? "Yes" : "No")
                                                            </span> *@
                                    </label>
                                    <input class="form-check-input" style="float:none;"
                                           type="checkbox"
                                           id="GoodCauseSwitch"
                                           @bind="building.GoodCause" />
                                </div>


                            </div>
                            @if (building.GoodCause.Value == false)
                            {
                                <div class="col-md-4">
                                    <label class="required-label" )>
                                        Exemption Reason
                                    </label>
                                    <InputSelect class="form-select" @bind-Value="building.ExemptionreasonId">
                                        <option value="">-- Select --</option>
                                        @foreach (var s in ExemptionReasonList)
                                        {
                                            <option value="@s.Id">@s.Name</option>
                                        }
                                    </InputSelect>

                                    <ValidationMessage For="() => building.ExemptionreasonId" />


                                </div>
                            }
                        </div>

                        <div class="row mb-3">
                            <div class="col-4">
                                <label class="required-label">Zip Code</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-geo"></i></span>
                                    <InputText class="form-control" @bind-Value="building.Zipcode" placeholder="Enter Zip Code " />
                                    <ValidationMessage For="@(() => building.Zipcode)" />
                                </div>

                            </div>

                            <div class="col-4">
                                <label class="required-label">City</label>

                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
                                    @* <InputText class="form-control" @bind-Value="building.CityName" placeholder="Enter City " /> *@
                                    <InputSelect class="form-select" @bind-Value="building.CityId">
                                        <option value="">-- Select --</option>
                                        @foreach (var s in CityList)
                                        {

                                            <option value="@s.Id">@s.Name</option>
                                        }
                                    </InputSelect>
                                    <ValidationMessage For="@(() => building.CityId)" />
                                </div>
                            </div>

                            <div class="col-4">
                                <label class="required-label">State</label>
                                <InputSelect class="form-select" @bind-Value="building.StateId">
                                    <option value="">-- Select --</option>
                                    @foreach (var s in StatesList)
                                    {
                                        <option value="@s.Id">@s.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => building.StateId)" />
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-12">
                                <label class="required-label">Rent Regulation Decription </label>
                                <div class="input-group">

                                    <InputTextArea class="form-control" @bind-Value="building.RentRegulationDescription" placeholder="Enter Description" />

                                </div>

                            </div>




                        </div>



                        <!-- Submit Button -->
                        @* <button type="submit" class="btn bg-navy text-white mt-2">Save</button> *@
                    </EditForm>
                }

                @if (!showBuildingForm)
                {
                    <div style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                        <table class="table table-bordered mt-4" style="min-width: 1000px;">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Premise</th>
                                    <th>Address</th>
                                    <th>MDR</th>
                                    <th> Petitioner Interest</th>
                                    <th>Rent Regulation</th>
                                    <th>Building Units</th>
                                    <th>Registration Status</th>
                                    <th>Agent</th>
                                    <th>Exemption Reason</th>
                                    <th>Exemption Basic</th>
                                    <th>Tenancy Type</th>
                                    <th>Status</th>

                                </tr>
                            </thead>
                            <tbody>
                                @if (apartmentList.Any())
                                {
                                    @foreach (var b in apartmentList)
                                    {
                                        <tr>
                                            <td>@(string.IsNullOrWhiteSpace(b.ApartmentCode) ? "-" : b.ApartmentCode)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.PremiseTypeName) ? "-" : b.PremiseTypeName)</td>

                                            <td>
                                                @{
                                                    var parts = new List<string>();

                                                    if (!string.IsNullOrWhiteSpace(b.Address1)) parts.Add(b.Address1);
                                                    if (!string.IsNullOrWhiteSpace(b.Address2)) parts.Add(b.Address2);
                                                    if (!string.IsNullOrWhiteSpace(b.CityName)) parts.Add(b.CityName);
                                                    if (!string.IsNullOrWhiteSpace(b.StateName)) parts.Add(b.StateName);
                                                    if (!string.IsNullOrWhiteSpace(b.Zipcode)) parts.Add(b.Zipcode);

                                                    var fullAddress = parts.Any() ? string.Join(", ", parts) : "-";
                                                }
                                                @fullAddress
                                            </td>
                                            <td>@(string.IsNullOrWhiteSpace(b.MDRNumber) ? "-" : b.MDRNumber)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.PetitionerInterest) ? "-" : b.PetitionerInterest)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.RegulationStatusName) ? "-" : b.RegulationStatusName)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.BuildingUnits) ? "-" : b.BuildingUnits)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.RegistrationStatusName) ? "-" : b.RegistrationStatusName)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.ManagingAgent) ? "-" : b.ManagingAgent)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.ExemptionBasisName) ? "-" : b.ExemptionBasisName)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.ExemptionReasonName) ? "-" : b.ExemptionReasonName)</td>
                                            <td>@(string.IsNullOrWhiteSpace(b.TenancyTypeForBuildingName) ? "-" : b.TenancyTypeForBuildingName)</td>
                                            <td>Active</td>

                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="10" class="text-muted">No buildings added yet.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="vertical-buttons d-flex flex-column align-items-center position-absolute end-0 top-0 translate-middle-y ">
                        <button class="vertical-tab-button @(activeTab == "tanent" ? "active-vertical" : "")" @onclick="@(() => SetActiveTab("tanent"))" style="position:relative ; top:15rem">Tanent</button>

                    </div>
                }

            </div>
        }


        @if (activeTab == "tanent")
        {
            <div class="overlay-form overlay-landlord">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="color-text fw-bold mb-0">TENANT INFORMATION</h5>
                    <div>
                        <button class="btn btn-outline-secondary fw-semibold me-2"
                                @onclick="@BackToPreviousTab">
                            ←
                        </button>
                        @* <button class="btn btn-outline-secondary fw-semibold me-2" @onclick="@(() => SetActiveTab(string.Empty))">←</button> *@
                        <button class="btn bg-navy text-white" style="font-size:14px; background:#1F365D;" @onclick="ToggleTanentForm">@GetToggleButtonText()</button>
                        @if (showTanentForm)
                        {
                            <button type="submit" form="tenantForm" class="btn bg-navy text-white me-2" style="font-size:14px; background:#1F365D;margin-left:10px">Save</button>
                        }
                    </div>
                </div>

                @if (showTanentForm)
                {
                    <EditForm id="tenantForm" Model="@tenant" OnValidSubmit="SaveTenantAsync">
                        <DataAnnotationsValidator />
                        <!-- Row 1: Apartment Selection -->
                        <div class="row mb-3">

                            <div class="col-md-3">
                                <label class="required-label">Building</label>
                                <InputSelect class="form-select" @bind-Value="tenant.BuildingId" @bind-Value:after="OnBuildingChanged">
                                    <option value="">-- Select --</option>
                                    @foreach (var apartment in apartmentList)
                                    {
                                        <option value="@apartment.Id">@apartment.ApartmentCode</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => tenant.BuildingId)" />
                            </div>
                            <div class="col-md-4">
                                <label class="required-label">First Name</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <InputText class="form-control" @bind-Value="tenant.FirstName" placeholder="Enter First Name" />
                                </div>
                                <ValidationMessage For="@(() => tenant.FirstName)" />
                            </div>
                            <div class="col-md-3">
                                <label class="required-label">Last Name</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text"><i class="bi bi-person"></i></span>
                                    <InputText class="form-control" @bind-Value="tenant.LastName" placeholder="Enter Last Name" />
                                    <ValidationMessage For="@(() => tenant.LastName)" />
                                </div>

                            </div>


                            <div class="col-md-2">
                                <label class=" required-label">Unit/AptNum</label>
                                <InputText class="form-control required-label" @bind-Value="tenant.UnitOrApartmentNumber" placeholder="Enter Unit or Apt No." />
                                <ValidationMessage For="@(() => tenant.UnitOrApartmentNumber)" />
                            </div>
                        </div>


                        <!-- Row 2: Email, Phone language  , ein -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label>Email</label>
                                <div class="input-group">
                                    <span class="input-group-text">@@</span>
                                    <InputText class="form-control" @bind-Value="tenant.Email" placeholder="Enter Email" />
                                </div>


                            </div>

                            <div class="col-md-4">
                                <label>Phone</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-phone"></i></span>
                                    <InputText class="form-control" @bind-Value="tenant.Phone" placeholder="Enter Phone " @oninput="@(e => FormatPhone(e, "tenant"))" />
                                </div>

                            </div>

                            <div class="col-md-4">
                                <label>EIN/SSN</label>

                                <div class="input-group mb-3">
                                    <span class="input-group-text">
                                        <i class="bi bi-person-vcard"></i> <!-- You can replace with bi-shield-lock too -->
                                    </span>
                                    <InputText class="form-control" @bind-Value="tenant.SSN" placeholder="Enter EIN " />
                                </div>
                            </div>

                        </div>


                        <div class="row mb-4">
                            <div class="col-md-3">
                                <label>Language</label>
                                <InputSelect class="form-select" @bind-Value="tenant.LanguageId">
                                    <option value="">-- Select --</option>
                                    @foreach (var l in LangList)
                                    {
                                        <option value="@l.Id">@l.Name</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-4">
                                <label>Social Services</label>
                                <InputText class="form-control" @bind-Value="tenant.SocialServices" placeholder="Enter Social Service Info" />
                            </div>
                            <div class="col-md-3">
                                <label class="required-label">Tenancy Type</label>
                                <InputSelect class="form-select" @bind-Value="tenant.TenancyTypeId">
                                    <option value="">-- Select --</option>
                                    @foreach (var l in TenancyTypeList)
                                    {
                                        <option value="@l.Id">@l.Name</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => tenant.TenancyTypeId)" />

                            </div>
                            <div class="col-md-2">
                                <label>Date</label>
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="tenant.MoveInDate" placeholder="Select Date" />
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="required-label">Date Rent (M/W)</label>
                                <div class="input-group mb-3">

                                    <InputSelect class="form-select" @bind-Value="tenant.RentDueEachMonthOrWeekId">
                                        <option value="">-- Select --</option>
                                        @foreach (var l in DateRentList)
                                        {
                                            <option value="@l.Id">@l.Name</option>
                                        }
                                    </InputSelect>



                                </div>
                                <ValidationMessage For="@(() => tenant.RentDueEachMonthOrWeekId)" />


                            </div>

                            <div class="col-md-3">
                                <label class="required-label">Monthly Rent</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text">
                                        <i class="bi bi-currency-dollar"></i>
                                    </span>


                                    <InputNumber class="form-control" @bind-Value="tenant.MonthlyRent" placeholder="Enter Monthly Rent" />

                                </div>
                                <ValidationMessage For="@(() => tenant.MonthlyRent)" />

                            </div>

                            <div class="col-md-2">
                                <label>Tenant's Share</label>
                                <div class="input-group mb-3">
                                    <span class="input-group-text">
                                        <i class="bi bi-percent"></i>
                                    </span>

                                    <InputNumber class="form-control" @bind-Value="tenant.TenantShare" placeholder="Enter Tenant Share" />

                                </div>
                            </div>


                            <div class="col-md-4">
                                <label>Units Illegal</label>
                                <InputSelect class="form-select" @bind-Value="tenant.IsUnitIllegalId">
                                    <option value="">-- Select --</option>
                                    @foreach (var l in IsUnitIllegalList)
                                    {
                                        <option value="@l.Id">@l.Name</option>
                                    }
                                </InputSelect>
                            </div>

                        </div>

                        <div class="row mb-3">
                            <div class="col-auto">
                                <label class="me-2 ">Building Address</label>
                            </div>
                            <div class="col">
                                <InputText class="form-control" @bind-Value="tenant.CompletedAddress" disabled />

                            </div>

                        </div>

                        <div class="row mb-3">
                            <div class="col-auto">
                                <label class="me-2 ">Additional Tenants</label>
                            </div>

                            <div class="col">
                                @for (int i = 0; i < occupants.Count; i++)
                                {
                                    var item = occupants[i];
                                    <div class="row mb-2" @key="item">


                                        <div class="col-auto">
                                            <!-- Sirf last row me + button -->
                                            @if (i == occupants.Count - 1)
                                            {
                                                <button type="button" class="btn btn-sm bg-navy text-white me-1"
                                                        @onclick="() => AddTenant(item)" disabled="@item.IsVisible">
                                                    +
                                                </button>
                                            }

                                            <!-- Minus button (only when inputs visible) -->
                                            @if (item.IsVisible)
                                            {
                                                <button type="button" class="btn btn-sm btn-danger"
                                                        @onclick="() => RemoveTenant(item)">
                                                    -
                                                </button>
                                            }
                                        </div>
                                        @if (item.IsVisible)
                                        {
                                            <!-- Show input fields -->
                                            <div class="col-auto">
                                                <InputText class="form-control" placeholder="First Name"
                                                           @bind-Value="item.FirstName" />
                                            </div>
                                            <div class="col-auto">
                                                <InputText class="form-control" placeholder="Last Name"
                                                           @bind-Value="item.LastName" />
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="form-check form-switch" style="padding-left:10px">

                                <label class="form-check-label form-label mb-0 me-2" for="primaryResidenceSwitch">
                                    <span class="required-label">Primary Residence?</span> :

                                </label>
                                <input class="form-check-input" style="float:none"
                                       type="checkbox"
                                       id="ownerOccupiedSwitch"
                                       @bind="tenant.PrimaryResidence" />
                            </div>
                            <ValidationMessage For="@(() => tenant.PrimaryResidence)" />

                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <InputRadioGroup @bind-Value="tenant.IsERAPPaymentReceived">
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">ERAP Payment Received?:</label>

                                        <div class="form-check me-2">
                                            <InputRadio class="form-check-input" Value="true" />
                                            <label class="form-check-label">Yes</label>
                                        </div>

                                        <div class="form-check">
                                            <InputRadio class="form-check-input" Value="false" />
                                            <label class="form-check-label">No</label>
                                        </div>
                                    </div>
                                </InputRadioGroup>
                            </div>

                            @if (tenant.IsERAPPaymentReceived == true)
                            {
                                <div class="col-md-6 d-flex align-items-center">
                                    <label class="form-label mb-0 me-2">ERAP Received Date:</label>
                                    <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer;" @bind-Value="tenant.ERAPPaymentReceivedDate" />
                                </div>
                            }
                        </div>


                        <div class="row mb-3">
                            <!-- Tenant of Record -->
                            <div class="col-md-6">
                                <InputRadioGroup @bind-Value="tenant.TenantRecord">
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">Tenant of Record:</label>

                                        <div class="form-check me-2">
                                            <InputRadio class="form-check-input" Value="true" />
                                            <label class="form-check-label">Yes</label>
                                        </div>

                                        <div class="form-check">
                                            <InputRadio class="form-check-input" Value="false" />
                                            <label class="form-check-label">No</label>
                                        </div>
                                    </div>
                                </InputRadioGroup>
                            </div>

                            <!-- Still in Possession -->
                            <div class="col-md-6">
                                <InputRadioGroup @bind-Value="tenant.HasPossession">
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">Still in Possession:</label>

                                        <div class="form-check me-2">
                                            <InputRadio class="form-check-input" Value="true" />
                                            <label class="form-check-label">Yes</label>
                                        </div>

                                        <div class="form-check">
                                            <InputRadio class="form-check-input" Value="false" />
                                            <label class="form-check-label">No</label>
                                        </div>
                                    </div>
                                </InputRadioGroup>
                            </div>
                        </div>

                        <div class="row align-items-center mb-3">

                            <div class="col-md-6">

                                <InputRadioGroup @bind-Value="tenant.HasRegulatedTenancy">
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">Is this a rent regulated tenancy:</label>

                                        <div class="form-check me-2">
                                            <InputRadio class="form-check-input" Value="true" />
                                            <label class="form-check-label">Yes</label>
                                        </div>

                                        <div class="form-check">
                                            <InputRadio class="form-check-input" Value="false" />
                                            <label class="form-check-label">No</label>
                                        </div>
                                    </div>
                                </InputRadioGroup>
                            </div>
                            <div class="col-md-6">
                                <InputRadioGroup @bind-Value="tenant.OtherOccupants">
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">Other Occupants:</label>

                                        <div class="form-check me-2">
                                            <InputRadio class="form-check-input" Value="true" />
                                            <label class="form-check-label">Yes</label>
                                        </div>

                                        <div class="form-check">
                                            <InputRadio class="form-check-input" Value="false" />
                                            <label class="form-check-label">No</label>
                                        </div>
                                    </div>
                                </InputRadioGroup>

                            </div>

                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <InputRadioGroup @bind-Value="tenant.HasPriorCase">
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">Any prior housing Court Case:</label>

                                        <div class="form-check me-2">
                                            <InputRadio class="form-check-input" Value="true" />
                                            <label class="form-check-label">Yes</label>
                                        </div>

                                        <div class="form-check">
                                            <InputRadio class="form-check-input" Value="false" />
                                            <label class="form-check-label">No</label>
                                        </div>
                                    </div>
                                </InputRadioGroup>

                            </div>
                            <div class="col-md-6">

                                <InputRadioGroup @bind-Value="tenant.RenewalOffer">
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">Renewal Offer</label>

                                        <div class="form-check me-2 ">
                                            <InputRadio class="form-check-input" Value="true" />
                                            <label class="form-check-label">Yes</label>
                                        </div>

                                        <div class="form-check">
                                            <InputRadio class="form-check-input" Value="false" />
                                            <label class="form-check-label">No</label>
                                        </div>
                                    </div>
                                </InputRadioGroup>

                            </div>

                        </div>


                    </EditForm>
                }

                @if (!showTanentForm)
                {
                    <div style="max-height: 400px; overflow-y: auto; overflow-x: auto;">
                        <table class="table table-bordered mt-4" style="min-width: 1200px;">
                            <thead class="table-light">
                                <tr>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Unit/Apt</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>SSN</th>
                                    <th>Language</th>

                                    <th>Monthly Rent</th>
                                    <th>Tenant's Share</th>
                                    <th>ERAP Received</th>
                                    <th>ERAP Date</th>

                                </tr>
                            </thead>
                            <tbody>
                                @if (saveTanentList.Any())
                                {
                                    @foreach (var t in saveTanentList)
                                    {
                                        <tr>
                                            <td>@t.FirstName</td>
                                            <td>@t.LastName</td>
                                            <td>@t.UnitOrApartmentNumber</td>
                                            <td>@t.Email</td>
                                            <td>@t.Phone</td>
                                            <td>@t.SSN</td>
                                            <td>@t.LanguageName</td>

                                            <td>@t.MonthlyRent</td>
                                            <td>@t.TenantShare</td>
                                            <td>@(t.IsERAPPaymentReceived == true ? "Yes" : "No")</td>
                                            <td>@(t.ERAPPaymentReceivedDate?.ToString("dd-MM-yyyy"))</td>

                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="14" class="text-muted text-center">No tenants added yet.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        }


    </div>


    @if (!showLandlordForm && !showBuildingForm && !showTanentForm)
    {
        <div class="sticky-footer bg-white border-top p-3 d-flex justify-content-between gap-2">
            @if (!IsClientFormValid())
            {
                <div class="text-danger mt-2">
                    Please fill all required client fields to enable Submit.
                </div>
            }
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary px-4 fw-semibold" style="font-family:'Poppins';font-size:14px;" @onclick="CheckCancel">Cancel</button>

                @if (showCancelPopup)
                {
                    <div class="modal-backdrop fade show "></div>
                    <div class="modal fade show d-block" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Confirm Cancel</h5>
                                </div>
                                <div class="modal-body">
                                    <p>Do you want to cancel?</p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" @onclick="() => showCancelPopup = false">No</button>
                                    <button class="btn btn-navy" @onclick="ConfirmCancel">Yes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <button class="btn bg-navy text-white px-4 fw-semibold" style="font-size:14px; font-family:'Poppins'; background:#1F365D;"
                        disabled="@(!IsClientFormValid())"
                        @onclick="SubmitClientAsync">
                    Submit
                </button>
            </div>
        </div>
    }



</div>

@code {
    [Parameter] public EditToClientDto createClient { get; set; } = new();


    [Parameter]
    public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<CreateToClientDto> Submit { get; set; }

    private string activeTab = string.Empty;

    private bool showLandlordForm = false;
    private bool showBuildingForm = false;
    private bool showTanentForm = false;

    private EditToLandlordDto landlord = new();
    private EditToBuildingDto building = new();
    private EditToTenantDto tenant = new();

    private List<EditToLandlordDto> savelandlordList = new();
    private List<EditToTenantDto> saveTanentList = new();
    private List<EditToBuildingDto> apartmentList = new();

    private List<State> StatesList = new();
    private IEnumerable<City> CityList = new List<City>();
    private List<Registrationstatus> RegistrationstatusList = new();

    private List<TypeOfOwner> TypeOwnerList = new();
    private List<RegulationStatus> RegulationList = new();
    private IEnumerable<ExemptionBasic> ExemptionBasicList = new List<ExemptionBasic>();
    private IEnumerable<ExemptionReason> ExemptionReasonList = new List<ExemptionReason>();
    private IEnumerable<TenancyTypeForBuilding> TenancyTypeForBuildingList = new List<TenancyTypeForBuilding>();
    private List<PremiseType> premiseTypesList = new();
    private List<Language> LangList = new();
    private List<LandlordType> LandLordTypeList = new();
    private List<TenancyType> TenancyTypeList = new();
    private List<IsUnitIllegal> IsUnitIllegalList = new();
    private List<DateRent> DateRentList = new();
    private List<ClientRole> ClientTypeList = new();
    private string LatestLandLordCode = "";
    private string LatestBuildingCode = "";
    private string LatestTenantCode = "";
    private Stack<string> tabHistory = new();

    private bool shouldAddNewOccupant = false;



    private bool showCancelPopup = false;
    private EditContext _editContextBuilding;
    private ValidationMessageStore messageStoreBuilding;

    protected override async Task OnInitializedAsync()
    {
        _editContextBuilding = new EditContext(building);
        messageStoreBuilding = new ValidationMessageStore(_editContextBuilding);
        if (createClient != null)
        {

            StatesList = await StateRepository.GetAllState();
            TypeOwnerList = await TypeOwnerRepository.GetAllOwner();
            RegulationList = await RegulationStatusRepository.GetAllRegulationStatus();
            premiseTypesList = await PremiseTypeRepository.GetAllPremiseType();
            DateRentList = await DateRentRepository.GetAllDateRent();
            ClientTypeList = await _clientRoleService.GetAllClientRole();
            LangList = await LanguageRepository.GetAllLanguage();
            LandLordTypeList = await LandlordTypeRepository.GetAllLandLordType();
            TenancyTypeList = await TenancyTypeRepository.GetAllTenancyType();
            IsUnitIllegalList = await UnitIllegalRepository.GetAllUnitIllegal();
            LatestLandLordCode = await _landlordService.GetLastLandLordCode();
            LatestBuildingCode = await _apartmentService.GetLastBuilding();
            LatestTenantCode = await _tenantService.GetLastTenantCode();
            CityList = await cityRepository.GetAllAsync();
            ExemptionBasicList = await ExemptionBasicRepository.GetAllAsync();
            ExemptionReasonList = await ExemptionReasonRepository.GetAllAsync();
            TenancyTypeForBuildingList = await TenancyTypeForBuildingRepository.GetAllAsync();


            if (!RegistrationstatusList.Any()) RegistrationstatusList = await CaseTypeRepository.GetAllRegistrationstatus();
        }
        landlord.StateId = StatesList.Where(e => e.Name.Contains("New York")).Select(e => e.Id).FirstOrDefault();
        building.StateId = StatesList.Where(e => e.Name.Contains("New York")).Select(e => e.Id).FirstOrDefault();
        building.GoodCause = true;
        occupants.Add(new AddtionalTenantDto());

    }

    private string? SelectedRegulationName =>
        RegulationList
            ?.FirstOrDefault(x => x.Id == building.RegulationStatusId)
            ?.Name;

    // bool ShowExemptionOther =>
    //    ExemptionBasicList.Any(r =>
    //        r.Id == building.ExemptionBasisId &&
    //        r.Name == "Other");

    private bool ShowExemptionBasic = false;

    private bool ShowExemptionOther = false;

    private bool ShowRentOther = false;
    string ColumnClass => ShowExemptionBasic || ShowRentOther ? "col-md-4" : "col-md-6";

    private async Task SelectedOwnerOccupied()
    {
        if (building.OwnerOccupied == true)
        {
            building.RegistrationStatusId = RegistrationstatusList.Where(e => e.Name.Equals("Registered")).FirstOrDefault().Id;
        }
    }
    private async Task OnBuildingChanged()
    {
        // if (Guid.TryParse(e.Value?.ToString(), out Guid buildingId))
        // {
        //tenant.BuildingId = buildingId;


        await LoadCompleteAddress((Guid)tenant.BuildingId!);

        StateHasChanged();
        // }
    }


    private async Task LoadCompleteAddress(Guid selectedId)
    {
        var building = apartmentList.Where(x => x.Id == selectedId).FirstOrDefault();

        if (building != null)
        {
            tenant.CompletedAddress = $"{building.Address1}, {building.Address2}, {building.CityName}, {building.StateName}, {building.Zipcode}";
        }
        else
        {
            tenant.CompletedAddress = string.Empty;
        }
    }
    private void Require<T>(Expression<Func<T>> accessor, string fieldName, string message)
    {
        var value = accessor.Compile().Invoke();
        var fieldIdentifier = new FieldIdentifier(building, fieldName);

        // Clear old message first
        messageStoreBuilding.Clear(fieldIdentifier);

        // Add message if invalid
        bool isEmpty = value == null ||
                       (value is string s && string.IsNullOrWhiteSpace(s)) ||
                       (value is Guid g && g == Guid.Empty);

        if (isEmpty)
        {
            messageStoreBuilding.Add(fieldIdentifier, message);
        }

        _editContextBuilding.NotifyValidationStateChanged();
    }


    private async Task<bool> ValidateCurrentStep()
    {
        messageStoreBuilding.Clear();

        if(activeTab == "building")
        {
            Require(() => building.MDRNumber, nameof(building.MDRNumber), "MDR is required");

            Require(() => building.Zipcode, nameof(building.Zipcode), "Zipcode is Required");
            Require(() => building.StateId, nameof(building.StateId), "Select state");
            Require(() => building.ManagingAgent, nameof(building.ManagingAgent), "Agent is Required");
            Require(() => building.CityId, nameof(building.CityId), "Select City");
            Require(() => building.BuildingUnits, nameof(building.BuildingUnits), "Units is required");
            Require(() => building.Address1, nameof(building.Address1), "Address is required");
            Require(() => building.RegulationStatusId, nameof(building.RegulationStatusId), "Select Rent Regulation");
            Require(() => building.RegistrationStatusId, nameof(building.RegistrationStatusId), "Select Registration Status");
            Require(() => building.PremiseTypeId, nameof(building.PremiseTypeId), "Select Building Type Status");
            if (ShowExemptionBasic)
            {
                Require(() => building.ExemptionBasisId, nameof(building.ExemptionBasisId), "Select Exception Basis");
            }
            if (ShowExemptionOther)
            {
                Require(() => building.ExemptionBasisother, nameof(building.ExemptionBasisother), "Other Exemption is required");
            }
            if (ShowRentOther)
            {
                Require(() => building.RentRegulationOther, nameof(building.RentRegulationOther), "Other Regulation is required");
            }
            if (building.GoodCause != true)
            {
                Require(() => building.ExemptionreasonId, nameof(building.ExemptionreasonId), "Select Exemption");
            }
        }

        // Notify UI about validation changes
        _editContextBuilding.NotifyValidationStateChanged();

        // Get current validation messages (optional: for logging)
        var errors = _editContextBuilding.GetValidationMessages().ToList();

        // Check if form is valid
        bool isValid = !_editContextBuilding.GetValidationMessages().Any();

        // Return validity
        return isValid;

    }
    private async Task BindRentRegulation()
    {
        if (RegulationList.Any(r => r.Id == building.RegulationStatusId && r.Name == "Exempt"))
        {
            ShowExemptionBasic = true;
            ShowRentOther = false;

            messageStoreBuilding.Clear(() => building.RentRegulationOther);
        }
        else if (RegulationList.Any(r => r.Id == building.RegulationStatusId && r.Name == "Other"))
        {
            ShowRentOther = true;
        }
        else
        {
            building.RentRegulationOther = null;
            building.ExemptionBasisother = null;
            building.ExemptionBasisId = null;
            ShowExemptionBasic = false;
            ShowRentOther = false;
            ShowExemptionOther = false;
            messageStoreBuilding.Clear(() => building.RentRegulationOther);
            messageStoreBuilding.Clear(() => building.ExemptionBasisother);

        }

        await ValidateParticularInput(() => building.RegulationStatusId, nameof(building.RegulationStatusId), "Select Rent Regulation");
    }
    private async Task BindExemptionBasis()
    {
        if (ExemptionBasicList.Any(r => r.Id == building.ExemptionBasisId && r.Name == "Other") && ShowExemptionBasic)
        {
            ShowExemptionOther = true;
        }
        else
        {
            building.ExemptionBasisother = null;
            ShowExemptionOther = false;
            messageStoreBuilding.Clear(() => building.ExemptionBasisother);
        }
        await ValidateParticularInput(() => building.ExemptionBasisId, nameof(building.ExemptionBasisId), "Select Exemption Basis");
    }
    private async Task BindGoodCause()
    {
        if (building.GoodCause == true)
        {
            building.ExemptionreasonId = null;
            messageStoreBuilding.Clear(() => building.ExemptionreasonId);
        }

    }
    private Task ValidateParticularInput<T>(Expression<Func<T>> accessor, string fieldName, string validationMsg)
    {
        Require(accessor, fieldName, validationMsg);
        _editContextBuilding.NotifyValidationStateChanged();
        return Task.CompletedTask;
    }


    private async Task SaveBuildingAsync()
    {
        if (!await ValidateCurrentStep()) return;
        if (building.Id == Guid.Empty)
        {
            building.Id = Guid.NewGuid();
        }

        building.PremiseTypeName = premiseTypesList
           .FirstOrDefault(x => x.Id == building.PremiseTypeId)?.Name ?? "";

        building.StateName = StatesList
            .FirstOrDefault(x => x.Id == building.StateId)?.Name ?? "";

        building.RegulationStatusName = RegulationList
       .FirstOrDefault(x => x.Id == building.RegulationStatusId)?.Name ?? "";

        building.ExemptionBasisName = ExemptionBasicList
       .FirstOrDefault(x => x.Id == building.ExemptionBasisId)?.Name ?? "";

        building.ExemptionReasonName = ExemptionReasonList
       .FirstOrDefault(x => x.Id == building.ExemptionreasonId)?.Name ?? "";

        building.TenancyTypeForBuildingName = TenancyTypeForBuildingList
       .FirstOrDefault(x => x.Id == building.TenancyTypeForBuildingId)?.Name ?? "";

        building.RegistrationStatusName = RegistrationstatusList
    .FirstOrDefault(x => x.Id == building.RegistrationStatusId)?.Name ?? "";

        int nextNumber = 0;
        if (LatestBuildingCode != null)
        {
            nextNumber = int.Parse(LatestBuildingCode[2..]) + 1;

        }
        else
        {
            nextNumber = 1;
        }
        LatestBuildingCode = $"BB{nextNumber.ToString().PadLeft(10, '0')}";

        building.BuildingCode = LatestBuildingCode;


        apartmentList.Add(building);
        building = new();
        building.GoodCause = true;
        building.StateId = StatesList.Where(e => e.Name.Contains("New York")).Select(e => e.Id).FirstOrDefault();
        showBuildingForm = false;
        // return await Task.CompletedTask;
    }


    private Task SaveTenantAsync()
    {
        if (tenant.Id == Guid.Empty)
        {
            tenant.Id = Guid.NewGuid();
        }

        tenant.LanguageName = LangList
            .FirstOrDefault(x => x.Id == tenant.LanguageId)?.Name ?? "";

        tenant.TenancyTypeName = TenancyTypeList
      .FirstOrDefault(x => x.Id == tenant.TenancyTypeId)?.Name ?? "";

        tenant.IsUnitIllegalName = IsUnitIllegalList
    .FirstOrDefault(x => x.Id == tenant.IsUnitIllegalId)?.Name ?? "";
        int nextNumber = 0;
        if (LatestTenantCode != null)
        {
            nextNumber = int.Parse(LatestTenantCode[2..]) + 1;

        }
        else
        {
            nextNumber = 1;
        }
        LatestTenantCode = $"TT{nextNumber.ToString().PadLeft(10, '0')}";

        tenant.TenantCode = LatestTenantCode;
        tenant.AdditioalTenants = occupants
     .Where(x => x.IsVisible && !string.IsNullOrWhiteSpace(x.FirstName))
     .ToList();


        saveTanentList.Add(tenant);

        tenant = new();
        showTanentForm = false;
        return Task.CompletedTask;
    }

    private List<AddtionalTenantDto> occupants = new()
    {
        new AddtionalTenantDto()
    };

    private void AddTenant(AddtionalTenantDto current)
    {
        if (!current.IsVisible)
        {
            current.IsVisible = true; // inputs dikhao
            occupants.Add(new AddtionalTenantDto()); // fresh row add karo
        }
    }

    private void RemoveTenant(AddtionalTenantDto current)
    {
        if (occupants.Contains(current))
        {
            occupants.Remove(current);
        }

        // agar sab rows remove ho gayi ho to ek fresh + row add karo
        if (!occupants.Any())
        {
            occupants.Add(new AddtionalTenantDto());
        }
    }


    private void BackToLandlordList()
    {
        showLandlordForm = false;
        landlord = new();
    }
    private void FormatPhone(ChangeEventArgs e, string target)
    {
        var phoneValue = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(phoneValue))
            return;

        var formattedPhone = ApplyMask(phoneValue);

        switch (target)
        {
            case "createClient":
                createClient.Phone = formattedPhone;
                break;
            case "landlord":
                landlord.Phone = formattedPhone;
                break;
            case "tenant":
                tenant.Phone = formattedPhone;
                break;
        }
    }

    private void FormatCellPhone(ChangeEventArgs e)
    {
        createClient.CellPhone = ApplyMask(e.Value?.ToString());
    }

    private void FormatFax(ChangeEventArgs e)
    {
        createClient.Fax = ApplyMask(e.Value?.ToString());
    }

    private string ApplyMask(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return string.Empty;

        // Sirf digits rakho
        var digits = new string(input.Where(char.IsDigit).ToArray());

        // Max 10 digits lo
        if (digits.Length > 10)
            digits = digits.Substring(0, 10);

        if (digits.Length <= 3)
            return digits;
        else if (digits.Length <= 6)
            return $"{digits.Substring(0, 3)}-{digits.Substring(3)}";
        else
            return $"{digits.Substring(0, 3)}-{digits.Substring(3, 3)}-{digits.Substring(6)}";
    }


    private void BackToBuildingList()
    {
        showBuildingForm = false;
        building = new();
    }
    private void BackToTenantList()
    {
        showTanentForm = false;
        tenant = new();
    }

    private bool IsClientFormValid()
    {
        return
            !string.IsNullOrWhiteSpace(createClient.FirstName) &&
            !string.IsNullOrWhiteSpace(createClient.Email)
             &&
            (createClient.ClientTypeId != null && createClient.ClientTypeId != Guid.Empty);
    }

    private void CheckCancel()
    {
        // Agar koi bhi field filled hai to modal dikhao
        if (!string.IsNullOrWhiteSpace(createClient.FirstName) ||
            !string.IsNullOrWhiteSpace(createClient.LastName) ||
            !string.IsNullOrWhiteSpace(createClient.Email) ||
            !string.IsNullOrWhiteSpace(createClient.Phone) ||
            !string.IsNullOrWhiteSpace(createClient.CellPhone) ||
            !string.IsNullOrWhiteSpace(createClient.Fax) ||
            !string.IsNullOrWhiteSpace(createClient.Address1) ||
            !string.IsNullOrWhiteSpace(createClient.Address2) ||
            !string.IsNullOrWhiteSpace(createClient.City) ||
            !string.IsNullOrWhiteSpace(createClient.ZipCode))
        {
            showCancelPopup = true;
        }
        else
        {

            createClient = new EditToClientDto();
        }
    }

    private void ConfirmCancel()
    {
        HideAsync();

        // Popup close
        showCancelPopup = false;

        StateHasChanged();
    }

    public async Task HideAsync()
    {

        if (createClient != null)
        {
            createClient.FirstName = "";
            createClient.Email = "";
        }
        activeTab = string.Empty;
        showLandlordForm = false;
        showBuildingForm = false;
        showTanentForm = false;
        await OnClose.InvokeAsync();
        StateHasChanged();
    }


    private async Task SetActiveTab(string tab)
    {
        // Step 1: Client tab complete hona chahiye for Landlord
        if (tab == "landlord")
        {
            if (createClient == null || string.IsNullOrWhiteSpace(createClient.FirstName) || string.IsNullOrWhiteSpace(createClient.Email))
            {
                await JS.InvokeVoidAsync("alert", "Please complete the Client form before moving to Landlord.");
                return;
            }
        }

        // Step 2: Landlord list me at least 1 item hona chahiye for Building
        if (tab == "building")
        {
            if (savelandlordList == null || !savelandlordList.Any())
            {
                await JS.InvokeVoidAsync("alert", "Please add and save at least one Landlord before moving to Building.");
                return;
            }
        }

        // Step 3: Building form filled hona chahiye before Tenant
        if (tab == "tanent")
        {
            if (apartmentList == null || !apartmentList.Any())
            {
                await JS.InvokeVoidAsync("alert", "Please complete and save Building details before moving to Tenant.");
                return;
            }
        }
        if (!string.IsNullOrEmpty(activeTab))
        {
            tabHistory.Push(activeTab);
        }
        // All checks passed: change tab
        activeTab = tab;
    }

    private void BackToPreviousTab()
    {
        if (tabHistory.Count > 0)
        {
            activeTab = tabHistory.Pop();

            showLandlordForm = false;
            showBuildingForm = false;
            showTanentForm = false;

            // Reset forms if needed
            if (activeTab == "landlord") showLandlordForm = false;
            else if (activeTab == "building") showBuildingForm = false;
            else if (activeTab == "tanent") showTanentForm = false;
        }
        else
        {
            activeTab = string.Empty;
        }

        StateHasChanged();
    }

    private void ToggleLandlordForm() => showLandlordForm = !showLandlordForm;

    private void ToggleBuildingForm() => showBuildingForm = !showBuildingForm;
    private void ToggleTanentForm() => showTanentForm = !showTanentForm;

    private string GetToggleButtonText() => (activeTab == "landlord" && showLandlordForm) || (activeTab == "building" && showBuildingForm) || (activeTab == "tanent" && showTanentForm)
        ? "Cancel"
        : "Add New";

    private Task SaveLandlordAsync()
    {

        if (landlord.Id == Guid.Empty)
        {
            landlord.Id = Guid.NewGuid();
        }
        landlord.TypeOwnerName = TypeOwnerList
       .FirstOrDefault(x => x.Id == landlord.TypeOwnerId)?.Name ?? "";

        landlord.StateName = StatesList
            .FirstOrDefault(x => x.Id == landlord.StateId)?.Name ?? "";
        landlord.LandlordTypeName = LandLordTypeList
            .FirstOrDefault(x => x.Id == landlord.LandlordTypeId)?.Name ?? "";

        int nextNumber = 0;
        if (LatestTenantCode != null)
        {
            nextNumber = int.Parse(LatestLandLordCode[2..]) + 1;

        }
        else
        {
            nextNumber = 1;
        }

        LatestLandLordCode = $"LL{nextNumber.ToString().PadLeft(10, '0')}";

        landlord.LandLordCode = LatestLandLordCode;
        savelandlordList.Add(landlord);

        landlord = new();
        landlord.StateId = StatesList.Where(e => e.Name.Contains("New York")).Select(e => e.Id).FirstOrDefault();
        showLandlordForm = false;
        return Task.CompletedTask;
    }



    private Guid? userId;



    private async Task SubmitClientAsync()
    {
        spinnerservice.Show();
        if (createClient == null)
            return;


        var authState = await _authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var userIdClaim = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;

        if (!string.IsNullOrEmpty(userIdClaim) && Guid.TryParse(userIdClaim, out Guid userGuid))
        {
            createClient.CreatedBy = userGuid;
        }
        else
        {
            // unauthenticated user
            createClient.CreatedBy = Guid.Empty;
        }


        // Assign LandLords to Client
        createClient.editLandLords = savelandlordList;

        foreach (var landlord in createClient.editLandLords)
        {
            // Assign Buildings to each LandLord
            landlord.editBuildings = apartmentList
                .Where(b => b.LandlordId == landlord.Id)
                .ToList();

            foreach (var building in landlord.editBuildings)
            {
                // Assign Tenants to each Building
                building.editTenants = saveTanentList
                    .Where(t => t.BuildingId == building.Id)
                    .ToList();
            }
        }

        // Save the full nested object
        var isSaved = await _clientService.Create(createClient);
        if (isSaved)
        {
            Navigation.NavigateTo("/clients?success=true", true);
        }
        spinnerservice.Hide();
    }
}
