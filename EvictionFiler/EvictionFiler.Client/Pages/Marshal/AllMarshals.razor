@page "/marshals"
@using EvictionFiler.Application.DTOs.MarshalsDto
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Client.SpinnerService
@inject SpinnerService spinnerservice
@inject IMarshalService _marshalService

<PageTitle>Marshals - Housing Court Filer</PageTitle>
<!-- Bootstrap CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />


<style>

    .container {
        border: solid 1px #F2F0EC;
        box-shadow: 0 15px 20px #F2F0EC !important;
        max-width:100%;
    }

    .btn-primary {
        background-color: #1F365D;
        border-color: #1F365D;
    }

        .btn-primary:hover {
            background-color: #162646;
            border-color: #162646;
        }

    table.table thead th {
        color: #1F365D;
        background: #F2F0EC;
        margin-bottom: 0px !important;
    }

    h5, p, small {
        color: #1F365D;
    }

    .table-responsive {
        overflow-x: auto; /* Enable horizontal scroll */
        position: relative;
    }

    table th, table td {
        white-space: nowrap;
    }

    th.sticky, td.sticky {
        position: sticky;
        right: 0;
        background: #F2F0EC; /* Same as container background */
        z-index: 2;
        text-align: center;
    }


    th.sticky {
        z-index: 3;
    }

    .search-box {
        width: 100%;
        padding-right: 3rem; /* space for the button */
        padding-left: 1rem;
        /* border-radius: 1.5rem; */
        border: 2px solid #1F365D;
        background-color: #FFF; /* dark background */
        color: black;
        height: 2.5rem;
    }

        .search-box::placeholder {
            color: darkgrey;
        }

        .search-box:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
            background: #c6d1e3;
        }

    .search-btn {
        position: absolute;
        right: 0.7rem;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: none;
        color: #1F365D;
        cursor: pointer;
        padding: 0;
        font-size: 1.2rem;
    }

        .search-btn:hover {
            color: #1F365D;
        }

    .page-link {
        color: #1F365D;
    }

        .page-link.active,
        .page-item.active .page-link {
            background-color: #1F365D;
            border-color: #1F365D;
            color: #F2F0EC;
        }
</style>


<div class="p-4">

    <div class="container p-4 rounded shadow-sm">

        <!-- Title Row -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0">Manage Marshal</h5>
        </div>
        <!-- Search Filters -->
        <div class="g-2 mb-3 d-flex justify-content-between align-items-center">

            <!-- Four default search boxes -->
            <button class="btn btn-primary" @onclick="AddMarshals">Add New</button>
            <div class="position-relative w-50">
                <input class="form-control border border-primary text-navy" placeholder="Search.." />
                <button class="search-btn" type="button">
                    <i class="fa fa-search"></i>
                </button>
            </div>
        </div>

        <div class="table-responsive mb-3">
            <table class="table table-hover align-middle text-center" style="margin-bottom: 0px;">
                <thead>
                    <tr>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Telephone</th>
                        <th>Fax</th>
                        <th>Badge Number</th>
                        <th>Office Address</th>
                        <th class="sticky">Action</th>
                    </tr>
                </thead>
                <tbody>

                    @if (allMarshals == null || !allMarshals.Any())
                    {
                        <tr>
                            <td colspan="6"> No records found.</td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var m in FilteredMarshals)
                        {
                            <tr>
                                <td>@m.FirstName</td>
                                <td>@m.LastName</td>
                                <td>@m.Email</td>
                                <td>@m.Telephone</td>
                                <td>@m.Fax</td>
                                <td>@m.BadgeNumber</td>
                                <td>@m.OfficeAddress</td>
                                <td class="sticky">
                                    <i class="fa-solid fa-pen-to-square"
                                       @onclick="() => ShowEdit(m)"
                                       style="cursor: pointer; margin-right: 10px;"
                                       title="Edit">
                                    </i>

                                    <i class="fa-solid fa-trash-can text-danger "
                                       @onclick="() => Delete(m.Id)"
                                       style="cursor: pointer; color: red;"
                                       title="Delete">
                                    </i>

                                    <span class="status-active ms-2">Active</span>
                                </td>

                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
        <!-- Pagination -->
        <div class="d-flex justify-content-between mt-3">
            <small>Showing 1 to 10 of 11 entries</small>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item disabled"><a class="page-link" href="#">←</a></li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">→</a></li>
                </ul>
            </nav>
        </div>
    </div>
</div>
<CreateMarshal @ref="createMarshalRef" Submit="Handle" />
<EditMarshal @ref=" editMarshalRef" Submit="HandleEdit" />

@code {

    private string searchTerm = string.Empty;
    private IEnumerable<MarshalDto> allMarshals = new List<MarshalDto>();

    private CancellationTokenSource _cts;
    private CreateMarshal createMarshalRef;
    private EditMarshal editMarshalRef;

    private async Task GetAllMarshal()
    {
        allMarshals = await _marshalService.GetAllMarshalAsync() ?? new List<MarshalDto>();
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        spinnerservice.Show();
        await GetAllMarshal();
        StateHasChanged();
        await Task.Delay(1000);
        spinnerservice.Hide();

    }

    private async Task AddMarshals()
    {
        //var modal = new MarshalDto();
        await createMarshalRef.ShowAsync();

        //var allMarshal = _marshalService.GetAllMarshalAsync();
    }

    public async Task Handle(MarshalDto dto)
    {
        _cts?.Cancel(); // cancel previous call
        _cts = new CancellationTokenSource();
        var token = _cts.Token;
        await Task.Delay(1000, token);
        //createUserRef.Hide();
        //allMarshals = await _marshalService.GetAllMarshalAsync();
        await GetAllMarshal();
        StateHasChanged();

    }
    private async Task ShowEdit(MarshalDto dto)
    {
        await editMarshalRef.ShowAsync(dto);
    }

    private async Task Delete(Guid id)
    {
        spinnerservice.Show();
        bool isDeleted = await _marshalService.DeleteMarshalAsync(id);
        if(isDeleted)
        {
            await GetAllMarshal();
        }
        else
        {

        }
        spinnerservice.Hide();


    }

    public async Task HandleEdit(MarshalDto dto)
    {
        await GetAllMarshal();
        StateHasChanged();
    }

    private IEnumerable<MarshalDto> FilteredMarshals => allMarshals.Where(m =>
     string.IsNullOrWhiteSpace(searchTerm)
        || (m.FirstName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
        || (m.Telephone?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
        || (m.OfficeAddress?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
        || (m.Fax?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
    );

}
