@using Blazored.Toast.Services
@using EvictionFiler.Application.DTOs
@using EvictionFiler.Application.DTOs.ApartmentDto
@using EvictionFiler.Application.DTOs.CaseHearing
@using EvictionFiler.Application.DTOs.ClientDto
@using EvictionFiler.Application.DTOs.CourtDto
@using EvictionFiler.Application.DTOs.FormTypeDto
@using EvictionFiler.Application.DTOs.LandLordDto
@using EvictionFiler.Application.DTOs.MarshalsDto
@using EvictionFiler.Application.DTOs.OccupantDto
@using EvictionFiler.Application.DTOs.TenantDto
@using EvictionFiler.Application.Interfaces.IRepository
@using EvictionFiler.Application.Interfaces.IRepository.MasterRepository
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Application.Services
@using EvictionFiler.Client.SpinnerService
@using EvictionFiler.Domain.Entities
@using EvictionFiler.Domain.Entities.Master
@inject ICaseFormRepository CaseFormRepository
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization;
@inject ICaseFormService _CaseFormService
@using System.Security.Claims
@inject IToastService ToastService
@inject ILegalCaseService _service
@inject AuthenticationStateProvider _authStateProvider

@inject IFormTypesRepository FormTypesRepository
@* @using EvictionFiler.Client.Jwt *@

@inject SpinnerService spinnerservice

@inject IClientService _clientService
@inject IClientRoleRepository _clientRoleService
@inject ILandlordSevice _landlordService
@inject IBuildingService _apartmentService
@inject ITenantService _tenantService
@inject IStateRepository StateRepository
@inject IPremiseTypeRepository PremiseTypeRepository
@inject ITypeOwnerRepository TypeOwnerRepository
@inject IRegulationStatusRepository RegulationStatusRepository
@inject ILanguageRepository LanguageRepository
@inject IUnitIllegalRepository UnitIllegalRepository
@inject ITenancyTypeRepository TenancyTypeRepository
@inject ILandlordTypeRepository LandlordTypeRepository
@inject IDateRentRepository DateRentRepository
@inject ICaseHearingService _caseHearingService
@inject IMarshalService _marshalService
@inject ILegalCaseService _caseService



@inject SpinnerService spinnerservice
@rendermode InteractiveAuto
@using System.Security.Claims
@inject AuthenticationStateProvider _authStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS

<style>
    :root {
        --bs-primary: #1F365D;
        --bs-warning: #D4A844;
        --bs-light: #F7F6F3;
    }

    body {
        background-color: var(--bs-light);
    }

    .offcanvas.show {
        transform: translateX(0%);
    }

    .offcanvas {
        transform: translateX(100%);
        width: 682px !important;
        transition: transform 1s ease-in-out;
    }

    .color-text {
        color: var(--bs-primary);
    }

    .form-control::placeholder {
        font-size: 0.9rem;
    }

    .input-group-text {
        background-color: var(--bs-light);
        color: var(--bs-primary);
        font-weight: 500;
    }

    .form-wrapper {
        transition: transform 0.5s ease, opacity 0.5s ease;
        will-change: transform, opacity;
    }

    /* .form-wrapper.hidden {
                            transform: translateX(-100%);
                            opacity: 0;
                            pointer-events: none;
                            } */

    .overlay-form {
        animation: slideIn 1.0s ease forwards;
        background-color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }

        to {
            opacity: 1;
            transform: translateX(0%);
        }
    }

    .form-wrapper.hidden {
        display: none !important;
    }

    .vertical-buttons button { /*  min-width: 100px; */
        text-align: center;
    }

    .vertical-tab-button {
        writing-mode: vertical-rl; /* vertical top-to-bottom */
        text-orientation: upright;
        background-color: #f0f2f5;
        color: #1F365D;
        font-weight: 700;
        font-size: 14px;
        border: none;
        padding: 12px 8px;
        border-radius: 10px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

        .vertical-tab-button:hover {
            background-color: #1F365D;
            color: white;
            transform: translateY(-2px);
        }

    .active-vertical {
        background: linear-gradient(135deg, #1F365D, #2F4F7F);
        color: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .required-label::after {
        content: " *";
        color: red;
    }

    .btn-navy {
        background-color: #020336;
        color: white;
        border: none;
    }

    .drop-zone {
        border: 1px solid black;
        min-height: 100px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .drop-zone:hover {
            border: 1px solid Green;
        }

    .google-upload-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .google-upload-item {
        background: #fff;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        padding: 12px 14px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: box-shadow 0.2s ease;
    }

        .google-upload-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

    .file-info {
        display: flex;
        align-items: center;
        width: 100%;
    }

    .file-icon {
        font-size: 25px;
    }

    .file-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 89%;
        margin-top: 6px;
    }

    .file-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 3px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .progress-container {
        display: flex;
        align-items: center;
        width: 65%;
        border-radius: 3px;
        overflow: hidden;
        margin-right: 5px;
    }

    .progress-bar {
        border-radius: 3px;
        height: 6px;
        background: green;
        transition: width 0.2s ease-out;
    }

    .progress-text {
        font-size: 12px;
        color: #555;
    }

    .delete-btn {
        border: none;
        opacity: 0.5;
        transition: opacity 0.2s;
        margin-top: 5px;
    }

        .delete-btn:hover {
            opacity: 1;
        }

    .tab-content {
        padding: 20px 20px;
        /* border-bottom: 1px solid; */
    }

    .dropzonecontent {
        display: flex;
        justify-content: center;
    }

    .courthearing {
        align-items: center;
        justify-content: center;
        display: flex;
        height: 120px;
        border: 1px solid;
        border-radius: 7px;
    }
    /* wwwroot/css/site.css ya aapke CSS file me add karo */
    .blazored-toast-container { z-index: 20000 !important; /* Offcanvas se upar */ }
    .search-box { width: 100%; padding-right: 3rem; /* space for the button */ padding-left: 1rem; /* border-radius: 1.5rem; */ border: 2px solid #020336; background-color: #FFF; /* dark background */ color: black; height: 2.5rem; font-size: 14px; }

        .search-box::placeholder { color: darkgrey; }

        .search-box:focus { border: 2px solid #020336 !important; box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2); background: #F5F5F5; }
    .search-btn { position: absolute; right: 1.7rem; top: 50%; transform: translateY(-50%); border: none; background: none; color: #020336; cursor: pointer; padding: 0; font-size: 1.2rem; }

        .search-btn:hover { color: #1F365D; }
</style>
@using System.Collections.Generic


<div class="offcanvas offcanvas-end show border-start shadow bg-white"
     tabindex="-1" id="createClient"
     aria-labelledby="createUserLabel">

    <div class="offcanvas-header border-bottom">

        <h5 class="offcanvas-title fw-bold color-text" id="createUserLabel">Actions</h5>

        <button type="button" class="btn-close" @onclick="HideAsync" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body p-0">
        <div class="d-flex align-items-center position-relative">
            <!-- CLIENT FORM -->

            <div class="form-wrapper  flex-grow-1 p-3 ">
                <div class="row">

                    <ul class="nav nav-tabs" id="actionTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="notice-tab" data-bs-toggle="tab" data-bs-target="#notice" type="button" role="tab">Notices</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link " id="marshal-tab" data-bs-toggle="tab" data-bs-target="#marshal" type="button" role="tab" @onclick="OnMarshalTabOpen">Marshal</button>
                        </li>

                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="server-tab" data-bs-toggle="tab" data-bs-target="#server" type="button" role="tab">Process Server</button>
                        </li>

                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab"> Documents</button>
                        </li>

                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">Notes</button>
                        </li>

                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="hearing-tab" data-bs-toggle="tab" data-bs-target="#hearing" type="button" role="tab">Hearing</button>
                        </li>
                    </ul>

                    <div class="tab-content mb-3" id="actionTabsContent">

                        <div class="tab-pane fade show active" id="notice" role="tabpanel" aria-labelledby="notice-tab">
                            <!-- CONTENT for Send to Marshal -->
                            <div class="row mb-3">
                                <EditForm Model="createAction" FormName="NoticeForm" OnValidSubmit="GenerateNotice">
                                    <DataAnnotationsValidator />
                                    <div class="row g-2 align-items-end">
                                        <div class="col-12 col-md-6">
                                            <label for="formType" class="form-label">File a Motion</label>
                                            <select class="form-select" @bind="createAction.FormTypeId" @bind:after="FormTypeBindAfter">
                                                <option value="">-- Select Form Type --</option>
                                                @foreach (var formType in FilteredFormTypeList)
                                                {
                                                    <option value="@formType.Id">@formType.Name @(formType.Rate != null ? $"- (${formType.Rate}) " : "")</option>
                                                }
                                            </select>
                                            <ValidationMessage For="() => createAction.FormTypeId" />
                                        </div>
                                        <div class="col-auto">
                                            <div class=" input-group" style="width:140px">
                                                <span class="input-group-text">$</span>
                                                <input class="form-control" type="number" @bind="createAction.BillAmount">
                                            </div>
                                            <ValidationMessage For="() => createAction.BillAmount" />
                                        </div>
                                        <div class="col-auto">
                                            <button class="btn bg-brand-primary base">  @(isEditMode ? "Update" : "Generate")</button>
                                        </div>
                                    </div>

                                </EditForm>

                            </div>
                        </div>

                        <div class="tab-pane fade" id="marshal" role="tabpanel" aria-labelledby="marshal-tab">
                            <div class="row mb-3 d-flex align-items-center">

                                <div class="fw-semibold col-3">Assign Marshal</div>

                                <div class="col-6 position-relative" @onfocusout="HideMarshalDropDown">

                                    @if (!isMarshalAssigned)
                                    {
                                        <!-- Search Box -->
                                       
                                            <InputText class="form-control search-box" placeholder="Search by marshal name.." @bind-value="searchmarshalText" @oninput="OnSearchMarshalInput"
                                                       @onclick="ShowAllmarshal" />
                                            <button class="search-btn" type="button">
                                                <i class="fa fa-search"></i>
                                            </button>
                                      

                                    

                                        @if (filteredmarshal?.Any() == true)
                                        {
                                            <ul class="dropdown-menu show" style="position:absolute; width:94%; cursor:pointer;">
                                                @foreach (var c in filteredmarshal)
                                                {
                                                    <li class="dropdown-item" @onclick="() => Selectedmarshal(c)">
                                                        @c.FirstName  @c.LastName
                                                    </li>
                                                }
                                            </ul>
                                        }
                                        
                                    }
                                    else
                                    {
                                        <!-- Selected Marshal -->
                                        <label class="form-control bg-light fw-bold d-flex align-items-center">
                                            @(selectedmarshal != null ? selectedmarshal.FirstName + " " + selectedmarshal.LastName : "")
                                        </label>

                                    }

                                </div>

                                <div class="col-3">
                                    @if (!isMarshalAssigned)
                                    {
                                        <button class="btn bg-brand-primary base text-white" @onclick="SubmitMarshal">Save</button>
                                    
                                    }
                                    else
                                    {
                                      
                                        <button class="btn bg-brand-primary base text-white" @onclick="ResetMarshal">Reset</button>
                                    }
                                </div>

                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    @if (showMarshalError)
                                    {
                                        <div class="text-danger small mt-1">Please select a marshal.</div>
                                    }
                                </div>
                            </div>
                        </div>



                        <div class="tab-pane fade" id="server" role="tabpanel" aria-labelledby="server-tab">
                            <!-- CONTENT for Process Server -->
                            <div class="row mb-3">
                                <label class="form-label color-text col-auto" style="display:flex; align-items:center;">Process Server</label>
                                <div class="input-group mb-3 col">

                                    <InputText class="form-control col" style="border-right:none;" @bind-Value="MarshalName" placeholder="Search Process Server" />
                                    <span class="input-group-text" style="background:none;"><i class="fa-solid fa-magnifying-glass"></i></span>
                                </div>

                            </div>
                        </div>

                        <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                            <!-- CONTENT for Upload / View Documents -->
                            <InputFile @ref="fileInput" OnChange="OnInputChanged" multiple style="display:none" />

                            <div class="drop-zone"
                                 @ref="dropZoneRef"
                                 @onclick="OpenFileDialog">

                                <div class="row">
                                    <div class="dropzonecontent">Upload Documents</div>
                                    <div class="dropzonecontent">
                                        <span style="text-decoration:underline; cursor:pointer; color:#00a7ff; margin-right:5px;">Click</span>
                                        or drag & drop file(s) here
                                    </div>
                                    
                                </div>
                              

                            </div>
                            <div class="dropzonecontent" style="color:red; font-size:0.9rem; margin-top:5px;">
                                * Only PDF and DOC/DOCX files are allowed
                            </div>

                            @if (Files.Count > 0)
                            {
                                <ul class="google-upload-list mt-3">
                                    @foreach (var item in UploadItems)
                                    {
                                        <li class="google-upload-item">

                                            <div class="file-info">
                                                <div class="file-icon">📄</div>

                                                <div class="file-meta">
                                                    <div class="file-name">@item.File.Name</div>

                                                    <div class="d-flex" style="width:100px">
                                                        <div class="progress-container">
                                                            <div class="progress-bar" style="width:@item.Progress%"></div>
                                                        </div>

                                                        <div class="progress-text">@item.Progress%</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <button class="btn-close delete-btn"
                                                    @onclick="() => RemoveUploadItem(item)">
                                            </button>

                                        </li>
                                    }
                                </ul>
                            }


                            <div class="modal-footer mt-3" style="padding: 5px !important; border-top: none !important; ">
                                <button type="submit" class="btn btn-primary base" @onclick="SaveFiles">Upload</button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
                            <!-- CONTENT for Add Notes -->
                            <div class="modal-body mb-3">
                                @* <div class="card border-0">
                                    <div class="card-body p-0">

                                        <!-- Search + Add Section -->
                                        <!-- Add/Edit Fields -->

                                        <div class="border rounded-3 p-3 mb-3 position-relative">

                                            @*  <button type="button" class=" position-absolute top-0 end-0 m-2"
                                                        aria-label="Reset" style="cursor:pointer; background:none;"
                                                        @onclick="OnBindHearingCancel"> Reset
                                                </button> *

                                            <div class=" g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label required-label">Date </label>
                                                    <InputDate class="form-control" @bind-Value="caseHearing.HearingDate" placeholder="Select Date" />
                                                </div>

                                                <div class="col-md-6 mt-2 ">
                                                    <label class="form-label required-label">Time</label>
                                                    <input type="time" class="form-control" @bind="caseHearing.HearingTime" />
                                                </div>



                                            </div>
                                        </div>
                                    </div>
                                </div> *@
                                <InputTextArea style="height:200px" class="form-control" placeholder="Enter Notes" @bind-Value="legalcaseDto.Notes" />

                            </div>

                            <div class="modal-footer" style="padding: 5px !important; border-top: none !important;">
                                <button type="submit" class="btn btn-primary base" @onclick="SaveHearingChanges">Save</button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="hearing" role="tabpanel" aria-labelledby="hearing-tab">
                            <!-- CONTENT for Add Hearing -->
                            @if ((legalcaseDto.CourtLocationId == null || legalcaseDto.CourtLocationId == Guid.Empty) && !CaseForms.Any())
                            {
                            <div class="modal-body mb-3 courthearing">
                                <ul>
                                    <li>Please Generate Form before Adding Case Hearing</li>
                                    <li>Please Add Court Details before Adding Case Hearing</li>
                                </ul>
                            </div>
                            }
                            else if (!CaseForms.Any())
                            {
                                <div class="modal-body mb-3 courthearing">

                                    <ul>
                                        <li>
                                            Please Generate Form before Adding Case Hearing
                                        </li>
                                    </ul>

                                </div>
                            }
                            else if (legalcaseDto.CourtLocationId == null || legalcaseDto.CourtLocationId == Guid.Empty)
                            {
                                <div class="modal-body mb-3 courthearing">

                                    <ul>
                                        <li>
                                            Please Add Court Details before Adding Case Hearing
                                        </li>
                                    </ul>

                                </div>
                            }
                            
                            else
                            {
                                <EditForm Model="@caseHearing">
                                    <DataAnnotationsValidator />
                                    <div class="modal-body">

                                        <div class="card border-0">
                                            <div class="card-body p-0">

                                                <!-- Search + Add Section -->
                                                <!-- Add/Edit Fields -->

                                                <div class="border rounded-3 p-3 mb-3 position-relative">

                                                    @*  <button type="button" class=" position-absolute top-0 end-0 m-2"
                                                        aria-label="Reset" style="cursor:pointer; background:none;"
                                                        @onclick="OnBindHearingCancel"> Reset
                                                </button> *@

                                                    <div class=" g-3">
                                                        <div class="col-md-6">
                                                            <label class="form-label required-label">Date </label>
                                                            <InputDate class="form-control" @bind-Value="caseHearing.HearingDate" placeholder="Select Date" />
                                                        </div>

                                                        <div class="col-md-6 mt-2 ">
                                                            <label class="form-label required-label">Time</label>
                                                            <input type="time" class="form-control" @bind="caseHearing.HearingTime" />
                                                        </div>



                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                                        <button type="button" class="btn btn-secondary me-2" @onclick="OnBindHearingCancel">Reset</button>
                                        <button type="submit" class="btn btn-primary base" @onclick="SaveHearingChanges">Save</button>
                                    </div>
                                </EditForm>
                            }


                        </div>
                    </div>
                    

                </div>




            </div>


        </div>

    </div>





</div>
<script>
    window.fileupload = {
        triggerInput: function (element) {
            element.click();
        },

         registerDropHandler: function (dropZoneElement, inputElement) {

        dropZoneElement.addEventListener("drop", function (event) {
            event.preventDefault();

            const dt = new DataTransfer();
            for (let i = 0; i < event.dataTransfer.files.length; i++) {
                dt.items.add(event.dataTransfer.files[i]);
            }

            inputElement.files = dt.files;
            inputElement.dispatchEvent(new Event("change"));
        });

        dropZoneElement.addEventListener("dragover", function (event) {
            event.preventDefault();
        });
    }
    };
</script>


@code {
    [Parameter] public GenrateNoticeModel createAction { get; set; } = new();
    public Guid caseId { get; set; }
    private List<FormAddEditViewModelDto> FilteredFormTypeList = new();
    [Parameter] public IntakeModel legalcaseDto { get; set; } = new();
    [Parameter] public List<GenrateNoticeModel> CaseForms { get; set; } = new();
    [Parameter] public EventCallback OnFormCreate { get; set; } = new();
    private string? loggedInUserId;
    private string? MarshalName;
    private bool isAdmin = false;
    private bool isEditMode = false;
    private MarshalDto selectedmarshal;
    private string searchmarshalText;
    private bool isMarshalAssigned = false;
    private List<MarshalDto> filteredmarshal= new();
    private GenrateNoticeModel caseForm = new();
    private List<CaseHearingDto> CaseHearings = new();
    private CaseHearingDto CaseHearing = new();
    private List<GenrateNoticeModel> caseFormDto = new();
    [Parameter] public Guid? CurrentCaseId { get; set; }
    private CancellationTokenSource _cts;
    private bool showMarshalError = false;


    [Parameter]
    public EventCallback OnClose { get; set; }
    // [Parameter] public EventCallback<CreateToClientDto> Submit { get; set; }
    public CaseHearingDto caseHearing = new CaseHearingDto();
    public class UploadItem
    {
        public IBrowserFile File { get; set; }
        public int Progress { get; set; } = 0;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await _authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            loggedInUserId = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
            isAdmin = user.Claims.Any(c => c.Type == ClaimTypes.Role && c.Value == "Admin");
        }
        FilteredFormTypeList = await FormTypesRepository.GetFormTypesByCaseTypeAsync(legalcaseDto.CaseTypeId);
      
        caseHearing = new CaseHearingDto();
        caseHearing.HearingDate = DateTime.Now;
        caseHearing.HearingTime = TimeOnly.FromTimeSpan(TimeSpan.FromHours(10));

        spinnerservice.Hide();
    }

    private async Task OnMarshalTabOpen()
    {

        await LoadMarshalUI();

        StateHasChanged();
    }

    private async Task LoadMarshalUI()
    {
        if (legalcaseDto.MarshalId != null && legalcaseDto.MarshalId != Guid.Empty)
        {
            selectedmarshal = await _marshalService.GetMarshalByIdAsync(legalcaseDto.MarshalId.Value);
            isMarshalAssigned = true;
        }
        else
        {
            isMarshalAssigned = false;
            selectedmarshal = null;
            searchmarshalText = string.Empty;
        }
    }

    async Task HideMarshalDropDown(FocusEventArgs e)
    {
        // Small delay to allow click on dropdown item to register before hiding
        await Task.Delay(500);
        if (filteredmarshal.Any())
        {
            filteredmarshal.Clear();

        }
        StateHasChanged();
    }

    private async void Selectedmarshal(MarshalDto marshal)
    {

        selectedmarshal = marshal;
        // searchmarshalText = marshal.Name!;
        searchmarshalText = $"{marshal.FirstName} {marshal.LastName}";


        legalcaseDto.MarshalId = marshal.Id;


        filteredmarshal?.Clear();
        // isMarshalAssigned = true;

        StateHasChanged();


    }

    private void ResetMarshal()
    {
        spinnerservice.Show();
        isMarshalAssigned = false;
        selectedmarshal = null;
        legalcaseDto.MarshalId = null;     // Marshal unassign
        searchmarshalText = "";            // Clear search box
        filteredmarshal?.Clear(); 
        showMarshalError = false;// Clear list

        StateHasChanged();
        spinnerservice.Hide();
    }


    private async Task OnSearchMarshalInput(ChangeEventArgs e)
    {
        searchmarshalText = e.Value?.ToString() ?? "";
        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        try
        {

            await Task.Delay(300, _cts.Token);
            // ⭐ Empty input → load all tenants (ONLY here)
            if (string.IsNullOrWhiteSpace(searchmarshalText))
            {
                await ShowAllmarshal();
                return;
            }

            // ⭐ 1st & 2nd character → DO NOTHING (keep list unchanged)
            if (searchmarshalText.Length < 3)
            {
                // ❗ No reload here (important)
                return;
            }

            else
            {
                // ⭐ 3+ characters → server search

                filteredmarshal = await _marshalService.SearchMarshalbyname(searchmarshalText);
            }

        }
        catch (TaskCanceledException)
        {
            // Old task cancelled → ignore
        }

    }

    private async Task ShowAllmarshal()
    {
        filteredmarshal = (await _marshalService.GetAllMarshalAsync()).ToList();
        StateHasChanged(); // UI refresh karega
    }


    private async Task SubmitMarshal()
    {
        showMarshalError = false; // reset old errors

        if (legalcaseDto.MarshalId == null || legalcaseDto.MarshalId == Guid.Empty)
        {
            showMarshalError = true;
            StateHasChanged();
            return;
        }
        spinnerservice.Show();

        var result = await _service.UpdateMarshalAsync(legalcaseDto);

        if (result)
        {
            ToastService.ShowSuccess("Marshal Assign  successfully!");
            // await LoadCaseDetails();
             isMarshalAssigned = true;
        }
        else
        {
            ToastService.ShowError("Failed to asign Marshal .");
        }
        StateHasChanged();
        spinnerservice.Hide();
        
    }

    private List<UploadItem> UploadItems = new();

 
    private void OnBindHearingCancel()
    {
        caseHearing = new CaseHearingDto();
        caseHearing.HearingDate = DateTime.Now;
        caseHearing.HearingTime = TimeOnly.FromTimeSpan(TimeSpan.FromHours(10));
    }
    private async Task SaveHearingChanges()
    {
        spinnerservice.Show();

        var newHearing = new CaseHearingDto()
        {
            Caption = caseHearing.Caption,
            LegalCaseId = legalcaseDto.Id,
            CourtId = legalcaseDto.CourtLocationId,
            HearingDate = caseHearing.HearingDate,
            HearingTime = caseHearing.HearingTime,
            CreatedBy = Guid.Parse(loggedInUserId),
            // CallIn = caseHearing.CallIn,
            // Phone = caseHearing.Phone,
            // VirtualLink = caseHearing.VirtualLink,
            // Notes = caseHearing.Notes
        };

        var CourtId = await _caseHearingService.AddHearing(newHearing);

        if (CourtId)
        {
            ToastService.ShowSuccess("Hearing details Added successfully!");
            await OnFormCreate.InvokeAsync();
        }
        else
        {
            ToastService.ShowError("Failed to create Hearing details.");
        }
        LoadHearing();
        spinnerservice.Hide();
    }


    // private async Task SaveCaseNotes()
    // {
    //     spinnerservice.Show();

    //     var result = await _service.UpdateNotesAsync(legalcaseDto);

    //     if (result)
    //     {
    //         ToastService.ShowSuccess("Hearing details Added successfully!");
    //         // await LoadCaseDetails();
    //     }
    //     else
    //     {
    //         ToastService.ShowError("Failed to create Hearing details.");
    //     }
    //     StateHasChanged();
    //     spinnerservice.Hide();
    // }

    private ElementReference dropZoneRef;
    private InputFile? fileInput;
    private List<IBrowserFile> Files = new();
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("fileupload.registerDropHandler", dropZoneRef, fileInput!.Element);
        }
    }

    private async Task OpenFileDialog()
    {
        await JS!.InvokeVoidAsync("fileupload.triggerInput", fileInput!.Element);
    }

    private void OnDragOver(DragEventArgs e)
    {
        e.DataTransfer.DropEffect = "copy";
    }

    private async Task OnDrop(DragEventArgs e)
    {
        // send dropped files to <input type="file">
        await JS!.InvokeVoidAsync("fileupload.addDroppedFiles", fileInput!.Element);
    }
    private void OnInputChanged(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            var item = new UploadItem
            {
                File = file,
                Progress = 0
            };

            UploadItems.Add(item);
            Files.Add(file);

            // Simulate upload progress (replace with real API upload later)
            _ = SimulateProgressAsync(item);
        }
    }

    private async Task SimulateProgressAsync(UploadItem item)
    {
        while (item.Progress < 100)
        {
            item.Progress += 5;
            await Task.Delay(100);
            StateHasChanged();
        }
    }

    private void RemoveUploadItem(UploadItem item)
    {
        UploadItems.Remove(item);
        Files.Remove(item.File);
        StateHasChanged();
    }

    private async Task LoadHearing()
    {
        CaseHearings = await _caseHearingService.GetAllCaseHeariingByCaseIdAsync(CurrentCaseId.Value);
        if (CaseHearings.Any())
        {
            CaseHearing = CaseHearings.FirstOrDefault()!;
        }

    }
    private async Task GenerateNotice()
    {
        spinnerservice.Show();

        legalcaseDto.BillAmount = (legalcaseDto.BillAmount ?? 0) + (createAction.BillAmount ?? 0);

        var successcase = await _service.UpdateCaseAsync(legalcaseDto);
        if (!successcase.HasValue)
        {
            return;
        }
        else
        {
            createAction.BillAmount = null;
        }

        if (CurrentCaseId.HasValue && CurrentCaseId.Value != Guid.Empty && createAction.FormTypeId.HasValue)
        {
            bool success = false;

            if (isEditMode)
            {
                // UPDATE existing notice
                success = await _CaseFormService.UpdateCaseFormAsync(new GenrateNoticeModel
                {
                    Id = createAction.Id,
                    LegalCaseId = CurrentCaseId.Value,
                    FormTypeId = createAction.FormTypeId,
                    File = createAction.File,
                    HTML = createAction.HTML,
                    CreatedOn = createAction.CreatedOn
                });

                if (success)
                {
                    ToastService.ShowSuccess("Notice has been updated successfully!");
                }
            }
            else
            {
                // CREATE new notice
                success = await CaseFormRepository.GenerateNoticeAsync(
                    CurrentCaseId.Value,
                    createAction.FormTypeId.Value,
                       Guid.Parse(loggedInUserId)
                );

                if (success)
                {
                    ToastService.ShowSuccess("Notice has been generated successfully!");
                }
            }

            if (success)
            {
                await LoadCaseForms();

                // Reset form
                createAction = new GenrateNoticeModel();
                isEditMode = false;
                CurrentCaseId = caseId;
                await OnFormCreate.InvokeAsync();
                await JS.InvokeVoidAsync("openTab", "activity");
            }
        }
        else
        {

        }

        spinnerservice.Hide();
    }
    private readonly string[] AllowedExtensions = { ".pdf", ".doc", ".docx" };

    private async Task SaveFiles()
    {
        if (legalcaseDto.Id == null || legalcaseDto.Id == Guid.Empty)
        {
            ToastService.ShowError("Invalid Case ID.");
            Files.Clear();
            return;
        }

        if (!Files.Any())
        {
            ToastService.ShowWarning("Please select files to upload.");
            Files.Clear();
            return;
        }

        // Check allowed file types
        foreach (var file in Files)
        {
            var extension = Path.GetExtension(file.Name).ToLower();
            if (!AllowedExtensions.Contains(extension))
            {
                ToastService.ShowWarning($" Only PDF and DOC/DOCX are permitted.");
                Files.Clear();
                return; // stop uploading
            }
        }

        var uploadPath = Path.Combine(Environment.CurrentDirectory, "wwwroot", "uploads");
        if (!Directory.Exists(uploadPath))
            Directory.CreateDirectory(uploadPath);

        var DocList = new List<CaseDocument>();

        foreach (var file in Files)
        {
            var extension = Path.GetExtension(file.Name);
            var baseName = Path.GetFileNameWithoutExtension(file.Name);

            // Add DateTime stamp to filename
            var dateStamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            var newFileName = $"{baseName}_{dateStamp}{extension}";

            var physicalPath = Path.Combine(uploadPath, newFileName);

            // Save the file physically
            await using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 200);
            await using var fs = new FileStream(physicalPath, FileMode.Create);
            await stream.CopyToAsync(fs);

            // Save DB record
            var document = new CaseDocument
            {
                Id = Guid.NewGuid(),
                LegalCaseId = CurrentCaseId.Value,
                Name = newFileName,
                Path = $"uploads/{newFileName}",   // Relative path for web access
                CreatedOn = DateTime.Now
            };

            DocList.Add(document);
        }

        var result = await _service.AddDocumentAsync(DocList);
        if (result)
        {
            ToastService.ShowSuccess("Documents saved successfully!");
            Files.Clear();
            UploadItems.Clear();
            await OnFormCreate.InvokeAsync();
        }
        else
        {
            ToastService.ShowError("An error occurred during saving!");
        }
    }



    private async Task LoadCaseForms()
    {
        caseFormDto = await _CaseFormService.GetCaseFormsByCaseId(CurrentCaseId.Value, loggedInUserId, isAdmin);
        if (caseFormDto.Any())
        {
            caseForm = caseFormDto.FirstOrDefault()!;
        }
    }

    public async Task EditCaseDetail(Guid id)
    {
        spinnerservice.Show();
        var result = await _CaseFormService.GetCaseFormByIdAsync(id);

        if (result != null)
        {
            createAction = new GenrateNoticeModel
            {
                Id = result.Id,
                FormTypeId = result.FormTypeId,
                File = result.File,
                HTML = result.HTML,
                CreatedOn = result.CreatedOn,
            };
            isEditMode = true;

        }
        spinnerservice.Hide();
        await JS.InvokeVoidAsync("showBootstrapTab", "#actions-tab");
    }

    private void FormTypeBindAfter()
    {
        var selectedForm = FilteredFormTypeList
            .FirstOrDefault(f => f.Id == createAction.FormTypeId);

        if (selectedForm != null)
            createAction.BillAmount =Convert.ToDecimal(selectedForm.Rate);
        else
            createAction.BillAmount = null;

        StateHasChanged(); // ensure UI refreshes
    }

    public async Task HideAsync()
    {


        await OnClose.InvokeAsync();
        StateHasChanged();
    }

}
