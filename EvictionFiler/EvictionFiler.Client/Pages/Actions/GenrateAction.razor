@using Blazored.Toast.Services
@using EvictionFiler.Application.DTOs
@using EvictionFiler.Application.DTOs.ApartmentDto
@using EvictionFiler.Application.DTOs.ArrearLedgerDtos
@using EvictionFiler.Application.DTOs.CaseDocumentDtos
@using EvictionFiler.Application.DTOs.CaseHearing
@using EvictionFiler.Application.DTOs.CaseNoticeInfoDtos
@using EvictionFiler.Application.DTOs.ClientDto
@using EvictionFiler.Application.DTOs.CourtDto
@using EvictionFiler.Application.DTOs.FormTypeDto
@using EvictionFiler.Application.DTOs.LandLordDto
@using EvictionFiler.Application.DTOs.MarshalsDto
@using EvictionFiler.Application.DTOs.OccupantDto
@using EvictionFiler.Application.DTOs.TenantDto
@using EvictionFiler.Application.Interfaces.IRepository
@using EvictionFiler.Application.Interfaces.IRepository.MasterRepository
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Application.Services
@using EvictionFiler.Client.SpinnerService
@using EvictionFiler.Domain.Entities
@using EvictionFiler.Domain.Entities.Master
@inject ICaseFormRepository CaseFormRepository
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization;
@inject ICaseFormService _CaseFormService
@using System.Security.Claims
@inject IToastService ToastService
@inject ILegalCaseService _service
@inject AuthenticationStateProvider _authStateProvider

@inject IFormTypesRepository FormTypesRepository
@* @using EvictionFiler.Client.Jwt *@

@inject SpinnerService spinnerservice

@inject IClientService _clientService
@inject IClientRoleRepository _clientRoleService
@inject ILandlordSevice _landlordService
@inject IBuildingService _apartmentService
@inject ITenantService _tenantService
@inject IStateRepository StateRepository
@inject IPremiseTypeRepository PremiseTypeRepository
@inject ITypeOwnerRepository TypeOwnerRepository
@inject IRegulationStatusRepository RegulationStatusRepository
@inject ILanguageRepository LanguageRepository
@inject IUnitIllegalRepository UnitIllegalRepository
@inject ITenancyTypeRepository TenancyTypeRepository
@inject ILandlordTypeRepository LandlordTypeRepository
@inject IDateRentRepository DateRentRepository
@inject ICaseHearingService _caseHearingService
@inject IMarshalService _marshalService
@inject ILegalCaseService _caseService
@inject ICaseTypeRepository CaseTypeRepository
@inject IAppearanceTypeRepository appearanceTypeRepository
@inject ICourtService courtRepository
@inject IDocumentTypeRepository DocRepo



@inject SpinnerService spinnerservice
@rendermode InteractiveAuto
@using System.Security.Claims
@inject AuthenticationStateProvider _authStateProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS

<style>
    :root {
        --bs-primary: #1F365D;
        --bs-warning: #D4A844;
        --bs-light: #F7F6F3;
    }

    body {
        background-color: var(--bs-light);
    }

    .offcanvas.show {
        transform: translateX(0%);
    }

    .offcanvas {
        transform: translateX(100%);
        width: 65% !important;
        transition: transform 1s ease-in-out;
    }

    .color-text {
        color: var(--bs-primary);
    }

    .form-control::placeholder {
        font-size: 0.9rem;
    }

    .input-group-text {
        background-color: var(--bs-light);
        color: var(--bs-primary);
        font-weight: 500;
    }

    .form-wrapper {
        transition: transform 0.5s ease, opacity 0.5s ease;
        will-change: transform, opacity;
    }

    /* .form-wrapper.hidden {
                                                                                        transform: translateX(-100%);
                                                                                        opacity: 0;
                                                                                        pointer-events: none;
                                                                                        } */

    .overlay-form {
        animation: slideIn 1.0s ease forwards;
        background-color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }

        to {
            opacity: 1;
            transform: translateX(0%);
        }
    }

    .form-wrapper.hidden {
        display: none !important;
    }

    .vertical-buttons button { /*  min-width: 100px; */
        text-align: center;
    }

    .vertical-tab-button {
        writing-mode: vertical-rl; /* vertical top-to-bottom */
        text-orientation: upright;
        background-color: #f0f2f5;
        color: #1F365D;
        font-weight: 700;
        font-size: 14px;
        border: none;
        padding: 12px 8px;
        border-radius: 10px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

        .vertical-tab-button:hover {
            background-color: #1F365D;
            color: white;
            transform: translateY(-2px);
        }

    .active-vertical {
        background: linear-gradient(135deg, #1F365D, #2F4F7F);
        color: white;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .required-label::after {
        content: " *";
        color: red;
    }

    .btn-navy {
        background-color: #020336;
        color: white;
        border: none;
    }

    .drop-zone {
        border: 1px solid black;
        min-height: 100px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

        .drop-zone:hover {
            border: 1px solid Green;
        }

    .google-upload-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .google-upload-item {
        background: #fff;
        border: 1px solid #e3e3e3;
        border-radius: 8px;
        padding: 12px 14px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: box-shadow 0.2s ease;
    }

        .google-upload-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

    .file-info {
        display: flex;
        align-items: center;
        width: 100%;
    }

    .file-icon {
        font-size: 25px;
    }

    .file-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 89%;
        margin-top: 6px;
    }

    .file-name {
        font-weight: 500;
        font-size: 14px;
        margin-bottom: 3px;
        color: #333;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .progress-container {
        display: flex;
        align-items: center;
        width: 65%;
        border-radius: 3px;
        overflow: hidden;
        margin-right: 5px;
    }

    .progress-bar {
        border-radius: 3px;
        height: 6px;
        background: green;
        transition: width 0.2s ease-out;
    }

    .progress-text {
        font-size: 12px;
        color: #555;
    }

    .delete-btn {
        border: none;
        opacity: 0.5;
        transition: opacity 0.2s;
        margin-top: 5px;
    }

        .delete-btn:hover {
            opacity: 1;
        }

    .tab-content {
        padding: 20px 20px;
        /* border-bottom: 1px solid; */
    }

    .dropzonecontent {
        display: flex;
        justify-content: center;
    }

    .courthearing {
        align-items: center;
        justify-content: center;
        display: flex;
        height: 120px;
        border: 1px solid;
        border-radius: 7px;
    }
    /* wwwroot/css/site.css ya aapke CSS file me add karo */
    .blazored-toast-container {
        z-index: 20000 !important; /* Offcanvas se upar */
    }

    .search-box {
        width: 100%;
        padding-right: 3rem; /* space for the button */
        padding-left: 1rem; /* border-radius: 1.5rem; */
        border: 2px solid #020336;
        background-color: #FFF; /* dark background */
        color: black;
        height: 2.5rem;
        font-size: 14px;
    }

        .search-box::placeholder {
            color: darkgrey;
        }

        .search-box:focus {
            border: 2px solid #020336 !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
            background: #F5F5F5;
        }

    .search-btn {
        position: absolute;
        right: 1.7rem;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: none;
        color: #020336;
        cursor: pointer;
        padding: 0;
        font-size: 1.2rem;
    }

        .search-btn:hover {
            color: #1F365D;
        }

    .form-check-input {
        border-color: black;
        cursor: pointer;
    }

    .hint {
        font-size: 12px;
        color: #64748b;
        margin-top: 4px
    }

    .rz-inputtext {
        box-shadow: none !important;
        min-height: 44px;
        border-radius: 12px !important;
        font-size: 16px !important;
    }

    .row-item {
        display: grid;
        grid-template-columns: 1fr 1fr 1.2fr 120px;
        column-gap: 18px;
        row-gap: 8px;
        padding: 15px 0;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 10px;
    }

    .form-label-arrear {
        grid-column: span 4;
        font-size: 14px;
        margin-bottom: 4px;
        font-weight: 600;
        color: #374151;
    }

    .input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        font-size: 15px;
    }

    .remove-btn {
        border: 1px solid #d1d5db;
        background: #f9fafb;
        border-radius: 10px;
        cursor: pointer;
        padding: 10px 15px;
        align-self: end;
    }

    .add-btn {
        margin-top: 15px;
        padding: 12px 22px;
        background: #6b84af;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        font-size: 15px;
    }

    .total-box {
        background: #f3f4f6;
        padding: 14px 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        font-size: 16px;
        font-weight: 600;
    }

    .center {
        display: flex;
        justify-content: center;
    }

    /* =========================================================
                               Motion Form – Scoped Styling
                               ========================================================= */

    .motion-form {
        --border-color: #e5e7eb;
        --text-muted: #6b7280;
        --bg-auto: #f3f4f6;
        --primary-dark: #1f3a5f;
    }

        /* Cards */
        .motion-form .card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .motion-form .card-body {
            padding: 1.25rem;
        }

        /* Section titles */
        .motion-form .fw-semibold {
            font-size: 15px;
            color: #111827;
        }

        /* Labels */
        .motion-form .form-label {
            font-size: 15px;
            font-weight: 500;
            color: #374151;
        }

        .motion-form .required-label::after {
            content: " *";
            color: #dc2626;
        }

        /* Inputs */
        .motion-form .form-control,
        .motion-form .form-select {
            font-size: 14px;
            padding: 0.55rem 0.75rem;
            border-radius: 6px;
            border-color: var(--border-color);
        }

            /* Focus state */
            .motion-form .form-control:focus,
            .motion-form .form-select:focus {
                border-color: var(--primary-dark);
                box-shadow: 0 0 0 0.1rem rgba(31, 58, 95, 0.15);
            }

            /* Disabled / Auto fields */
            .motion-form .form-control:disabled,
            .motion-form .form-select:disabled,
            .motion-form .bg-light {
                background-color: var(--bg-auto) !important;
                cursor: not-allowed;
                color: #6b7280;
            }

        /* Filing fee badge */
        .motion-form .badge {
            background-color: #eef2ff;
            color: var(--primary-dark);
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
        }

        /* Toggle (Bootstrap switch enhancement) */
        /* .motion-form .form-switch .form-check-input {
                                    width: 2.5rem;
                                    height: 1.25rem;
                                    cursor: pointer;
                                } */

        /* .motion-form .form-switch .form-check-input:checked {
                                        background-color: var(--primary-dark);
                                        border-color: var(--primary-dark);
                                    }
                         */
        /* Attachments */
        /*  .motion-form .form-check {
                                    margin-bottom: 0.5rem;
                                } */

        .motion-form .form-check-label {
            font-size: 14px;
            color: #374151;
        }

        /* Textarea */
        .motion-form textarea.form-control {
            resize: none;
            show none;
            min-height: 90px;
        }

        /* Footer */
        .motion-form .border-top {
            border-top: 1px solid var(--border-color) !important;
        }

        .motion-form .text-warning {
            color: #b45309 !important;
            font-size: 13px;
        }

        /* Buttons */
        .motion-form .btn-primary {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

            .motion-form .btn-primary:hover {
                background-color: #162c47;
                border-color: #162c47;
            }

        .motion-form .btn-outline-secondary {
            border-color: var(--border-color);
        }

        /* Validation */
        .motion-form .validation-message {
            font-size: 12px;
            color: #dc2626;
        }

    /* Compact spacing on smaller screens */
    @@media (max-width: 768px) {
        .motion-form .card-body {
            padding: 1rem;
        }
    }

    /* =========================================================
                               Collapsible Motion Sections (Tab-like)
                               ========================================================= */

    .motion-section {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
        overflow: hidden;
        background: #fff;
    }

        /* Header bar */
        .motion-section .section-header {
            width: 100%;
            background: #f9fafb;
            border: none;
            padding: 12px 16px;
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

            /* Hover */
            .motion-section .section-header:hover {
                background: #f3f4f6;
            }

        /* Chevron */
        .motion-section .chevron {
            width: 10px;
            height: 10px;
            border-right: 2px solid #6b7280;
            border-bottom: 2px solid #6b7280;
            transform: rotate(45deg);
            transition: transform 0.25s ease;
        }

            .motion-section .chevron.open {
                transform: rotate(-135deg);
            }

        /* Collapsible body */
        .motion-section .section-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

            .motion-section .section-body.open {
                max-height: 2000px; /* large enough for content */
            }

        /* Inner card refinement */
        .motion-section .card {
            border: none;
            border-top: 1px solid #e5e7eb;
            border-radius: 0;
        }

    .btn-primary {
        color: white;
        min-width: 100%;
    }

</style>
@using System.Collections.Generic
@using System.Linq.Expressions
@using System.Globalization


<div class="offcanvas offcanvas-end show border-start shadow bg-white"
     tabindex="-1" id="createClient"
     aria-labelledby="createUserLabel">

    <div class="offcanvas-header border-bottom">

        <h5 class="offcanvas-title fw-bold color-text" id="createUserLabel">Actions</h5>

        <button type="button" class="btn-close" @onclick="HideAsync" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body p-0">
        <div class="d-flex align-items-center position-relative">
            <!-- CLIENT FORM -->

            <div class="form-wrapper  flex-grow-1 p-3 ">
                <div class="row">

                    <ul class="row nav nav-tabs" id="actionTabs" role="tablist">
                        <li class="col nav-item center" role="presentation" style="padding:0px;">
                            <button class="nav-link active" id="notice-tab" data-bs-toggle="tab" data-bs-target="#notice" type="button" role="tab">Notices</button>
                        </li>
                        <li class="col nav-item center" role="presentation" style="padding:0px;">
                            <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" @onclick="GetAllDocuments" role="tab">Uploads</button>
                        </li>
                        <li class="col nav-item center" role="presentation" style="padding:0px;">
                            <button class="nav-link" id="hearing-tab" data-bs-toggle="tab" data-bs-target="#hearing" type="button" role="tab">Hearing</button>
                        </li>
                        <li class="col nav-item center" role="presentation" style="padding:0px;white-space:nowrap;">
                            <button class="nav-link" id="appearance-tab" data-bs-toggle="tab" data-bs-target="#appearance" type="button" @onclick="() => ShowAppearance = true" role="tab">Appearance Status</button>
                        </li>
                        <li class="col nav-item center" role="presentation" style="padding:0px;">
                            <button class="nav-link" id="filings-tab" data-bs-toggle="tab" data-bs-target="#filings" type="button" role="tab">Filings</button>
                        </li>
                        <li class="col nav-item center" role="presentation" style="padding:0px;">
                            <button class="nav-link " id="marshal-tab" data-bs-toggle="tab" data-bs-target="#marshal" type="button" role="tab" @onclick="OnMarshalTabOpen">Marshal</button>
                        </li>
                        <li class="col nav-item center" role="presentation" style="padding:0px;">
                            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">Notes</button>
                        </li>
                        <li class="col-auto nav-item center" role="presentation" style="padding:0px;">
                            <button class="nav-link" id="server-tab" data-bs-toggle="tab" data-bs-target="#server" type="button" role="tab">Process Server</button>
                        </li>
                        <li class="col nav-item center" role="presentation" style="padding:0px;">
                            <button class="nav-link" id="reminder-tab" data-bs-toggle="tab" data-bs-target="#reminder" type="button" @onclick="() => ShowReminder = true" role="tab">Reminder</button>
                        </li>

                    </ul>

                    <div class="tab-content mb-3" id="actionTabsContent">

                        <div class="tab-pane fade show active" id="notice" role="tabpanel" aria-labelledby="notice-tab">
                            <!-- CONTENT for Send to Marshal -->
                            <div class="row mb-3 motion-form">
                                <EditForm Model="@noticeModel" OnValidSubmit="GenerateNotice">
                                    <DataAnnotationsValidator />
                                    <ValidationSummary />

                                    <div class="motion-section">
                                        <button type="button"
                                                class="section-header"
                                                @onclick="() => Toggle(nameof(IsMotionOpen))">
                                            <span>Motion Type</span>
                                            <i class="chevron @(IsMotionOpen ? "open" : "")"></i>
                                        </button>

                                        <div class="section-body @(IsMotionOpen ? "open" : "")">
                                            <div class="card card-body">
                                                <!-- YOUR EXISTING FORM FIELDS HERE -->
                                                <div class="row g-3 align-items-end">
                                                    <div class="col-md-8">
                                                        <label class="form-label ">Motion</label>
                                                        <InputSelect class="form-select" @bind-Value="noticeModel.FormTypeId" @bind-Value:after="FormTypeBindAfter">
                                                            <option value="">-- Select --</option>
                                                            @foreach (var m in FilteredFormTypeList)
                                                            {
                                                                <option value="@m.Id">@m.Name</option>
                                                            }
                                                        </InputSelect>
                                                        <ValidationMessage For="() => noticeModel.FormTypeId" />

                                                    </div>

                                                    <div class="col-md-4 text-md-end">
                                                        @* <label class="form-label required-label">Motion</label> *@
                                                        <div class=" input-group" style="width:140px">
                                                            <span class="input-group-text">$</span>
                                                            <input class="form-control" type="number" @bind="noticeModel.BillAmount">
                                                        </div>
                                                        <ValidationMessage For="() => noticeModel.BillAmount" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    @if (legalcaseDto.CaseTypeName == "NonPayment" || legalcaseDto.CaseTypeName == "Holdover")
                                    {

                                        <div class="motion-section">
                                            <button type="button"
                                                    class="section-header"
                                                    @onclick="() => Toggle(nameof(IsRentOpen))">
                                                <span>Rent & Payment Details</span>
                                                <i class="chevron @(IsRentOpen ? "open" : "")"></i>
                                            </button>

                                            <div class="section-body @(IsRentOpen ? "open" : "")">
                                                <div class="card card-body">
                                                    <!-- YOUR EXISTING FORM FIELDS HERE -->
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <label class="form-label ">Rent Due Frequency</label>
                                                            <InputSelect class="form-select" @bind-Value="noticeModel.DateRentId">
                                                                <option value="">-- Select --</option>
                                                                @foreach (var l in DateRentList)
                                                                {
                                                                    <option value="@l.Id">@l.Name</option>
                                                                }
                                                            </InputSelect>
                                                            <ValidationMessage For="() => noticeModel.DateRentId" />
                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label ">Monthly Rent ($)</label>
                                                            <InputNumber class="form-control" @bind-Value="noticeModel.MonthlyRent" />
                                                            <ValidationMessage For="() => noticeModel.MonthlyRent" />

                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label">Tenant's Share ($)</label>
                                                            <InputNumber class="form-control" @bind-Value="noticeModel.TenantShare" />
                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label ">Tenancy Type</label>
                                                            <InputSelect class="form-select" @bind-Value="noticeModel.TenancyTypeId" @bind-Value:after="CalcNoticeDays">
                                                                <option value="">-- Select --</option>
                                                                @foreach (var t in TenancyTypeList)
                                                                {
                                                                    <option value="@t.Id">@t.Name</option>
                                                                }
                                                            </InputSelect>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label">Last Payment Date</label>
                                                            <InputDate class="form-control" @bind-Value="noticeModel.DateofLastPayment" @bind-Value:after="GenerateMonths" />
                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label">Last Payment Amount ($)</label>
                                                            <InputNumber class="form-control" @bind-Value="noticeModel.LastPaidAmt" />
                                                        </div>
                                                        @if (legalcaseDto.CaseTypeName == "NonPayment")
                                                        {
                                                            <div class="col-md-4">
                                                                <label class="form-label ">Lease Start </label>
                                                                <RadzenDatePicker Style="width:100%; box-shadow:none" @bind-Value="noticeModel.LeaseStart" />

                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="form-label ">Lease End </label>
                                                                <RadzenDatePicker Style="width:100%; box-shadow:none" @bind-Value="noticeModel.LeaseEnd" />

                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="form-label" style="align-items: center;display: flex;height: 36px;">Written Lease?</label>
                                                                <div class="d-flex justify-content-start align-items-center  gap-2">
                                                                    <InputRadioGroup @bind-Value="noticeModel.WrittenLease">
                                                                        <div class="form-check d-flex justify-content-center gap-2">
                                                                            <InputRadio class="form-check-input" Value="true" style="font-size:15px" />
                                                                            <label class="form-check-label">Yes</label>
                                                                        </div>
                                                                        <div class="form-check  d-flex justify-content-center gap-2">
                                                                            <InputRadio class="form-check-input " Value="false" style="font-size:15px" />
                                                                            <label class="form-check-label">No</label>
                                                                        </div>
                                                                    </InputRadioGroup>
                                                                </div>
                                                            </div>
                                                        }

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        @if (LastdateSelected)
                                        {
                                            <div class="motion-section">
                                                <button type="button"
                                                        class="section-header"
                                                        @onclick="() => Toggle(nameof(IsLedgerOpen))">
                                                    <span>Arrear Ledger</span>
                                                    <i class="chevron @(IsLedgerOpen ? "open" : "")"></i>
                                                </button>

                                                <div class="section-body @(IsLedgerOpen ? "open" : "")">
                                                    <div class="card card-body">
                                                        <!-- YOUR EXISTING FORM FIELDS HERE -->
                                                        <div class="row g-2 mt-2">
                                                            <div class="col">
                                                                <label class="form-label">Rent Breakup</label>
                                                                <div class="total-box mt-1">
                                                                    <label class="form-label " style="font-size:14px; font-weight:300; margin-bottom:0px;">Total Owed: $ @(noticeModel.Totalowed ?? 00)</label>
                                                                </div>

                                                                @foreach (var item in Rows)
                                                                {
                                                                    <div class="row mb-3">
                                                                        <div class="col-4">
                                                                            <label class="form-label ">Month (YYYY-MM) </label>
                                                                            <InputSelect class="form-select holdover-form"
                                                                                         @bind-Value="item.Month"
                                                                                         @bind-Value:after="(() => OnMonthChanged(item))">

                                                                                <option value="">Select month</option>

                                                                                @foreach (var m in MonthOptions)
                                                                                {
                                                                                    <option value="@m.Value">@m.Display</option>
                                                                                }

                                                                            </InputSelect>
                                                                        </div>
                                                                        <div class="col-3">
                                                                            <label class="form-label  ">Amount ($) </label>
                                                                            <InputNumber @bind-Value="item.Amount" @bind-Value:after="RecalculateTotal"
                                                                                         class="form-control" />
                                                                        </div>

                                                                        <div class="col-3">
                                                                            <label class="form-label  ">Notes </label>
                                                                            <InputText @bind-Value="item.Notes"
                                                                                       class="form-control" placeholder="Partial, vouchers, etc." />
                                                                        </div>

                                                                        <div class="col-2" style="justify-content:end; display:flex;">
                                                                            <button type="button" class="remove-btn" @onclick="(() => RemoveRow(item))">
                                                                                <i class="fa-solid fa-xmark"></i>
                                                                            </button>
                                                                        </div>


                                                                    </div>
                                                                }

                                                                <button type="button" class="add-btn" @onclick="AddRow">
                                                                    + Add Month
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }



                                        <div class="motion-section">
                                            <button type="button"
                                                    class="section-header"
                                                    @onclick="() => Toggle(nameof(IsNoticeOpen))">
                                                <span>Notice Details</span>
                                                <i class="chevron @(IsNoticeOpen ? "open" : "")"></i>
                                            </button>

                                            <div class="section-body @(IsNoticeOpen ? "open" : "")">
                                                <div class="card card-body">
                                                    <!-- YOUR EXISTING FORM FIELDS HERE -->
                                                    <div class="row g-3">
                                                        <div class="col-md-4">
                                                            <label class="form-label ">Date Notice Served</label>
                                                            <InputDate class="form-control"
                                                                       @bind-Value="noticeModel.DateNoticeServed" />
                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label">Calculated Notice Length</label>
                                                            <InputNumber class="form-control bg-light" disabled @bind-Value="noticeModel.CalcNoticeLength" />
                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label d-block">Good Cause Exemption</label>
                                                            <div class="d-flex justify-content-start align-items-center  gap-2">
                                                                <InputRadioGroup @bind-Value="noticeModel.GoodCauseExempt">
                                                                    <div class="form-check d-flex justify-content-center gap-2">
                                                                        <InputRadio class="form-check-input" Value="true" style="font-size:15px" />
                                                                        <label class="form-check-label">Yes</label>
                                                                    </div>
                                                                    <div class="form-check  d-flex justify-content-center gap-2">
                                                                        <InputRadio class="form-check-input " Value="false" style="font-size:15px" />
                                                                        <label class="form-check-label">No</label>
                                                                    </div>
                                                                </InputRadioGroup>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label">Expiration Date</label>
                                                            <InputDate class="form-control bg-light" disabled
                                                                       @bind-Value="noticeModel.ExpirationDate" />
                                                        </div>

                                                        <div class="col-md-4">
                                                            <label class="form-label">Predicate Notice</label>
                                                            <InputText class="form-control bg-light" disabled
                                                                       @bind-Value="noticeModel.PredicateNotice" />
                                                        </div>
                                                        @if (legalcaseDto.CaseTypeName == "NonPayment")
                                                        {
                                                            <div class="col-md-4">
                                                                <label class="form-label ">Service Method </label>
                                                                <InputSelect class="form-select" @bind-Value="legalcaseDto.ServiceMethodId" style="cursor:pointer;">
                                                                    <option value="">-- Select --</option>
                                                                    @foreach (var l in ServiceMethodList)
                                                                    {
                                                                        <option value="@l.Id">@l.Name</option>
                                                                    }
                                                                </InputSelect>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="form-label ">Planned Service Date </label>
                                                                <RadzenDatePicker Style="width:100%; box-shadow:none" @bind-Value="legalcaseDto.PlannedServiceDate" />

                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="form-label">Roll to Next Business Day</label>
                                                                <div class="d-flex justify-content-start align-items-center  gap-2">
                                                                    <InputRadioGroup @bind-Value="legalcaseDto.NextBussinessday">
                                                                        <div class="form-check d-flex justify-content-center gap-2">
                                                                            <InputRadio class="form-check-input" Value="true" style="font-size:15px" />
                                                                            <label class="form-check-label">Yes</label>
                                                                        </div>
                                                                        <div class="form-check  d-flex justify-content-center gap-2">
                                                                            <InputRadio class="form-check-input " Value="false" style="font-size:15px" />
                                                                            <label class="form-check-label">No</label>
                                                                        </div>
                                                                    </InputRadioGroup>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="form-label ">Deemed Service (Auto) </label>
                                                                <InputText class="form-control" @bind-Value="legalcaseDto.DeemedService" style="cursor:pointer;" />

                                                            </div>
                                                            <div class="col-md-4">
                                                                <label class="form-label ">Expiry (auto) </label>
                                                                <InputText class="form-control" Style="width:100%; box-shadow:none" @bind-Value="legalcaseDto.Expiry" />

                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="motion-section">
                                            <button type="button"
                                                    class="section-header"
                                                    @onclick="() => Toggle(nameof(IsAttachmentOpen))">
                                                <span>Attachments</span>
                                                <i class="chevron @(IsAttachmentOpen ? "open" : "")"></i>
                                            </button>

                                            <div class="section-body @(IsAttachmentOpen ? "open" : "")">
                                                <div class="card card-body">
                                                    <!-- YOUR EXISTING FORM FIELDS HERE -->
                                                    <div class="row g-3">
                                                        <div class="col-md-6 form-check">
                                                            <InputCheckbox class="form-check-input" @bind-Value="noticeModel.LeasedAttached" />
                                                            <label class="form-check-label">Lease Attached</label>
                                                        </div>

                                                        <div class="col-md-6 form-check">
                                                            <InputCheckbox class="form-check-input" @bind-Value="noticeModel.LedgerAttached" />
                                                            <label class="form-check-label">Ledger Attached</label>
                                                        </div>

                                                        <div class="col-md-6 form-check">
                                                            <InputCheckbox class="form-check-input" @bind-Value="noticeModel.NoticeProofattached" />
                                                            <label class="form-check-label">Notices Proof Attached</label>
                                                        </div>

                                                        <div class="col-md-6 form-check">
                                                            <InputCheckbox class="form-check-input" @bind-Value="noticeModel.RegistrationRentHistory" />
                                                            <label class="form-check-label">Registration / Rent History Attached</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="motion-section">
                                            <button type="button"
                                                    class="section-header"
                                                    @onclick="() => Toggle(nameof(IsCommentsOpen))">
                                                <span>Additional Comments</span>
                                                <i class="chevron @(IsCommentsOpen ? "open" : "")"></i>
                                            </button>

                                            <div class="section-body @(IsCommentsOpen ? "open" : "")">
                                                <div class="card card-body">
                                                    <!-- YOUR EXISTING FORM FIELDS HERE -->
                                                    <div class="fw-semibold mb-2">Additional Comments</div>
                                                    <InputTextArea class="form-control" rows="3"
                                                                   @bind-Value="noticeModel.AdditionalComments" />

                                                </div>
                                            </div>
                                        </div>
                                        @if (legalcaseDto.CaseTypeName == "NonPayment")
                                        {
                                            <div class="motion-section">
                                                <button type="button"
                                                        class="section-header"
                                                        @onclick="() => Toggle(nameof(IsothersOpen))">
                                                    <span>Other</span>
                                                    <i class="chevron @(IsothersOpen ? "open" : "")"></i>
                                                </button>

                                                <div class="section-body @(IsothersOpen ? "open" : "")">
                                                    <div class="card card-body">
                                                        <!-- YOUR EXISTING FORM FIELDS HERE -->
                                                        <div class="fw-semibold mb-2">Assistance (Section 8 / SCRIE/DRIE / other)</div>
                                                        <InputText class="form-control" rows="3"
                                                                   @bind-Value="noticeModel.Assistance" />
                                                    </div>
                                                </div>
                                            </div>
                                        }

                                    }
                                    @if (legalcaseDto.CaseTypeName == "Per Diem")
                                    {
                                        <div class="motion-section">
                                            <button type="button"
                                                    class="section-header"
                                                    @onclick="() => Toggle(nameof(IsBillingopen))">
                                                <span>Billing</span>
                                                <i class="chevron @(IsBillingopen ? "open" : "")"></i>
                                            </button>

                                            <div class="section-body @(IsBillingopen ? "open" : "")">
                                                <div class="card card-body">
                                                    <!-- YOUR EXISTING FORM FIELDS HERE -->
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <label class="form-label ">Rate / Compensation </label>
                                                            @if (BilingTypesList != null && BilingTypesList.Any())
                                                            {
                                                                <InputRadioGroup @bind-Value="legalcaseDto.BilingTypeId" class="d-flex flex-wrap">
                                                                    <div class="d-flex align-items-center gap-4">

                                                                        @foreach (var Type in BilingTypesList)
                                                                        {
                                                                            <div class="d-flex align-items-center">

                                                                                <!-- Radio -->
                                                                                <InputRadio class="form-check-input me-2"
                                                                                            Value="@Type.Id"
                                                                                            id="@($"Type_{Type.Id}")"
                                                                                            @onclick="@(() => OnBillingTypeChanged(Type.Id))" />

                                                                                <!-- Label -->
                                                                                <label class="form-check-label me-3" for="@($"Type_{Type.Id}")">
                                                                                    @Type.Name
                                                                                </label>

                                                                                <!-- Input box (same horizontal line) -->
                                                                                @if (legalcaseDto.BilingTypeId == Type.Id)
                                                                                {
                                                                                    <input type="number"
                                                                                           class="form-control"
                                                                                           style="width: 180px;"
                                                                                           placeholder="@(Type.Name == "Flat Rate" ? "$" : "$ / hr")"
                                                                                           @bind="legalcaseDto.BilingTypeInputValue" />
                                                                                }

                                                                            </div>
                                                                        }

                                                                    </div>


                                                                </InputRadioGroup>
                                                                <ValidationMessage For="() => legalcaseDto.BilingTypeId" />
                                                            }
                                                        </div>
                                                    </div>
                                                    <div class="row mt-3">
                                                        <div class="col-5">
                                                            <label class="form-label">Travel / Other Expenses </label>
                                                            <InputText class="form-control" placeholder="Optional" @bind-Value="legalcaseDto.TravelExpense" />
                                                        </div>
                                                        <div class="col-md-7">
                                                            <label class="form-label">Payment Method  <span class="text-danger">*</span></label>

                                                            <div id="reliefRespondentGroup" class="row">
                                                                @if (PaymentMethodDtoList != null && PaymentMethodDtoList.Any())
                                                                {
                                                                    <InputRadioGroup @bind-Value="legalcaseDto.PaymentMethodId" class="d-flex flex-wrap">
                                                                        @foreach (var method in PaymentMethodDtoList)
                                                                        {
                                                                            <div class="col-auto">
                                                                                <div class="form-check mb-2">
                                                                                    <InputRadio class="form-check-input"
                                                                                                id="@($"partyType_{method.Id}")"
                                                                                                Value="@method.Id" />
                                                                                    <label class="form-check-label"
                                                                                           for="@($"method{method.Id}")">@method.Name</label>
                                                                                </div>
                                                                            </div>
                                                                        }
                                                                    </InputRadioGroup>
                                                                    <ValidationMessage For="() => legalcaseDto.PaymentMethodId" />
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                    <!-- Sticky Footer (inside modal/container) -->
                                    <div class="d-flex justify-content-between align-items-center border-top pt-3">
                                        <div class="text-warning small">
                                        </div>

                                        <div style="min-width:20% !important">
                                            @* <button type="button" class="btn btn-outline-secondary me-2"
                                                    @onclick="Cancel">
                                                Cancel
                                            </button> *@

                                            <button type="submit" class="btn btn-primary" style="min-width:100% !important">
                                                Generate
                                            </button>
                                        </div>
                                    </div>

                                </EditForm>

                            </div>

                        </div>
                        <div class="tab-pane fade" id="appearance" role="tabpanel" aria-labelledby="appearance-tab">
                            @if(ShowAppearance)
                            {
                                <AppearanceStatus />
                            }
                        </div>
                        <div class="tab-pane fade" id="reminder" role="tabpanel" aria-labelledby="reminder-tab">
                            @if (ShowReminder)
                            {
                                <RemainderCenter />
                            }
                        </div>
                        <div class="tab-pane fade" id="filings" role="tabpanel" aria-labelledby="filings-tab">
                           <h4>Under Construction</h4>
                        </div>
                        <div class="tab-pane fade" id="marshal" role="tabpanel" aria-labelledby="marshal-tab">
                            <div class="row mb-3 d-flex align-items-center">

                                <div class="fw-semibold col-3">Assign Marshal</div>

                                <div class="col-6 position-relative" @onfocusout="HideMarshalDropDown">

                                    @if (!isMarshalAssigned)
                                    {
                                        <!-- Search Box -->

                                        <InputText class="form-control search-box" placeholder="Search by marshal name.." @bind-value="searchmarshalText" @oninput="OnSearchMarshalInput"
                                                   @onclick="ShowAllmarshal" />
                                        <button class="search-btn" type="button">
                                            <i class="fa fa-search"></i>
                                        </button>




                                        @if (filteredmarshal?.Any() == true)
                                        {
                                            <ul class="dropdown-menu show" style="position:absolute; width:94%; cursor:pointer;">
                                                @foreach (var c in filteredmarshal)
                                                {
                                                    <li class="dropdown-item" @onclick="() => Selectedmarshal(c)">
                                                        @c.FirstName  @c.LastName
                                                    </li>
                                                }
                                            </ul>
                                        }

                                    }
                                    else
                                    {
                                        <!-- Selected Marshal -->
                                        <label class="form-control bg-light fw-bold d-flex align-items-center">
                                            @(selectedmarshal != null ? selectedmarshal.FirstName + " " + selectedmarshal.LastName : "")
                                        </label>

                                    }

                                </div>

                                <div class="col-3">
                                    @if (!isMarshalAssigned)
                                    {
                                        <button class="btn bg-brand-primary base text-white" @onclick="SubmitMarshal">Save</button>

                                    }
                                    else
                                    {

                                        <button class="btn bg-brand-primary base text-white" @onclick="ResetMarshal">Reset</button>
                                    }
                                </div>

                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    @if (showMarshalError)
                                    {
                                        <div class="text-danger small mt-1">Please select a marshal.</div>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="server" role="tabpanel" aria-labelledby="server-tab">
                            <h4>Under Construction</h4>
                        </div>

                        <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                            <EditForm Model="@Documentdto" OnValidSubmit="SaveFiles">
                                <DataAnnotationsValidator />
                                <div class="row mb-3">
                                    <div class="fw-semibold col-auto" style="display: flex;
                                                                            justify-content: center;
                                                                            align-items: center;">
                                        Document Type
                                    </div>
                                    <div class="col-6 ">
                                        <InputSelect class="form-select" @bind-Value="Documentdto.DocumentTypeId">
                                            <option value="">--Select--</option>
                                            @foreach (var item in DocumentsType)
                                            {
                                                <option value="@item.Id">@item.Name</option>
                                            }
                                        </InputSelect>
                                        <ValidationMessage For="@(() => Documentdto.DocumentTypeId)" />
                                    </div>

                                </div>
                                <!-- CONTENT for Upload / View Documents -->
                                <InputFile @ref="fileInput" OnChange="OnInputChanged" multiple style="display:none" disabled="@(Documentdto.DocumentTypeId != null && Documentdto.DocumentTypeId != Guid.Empty)" />

                                <div class="drop-zone"
                                     @ref="dropZoneRef"
                                     @onclick="OpenFileDialog">

                                    <div class="row">
                                        <div class="dropzonecontent">Upload Documents</div>
                                        <div class="dropzonecontent">
                                            <span style="text-decoration:underline; cursor:pointer; color:#00a7ff; margin-right:5px;">Click</span>
                                            or drag & drop file(s) here
                                        </div>

                                    </div>


                                </div>
                                <div class="dropzonecontent" style="color:red; font-size:0.9rem; margin-top:5px;">
                                    * Only PDF and DOC/DOCX files are allowed
                                </div>

                                @if (Files.Count > 0)
                                {
                                    <ul class="google-upload-list mt-3">
                                        @foreach (var item in UploadItems)
                                        {
                                            <li class="google-upload-item">

                                                <div class="file-info">
                                                    <div class="file-icon">📄</div>

                                                    <div class="file-meta">
                                                        <div class="file-name">@item.File.Name</div>

                                                        <div class="d-flex" style="width:100px">
                                                            <div class="progress-container">
                                                                <div class="progress-bar" style="width:@item.Progress%"></div>
                                                            </div>

                                                            <div class="progress-text">@item.Progress%</div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <button class="btn-close delete-btn"
                                                        @onclick="() => RemoveUploadItem(item)">
                                                </button>

                                            </li>
                                        }
                                    </ul>
                                }


                                <div class="modal-footer mt-3" style="padding: 5px !important; border-top: none !important; ">
                                    <button type="submit" class="btn btn-primary base" style="min-width:100% !important" disabled="@(Documentdto.DocumentTypeId != null && Documentdto.DocumentTypeId != Guid.Empty)">Upload</button>
                                </div>
                            </EditForm>

                        </div>

                        <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
                            <!-- CONTENT for Add Notes -->
                            <div class="modal-body mb-3">
                                @* <div class="card border-0">
                                    <div class="card-body p-0">

                                        <!-- Search + Add Section -->
                                        <!-- Add/Edit Fields -->

                                        <div class="border rounded-3 p-3 mb-3 position-relative">

                                            @*  <button type="button" class=" position-absolute top-0 end-0 m-2"
                                                        aria-label="Reset" style="cursor:pointer; background:none;"
                                                        @onclick="OnBindHearingCancel"> Reset
                                                </button> *

                                            <div class=" g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label required-label">Date </label>
                                                    <InputDate class="form-control" @bind-Value="caseHearing.HearingDate" placeholder="Select Date" />
                                                </div>

                                                <div class="col-md-6 mt-2 ">
                                                    <label class="form-label required-label">Time</label>
                                                    <input type="time" class="form-control" @bind="caseHearing.HearingTime" />
                                                </div>



                                            </div>
                                        </div>
                                    </div>
                                </div> *@
                                <InputTextArea style="height:200px" class="form-control" placeholder="Enter Notes" @bind-Value="legalcaseDto.Notes" />

                            </div>

                            <div class="modal-footer" style="padding: 5px !important; border-top: none !important;">
                                <button type="submit" class="btn btn-primary base" @onclick="SaveHearingChanges">Save</button>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="hearing" role="tabpanel" aria-labelledby="hearing-tab">
                            <!-- CONTENT for Add Hearing -->
                            @if ((legalcaseDto.CourtLocationId == null || legalcaseDto.CourtLocationId == Guid.Empty) && !CaseForms.Any())
                            {
                                <div class="modal-body mb-3 courthearing">
                                    <ul>
                                        <li>Please Generate Form before Adding Case Hearing</li>
                                        <li>Please Add Court Details before Adding Case Hearing</li>
                                    </ul>
                                </div>
                            }


                            else if (!CaseForms.Any())
                            {
                                <div class="modal-body mb-3 courthearing">

                                    <ul>
                                        <li>
                                            Please Generate Form before Adding Case Hearing
                                        </li>
                                    </ul>

                                </div>
                            }
                            else if (legalcaseDto.CourtLocationId == null || legalcaseDto.CourtLocationId == Guid.Empty)
                            {
                                <div class="modal-body mb-3 courthearing">

                                    <ul>
                                        <li>
                                            Please Add Court Details before Adding Case Hearing
                                        </li>
                                    </ul>

                                </div>
                            }

                            else
                            {
                                <h5 class="offcanvas-title fw-bold color-text" id="createUserLabel">Appearance Details (@Court.Court)</h5>
                                <EditForm Model="@caseHearing">
                                    <DataAnnotationsValidator />
                                    @* <div class="modal-body">

                                        <div class="card border-0">
                                            <div class="card-body p-0">

                                                <!-- Search + Add Section -->
                                                <!-- Add/Edit Fields -->

                                                <div class="border rounded-3 p-3 mb-3 position-relative">

                                                    @*  <button type="button" class=" position-absolute top-0 end-0 m-2"
                                                        aria-label="Reset" style="cursor:pointer; background:none;"
                                                        @onclick="OnBindHearingCancel"> Reset
                                                </button> *

                                                    <div class=" g-3">
                                                        <div class="col-md-6">
                                                            <label class="form-label required-label">Date </label>
                                                            <InputDate class="form-control" @bind-Value="caseHearing.HearingDate" placeholder="Select Date" />
                                                        </div>

                                                        <div class="col-md-6 mt-2 ">
                                                            <label class="form-label required-label">Time</label>
                                                            <input type="time" class="form-control" @bind="caseHearing.HearingTime" />
                                                        </div>



                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                                        <button type="button" class="btn btn-secondary me-2" @onclick="OnBindHearingCancel">Reset</button>
                                        <button type="submit" class="btn btn-primary base" @onclick="SaveHearingChanges">Save</button>
                                    </div> *@

                                    <div class="motion-section">
                                        <button type="button"
                                                class="section-header"
                                                @onclick="() => Toggle(nameof(IsBasicHearingOpen))">
                                            <span>Basic Appearance Information</span>
                                            <i class="chevron @(IsBasicHearingOpen ? "open" : "")"></i>
                                        </button>

                                        <div class="section-body @(IsBasicHearingOpen ? "open" : "")">
                                            <div class="card card-body">
                                                <div class="row g-3">
                                                    <div class="col-md-6">
                                                        <label class="form-label ">Appearance Type </label>
                                                        <InputSelect class="form-select" @bind-Value="caseHearing.AppearanceTypeForHearingId" placeholder="Select Date">

                                                            @foreach (var item in AppearanceTypeforHearing)
                                                            {
                                                                <option value="@item.Id">@item.Name</option>
                                                            }
                                                        </InputSelect>
                                                    </div>

                                                    <div class="col-md-6 ">
                                                        <label class="form-label ">Court Part</label>
                                                        <InputSelect class="form-select" @bind-Value="caseHearing.CourtPartId">
                                                            <option value="">-- Select --</option>
                                                            @foreach (var item in Court.CourtPart)
                                                            {
                                                                <option value="@item.Id">@item.Part / @item.RoomNo</option>
                                                            }
                                                        </InputSelect>
                                                    </div>
                                                </div>


                                                <div class="row g-3 mt-2">
                                                    <div class="col-md-6">
                                                        <label class="form-label required-label">Date </label>
                                                        <InputDate class="form-control" @bind-Value="caseHearing.HearingDate" placeholder="Select Date" />
                                                    </div>

                                                    <div class="col-md-6  ">
                                                        <label class="form-label required-label">Time</label>
                                                        <input type="time" class="form-control" @bind="caseHearing.HearingTime" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    @*   <div class="motion-section">
                                        <button type="button"
                                                class="section-header"
                                                @onclick="() => Toggle(nameof(IsDatetime))">
                                            <span>Motion Type</span>
                                            <i class="chevron @(IsDatetime ? "open" : "")"></i>
                                        </button>

                                        <div class="section-body @(IsDatetime ? "open" : "")">
                                            <div class="card card-body">

                                            </div>
                                        </div>
                                    </div> *@


                                    <div class="motion-section">
                                        <button type="button"
                                                class="section-header"
                                                @onclick="() => Toggle(nameof(IsAppearanceformatOpen))">
                                            <span>Appearance Format</span>
                                            <i class="chevron @(IsAppearanceformatOpen ? "open" : "")"></i>
                                        </button>

                                        <div class="section-body @(IsAppearanceformatOpen ? "open" : "")">
                                            <div class="card card-body">

                                                <div class="row g-3">
                                                    <div class="col-md-3">
                                                        <label class="form-label ">Appearance Mode </label>
                                                        <InputSelect class="form-select" @bind-Value="caseHearing.AppearanceModeId">

                                                            @foreach (var item in AppearanceModes)
                                                            {
                                                                <option value="@item.Id">@item.Name</option>
                                                            }
                                                        </InputSelect>
                                                    </div>

                                                    @if (IsVirtualMode)
                                                    {

                                                        <div class="col-md-3 ">
                                                            <label class="form-label ">Virtual Platform</label>
                                                            <InputSelect class="form-select" @bind-Value="caseHearing.VirtualPlatformId">
                                                                <option value="">-- Select --</option>
                                                                @foreach (var item in VirtualPlatforms)
                                                                {
                                                                    <option value="@item.Id">@item.Name</option>
                                                                }
                                                            </InputSelect>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <label class="form-label ">Virtual Link</label>
                                                            <InputText class="form-control" @bind-Value="caseHearing.Virtuallink" placeholder="https://" />
                                                        </div>


                                                        <div class="col-md-3 ">
                                                            <label class="form-label ">Metting ID</label>
                                                            <InputText class="form-control" @bind-Value="caseHearing.Meetingid" placeholder="optional" />
                                                        </div>
                                                    }

                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="motion-section">
                                        <button type="button"
                                                class="section-header"
                                                @onclick="() => Toggle(nameof(IsInternalNotes))">
                                            <span>Internal Notes (Non - Outcomes)</span>
                                            <i class="chevron @(IsInternalNotes ? "open" : "")"></i>
                                        </button>

                                        <div class="section-body @(IsInternalNotes ? "open" : "")">
                                            <div class="card card-body">

                                                <div class="row g-3">
                                                    <div class="col">
                                                        <InputTextArea class="form-control" @bind-Value="caseHearing.LastAction" placeholder="Taking points, courts instruction, clerk comments" />
                                                    </div>


                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center border-top pt-3">
                                        <div class="text-warning small">
                                        </div>

                                        <div style="min-width:40% !important">
                                            @* <button type="button" class="btn btn-outline-secondary me-2"
                                                    @onclick="Cancel">
                                                Cancel
                                            </button> *@
                                            <button type="button" class="btn btn-secondary " style="width:45% !important;" @onclick="OnBindHearingCancel">Reset</button>
                                            <button type="submit" class="btn btn-primary base" style="width:45% !important; min-width:0px !important;" @onclick="SaveHearingChanges">Save</button>

                                        </div>
                                    </div>
                                </EditForm>
                            }


                        </div>

                        <div class="tab-pane fade" id="predicate" role="tabpanel" aria-labelledby="predicate-tab">
                            <!-- CONTENT for Add Hearing -->

                            <EditForm Model="legalcaseDto" FormName="PredicateNotices" OnValidSubmit="UpdateCase">
                                <div class="row">
                                    <div class="col">
                                        <div class=" mb-3">
                                            @* <div class="card-header">
                                                <div style="font-weight:700" class="head"> Predicate Notice Planner</div>
                                            </div> *@
                                            <div class="card-body">
                                                <div class="row g-2 mb-3" style="gap: 40px;">

                                                    <!-- Notice type -->
                                                    <div class="col-md-5">
                                                        <label class="form-label " style="font-weight:600;">Notice Type </label>
                                                        <InputSelect class="form-select" @bind-Value="legalcaseDto.NoticeId" style="cursor:pointer;">
                                                            <option value="">-- Select --</option>
                                                            @foreach (var l in FilteredFormTypeList)
                                                            {
                                                                <option value="@l.Id">@l.Name</option>
                                                            }
                                                        </InputSelect>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label " style="font-weight:600;">Service Method </label>
                                                        <InputSelect class="form-select" @bind-Value="legalcaseDto.ServiceMethodId" style="cursor:pointer;">
                                                            <option value="">-- Select --</option>
                                                            @foreach (var l in ServiceMethodList)
                                                            {
                                                                <option value="@l.Id">@l.Name</option>
                                                            }
                                                        </InputSelect>
                                                    </div>
                                                </div>
                                                <div class="row g-2 mb-3" style="gap: 40px;">
                                                    <div class="col-md-5">
                                                        <label class="form-label " style="font-weight:600;">Service Method </label>
                                                        <InputSelect class="form-select" @bind-Value="legalcaseDto.ServiceMethodId" style="cursor:pointer;">
                                                            <option value="">-- Select --</option>
                                                            @foreach (var l in ServiceMethodList)
                                                            {
                                                                <option value="@l.Id">@l.Name</option>
                                                            }
                                                        </InputSelect>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label " style="font-weight:600;">Planned Service Date </label>
                                                        <RadzenDatePicker Style="width:100%; box-shadow:none" @bind-Value="legalcaseDto.PlannedServiceDate" />

                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label" style="font-weight:600;">Roll to Next Business Day</label>
                                                        <div class="d-flex justify-content-start align-items-center  gap-2">
                                                            <InputRadioGroup @bind-Value="legalcaseDto.NextBussinessday">
                                                                <div class="form-check d-flex justify-content-center gap-2">
                                                                    <InputRadio class="form-check-input" Value="true" style="font-size:15px" />
                                                                    <label class="form-check-label">Yes</label>
                                                                </div>
                                                                <div class="form-check  d-flex justify-content-center gap-2">
                                                                    <InputRadio class="form-check-input " Value="false" style="font-size:15px" />
                                                                    <label class="form-check-label">No</label>
                                                                </div>
                                                            </InputRadioGroup>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label " style="font-weight:600;">Deemed Service (Auto) </label>
                                                        <InputText class="form-control" @bind-Value="legalcaseDto.DeemedService" style="cursor:pointer;" />

                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label " style="font-weight:600;">Expiry (auto) </label>
                                                        <InputText class="form-control" Style="width:100%; box-shadow:none" @bind-Value="legalcaseDto.Expiry" />

                                                    </div>
                                                </div>
                                                <div class="row g-2 mb-3" style="gap: 40px;">
                                                    <div class="col-md-5">
                                                        <label class="form-label " style="font-weight:600;">Deemed Service (Auto) </label>
                                                        <InputText class="form-control" @bind-Value="legalcaseDto.DeemedService" style="cursor:pointer;" />

                                                    </div>
                                                    <div class="col-md-5">
                                                        <label class="form-label " style="font-weight:600;">Expiry (auto) </label>
                                                        <InputText class="form-control" Style="width:100%; box-shadow:none" @bind-Value="legalcaseDto.Expiry" />

                                                    </div>

                                                </div>
                                                <div class="row g-2">
                                                    <div class="hint">Add-ons: Personal +0 • Overnight +1 • Mail +5 • Posting+Mail +5. Expiry counts from deemed date.</div>
                                                    <div class="col-auto">
                                                        <label class="form-label" style="border:1px solid; padding: 10px;border-radius: 25px;align-items: center;display: flex;height: 36px;">Live Expiry : --</label>

                                                    </div>

                                                </div>

                                            </div>
                                        </div>
                                    </div>



                                </div>

                                <div style="display:flex; justify-content:end">
                                    <button type="submit" class="btn bg-navy text-white me-2" style="font-size:14px; background:#1F365D;margin-left:10px">Save</button>

                                </div>
                            </EditForm>

                        </div>

                        <div class="tab-pane fade" id="remarks" role="tabpanel" aria-labelledby="remarks-tab">
                            <!-- CONTENT for Add Hearing -->
                            @*  @if (legalcaseDto.CaseTypeName == "Holdover")
                            {
                                <EditForm EditContext="_editContext" FormName="DocumentRemarks" >
                                    <DataAnnotationsValidator></DataAnnotationsValidator>
                                    <div class="row">
                                        <div class="col">
                                            <div class="mb-3">
                                                <div class="card-body">
                                                    <div class="row g-2"  >

                                                        <!-- Rent Due Day -->
                                                        <div class="col-md-5">
                                                            <label class="form-label  required-label">Date Rent  Due (Month/Week) </label>
                                                            <InputSelect class="form-select" @bind-Value="legalcaseDto.RentDueEachMonthOrWeekId" style="cursor:pointer;">
                                                                <option value="">-- Select Type --</option>
                                                                @foreach (var l in DateRentList)
                                                                {
                                                                    <option value="@l.Id">@l.Name</option>
                                                                }
                                                            </InputSelect>
                                                            <ValidationMessage For="() => legalcaseDto.RentDueEachMonthOrWeekId" />
                                                        </div>

                                                        <!-- Monthly Rent -->
                                                        <div class="col-md-5">
                                                            <label class="form-label  required-label">Monthly Rent ($) </label>
                                                            <InputNumber class="form-control" @bind-Value="legalcaseDto.MonthlyRent" placeholder="Enter Monthly Rent" />
                                                            <ValidationMessage For="() => legalcaseDto.MonthlyRent" />
                                                        </div>

                                                        <!-- Tenant's Share -->



                                                    </div>

                                                    <div class="row g-2 mt-2"  >
                                                        <div class="col-md-5">
                                                            <label class="form-label">Tenant's Share ($)</label>
                                                            <InputNumber class="form-control" @bind-Value="legalcaseDto.TenantShare" placeholder="Enter Total Share" min="0" />

                                                        </div>
                                                        <div class="col-md-5">
                                                            <label class="form-label">Social Services (If any)</label>
                                                            <InputText class="form-control" @bind-Value="legalcaseDto.SocialService" placeholder="Enter Social Service" />

                                                        </div>
                                                    </div>
                                                    @* <div class="col-md-4">
                                        <label class="form-label">Unpaid Rent (Months) </label>
                                        <InputText class="form-control"
                                                   @bind-Value="legalcaseDto.LastRentPaid"
                                                   placeholder="Enter  unpaid months" @bind-Value:after="FormatLastRentPaid" />
                                    </div>

                                    <div class="col-md-4">
                                        <label class="form-label">Total Rent Owed ($)</label>
                                        <InputNumber class="form-control" @bind-Value="legalcaseDto.TotalOwed" placeholder="Enter Total Rent" min="0" />

                                    </div> *
                                                    <div class="row g-2 mt-2"  >

                                                        <div class="col-md-5">
                                                            <label class="form-label ">Date of Last Payment </label>
                                                            <RadzenDatePicker Style="width:100%; box-shadow:none" @bind-Value="legalcaseDto.LastPaymentDate" @bind-Value:after="GenerateMonths" />

                                                        </div>
                                                        <div class="col-md-5">
                                                            <label class="form-label">Amount of Last Payment ($)</label>
                                                            <InputNumber class="form-control" @bind-Value="legalcaseDto.LastPayment" min="0" />

                                                        </div>
                                                    </div>
                                                    <div class="row g-2 mt-2">
                                                        <div class="col">
                                                            <label class="form-label">Rent Breakup</label>
                                                            <div class="total-box mt-1">
                                                                <label class="form-label " style="font-size:14px; font-weight:300; margin-bottom:0px;">Total Owed: $ @(legalcaseDto.TotalOwed ?? 00)</label>
                                                            </div>

                                                            @foreach (var item in Rows)
                                                            {
                                                                <div class="row mb-3">
                                                                    <div class="col-4">
                                                                        <label class="form-label ">Month (YYYY-MM) </label>
                                                                        <InputSelect class="form-select holdover-form"
                                                                                     @bind-Value="item.Month"
                                                                                     @bind-Value:after="(() => OnMonthChanged(item))">

                                                                            <option value="">Select month</option>

                                                                            @foreach (var m in MonthOptions)
                                                                            {
                                                                                <option value="@m.Value">@m.Display</option>
                                                                            }

                                                                        </InputSelect>
                                                                    </div>
                                                                    <div class="col-3">
                                                                        <label class="form-label  ">Amount ($) </label>
                                                                        <InputNumber @bind-Value="item.Amount" @bind-Value:after="RecalculateTotal"
                                                                                     class="form-control" />
                                                                    </div>

                                                                    <div class="col-3">
                                                                        <label class="form-label  ">Notes </label>
                                                                        <InputText @bind-Value="item.Notes"
                                                                                   class="form-control" placeholder="Partial, vouchers, etc." />
                                                                    </div>

                                                                    <div class="col-2" style="justify-content:end; display:flex;">
                                                                        <button type="btn" class="remove-btn" @onclick="(() => RemoveRow(item))">
                                                                            Remove
                                                                        </button>
                                                                    </div>


                                                                </div>
                                                            }

                                                            <button type="btn" class="add-btn" @onclick="(() => AddRow())">
                                                                + Add Month
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>


                                    <div class="row">
                                        <div class="col">
                                            <div class=" mb-3">
                                                <div class="card-body">
                                                    <div class="row g-2 mb-3"  >
                                                        <!-- Tenancy Type -->
                                                        <div class="col-md-5">
                                                            <label class="form-label required-label" style="font-weight:600;">Tenancy Type</label>
                                                            <InputSelect class="form-select" @bind-Value="legalcaseDto.TenancyTypeId" @bind-Value:after="CalcNoticeDays" style="cursor:pointer;">
                                                                <option value="">-- Select Type --</option>
                                                                @foreach (var l in TenancyTypeList)
                                                                {
                                                                    <option value="@l.Id">@l.Name</option>
                                                                }
                                                            </InputSelect>
                                                            <ValidationMessage For="() => legalcaseDto.TenancyTypeId" />
                                                        </div>

                                                        <div class="col-md-5">
                                                            <label class="form-label required-label" style="font-weight:600;">Date Notice Served</label>
                                                            <RadzenDatePicker Style="width:100%; box-shadow:none" @bind-Value="legalcaseDto.DateNoticeServed" @bind-Value:after="CalcExpireAligned" />
                                                            <ValidationMessage For="() => legalcaseDto.DateNoticeServed" />

                                                        </div>
                                                    </div>
                                                    <div class="row g-2 mb-3"  >
                                                        <div class="col-md-5">
                                                            <label class="form-label" style="font-weight:600;">Calculated Notice Length</label>
                                                            <InputNumber class="form-control" @bind-Value="legalcaseDto.CalculatedNoticeLength" />
                                                        </div>
                                                        <div class="col-md-5">
                                                            <label class="form-label" style="display: flex; align-items: center;font-weight:600;">Expiration Date (Auto)</label>
                                                            <RadzenDatePicker Style="width:100%;" @bind-Value="legalcaseDto.ExpirationDate" />

                                                        </div>
                                                    </div>
                                                    <div class="row g-2 mb-3"  >
                                                        <div class="col-md-5">
                                                            <label class="form-label " style="height: 36px; display: flex;align-items: center;font-weight:600;">Predicate Notice (Auto) </label>
                                                            <InputText class="form-control" @bind-Value="legalcaseDto.PredicateNotice" />

                                                        </div>
                                                        <div class="col-md-5">
                                                            <label class="form-label" style="font-weight:600;">Good Cause Exemption Notice attached</label>
                                                            <div class="d-flex justify-content-start align-items-center  gap-2">
                                                                <InputRadioGroup @bind-Value="legalcaseDto.GoodCauseExempt">
                                                                    <div class="form-check d-flex justify-content-center gap-2">
                                                                        <InputRadio class="form-check-input" Value="true" style="font-size:15px" />
                                                                        <label class="form-check-label">Yes</label>
                                                                    </div>
                                                                    <div class="form-check  d-flex justify-content-center gap-2">
                                                                        <InputRadio class="form-check-input " Value="false" style="font-size:15px" />
                                                                        <label class="form-check-label">No</label>
                                                                    </div>
                                                                </InputRadioGroup>
                                                            </div>
                                                        </div>

                                                    </div>



                                                    <div class="row g-2 mb-3">
                                                        <div class="col-6">
                                                            <div class="form-check gap-2">
                                                                <InputCheckbox class="form-check-input" style="font-size:15px" @bind-Value="legalcaseDto.leasedAttached" />
                                                                <label class="form-check-label"> Leased Attached </label>
                                                            </div>
                                                        </div>

                                                        <div class="col-6">
                                                            <div class="form-check  gap-2">
                                                                <InputCheckbox class="form-check-input" style="font-size:15px" @bind-Value="legalcaseDto.ledgerAttached" />
                                                                <label class="form-check-label"> Ledger attached </label>
                                                            </div>

                                                        </div>
                                                        <div class="col-6">

                                                            <div class="form-check  gap-2">
                                                                <InputCheckbox class="form-check-input" style="font-size:15px" @bind-Value="legalcaseDto.NoticeproofAttached" />
                                                                <label class="form-check-label"> Notices proof attached </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">

                                                            <div class="form-check  gap-2">
                                                                <InputCheckbox class="form-check-input" style="font-size:15px" @bind-Value="legalcaseDto.RegistrationRentAttached" />
                                                                <label class="form-check-label">Registration/Rent history attached</label>
                                                            </div>
                                                        </div>

                                                    </div>
                                                    <div class="row g-2 mb-3">

                                                        @* <div class="col-12">
                                                            <label class="form-label" style="font-weight:600;">Good Cause Exemption Notice attached</label>
                                                            <div class="d-flex justify-content-start align-items-center  gap-2">
                                                                <InputRadioGroup @bind-Value="legalcaseDto.GoodCauseExempt">
                                                                    <div class="form-check d-flex justify-content-center gap-2">
                                                                        <InputRadio class="form-check-input" Value="true" style="font-size:15px" />
                                                                        <label class="form-check-label">Yes</label>
                                                                    </div>
                                                                    <div class="form-check  d-flex justify-content-center gap-2">
                                                                        <InputRadio class="form-check-input " Value="false" style="font-size:15px" />
                                                                        <label class="form-check-label">No</label>
                                                                    </div>
                                                                </InputRadioGroup>
                                                            </div>
                                                        </div> *

                                                        <div class="col-9">
                                                            <label class="form-label " style="font-weight:600;">Additional Comments </label>
                                                            <InputText class="form-control" @bind-Value="legalcaseDto.AdditionalComments" style="cursor:pointer;" />

                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>



                                    </div>



                                    <div style="display:flex; justify-content:end">
                                        <button type="submit" class="btn bg-navy text-white me-2" style="font-size:14px; background:#1F365D;margin-left:10px">Save</button>

                                    </div>
                                </EditForm>
                            }
                            else
                            {
                                <EditForm EditContext="_editContext" FormName="DocumentRemarks" OnSubmit="UpdateCase">

                                    <div class="row">
                                        <div class="col">
                                            <div class=" mb-3">
                                                @* <div class="card-header">
                                                <div style="font-weight:700" class="head">Documents & Remarks</div>
                                            </div> *
                                                <div class="card-body">

                                                    <div class="row g-2 mb-3">

                                                        <!-- Notice type -->
                                                        <div class="col-6">

                                                            <div class="form-check gap-2">
                                                                <InputCheckbox class="form-check-input" style="font-size:15px" @bind-Value="legalcaseDto.leasedAttached" />
                                                                <label class="form-check-label"> Leased Attached </label>
                                                            </div>
                                                        </div>

                                                        <div class="col-6">
                                                            <div class="form-check  gap-2">
                                                                <InputCheckbox class="form-check-input" style="font-size:15px" @bind-Value="legalcaseDto.ledgerAttached" />
                                                                <label class="form-check-label"> Ledger attached </label>
                                                            </div>

                                                        </div>
                                                        <div class="col-6">

                                                            <div class="form-check  gap-2">
                                                                <InputCheckbox class="form-check-input" style="font-size:15px" @bind-Value="legalcaseDto.NoticeproofAttached" />
                                                                <label class="form-check-label"> Notices proof attached </label>
                                                            </div>
                                                        </div>
                                                        <div class="col-6">

                                                            <div class="form-check  gap-2">
                                                                <InputCheckbox class="form-check-input" style="font-size:15px" @bind-Value="legalcaseDto.RegistrationRentAttached" />
                                                                <label class="form-check-label">Registration/Rent history attached</label>
                                                            </div>
                                                        </div>

                                                    </div>
                                                    <div class="row g-2 mb-3">

                                                        <div class="col-12">
                                                            <label class="form-label" style="font-weight:600;">Good Cause Exemption Notice attached</label>
                                                            <div class="d-flex justify-content-start align-items-center  gap-2">
                                                                <InputRadioGroup @bind-Value="legalcaseDto.GoodCauseExempt">
                                                                    <div class="form-check d-flex justify-content-center gap-2">
                                                                        <InputRadio class="form-check-input" Value="true" style="font-size:15px" />
                                                                        <label class="form-check-label">Yes</label>
                                                                    </div>
                                                                    <div class="form-check  d-flex justify-content-center gap-2">
                                                                        <InputRadio class="form-check-input " Value="false" style="font-size:15px" />
                                                                        <label class="form-check-label">No</label>
                                                                    </div>
                                                                </InputRadioGroup>
                                                            </div>
                                                        </div>

                                                        <div class="col-9">
                                                            <label class="form-label " style="font-weight:600;">Additional Comments </label>
                                                            <InputText class="form-control" @bind-Value="legalcaseDto.AdditionalComments" style="cursor:pointer;" />

                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>



                                    </div>
                                    <div style="display:flex; justify-content:end">
                                        <button type="submit" class="btn bg-navy text-white me-2" style="font-size:14px; background:#1F365D;margin-left:10px">Save</button>

                                    </div>
                                </EditForm>
                            }
 *@

                        </div>

                        <div class="tab-pane fade" id="billing" role="tabpanel" aria-labelledby="billing-tab">
                            <!-- CONTENT for Add Hearing -->
                            <EditForm EditContext="_editContext" FormName="billing" OnSubmit="UpdateCase">
                                <div class="row">
                                    <div class="col">
                                        <div class=" mb-3">
                                            <div class="card-body">
                                                <!-- Billing Type -->
                                                <div class="mb-3">
                                                    <label class="form-label fw-semibold">
                                                        @(legalcaseDto.CaseTypeName == "HPD" || legalcaseDto.CaseTypeName == "Illegal Lockout"
                                                                                                                ? "Billing Type"
                                                                                                                : "Rate / Compensation")  <span class="text-danger">*</span>
                                                    </label>

                                                    @if (legalcaseDto.CaseTypeName == "HPD" || legalcaseDto.CaseTypeName == "Illegal Lockout")
                                                    {
                                                        <div id="billingRadio" class="d-flex flex-wrap align-items-center gap-3">
                                                            @if (BilingTypesList != null && BilingTypesList.Any())
                                                            {
                                                                <InputRadioGroup @bind-Value="legalcaseDto.BilingTypeId" class="d-flex flex-wrap">
                                                                    <div class="d-flex align-items-center gap-4">

                                                                        @foreach (var Type in BilingTypesList)
                                                                        {
                                                                            <div class="d-flex align-items-center">

                                                                                <!-- Radio -->
                                                                                <InputRadio class="form-check-input me-2"
                                                                                            Value="@Type.Id"
                                                                                            id="@($"Type_{Type.Id}")" />

                                                                                <!-- Label -->
                                                                                <label class="form-check-label me-3" for="@($"Type_{Type.Id}")">
                                                                                    @Type.Name
                                                                                </label>
                                                                            </div>
                                                                        }

                                                                    </div>
                                                                </InputRadioGroup>
                                                                <ValidationMessage For="() => legalcaseDto.BilingTypeId" />
                                                            }

                                                        </div>


                                                        <!-- Invoice To -->
                                                        <div class="row mt-3">
                                                            <div class="col-md-6">
                                                                <label class="form-label fw-semibold">Invoice To</label>
                                                                <InputText type="text" class="form-control" name="invoiceTo" placeholder="Name or Organization" @bind-Value="legalcaseDto.InvoiceTo" />
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {

                                                        <div class="row">
                                                            <div class="col-12">
                                                                @if (BilingTypesList != null && BilingTypesList.Any())
                                                                {
                                                                    <InputRadioGroup @bind-Value="legalcaseDto.BilingTypeId" class="d-flex flex-wrap">
                                                                        <div class="d-flex align-items-center gap-4">

                                                                            @foreach (var Type in BilingTypesList)
                                                                            {
                                                                                <div class="d-flex align-items-center">

                                                                                    <!-- Radio -->
                                                                                    <InputRadio class="form-check-input me-2"
                                                                                                Value="@Type.Id"
                                                                                                id="@($"Type_{Type.Id}")"
                                                                                                @onclick="@(() => OnBillingTypeChanged(Type.Id))" />

                                                                                    <!-- Label -->
                                                                                    <label class="form-check-label me-3" for="@($"Type_{Type.Id}")">
                                                                                        @Type.Name
                                                                                    </label>

                                                                                    <!-- Input box (same horizontal line) -->
                                                                                    @if (legalcaseDto.BilingTypeId == Type.Id)
                                                                                    {
                                                                                        <input type="number"
                                                                                               class="form-control"
                                                                                               style="width: 180px;"
                                                                                               placeholder="@(Type.Name == "Flat Rate" ? "$" : "$ / hr")"
                                                                                               @bind="legalcaseDto.BilingTypeInputValue" />
                                                                                    }

                                                                                </div>
                                                                            }

                                                                        </div>


                                                                    </InputRadioGroup>
                                                                    <ValidationMessage For="() => legalcaseDto.BilingTypeId" />
                                                                }
                                                            </div>
                                                        </div>
                                                        <div class="row mt-3">
                                                            <div class="col-5">
                                                                <label class="form-label fw-semibold">Travel / Other Expenses </label>
                                                                <InputText class="form-control" placeholder="Optional" @bind-Value="legalcaseDto.TravelExpense" />
                                                            </div>
                                                            <div class="col-md-7">
                                                                <label class="form-label fw-semibold">Payment Method  <span class="text-danger">*</span></label>

                                                                <div id="reliefRespondentGroup" class="row">
                                                                    @if (PaymentMethodDtoList != null && PaymentMethodDtoList.Any())
                                                                    {
                                                                        <InputRadioGroup @bind-Value="legalcaseDto.PaymentMethodId" class="d-flex flex-wrap">
                                                                            @foreach (var method in PaymentMethodDtoList)
                                                                            {
                                                                                <div class="col-auto">
                                                                                    <div class="form-check mb-2">
                                                                                        <InputRadio class="form-check-input"
                                                                                                    id="@($"partyType_{method.Id}")"
                                                                                                    Value="@method.Id" />
                                                                                        <label class="form-check-label"
                                                                                               for="@($"method{method.Id}")">@method.Name</label>
                                                                                    </div>
                                                                                </div>
                                                                            }
                                                                        </InputRadioGroup>
                                                                        <ValidationMessage For="() => legalcaseDto.PaymentMethodId" />
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>

                                                    }
                                                </div>
                                            </div>

                                        </div>
                                    </div>



                                </div>

                                <div style="display:flex; justify-content:end">
                                    <button type="submit" class="btn bg-navy text-white me-2" style="font-size:14px; background:#1F365D;margin-left:10px">Save</button>

                                </div>
                            </EditForm>

                        </div>
                    </div>


                </div>




            </div>


        </div>

    </div>





</div>
<script>
    window.fileupload = {
        triggerInput: function (element) {
            element.click();
        },

         registerDropHandler: function (dropZoneElement, inputElement) {

        dropZoneElement.addEventListener("drop", function (event) {
            event.preventDefault();

            const dt = new DataTransfer();
            for (let i = 0; i < event.dataTransfer.files.length; i++) {
                dt.items.add(event.dataTransfer.files[i]);
            }

            inputElement.files = dt.files;
            inputElement.dispatchEvent(new Event("change"));
        });

        dropZoneElement.addEventListener("dragover", function (event) {
            event.preventDefault();
        });
    }
    };
</script>


@code {
    [Parameter] public GenrateNoticeModel createAction { get; set; } = new();
    [Parameter] public CaseNoticeInfoDto noticeModel { get; set; } = new();
    public Guid caseId { get; set; }
    private List<FormAddEditViewModelDto> FilteredFormTypeList = new();
    [Parameter] public IntakeModel legalcaseDto { get; set; } = new();
    [Parameter] public List<GenrateNoticeModel> CaseForms { get; set; } = new();
    [Parameter] public EventCallback OnFormCreate { get; set; } = new();
    private IEnumerable<ServiceMethod> ServiceMethodList = new List<ServiceMethod>();
    private IEnumerable<AppearanceMode> AppearanceModes = new List<AppearanceMode>();
    private IEnumerable<AppearanceTypeforHearing> AppearanceTypeforHearing = new List<AppearanceTypeforHearing>();
    private IEnumerable<AppearanceType> AppearanceTypes = new List<AppearanceType>();
    private IEnumerable<VirtualPlatform> VirtualPlatforms = new List<VirtualPlatform>();
    private IEnumerable<DocumentType> DocumentsType = new List<DocumentType>();
    private List<BilingType> BilingTypesList = new();
    private List<PaymentMethod> PaymentMethodDtoList = new();
    private List<TenancyType> TenancyTypeList = new();
    private List<DateRent> DateRentList = new();
    private CourtDto Court = new();

    private string? loggedInUserId;
    private string? MarshalName;
    private bool isAdmin = false;
    private bool isEditMode = false;
    private bool ShowAppearance = false;
    private bool ShowReminder = false;
    private MarshalDto selectedmarshal;
    private string searchmarshalText;
    private bool isMarshalAssigned = false;
    private List<MarshalDto> filteredmarshal = new();
    private GenrateNoticeModel caseForm = new();
    private List<CaseHearingDto> CaseHearings = new();
    private CaseHearingDto CaseHearing = new();
    private CaseDocumentDto Documentdto = new();
    private List<GenrateNoticeModel> caseFormDto = new();
    [Parameter] public Guid? CurrentCaseId { get; set; }
    private CancellationTokenSource _cts;
    private bool showMarshalError = false;
    private ValidationMessageStore messageStore;
    private EditContext _editContext;
    private bool _showCreateAction = false;

    [Parameter]
    public EventCallback OnClose { get; set; }
    // [Parameter] public EventCallback<CreateToClientDto> Submit { get; set; }
    public CaseHearingDto caseHearing = new CaseHearingDto();
    public class UploadItem
    {
        public IBrowserFile File { get; set; }
        public int Progress { get; set; } = 0;
    }




    protected override async Task OnInitializedAsync()
    {
        var authState = await _authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            loggedInUserId = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)?.Value;
            isAdmin = user.Claims.Any(c => c.Type == ClaimTypes.Role && c.Value == "Admin");
        }

        _editContext = new EditContext(noticeModel);
        messageStore = new ValidationMessageStore(_editContext);

        FilteredFormTypeList = await FormTypesRepository.GetFormTypesByCaseTypeAsync(legalcaseDto.CaseTypeId);

        caseHearing = new CaseHearingDto();
        caseHearing.HearingDate = DateTime.Now;
        caseHearing.HearingTime = TimeOnly.FromTimeSpan(TimeSpan.FromHours(10));
        if (!ServiceMethodList.Any()) ServiceMethodList = await _caseService.ServiceMethodList();
        if (!BilingTypesList.Any()) BilingTypesList = await CaseTypeRepository.GetAllBilingTypes();
        PaymentMethodDtoList = await CaseTypeRepository.GetAllPaymentMethod();
        if (!TenancyTypeList.Any()) TenancyTypeList = await TenancyTypeRepository.GetAllTenancyType();
        if (!DateRentList.Any()) DateRentList = await DateRentRepository.GetAllDateRent();
        AppearanceModes = await _caseHearingService.GetAllModes();
        AppearanceTypeforHearing = await _caseHearingService.GetAllAppearanceTypeForHearing();
        AppearanceTypes = await appearanceTypeRepository.GetAllAsync();
        VirtualPlatforms = await _caseHearingService.GetAllPlatform();
        if (legalcaseDto.CourtLocationId != null && legalcaseDto.CourtLocationId != Guid.Empty)
        {
            Court = await courtRepository.GetCourtByIdAsync(legalcaseDto.CourtLocationId!.Value);
        }

        var virtualMode = AppearanceModes
      .FirstOrDefault(x => x.Name.Equals("Virtual", StringComparison.OrdinalIgnoreCase));

        if (virtualMode != null)
        {
            caseHearing.AppearanceModeId = virtualMode.Id;
        }
        spinnerservice.Hide();
    }

    bool IsMotionOpen = true;
    bool IsBasicHearingOpen = true;
    bool IsAppearanceformatOpen = false;
    bool IsDatetime = false;
    bool IsInternalNotes = false;
    bool IsRentOpen = false;
    bool IsLedgerOpen = false;
    bool LastdateSelected = false;
    bool IsothersOpen = false;
    bool IsBillingopen = false;
    bool IsNoticeOpen = false;
    bool IsAttachmentOpen = false;
    bool IsCommentsOpen = false;

    void Toggle(string section)
    {
        switch (section)
        {
            case nameof(IsMotionOpen): IsMotionOpen = !IsMotionOpen; break;
            case nameof(IsRentOpen): IsRentOpen = !IsRentOpen; break;
            case nameof(IsBasicHearingOpen): IsBasicHearingOpen = !IsBasicHearingOpen; break;
            case nameof(IsAppearanceformatOpen): IsAppearanceformatOpen = !IsAppearanceformatOpen; break;
            case nameof(IsInternalNotes): IsInternalNotes = !IsInternalNotes; break;
            case nameof(IsDatetime): IsDatetime = !IsDatetime; break;
            case nameof(IsothersOpen): IsothersOpen = !IsothersOpen; break;
            case nameof(IsBillingopen): IsBillingopen = !IsBillingopen; break;
            case nameof(IsLedgerOpen): IsLedgerOpen = !IsLedgerOpen; break;
            case nameof(IsNoticeOpen): IsNoticeOpen = !IsNoticeOpen; break;
            case nameof(IsAttachmentOpen): IsAttachmentOpen = !IsAttachmentOpen; break;
            case nameof(IsCommentsOpen): IsCommentsOpen = !IsCommentsOpen; break;
        }
    }

    private bool IsVirtualMode
    {
        get
        {
            var selectedMode = AppearanceModes
                .FirstOrDefault(x => x.Id == caseHearing.AppearanceModeId);

            return selectedMode?.Name?.ToLower() == "virtual";
        }
    }


    void OnBillingTypeChanged(Guid id)
    {
        legalcaseDto.BilingTypeId = id;

        // Input reset jab Flat → Hourly switch hota hai
        legalcaseDto.BilingTypeInputValue = null;
    }
    private async Task OnMarshalTabOpen()
    {

        await LoadMarshalUI();

        StateHasChanged();
    }
    private async Task GetAllDocuments()
    {

        if (!DocumentsType.Any()) DocumentsType = await DocRepo.GetAllAsync();

        StateHasChanged();
    }
    private int ParseDueDay(string str)
    {
        if (string.IsNullOrWhiteSpace(str)) return 1;
        if (int.TryParse(str, out var d)) return Math.Clamp(d, 1, 31);
        return 1;
    }
    private void CalcExpireAligned()
    {
        int dueDay = ParseDueDay(
            DateRentList.FirstOrDefault(x => x.Id == legalcaseDto.RentDueEachMonthOrWeekId)?.Name
        );

        int? days = legalcaseDto.CalculatedNoticeLength;
        var servedISO = ToDateTime(legalcaseDto.DateNoticeServed);

        // Null check
        if (!servedISO.HasValue || !days.HasValue || days.Value <= 0)
        {
            legalcaseDto.ExpirationDate = null;
            return;
        }

        // *** FIX: Initialize target here ***
        DateTime target = servedISO.Value.AddDays(days.Value);

        DateOnly expiration;

        if (dueDay == 1)
        {
            expiration = new DateOnly(
                target.Year,
                target.Month,
                DateTime.DaysInMonth(target.Year, target.Month)
            );
        }
        else
        {
            expiration = new DateOnly(target.Year, target.Month, dueDay - 1);
        }

        legalcaseDto.ExpirationDate = expiration;
    }
    private DateTime? ToDateTime(DateOnly? date)
    {
        return date.HasValue ? date.Value.ToDateTime(TimeOnly.MinValue) : (DateTime?)null;
    }

    private void CalcNoticeDays()
    {
        if (legalcaseDto.CaseTypeName == "Holdover")
        {
            Console.WriteLine("1");
            if (legalcaseDto.DateTenantMoved != null && noticeModel.TenancyTypeId != null)
            {
                Console.WriteLine("2");

                int length = 0;

                var type = TenancyTypeList
                    .Where(a => a.Id == noticeModel.TenancyTypeId)
                    .Select(e => e.Name?.ToLower())
                    .FirstOrDefault();

                // ✅ Special case tenancy types get fixed 10 days
                if (new[] { "squatter", "licensee", "referee" }.Contains(type))
                {
                    length = 10;
                }
                else
                {
                    // ✅ Otherwise calculate by years
                    var yrs = DiffYears(legalcaseDto.DateTenantMoved?.ToDateTime(TimeOnly.MinValue), DateTime.Today);

                    if (yrs < 1)
                        length = 30;
                    else if (yrs < 2)
                        length = 60;
                    else
                        length = 90;
                }

                noticeModel.CalcNoticeLength = length;

                // ✅ Set PredicateNotice text
                noticeModel.PredicateNotice = type switch
                {
                    "licensee" => "10 Days Notice - Tenant Of Record Vacated (Licensee)",
                    "referee" => "10 Days Notice - Referee Deed / Prior Owner",
                    "squatter" => "10 Days Notice - Squatter / Intruder",
                    "month-to-month" => $"{length} Days Notice - Month to Month",
                    _ => ""
                };
            }
        }
    }
    private int DiffYears(DateTime? from, DateTime? to)
    {
        if (!from.HasValue || !to.HasValue) return 0;
        return (int)((to.Value - from.Value).TotalDays / 365);
    }

    private async Task LoadMarshalUI()
    {
        if (legalcaseDto.MarshalId != null && legalcaseDto.MarshalId != Guid.Empty)
        {
            selectedmarshal = await _marshalService.GetMarshalByIdAsync(legalcaseDto.MarshalId.Value);
            isMarshalAssigned = true;
        }
        else
        {
            isMarshalAssigned = false;
            selectedmarshal = null;
            searchmarshalText = string.Empty;
        }
    }

    async Task HideMarshalDropDown(FocusEventArgs e)
    {
        // Small delay to allow click on dropdown item to register before hiding
        await Task.Delay(500);
        if (filteredmarshal.Any())
        {
            filteredmarshal.Clear();

        }
        StateHasChanged();
    }

    private async void Selectedmarshal(MarshalDto marshal)
    {

        selectedmarshal = marshal;
        // searchmarshalText = marshal.Name!;
        searchmarshalText = $"{marshal.FirstName} {marshal.LastName}";


        legalcaseDto.MarshalId = marshal.Id;


        filteredmarshal?.Clear();
        // isMarshalAssigned = true;

        StateHasChanged();


    }

    private void ResetMarshal()
    {
        spinnerservice.Show();
        isMarshalAssigned = false;
        selectedmarshal = null;
        legalcaseDto.MarshalId = null;     // Marshal unassign
        searchmarshalText = "";            // Clear search box
        filteredmarshal?.Clear();
        showMarshalError = false;// Clear list

        StateHasChanged();
        spinnerservice.Hide();
    }


    private async Task OnSearchMarshalInput(ChangeEventArgs e)
    {
        searchmarshalText = e.Value?.ToString() ?? "";
        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        try
        {

            await Task.Delay(300, _cts.Token);
            // ⭐ Empty input → load all tenants (ONLY here)
            if (string.IsNullOrWhiteSpace(searchmarshalText))
            {
                await ShowAllmarshal();
                return;
            }

            // ⭐ 1st & 2nd character → DO NOTHING (keep list unchanged)
            if (searchmarshalText.Length < 3)
            {
                // ❗ No reload here (important)
                return;
            }

            else
            {
                // ⭐ 3+ characters → server search

                filteredmarshal = await _marshalService.SearchMarshalbyname(searchmarshalText);
            }

        }
        catch (TaskCanceledException)
        {
            // Old task cancelled → ignore
        }

    }

    private async Task ShowAllmarshal()
    {
        filteredmarshal = (await _marshalService.GetAllMarshalAsync()).ToList();
        StateHasChanged(); // UI refresh karega
    }


    private async Task SubmitMarshal()
    {
        showMarshalError = false; // reset old errors

        if (legalcaseDto.MarshalId == null || legalcaseDto.MarshalId == Guid.Empty)
        {
            showMarshalError = true;
            StateHasChanged();
            return;
        }
        spinnerservice.Show();

        var result = await _service.UpdateMarshalAsync(legalcaseDto);

        if (result)
        {
            ToastService.ShowSuccess("Marshal Assign  successfully!");
            // await LoadCaseDetails();
            isMarshalAssigned = true;
        }
        else
        {
            ToastService.ShowError("Failed to asign Marshal .");
        }
        StateHasChanged();
        spinnerservice.Hide();

    }
    private async Task<bool> ValidateCurrentStep()
    {
        messageStore.Clear();

        if (legalcaseDto.CaseTypeName == "Holdover")
        {
            Require(() => noticeModel.TenancyTypeId, nameof(noticeModel.TenancyTypeId), "Tenancy type required");
            Require(() => noticeModel.DateNoticeServed, nameof(noticeModel.DateNoticeServed), "Notice Serve Date required");
            Require(() => noticeModel.DateRentId, nameof(noticeModel.DateRentId), "Select Date Rent required");
            Require(() => noticeModel.MonthlyRent, nameof(noticeModel.MonthlyRent), "Monthly Rent required");
        }


        _editContext.NotifyValidationStateChanged();

        // Get current validation messages (optional: for logging)
        var errors = _editContext.GetValidationMessages().ToList();
        Console.WriteLine($"Validation errors : {string.Join(", ", errors)}");

        // Check if form is valid
        bool isValid = !_editContext.GetValidationMessages().Any();

        // Return validity
        return isValid;
    }
    private void Require<T>(Expression<Func<T>> accessor, string fieldName, string message)
    {
        var value = accessor.Compile().Invoke();
        var fieldIdentifier = new FieldIdentifier(legalcaseDto, fieldName);

        // Clear old message first
        messageStore.Clear(fieldIdentifier);

        // Add message if invalid
        bool isEmpty = value == null ||
                       (value is string s && string.IsNullOrWhiteSpace(s)) ||
                       (value is Guid g && g == Guid.Empty);

        if (isEmpty)
        {
            messageStore.Add(fieldIdentifier, message);
        }

        _editContext.NotifyValidationStateChanged();
    }


    private List<UploadItem> UploadItems = new();


    private void OnBindHearingCancel()
    {
        caseHearing = new CaseHearingDto();
        caseHearing.HearingDate = DateTime.Now;
        caseHearing.HearingTime = TimeOnly.FromTimeSpan(TimeSpan.FromHours(10));
    }
    private async Task SaveHearingChanges()
    {
        spinnerservice.Show();

        var newHearing = new CaseHearingDto()
        {
            Caption = caseHearing.Caption,
            LegalCaseId = legalcaseDto.Id,
            CourtPartId = caseHearing.CourtPartId,
            CourtId = legalcaseDto.CourtLocationId,
            HearingDate = caseHearing.HearingDate,
            HearingTime = caseHearing.HearingTime,
            CreatedBy = Guid.Parse(loggedInUserId),
            AppearanceModeId = caseHearing.AppearanceModeId,
            AppearanceTypeForHearingId = caseHearing.AppearanceTypeForHearingId,
            VirtualPlatformId = caseHearing.VirtualPlatformId,
            Virtuallink = caseHearing.Virtuallink,
            LastAction = caseHearing.LastAction,
            // CallIn = caseHearing.CallIn,
            // Phone = caseHearing.Phone,
            // VirtualLink = caseHearing.VirtualLink,
            // Notes = caseHearing.Notes
        };

        var CourtId = await _caseHearingService.AddHearing(newHearing);

        if (CourtId)
        {
            ToastService.ShowSuccess("Hearing details Added successfully!");
            await OnFormCreate.InvokeAsync();
        }
        else
        {
            ToastService.ShowError("Failed to create Hearing details.");
        }
        LoadHearing();
        HideAsync();

        spinnerservice.Hide();
    }


    // private async Task SaveCaseNotes()
    // {
    //     spinnerservice.Show();

    //     var result = await _service.UpdateNotesAsync(legalcaseDto);

    //     if (result)
    //     {
    //         ToastService.ShowSuccess("Hearing details Added successfully!");
    //         // await LoadCaseDetails();
    //     }
    //     else
    //     {
    //         ToastService.ShowError("Failed to create Hearing details.");
    //     }
    //     StateHasChanged();
    //     spinnerservice.Hide();
    // }

    private ElementReference dropZoneRef;
    private InputFile? fileInput;
    private List<IBrowserFile> Files = new();
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("fileupload.registerDropHandler", dropZoneRef, fileInput!.Element);
        }
    }

    private async Task OpenFileDialog()
    {
        await JS!.InvokeVoidAsync("fileupload.triggerInput", fileInput!.Element);
    }

    private void OnDragOver(DragEventArgs e)
    {
        e.DataTransfer.DropEffect = "copy";
    }

    private async Task OnDrop(DragEventArgs e)
    {
        // send dropped files to <input type="file">
        await JS!.InvokeVoidAsync("fileupload.addDroppedFiles", fileInput!.Element);
    }
    private void OnInputChanged(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            var item = new UploadItem
            {
                File = file,
                Progress = 0
            };

            UploadItems.Add(item);
            Files.Add(file);

            // Simulate upload progress (replace with real API upload later)
            _ = SimulateProgressAsync(item);
        }
    }

    private async Task SimulateProgressAsync(UploadItem item)
    {
        while (item.Progress < 100)
        {
            item.Progress += 5;
            await Task.Delay(100);
            StateHasChanged();
        }
    }

    private void RemoveUploadItem(UploadItem item)
    {
        UploadItems.Remove(item);
        Files.Remove(item.File);
        StateHasChanged();
    }

    private async Task LoadHearing()
    {
        CaseHearings = await _caseHearingService.GetAllCaseHeariingByCaseIdAsync(CurrentCaseId.Value);
        if (CaseHearings.Any())
        {
            CaseHearing = CaseHearings.FirstOrDefault()!;
        }

    }
    private async Task GenerateNotice()
    {
        spinnerservice.Show();

        noticeModel.LegalCaseId = legalcaseDto.Id;
        legalcaseDto.BillAmount = (legalcaseDto.BillAmount ?? 0) + (noticeModel.BillAmount ?? 0);

        var successcase = await _service.UpdateCaseAsync(legalcaseDto);
        if (!successcase.HasValue)
        {
            return;
        }
        else
        {

            noticeModel.BillAmount = null;
        }

        if (CurrentCaseId.HasValue && CurrentCaseId.Value != Guid.Empty && noticeModel.FormTypeId.HasValue)
        {
            bool success = false;

            var infosuccess = await _service.AddOrUpdateCaseNoticeInfo(noticeModel);
            if (Rows.Count > 0)
            {
                var addrows = Rows.Where(e => (e.Id == null || e.Id == Guid.Empty) && (e.Amount != null || e.Month != null)).Select(e => new ArrearLedgerDto()
                {
                    LegalCaseId = legalcaseDto.Id,
                    CaseNoticeId = infosuccess ?? null,
                    Notes = e.Notes,
                    Amount = e.Amount,
                    Month = e.Month,
                }).ToList();
                if (addrows.Any())
                {
                    await _service.AddArrearLedgerAsync(addrows);
                }

                var updaterows = Rows.Where(e => e.Id != null && e.Id != Guid.Empty).Select(e => new ArrearLedgerDto()
                {
                    LegalCaseId = legalcaseDto.Id,
                    CaseNoticeId = infosuccess ?? null,
                    Notes = e.Notes,
                    Amount = e.Amount,
                    Month = e.Month,
                }).ToList();
                if (updaterows.Any())
                {
                    await _service.UpdateArrearLedgerAsync(updaterows);
                }
            }

            if (isEditMode)
            {
                // UPDATE existing notice
                success = await _CaseFormService.UpdateCaseFormAsync(new GenrateNoticeModel
                {
                    Id = createAction.Id,
                    LegalCaseId = CurrentCaseId.Value,
                    FormTypeId = createAction.FormTypeId,
                    File = createAction.File,
                    HTML = createAction.HTML,
                    CreatedOn = createAction.CreatedOn
                });

                if (success)
                {
                    ToastService.ShowSuccess("Notice has been updated successfully!");
                }
            }
            else
            {
                // CREATE new notice
                success = await CaseFormRepository.GenerateNoticeAsync(
                    CurrentCaseId.Value,
                    noticeModel.FormTypeId.Value,
                       Guid.Parse(loggedInUserId)
                );

                if (success)
                {
                    ToastService.ShowSuccess("Notice has been generated successfully!");
                }
            }

            if (success)
            {
                await LoadCaseForms();

                // Reset form
                createAction = new GenrateNoticeModel();
                isEditMode = false;
                CurrentCaseId = caseId;
                await OnFormCreate.InvokeAsync();
                await JS.InvokeVoidAsync("openTab", "activity");
            }
        }
        else
        {

        }

        spinnerservice.Hide();
    }
    private readonly string[] AllowedExtensions = { ".pdf", ".doc", ".docx" };

    private async Task SaveFiles()
    {
        if (legalcaseDto.Id == null || legalcaseDto.Id == Guid.Empty)
        {
            ToastService.ShowError("Invalid Case ID.");
            Files.Clear();
            return;
        }

        if (!Files.Any())
        {
            ToastService.ShowWarning("Please select files to upload.");
            Files.Clear();
            return;
        }

        // Check allowed file types
        foreach (var file in Files)
        {
            var extension = Path.GetExtension(file.Name).ToLower();
            if (!AllowedExtensions.Contains(extension))
            {
                ToastService.ShowWarning($" Only PDF and DOC/DOCX are permitted.");
                Files.Clear();
                return; // stop uploading
            }
        }

        var uploadPath = Path.Combine(Environment.CurrentDirectory, "wwwroot", "uploads");
        if (!Directory.Exists(uploadPath))
            Directory.CreateDirectory(uploadPath);

        var DocList = new List<CaseDocument>();

        foreach (var file in Files)
        {
            var extension = Path.GetExtension(file.Name);
            var baseName = Path.GetFileNameWithoutExtension(file.Name);

            // Add DateTime stamp to filename
            var dateStamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            var newFileName = $"{baseName}_{dateStamp}{extension}";

            var physicalPath = Path.Combine(uploadPath, newFileName);

            // Save the file physically
            await using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024 * 200);
            await using var fs = new FileStream(physicalPath, FileMode.Create);
            await stream.CopyToAsync(fs);

            // Save DB record
            var document = new CaseDocument
            {
                Id = Guid.NewGuid(),
                LegalCaseId = CurrentCaseId.Value,
                DocumentTypeId = Documentdto.DocumentTypeId,
                Name = newFileName,
                Path = $"uploads/{newFileName}",   // Relative path for web access
                CreatedOn = DateTime.Now
            };

            DocList.Add(document);
        }

        var result = await _service.AddDocumentAsync(DocList);
        if (result)
        {
            ToastService.ShowSuccess("Documents saved successfully!");
            Files.Clear();
            UploadItems.Clear();
            await OnFormCreate.InvokeAsync();
        }
        else
        {
            ToastService.ShowError("An error occurred during saving!");
        }
    }
    public record MonthItem(string Value, string Display);
    private List<MonthItem> MonthOptions = new();
    private List<ArrearLedgerDto> Rows = new();
    private bool LastDaterentfilled = false;
    private bool NoticeSelected = false;
    private void OnMonthChanged(ArrearLedgerDto row)
    {
        StateHasChanged();
    }

    private void RecalculateTotal()
    {
        noticeModel.Totalowed = (int)Rows.Sum(x => x.Amount);
        StateHasChanged();
    }

    private void AddRow()
    {
        Rows.Add(new ArrearLedgerDto());
    }

    private void RemoveRow(ArrearLedgerDto row)
    {
        Rows.Remove(row);
    }

    private void OnAmountChanged(ArrearLedgerDto row, double value)
    {

        row.Amount = value;
        StateHasChanged();
    }

    private void GenerateMonths()
    {
        MonthOptions.Clear();
        LastDaterentfilled = true;

        if (noticeModel.DateofLastPayment is null)
            return;

        LastdateSelected = true;
        IsLedgerOpen = true;
        DateTime start = new DateTime(
            noticeModel.DateofLastPayment.Value.Year,
            noticeModel.DateofLastPayment.Value.Month,
            1);

        DateTime end = new DateTime(
            DateTime.Today.Year,
            DateTime.Today.Month,
            1);

        // Iterate month-by-month
        for (DateTime dt = start; dt <= end; dt = dt.AddMonths(1))
        {
            string value = $"{dt:yyyy-MM}"; // stored value
            string display = $"{dt:yyyy}-{CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(dt.Month)}";

            MonthOptions.Add(new MonthItem(value, display));
        }
        if (Rows.Any())
        {
            if (Rows.Last().Month != null)
            {
                Rows.Add(new ArrearLedgerDto());
            }
        }

        if (!Rows.Any())
        {
            Rows.Add(new ArrearLedgerDto());
        }

    }

    private async Task UpdateCase()
    {
        if (!await ValidateCurrentStep()) return;
        spinnerservice.Show();


        legalcaseDto.BillAmount = (legalcaseDto.BillAmount ?? 0) + (createAction.BillAmount ?? 0);

        var successcase = await _service.UpdateCaseAsync(legalcaseDto);
        if (successcase.HasValue)
        {
            ToastService.ShowSuccess("Case updated successfully!");
        }
        else
        {
            ToastService.ShowError("An error occurred during updating!");
        }

        spinnerservice.Hide();
    }


    private async Task LoadCaseForms()
    {
        caseFormDto = await _CaseFormService.GetCaseFormsByCaseId(CurrentCaseId.Value, loggedInUserId, isAdmin);
        if (caseFormDto.Any())
        {
            caseForm = caseFormDto.FirstOrDefault()!;
        }
    }

    public async Task EditCaseDetail(Guid id)
    {
        spinnerservice.Show();
        var result = await _CaseFormService.GetCaseFormByIdAsync(id);

        if (result != null)
        {
            createAction = new GenrateNoticeModel
            {
                Id = result.Id,
                FormTypeId = result.FormTypeId,
                File = result.File,
                HTML = result.HTML,
                CreatedOn = result.CreatedOn,
            };
            isEditMode = true;

        }
        spinnerservice.Hide();
        await JS.InvokeVoidAsync("showBootstrapTab", "#actions-tab");
    }

    private void FormTypeBindAfter()
    {
        var selectedForm = FilteredFormTypeList
            .FirstOrDefault(f => f.Id == noticeModel.FormTypeId);

        if (selectedForm != null)
            noticeModel.BillAmount = Convert.ToDecimal(selectedForm.Rate);
        else
            noticeModel.BillAmount = null;

        NoticeSelected = true;
        StateHasChanged(); // ensure UI refreshes
    }

    public async Task HideAsync()
    {


        await OnClose.InvokeAsync();
        StateHasChanged();
    }

}


