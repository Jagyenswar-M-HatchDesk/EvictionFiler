@page "/Settings/users"
@using EvictionFiler.Application.DTOs
@using EvictionFiler.Application.DTOs.PaginationDto
@using EvictionFiler.Application.DTOs.UserDto
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Client.SpinnerService
@using EvictionFiler.Domain.Entities
@using Microsoft.AspNetCore.Authorization
@inject IUserservices _userService
@inject SpinnerService spinnerservice
<PageTitle>Users - Housing Court Filer</PageTitle>
@attribute [Authorize]
<!-- Bootstrap CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />

<style>
    .status-active {
    background-color: #28a745;
    color: #fff;
    padding: 2px 7px;
    border-radius: 1rem;
    font-size: 10px;
    }

    .container {
    /* background-color: #F2F0EC; */
    border: solid 1px #F2F0EC;
    box-shadow: 0 15px 20px #F2F0EC !important;
    max-width:100%;
    }

    .btn-primary {
    background-color: #1F365D;
    border-color: #1F365D;
    }

    .btn-primary:hover {
    background-color: #162646;
    border-color: #162646;
    }

    .page-link {
    color: #1F365D;
    }

    .page-link.active,
    .page-item.active .page-link {
    background-color: #1F365D;
    border-color: #1F365D;
    color: #F2F0EC;
    }

    table.table thead th {
    color: #1F365D;
    background: #F2F0EC;
    margin-bottom: 0px !important;
    }

    h5, p, small {
    color: #1F365D;
    }

    .adv-btn {
    color: #1F365D;
    background: #FFF;
    }

    .adv-btn:hover {
    color: #FFF;
    background: #1F365D;
    }

    .adv-btn.active-adv-btn {
    background-color: #1F365D !important;
    color: #F2F0EC !important;
    border-color: #1F365D !important;
    }
    .add-btn
    {
        font-size:14px;
        font-family:'Poppins';
    }

    .table-responsive {
    overflow-x: auto; /* Enable horizontal scroll */
    position: relative;
        white-space: nowrap;
    }

    

    th.sticky, td.sticky {
    position: sticky;
    right: 0;
    background: #F2F0EC; /* Same as container background */
    z-index: 2;
    text-align: center;
    }

    /* Make sure header sticky stays above other cells */
    th.sticky {
    z-index: 3;
    }
    .border
    {
        border: 1px solid #1F365D !important;
        border-radius: 12px;
        min-height:45px;
    }
</style>
<style>
    .search-box {
    width: 100%;
    padding-right: 3rem; /* space for the button */
    padding-left: 1rem;
    /* border-radius: 1.5rem; */
    border: 2px solid #1F365D;
    background-color: #FFF; /* dark background */
    color: black;
    height: 2.5rem;
    }

    .search-box::placeholder {
    color: darkgrey;
    }

    .search-box:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
    background: #c6d1e3;
    }

    .search-btn {
    position: absolute;
    right: 0.7rem;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: none;
    color: #1F365D;
    cursor: pointer;
    padding: 0;
    font-size: 1.2rem;
    }

    .search-btn:hover {
    color: #1F365D;
    }
    .head
    {
        font-weight: 700;
    }

    .role-card {
        display: flex;
        flex-direction: column;
        border-radius: 16px;
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.06);
        border: none;
        height: 100%;
        transition: transform .25s ease;
    }

    /* .case-card:hover {
                transform: translateY(-5px);
            } */

    .role-header {
        background: #1F365D;
        color: #fff;
        padding: 10px 11px;
        border-radius: 16px 16px 0 0;
        font-size: 16px;
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .role-body {
        padding: 10px;
        font-size: 15px;
        flex-grow: 1;
    }

        .role-body .title {
            font: 500 16px 'Lato';
            color: #1F365D;
        }

        .role-body .value {
            font: 500 14px 'Lato';
            color: #1F365D;
            text-align: right;
        }

    /* -------------------------------------------------------
                   Info Rows (Bottom Data)
                --------------------------------------------------------*/
    .card-footer-data {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .label-1 {
        font: 500 16px 'Lato';
        color: #1F365D;
    }

    .value-1 {
        font: 500 14px 'Lato';
        color: #1F365D;
    }

    .btn-grid {
        border-top-right-radius: 0px !important;
        border-bottom-right-radius: 0px !important;
    }

    .btn-table {
        border-top-left-radius: 0px !important;
        border-bottom-left-radius: 0px !important;
    }
</style>


<body class="p-4">

    <div class="container p-4 rounded shadow-sm">

        <!-- Title Row -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="m-0 head">Manage Users</h5>
       

        <!-- Search Filters -->
        <div class="g-2 mb-3 d-flex align-items-center gap-2 ">
            <!-- Four default search boxes -->
            <button class="btn btn-primary add-btn" @onclick="AddUser">Add New</button>

            <div class="d-flex justify-content-end gap-1"></div>
            <div class="btn-group view-toggle">
                <button id="cardViewBtn" class=@(IsGridView ? "btn btn-primary btn-grid btn-sm" : "btn btn-grid btn-outline-secondary btn-sm") @onclick="OnViewTypeChange">
                    <i class="bi bi-grid"></i>
                </button>
                <button id="tableViewBtn" class=@(IsGridView ? "btn btn-table btn-outline-secondary btn-sm" : "btn btn-table btn-primary btn-sm") @onclick="OnViewTypeChange">
                    <i class="bi bi-table"></i>
                </button>
            </div>
            <div class="position-relative w-50">
                <input class="form-control border border-primary text-navy" placeholder="Search.." @bind="searchTerm" @oninput="OnSearchChanged"  />
                <button class="search-btn" type="button">
                    <i class="fa fa-search"></i>
                </button>
            </div>
            </div>
            </div>

           

        @if (IsGridView)
        {
            <div class="row g-4">
                @{
                    int srNo = 1;
                }
                @if (pagedUsers != null && pagedUsers.Items.Any())
                {

                    @foreach (var user in pagedUsers.Items)
                    {


                        <div class="col-md-6 col-xl-4">
                            <div class="card role-card">
                                <div class="role-header">
                                    <div class="d-flex align-items-center gap-2">




                                        @* <span class="badge badge-type" style="margin-bottom:0px !important">
                                                @(cas.IsActive == true? "Active" : cas.IsDeleted == true ? "InActive" : "Not Set")
                                                </span> *@
                                        <span class="badge badge-type
                                                                                                                                         @(user.IsActive ? "bg-success text-white" : user.IsDeleted == true ? "bg-secondary text-white" : "bg-warning text-dark")" style="margin-bottom:0px !important">
                                            @(user.IsActive ? "Active" : user.IsDeleted == true ? "InActive" : "Not Set")
                                        </span>



                                    </div>

                                    <div class="role-actions d-flex">

                                        <i class="fa-solid fa-pen-to-square text-navy me-2" style="cursor:pointer"
                                           @onclick="@(() => EditUser(user))"
                                           title="Edit"></i>
                                        @* <i class="fa-solid fa-trash-can text-navy  me-2" title="Delete" style="cursor:pointer" @onclick="@(() => DeleteRole(role.Id))"></i> *@

                                    </div>
                                </div>
                                <div class="role-body">
                                    <div class="mt-2 mb-1 row"><span class="col-auto title">Name: </span><span class="col value">@($"{user.FirstName} {user.LastName}" ?? "")</span></div>
                                    <div class="mb-1 row"><span class="col-auto title">FirmName: </span><span class="col value">@(user.Firms?.Name ?? "")</span></div>
                                    <div class="mb-1 row"><span class="col-auto title">Email: </span><span class="col value">@(user.Email ?? "")</span></div>
                                    <div class="mb-1 row"><span class="col-auto title">Phone: </span><span class="col value">@(user.PhoneNumber ?? "")</span></div>



                                </div>
                                <hr style="margin:0;" />
                                <div class="row p-3">
                                    <div class="col-12" style="align-content:end;">
                                        @if (user.UpdatedOn == null)
                                        {
                                            <div class="card-footer-data" style="margin-bottom:0px"><span class="label-1">Created On: </span><span class="value-1">@user.CreatedOn?.ToString(DateFormats.Default)</span></div>
                                        }
                                        else
                                        {
                                            <div class="card-footer-data" style="margin-bottom:0px"><span class="label-1">Updated On:  </span><span class="value-1">@user.UpdatedOn?.ToString(DateFormats.Default)</span></div>
                                        }
                                    </div>
                                    </div>
                            </div>
                        </div>

                        srNo++;
                    }
                }
                else
                {

                    <p class="text-muted text-center fs-5">No Cases found.</p>

                }

            </div>
        }
        else
        {
        <!-- Data Table -->
        <div class="table-responsive mb-3">
            <table class="table table-hover align-middle text-center" style="margin-bottom: 0px;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Firm Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Phone</th>
                        <th>Created At</th>
                        <th class="sticky">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @* <tr>
                        <td>Jagyenswar</td>
                        <td>Meher</td>
                        <td>jm@gmail.com</td>
                        <td>7723099993</td>
                        <td>Property Manager</td>
                        <td>06-27-2025</td>
                        <td class="sticky"><i class="fa-solid fa-pen-to-square"></i><span class="status-active ms-2">Active</span></td>
                    </tr>
                    <tr>
                        <td>Siddharth</td>
                        <td>Kanoujia</td>
                        <td>sk@gmail.comL</td>
                        <td>7988324752</td>
                        <td>Property Manager</td>
                        <td>06-27-2025</td>
                        <td class="sticky"><i class="fa-solid fa-pen-to-square"></i><span class="status-active ms-2">Active</span></td>
                    </tr> *@
                        @if (pagedUsers != null && pagedUsers.Items.Any())
                    {
                        @foreach (var user in pagedUsers.Items)
                        {
                            if (user != null)
                            {
                                <tr>
                                    <td>@($"{user.FirstName} {user.LastName}" ?? "")</td>
                                    <td>@(user.Firms?.Name ?? "")</td>
                                    <td>@(user.Email ?? "")</td>
                                    @if (user.Role?.Name == "Admin")
                                    {
                                        <td>Firm Admin</td>

                                    }
                                    else
                                    {
                                        <td>@(user.Role?.Name ?? "")</td>

                                    }
                                    <td>@(user.PhoneNumber ?? "")</td>
                                    <td>@(user?.CreatedOn?.ToString(DateFormats.Default))</td>
                                    <td class="sticky"><i class="fa-solid fa-pen-to-square" style="cursor:pointer" @onclick="() => EditUser(user)"></i><span class="status-active ms-2">Active</span></td>
                                </tr>
                            }
                        }

                    }
                    else
                    {
                        <tr>
                            <td colspan="7" class="text-muted">No Users found.</td>
                        </tr>
                    }
                    <!-- repeat more data here -->
                </tbody>
            </table>
        </div>

        
        }
        @if (pagedUsers != null && pagedUsers.TotalCount > 0)
        {
            <div class="d-flex justify-content-between mt-3">
                <small style="font-size:14px">
                    Showing @(((currentPage - 1) * pageSize) + 1)
                    to @(Math.Min(currentPage * pageSize, pagedUsers.TotalCount))
                    of @pagedUsers.TotalCount entries
                </small>
                <nav>
                    <ul class="pagination mb-0" style="font-size:14px">
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">←</button>
                        </li>
                        @for (int i = 1; i <= Math.Ceiling((double)pagedUsers.TotalCount / pageSize); i++)
                        {
                            var pageNumber = i;
                            <li class="page-item @(pageNumber == currentPage ? "active" : "")">
                                <button class="page-link" @onclick="() => ChangePage(pageNumber)">@pageNumber</button>
                            </li>
                        }
                        <li class="page-item @(currentPage == Math.Ceiling((double)pagedUsers.TotalCount / pageSize) ? "disabled" : "")">
                            <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">→</button>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <CreateUsers @ref="createUserRef" Submit="Handle" />
    <EditUsers @ref="editUserRef" Submit="Handle1" />
</body>


@code {
    private string searchTerm = string.Empty;


    private CreateUsers createUserRef;
    private EditUsers editUserRef;
    private bool IsGridView = true;
    private string search = "";

    private int currentPage = 1;
    private int pageSize => IsGridView ? 12 : 10;
    private PaginationDto<User> pagedUsers;

    private async Task AddUser()
    {
        var modal = new RegisterDto();
        createUserRef.Show(modal);

       
    }
    private async Task EditUser(User user)
    {
        var modal = new RegisterDto
        {
            Id = user.Id,
            FirstName = user.FirstName,
            LastName = user.LastName,
            Email = user.Email,
            Phone = user.PhoneNumber,
            Role = user.Role.Name,
            FirmId = user.FirmId
        };
        editUserRef.Show(modal);
       
    }
    private CancellationTokenSource _cts;

    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";

        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        var token = _cts.Token;

        try
        {
            await Task.Delay(200, token);   // debounce (avoid too many API calls)
            currentPage = 1;                // reset to first page on search
            await GetAllUsers();
        }
        catch (TaskCanceledException) { }
    }

    public async Task Handle(RegisterDto register)
    {
        // Your existing DB logic here
        _cts?.Cancel(); // cancel previous call
        _cts = new CancellationTokenSource();
        var token = _cts.Token;
        await Task.Delay(1000, token);
        createUserRef.Hide();
       
        allUsers = await _userService.GetAllUserAsync();

        StateHasChanged();
    }
    private async Task ChangePage(int page)
    {
        if (page >= 1 && page <= Math.Ceiling((double)pagedUsers.TotalCount / pageSize))
        {
            currentPage = page;
            await GetAllUsers();
        }
    }
    public async Task Handle1(RegisterDto dto)
    {
        // Your existing DB logic here
        _cts?.Cancel(); // cancel previous call
        _cts = new CancellationTokenSource();
        var token = _cts.Token;
        await Task.Delay(1000, token);
        editUserRef.Hide();

        allUsers = await _userService.GetAllUserAsync();

        StateHasChanged();
    }
    private IEnumerable<User> allUsers = new List<User>();

    // private IEnumerable<User> cases =>
    //    string.IsNullOrWhiteSpace(searchTerm)
    //    ? allUsers
    //    : allUsers.Where(c =>
    //        (!string.IsNullOrWhiteSpace(c.FirstName) && c.FirstName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
    //        (!string.IsNullOrWhiteSpace(c.LastName) && c.LastName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
    //        (!string.IsNullOrWhiteSpace(c.Email) && c.Email.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
    //        (!string.IsNullOrWhiteSpace(c.PhoneNumber) && c.PhoneNumber.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)));
    protected override async Task OnInitializedAsync()
    {
        spinnerservice.Show();
        await GetAllUsers();
        spinnerservice.Hide();
    }


    private async Task OnViewTypeChange()
    {
        IsGridView = !IsGridView;
    }
    private async Task GetAllUsers()
    {
        
        pagedUsers = await _userService.GetAllUsersAsync(currentPage, pageSize, searchTerm);
        StateHasChanged();
    }

    // private void FilterUsers()
    // {
    //     if (!string.IsNullOrWhiteSpace(searchTerm))
    //     {
    //         var term = searchTerm.Trim().ToLower();
    //         cases = allUsers.Where(user =>
    //             (user.FirstName?.ToLower().Contains(term) ?? false) ||
    //             (user.LastName?.ToLower().Contains(term) ?? false) ||
    //             (user.Email?.ToLower().Contains(term) ?? false) ||
    //             (user.PhoneNumber?.ToLower().Contains(term) ?? false) ||
    //             (user.Roles?.Name?.ToLower().Contains(term) ?? false));
    //     }
    //     else
    //     {
    //         cases = allUsers;
    //     }
    // }



}
