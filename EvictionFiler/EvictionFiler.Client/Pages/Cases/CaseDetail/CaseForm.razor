@using Blazored.Toast.Services
@using EvictionFiler.Application.DTOs.FormTypeDto
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Domain.Entities
@using EvictionFiler.Client.SpinnerService
@inject ICaseFormService _CaseFormService
@inject IJSRuntime JS
@inject ICaseDetailService caseDetailService
@inject NavigationManager Navigation

@inject SpinnerService spinnerservice
@inject IToastService ToastService
<div class="table-responsive" style="height:205px;">
                                    <table class="info-table" style="border:none; ">
                                        <thead>
                                            <tr>

                                                <th scope="col" class="info-bar" style="border-radius:8px 0px 0px 0px;  display:flex;align-items:center;">

                                                    ID
                                                </th>
                                                <th scope="col" class="info-bar" style="border-radius: 0px;">Forms</th>


                                                <th scope="col" class="info-bar" style="border-radius: 0px;">Created By</th>

                                                <th scope="col" style="width:12%;border-radius:0px ;" class="text-nowrap info-bar">Actions</th>
                                                <th scope="col" class="info-bar" style="border-radius: 0px;">Created On</th>

                                            </tr>
                                        </thead>

                                        <tbody>

                                            @if (caseFormDto != null && caseFormDto.Count() > 0)
                                            {
                                                int index = 1;
                                                @foreach (var form in caseFormDto)
                                                {
                                                    <tr class="info-row" style="display:table-row">
                                                        <td class="info-block-table">
                                                            <div class="value">@index</div>

                                                        </td>
                                                        <td class="info-block-table"><div class="value">@form.FormTypeName</div></td>

                                                        <td class="info-block-table"><div class="value">@form.CreatedByName</div></td>

                                                        <td class="d-flex justify-content-between info-block-table" style="gap:2px">
                                                            <span class="action-icon value" @onclick="@(() => ViewPdf(form.File))"><i class="fa-solid fa-eye"></i></span>
                                                            <span class="action-icon value" @onclick="@(() => EditCaseDetail(form.Id))"><i class="fa-solid fa-pen-to-square"></i></span>
                                                            <span class="action-icon-danger value" @onclick="@(() => DeleteCaseDetail(form.Id))"><i class="fa-solid fa-trash"></i></span>
                                                        </td>
                                                        <td class="info-block-table"><div class="value">@form.CreatedOn?.ToString(DateFormats.Default)</div></td>

                                                    </tr>
                                                    index++;
                                                }
                                            }
                                            else
                                            {
                                                <tr class="info-row">
                                                    <td colspan="4" class="text-muted text-center info-block-table"> <div class="value">No notices generated yet.</div></td>
                                                </tr>
                                            }
                                            
                                        </tbody>
                                    </table>
                                </div>






@code {
    [Parameter]
    public Guid CaseId { get; set; }
    [Parameter]
    public bool isAdmin { get; set; }
    public bool IsFormGenerated { get; set; } = false;
    public bool isEditMode { get; set; } = false;
    public bool isLoading { get; set; } = true;
    [Parameter]
    public string loggedInUserId { get; set; }
    private List<GenrateNoticeModel> caseFormDto = new();
    private GenrateNoticeModel caseForm = new();
    private GenrateNoticeModel noticeModel = new GenrateNoticeModel();


    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        await LoadCaseForms();
        isLoading = false;
    }

    private async Task LoadCaseForms()
    {
        caseFormDto = await caseDetailService.GetCaseFormsByCaseId(CaseId, loggedInUserId, isAdmin);
        if (caseFormDto.Any())
        {
            caseForm = caseFormDto.FirstOrDefault()!;
        }
        else
        {
            IsFormGenerated = false;
        }
        await JS.InvokeVoidAsync("openTab", "activity");
        StateHasChanged();
    }
    private async Task ViewPdf(string filePath)
    {
        if (!string.IsNullOrWhiteSpace(filePath))
        {
            var fullUrl = Navigation.BaseUri.TrimEnd('/') + filePath;
            // Navigation.NavigateTo(fullUrl, forceLoad: true);
            await JS.InvokeVoidAsync("open", fullUrl, "_blank");
        }
    }

    public async Task EditCaseDetail(Guid id)
    {
        spinnerservice.Show();
        var result = await _CaseFormService.GetCaseFormByIdAsync(id);

        if (result != null)
        {
            noticeModel = new GenrateNoticeModel
            {
                Id = result.Id,
                FormTypeId = result.FormTypeId,
                File = result.File,
                HTML = result.HTML,
                CreatedOn = result.CreatedOn,
            };
            isEditMode = true;

        }
        spinnerservice.Hide();
        await JS.InvokeVoidAsync("showBootstrapTab", "#actions-tab");
    }
    public async Task DeleteCaseDetail(Guid id)
    {
        spinnerservice.Show();
        bool isDeleted = await _CaseFormService.DeleteDetailAsync(id);

        if (isDeleted)
        {
            caseFormDto = await _CaseFormService.GetCaseFormsByCaseId(CaseId, loggedInUserId, isAdmin);
            ToastService.ShowSuccess("File  has been Deleted successfully!");
            StateHasChanged();
        }
        spinnerservice.Hide();
    }
}


