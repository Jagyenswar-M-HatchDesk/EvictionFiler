@using EvictionFiler.Application.DTOs.CaseDetailDtos
@using EvictionFiler.Application.DTOs.CaseWarrantDtos
@using EvictionFiler.Application.Interfaces.IServices
@inject ICaseDetailService caseDetailService
@inject IJSRuntime JS
@inject ICaseWarrantService caseWarrantService

<table class="info-table " style="border:none;">
    <thead>
        <tr>
            <th colspan="2" class="info-bar">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="info-bar-title">
                        <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important;margin-right:10px;">

                            <i class="fa-regular fa-circle-check" style="font-size:16px;color:#fff !important;"></i>
                        </div>
                        Marshal & Warrant
                    </div>
                    <button type="button" class="btn btn-sm normal p-1" @onclick="ShowMarshalModal" style="color:#1f365d">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </th>
        </tr>
    </thead>

    <tbody>
         @if (isLoading)
        {
            <!-- 🔄 Loading UI -->
            <tr>
                <td colspan="3">
                    <div class="d-flex flex-column justify-content-center align-items-center p-4">
                        <div class="spinner-border"
                             style="color:#1F365D; width:2.5rem; height:2.5rem;"
                             role="status">
                        </div>

                    </div>
                </td>
            </tr>
        }
        else
        {
        <tr class="info-row">
            <td class="info-cell label">Name:</td>
            <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(marshalAndWarrant.MarshalName) ? "--" : marshalAndWarrant.MarshalName)</td>
        </tr>

        <tr class="info-row">
            <td class="info-cell label">Phone No.:</td>
            <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(marshalAndWarrant.MarshalPhone) ? "--" : marshalAndWarrant.MarshalPhone)</td>
        </tr>

        <tr class="info-row">
            <td class="info-cell label">Docket No.:</td>
            <td class="info-cell value ellipsis">
                @(string.IsNullOrWhiteSpace(marshalAndWarrant.Docketno) ? "--" : marshalAndWarrant.Docketno)

            </td>
        </tr>
        }
    </tbody>
</table>

<EditMarshalAndWarrant caseWarrantDto="caseWarrantDto" modelid="marshalModal"
                       OnSave="SaveItem" MarshalId="SelectedMarshalId"
                       CaseId="CurrentCaseId" loggedInUserId="@loggedInUserId" />


@code {
    [Parameter] public Guid? CurrentCaseId { get; set; }

    [Parameter]
    public string? loggedInUserId { get; set; }
    [Parameter] public bool isReload { get; set; }
    private CaseWarrantDto CaseWarranrDto { get; set; } = new();
    private MarshalAndWarrantDetailDto marshalAndWarrant = new();
    private CaseWarrantDto caseWarrantDto = new();
    private bool isLoading = false;
    private bool isEditVisible;
    private Guid? SelectedMarshalId;

    protected override async Task OnInitializedAsync()
    {

        if (CurrentCaseId.HasValue && CurrentCaseId.Value != Guid.Empty)
        {

            isLoading = true;

            await Task.Delay(1000);
            StateHasChanged();
            await MarshalAndWarrantDetails();

            caseWarrantDto = await caseDetailService.GetWarrantDetails(CurrentCaseId!.Value);
            isLoading = false;

        }
    }
    protected override async Task OnParametersSetAsync()
    {
        if (isReload)
        {
            await MarshalAndWarrantDetails();
        }

    }


    public async Task MarshalAndWarrantDetails()
    {

        marshalAndWarrant = await caseDetailService.GetMarshalDetailAsync(CurrentCaseId!.Value);
        if (marshalAndWarrant != null)
        {
            SelectedMarshalId = marshalAndWarrant?.Id;
        }
        StateHasChanged();

    }
    private async Task ShowMarshalModal()
    {

        caseWarrantDto = new CaseWarrantDto
        {
            Id = caseWarrantDto.Id,
            WarrantRequested = caseWarrantDto.WarrantRequested,
            WarrantIssued = caseWarrantDto.WarrantIssued,
            WarrantRejected = caseWarrantDto.WarrantRejected,
            NoticeServed = caseWarrantDto.NoticeServed,
            ExecutionEligible = caseWarrantDto.ExecutionEligible,
            EvictionExecuted = caseWarrantDto.EvictionExecuted,
            ReFileDate = caseWarrantDto.ReFileDate,
            Status = caseWarrantDto.Status,
            LegalcaseId = caseWarrantDto.LegalcaseId

        };
        isEditVisible = true;
        StateHasChanged();
        JS.InvokeVoidAsync("showModal", "marshalModal");

    }
    private async Task SaveItem()
    {

        await MarshalAndWarrantDetails();
    }


}
