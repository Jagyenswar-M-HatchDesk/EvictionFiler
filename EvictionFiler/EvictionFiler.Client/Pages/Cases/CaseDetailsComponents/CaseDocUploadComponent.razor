@using Blazored.Toast.Services
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Domain.Entities
@inject ILegalCaseService _legalcaseSerice
@inject IToastService toastService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using EvictionFiler.Infrastructure.Repositories
@using EvictionFiler.Client.SpinnerService
@inject SpinnerService spinnerservice

<div class="table-responsive">
    <table class="info-table mb-4" style="border:none;">
        <thead style="background-color:#ECF2FF;">
            <tr>
                <th scope="col" class="info-bar" style="border-radius:8px 0px 0px 0px;background: #ECF2FF;color: #1F365D">Uploaded Documents</th>
                <th scope="col" class="info-bar" style="border-radius:0px;background: #ECF2FF;color: #1F365D">Created On</th>
                <th scope="col" style="width:12%;border-radius:0px 8px 0px 0px;background: #ECF2FF;color: #1F365D" class="text-nowrap info-bar">Actions</th>
            </tr>
        </thead>

        <tbody>
            @if (caseDocuments != null && caseDocuments.Count() > 0)
            {
                @foreach (var docs in caseDocuments)
                {
                    <tr class="info-row">

                        <td class="info-block-table"><div class="value">@docs.Name</div></td>

                        <td class="info-block-table"><div class="value">@docs.CreatedOn.ToString(DateFormats.Default)</div></td>
                        <td class="d-flex justify-content-between info-block-table" style="gap:2px">

                            <span class="action-icon value">
                                <i class="fa-solid fa-eye text-navy me-2" style="cursor:pointer"
                                   @onclick="@(() => PreviewDocument(docs.Path))"
                                   title="Preview"></i>

                            </span>
                            <span class="action-icon-danger value">
                                <i class="fa-solid fa-trash text-navy me-2" style="cursor:pointer"
                                   @onclick="@(() => DeleteCaseDocument(docs.Id))"
                                   title="Delete"></i>
                            </span>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr class="info-row">
                    <td colspan="4" class="text-muted text-center info-block-table"> <div class="value">No Document uploaded yet.</div></td>
                </tr>
            }

        </tbody>
    </table>
</div>


@code {
    [Parameter]
    public Guid CaseId { get; set; }
    private IEnumerable<CaseDocument> caseDocuments = new List<CaseDocument>();

    protected override async Task OnInitializedAsync()
    {
        await LoadCaseDocument();
    }

    private async Task LoadCaseDocument()
    {
        caseDocuments = await _legalcaseSerice.CaseDocumentList(CaseId);
        StateHasChanged();
    }

    private async Task PreviewDocument(string filePath)
    {
        if (!string.IsNullOrWhiteSpace(filePath))
        {
            var fullUrl = Navigation.BaseUri + filePath;
            // Navigation.NavigateTo(fullUrl, forceLoad: true);
            await JS.InvokeVoidAsync("open", fullUrl, "_blank");
        }
    }

    public async Task DeleteCaseDocument(Guid id)
    {
        spinnerservice.Show();
        bool isDeleted = await _legalcaseSerice.DeleteCaseDocument(id);

        if (isDeleted)
        {
            await LoadCaseDocument();
            toastService.ShowSuccess("File  has been Deleted successfully!");
            StateHasChanged();
        }
        spinnerservice.Hide();
    }
}
