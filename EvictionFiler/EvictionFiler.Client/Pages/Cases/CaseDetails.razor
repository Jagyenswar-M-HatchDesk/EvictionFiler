@page "/legalcase/details/{caseId:guid}"
@using Blazored.Toast
@using Blazored.Toast.Services
@using EvictionFiler.Application.Constants
@using EvictionFiler.Application.DTOs
@using EvictionFiler.Application.DTOs.ApartmentDto
@using EvictionFiler.Application.DTOs.ArrearLedgerDtos
@using EvictionFiler.Application.DTOs.CaseAppearanceDtos
@using EvictionFiler.Application.DTOs.CaseHearing
@using EvictionFiler.Application.DTOs.CaseNoticeInfoDtos
@using EvictionFiler.Application.DTOs.CaseWarrantDtos
@using EvictionFiler.Application.DTOs.ClientDto
@using EvictionFiler.Application.DTOs.CourtDto
@using EvictionFiler.Application.DTOs.CourtPart
@using EvictionFiler.Application.DTOs.FormTypeDto
@using EvictionFiler.Application.DTOs.LandLordDto
@using EvictionFiler.Application.DTOs.LegalCaseDto
@using EvictionFiler.Application.DTOs.MarshalsDto
@using EvictionFiler.Application.DTOs.MasterDtos.CountyDto
@using EvictionFiler.Application.DTOs.OccupantDto
@using EvictionFiler.Application.DTOs.RemainderCenterDto
@using EvictionFiler.Application.DTOs.TenantDto
@using EvictionFiler.Application.Interfaces.IRepository
@using EvictionFiler.Application.Interfaces.IRepository.MasterRepository
@using EvictionFiler.Application.Interfaces.IServices
@inject NavigationManager Navigation
@* @using EvictionFiler.Client.Jwt *@
@using EvictionFiler.Application.Interfaces.IServices.Master
@using EvictionFiler.Application.Services
@using EvictionFiler.Client.AuthService
@using EvictionFiler.Client.Components.Layout
@using EvictionFiler.Client.Pages.Actions
@using EvictionFiler.Client.Pages.Cases.CaseDetail
@using EvictionFiler.Client.SpinnerService
@using EvictionFiler.Domain.Entities.Master
@using EvictionFiler.Infrastructure.Repositories
@inject SpinnerService spinnerservice
@inject ICaseFormRepository CaseFormRepository
@inject IClientService _clientService
@inject IClientRoleRepository _clientRoleRepository
@inject ITenancyTypeRepository TenancyTypeRepository
@inject IFormTypesRepository FormTypesRepository
@inject ICasesRepository _casesRepository
@inject ICaseFormService _CaseFormService
@inject IRegulationStatusRepository _regulationStatusRepository
@inject ILandLordRepository _landLordRepository
@inject IStateRepository _stateRepository
@inject IBuildingRepository _buildingRepository
@inject IBuildingService _buildingService
@inject IAdditionalTenantService _additionalTenantService
@inject IAdditionalOccupantsService _additionalOccupantService
@inject ITenantService _tenantService
@inject ICourtService _courtService
@inject ILegalCaseService _service
@inject ICaseHearingService _caseHearingService
@inject ILegalCaseService _CaseService
@inject IFeesCatalogService _feeCatalogService
@inject IToastService ToastService
@inject IMarshalService _marshalService
@inject ICourtpartServices courtpartService
@inject IPremiseTypeRepository PremiseTypeRepository
@inject ILandlordSevice _landlordSevice
@inject ICountyService countyService
@inject IRemianderCenterService RemianderCenterService
@inject ITenancyTypeForBuildingRepository TenancyTypeForBuildingRepository;
@inject IExemptionBasicRepository ExemptionBasicRepository;
@inject IExemptionReasonRepository ExemptionReasonRepository;
@inject ICaseTypeRepository CaseTypeRepository
@inject ICaseAdditionalTenantService _caseAdditionalTenant
@inject ICaseAppearanceService _caseAppreance
@inject ICaseNoticeInfoService _caseNoticeinfo
@inject IRemianderCenterService _remainders
@inject IDateRentRepository DateRentRepository
@inject ICaseWarrantService _casewarrantservice
@inject IRemianderCenterService _remainder
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization;
@using EvictionFiler.Domain.Entities
@inject IJSRuntime JS
@inject NavigationStateMessage navmessage
@inject UserContextService userContext
@inject ICourtTodayTypeRepository Courttodayrepo
@layout Aut

@attribute [Authorize]

@using System.Security.Claims
@using System.Linq.Expressions
@using System.Globalization
@inject AuthenticationStateProvider _authStateProvider
<PageTitle>Case Details - Housing Court Filer</PageTitle>
<style>
    :root {
        /* default palette (indigo/teal) */
        --brand-primary: #4f46e5; /* indigo-600 */
        --brand-primary-600: #4f46e5;
        --brand-primary-700: #4338ca;
        --brand-primary-50: #eef2ff;
        --brand-primary-text: #3730a3;
        --brand-accent: #10b981; /* emerald-500 */
        --brand-accent-100: #d1fae5;
        --brand-accent-text: #065f46;
    }
    /* Optional alt theme examples; swap by changing data-theme */
    html[data-theme="sky-rose"] {
        --brand-primary: #0284c7;
        --brand-primary-600: #0284c7;
        --brand-primary-700: #0369a1;
        --brand-primary-50: #e0f2fe;
        --brand-primary-text: #075985;
        --brand-accent: #e11d48;
        --brand-accent-100: #ffe4e6;
        --brand-accent-text: #881337;
    }

    html[data-theme="midalta"] {
        /* Replace with your brand hexes */
        --brand-primary: #0B3B6E;
        --brand-primary-600: #0B3B6E;
        --brand-primary-700: #0a2f57;
        --brand-primary-50: #E6EEF7;
        --brand-primary-text: #0B3B6E;
        --brand-accent: #14B8A6;
        --brand-accent-100: #CCFBF1;
        --brand-accent-text: #0F766E;
    }

    .sticky-blur {
        backdrop-filter: saturate(180%) blur(6px);
    }

    .bg-brand-primary {
        background-color: var(--brand-primary) !important;
    }

    .bg-brand-primary-50 {
        background-color: var(--brand-primary-50) !important;
    }

    .text-brand-primary {
        color: var(--brand-primary-text) !important;
    }

    .bg-brand-accent {
        background-color: var(--brand-accent) !important;
    }

    .bg-brand-accent-100 {
        background-color: var(--brand-accent-100) !important;
    }

    .text-brand-accent {
        color: var(--brand-accent-text) !important;
    }

    /* Simple timeline */




    /* ====== Intake page responsive CSS (works with Bootstrap 5) ====== */

    /* Tokens */
    :root {
        --ef-radius: 14px;
        --ef-gap: 1rem;
        --ef-gap-sm: .75rem;
        --ef-gap-xs: .5rem;
    }

    body {
        font-size: 16px;
    }

    .Lato {
        font-family: 'Lato', sans-serif !important;
    }

    .Inter {
        font-family: 'Inter', sans-serif !important;
    }

    .Poppins {
        font-family: 'Poppins', sans-serif !important;
    }
    /* General polish */
    .container {
        max-width: 100%; /* keeps content readable on desktop */
    }

    .card {
        border-radius: var(--ef-radius);
    }

    .card-header {
        border-top-left-radius: var(--ef-radius);
        border-top-right-radius: var(--ef-radius);
    }

    /* Sticky header spacing on mobile so content doesn't hide under it */
    .sticky-top {
        backdrop-filter: saturate(120%) blur(6px);
        border-bottom: 1px solid rgba(0,0,0,.06);
    }

    /* Stepper dots */
    .step-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        display: inline-block;
        background: #cbd5e1; /* inactive */
    }

        .step-dot.active {
            background: #60a5fa;
        }
        /* info */
        .step-dot.done {
            background: #0d6efd;
        }
    /* primary */

    /* Minor tweaks for Bootstrap form controls on touch */
    .form-control, .form-select, .btn {
        border-radius: 12px;
    }

    .form-control, .form-select {
        min-height: 44px; /* good touch target */
    }

    /*  .btn {
                                                        min-height: 42px;
                                                    } */

    /* Review JSON block */
    details > pre {
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 12px;
        padding: 12px;
        overflow: auto;
    }

    /* Footer action bar */
    @@media (min-width: 0px) {
        /* On small1 screens make actions stick and fill width cleanly */
        .ef-actions {
            position: sticky;
            bottom: 0;
            z-index: 10;
            background: rgba(255,255,255,.94);
            backdrop-filter: blur(6px);
            border-top: 1px solid rgba(0,0,0,.06);
            padding: .75rem .5rem;
        }
    }

    /* ---------- Mobile-first layout ---------- */
    @@media (max-width: 575.98px) {
        /* Tighten container padding */
        .container, .container-fluid {
            padding-left: .75rem !important;
            padding-right: .75rem !important;
        }
        /* Header stack */
        .sticky-top .d-flex.justify-content-between {
            flex-direction: column;
            align-items: flex-start !important;
            gap: .5rem;
        }
        /* Stepper dots wrap nicely */
        .sticky-top .d-flex.align-items-center.gap-2 {
            flex-wrap: wrap;
            gap: .4rem !important;
        }
        /* Card body spacing */
        .card-body.row.g-3 {
            row-gap: var(--ef-gap-sm) !important;
        }
        /* Form labels slightly small1er to reduce wrapping */
        .form-label {
            font-size: .9rem;
            margin-bottom: .25rem;
        }
        /* Inputs extend full width */
        .form-control, .form-select {
            font-size: 1rem;
        }
        /* Buttons fill width in footer and stack */
        .ef-actions .btn {
            width: 100%;
        }

            .ef-actions .btn + .btn {
                margin-top: .5rem;
            }
        /* Turn 2-column sections into single column */
        .row.g-3 > [class*="col-md-6"] {
            width: 100%;
            flex: 0 0 100%;
            max-width: 100%;
        }
        /* Download PDF button: keep visible but compact */
        .card-header .btn.btn-sm {
            padding: .25rem .5rem;
            font-size: .8rem;
        }
    }

    /* ---------- small1 tablets ---------- */
    @@media (min-width: 576px) and (max-width: 767.98px) {
        .card-body.row.g-3 {
            row-gap: var(--ef-gap-sm) !important;
        }

        .form-control, .form-select {
            font-size: 1rem;
        }
    }

    /* ---------- Tablets / small1 laptops ---------- */
    @@media (min-width: 768px) and (max-width: 991.98px) {
        .card-body.row.g-3 {
            row-gap: var(--ef-gap) !important;
        }
    }

    /* ---------- Large screens ---------- */
    @@media (min-width: 992px) {
        .card-body.row.g-3 {
            row-gap: var(--ef-gap) !important;
        }
    }

    /* Accessibility: clear focus states even on mobile */
    :focus-visible {
        outline: 3px solid rgba(13,110,253,.35);
        outline-offset: 2px;
        border-radius: 10px;
    }

    /* Reduce animations if user prefers */
    @@media (prefers-reduced-motion: reduce) {
        * {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }
    }

    /* Print (nice PDF from browser too) */
    @@media print {
        .sticky-top, .ef-actions, details {
            display: none !important;
        }

        .card {
            box-shadow: none !important;
            border: 1px solid #ddd;
        }

        .card-header {
            background: #f8f9fa !important;
        }

        body {
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
    }



    .btn {
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid #cbd5e1;
        background: #fff;
        color: #0f172a
    }

        .btn.primary {
            background: var(--brand);
            border-color: transparent;
            color: #fff
        }

        .btn.danger {
            background: #fee2e2;
            border-color: #fecaca;
            color: #991b1b
        }

        .btn.base {
            background: #1F365D !important;
            color: #fff;
        }

        .btn.normal {
            background: transparent !important;
            border: none;
        }

    .list {
        display: flex;
        flex-direction: column;
        gap: 8px
    }

        .list .row {
            display: flex;
            gap: 8px
        }

    .iconbtn {
        border: 1px solid #cbd5e1;
        background: #fff;
        border-radius: 10px;
        padding: 8px 10px;
        cursor: pointer
    }


    .btn-tenant:hover {
        background: #1F365D !important;
    }

    .nowrap {
        white-space: nowrap;
    }

    .required-label {
        font-family: Lato;
        font-weight: 600;
        font-size: 16px;
        line-height: 20px;
        letter-spacing: 0px;
        text-transform: capitalize;
    }

        .required-label::after {
            content: " *";
            color: red;
        }

    .btn-delete:hover {
        background-color: #1F365D;
        color: white;
    }

    .search-box {
        width: 100%;
        padding-right: 3rem; /* space for the button */
        padding-left: 1rem; /* border-radius: 1.5rem; */
        border: 2px solid #020336;
        background-color: #FFF; /* dark background */
        color: black;
        height: 2.5rem;
        font-size: 14px;
    }

        .search-box::placeholder {
            color: darkgrey;
        }

        .search-box:focus {
            border: 2px solid #020336 !important;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2);
            background: #F5F5F5;
        }

    .search-btn {
        position: absolute;
        right: 1.7rem;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: none;
        color: #020336;
        cursor: pointer;
        padding: 0;
        font-size: 1.2rem;
    }

        .search-btn:hover {
            color: #1F365D;
        }

    .action-icon {
        color: #374151;
        cursor: pointer;
        transition: color 0.15s ease, transform 0.1s ease;
    }

        .action-icon:hover {
            color: #1F365D;
        }

    .action-icon-danger {
        color: #DC2626 !important;
    }




    .row-item {
        display: grid;
        grid-template-columns: 1fr 1fr 1.2fr 120px;
        column-gap: 18px;
        row-gap: 8px;
        padding: 15px 0;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 10px;
    }

    .form-label-arrear {
        grid-column: span 4;
        font-size: 14px;
        margin-bottom: 4px;
        font-weight: 600;
        color: #374151;
    }

    .input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        font-size: 15px;
    }

    .remove-btn {
        border: 1px solid #d1d5db;
        background: #f9fafb;
        border-radius: 10px;
        cursor: pointer;
        padding: 10px 15px;
        align-self: end;
    }

    .add-btn {
        margin-top: 15px;
        padding: 12px 22px;
        background: #f9fafb;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        cursor: pointer;
        font-size: 15px;
    }

        .add-btn:hover {
            background: #1F365D !important;
            color: white;
        }

    .total-box {
        background: #f3f4f6;
        padding: 14px 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        font-size: 16px;
        font-weight: 600;
    }
</style>
<style>
    #activityTable th,
    #activityTable td {
        white-space: nowrap !important;
        vertical-align: middle !important;
    }

    .btn:focus, .btn:active:focus, .btn-link.nav-link:focus, .form-control:focus, .form-check-input:focus {
        box-shadow: none;
    }

    .form-switch .form-check-input:checked {
        background-color: darkblue;
    }

    .form-switch .form-check-input:not(:checked) {
        --bs-form-switch-bg: url("data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'><circle r='3' fill='%236b84af'/></svg>");
    }

    .form-switch .form-check-input {
        width: 2.5em;
        margin-left: -0.5em;
        height: 17px;
        border: solid 2px lightgrey;
    }

    .field-label {
        font-size: 1rem;
        color: var(--text-muted);
        margin-bottom: 0.15rem;
    }

    .field-value {
        margin-left: 5px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .cols-2 {
        display: grid;
        column-gap: 10px;
        grid-template-columns: repeat(2,minmax(0,1fr))
    }

    .font14 {
        font-size: 1rem;
    }

    .holdover-form {
        box-shadow: none !important;
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #cbd5e1;
        border-radius: 12px;
        background: #fff;
        color: #0f172a;
        outline: none;
    }

        /* Remove highlight outline when opening */
        .holdover-form:focus {
            border-color: #1F365D !important;
            box-shadow: 0 0 0 0 !important;
            outline: none !important;
        }

    .Attorney {
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        text-decoration: underline;
        color: #1F365D;
        align-items: baseline;
    }

        .Attorney:hover {
            font-weight: 700;
        }

    .lbl {
        display: block;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: .04em;
        font-weight: 700;
        color: #475569;
        margin-bottom: 6px
    }

    .inner-card {
        box-shadow: none;
        background-color: white;
        box-shadow: 0px 4px 14px 0px #0000000D;
        border-radius: 20px;
    }

    .Overview-lbl {
        display: flex;
        align-items: end;
        font-family: Poppins;
        font-weight: 500;
        font-style: normal;
        font-size: 16px;
        /* leading-trim: NONE; */
        line-height: 100%;
        letter-spacing: -0.5px;
        vertical-align: middle;
        text-transform: capitalize;
        color: #1F365D;
    }

    .Overview-Value {
        font-family: Lato;
        font-weight: 800;
        font-style: normal;
        font-size: 28px;
        line-height: 100%;
        letter-spacing: -2%;
        color: #1F365D;
    }

    .Details-header {
        font-family: Lato;
        font-weight: 800;
        font-size: 34px;
        line-height: 100%;
        letter-spacing: 0px;
        text-transform: capitalize;
        color: #1F365D;
    }

    .modal-title {
        font-family: Lato;
        font-weight: 800;
        font-size: 34px;
        line-height: 100%;
        letter-spacing: 0px;
        text-transform: capitalize;
    }

    /* Progress Track */
    .custom-progress {
        height: 10px; /* matches Figma */
        background-color: #ffffff; /* white track */
        border-radius: 20px; /* fully rounded */
        overflow: hidden; /* hide striped overflow */
    }

    /* Progress Fill (Green + Diagonal Stripes) */
    .custom-progress-bar {
        background: repeating-linear-gradient( 45deg, #32c864 0px, /* lighter green */
        #32c864 6px, #28a745 6px, /* darker green stripe */
        #28a745 12px );
        border-radius: 20px;
        transition: width 0.5s ease-out;
    }

    /* Percentage Label */
    .progress-percent {
        font-size: 14px;
        font-weight: 600;
        color: #0e1726; /* dark navy, matching your theme */
    }

    #tenantName {
        white-space: nowrap; /* avoid line wrap */
        overflow: hidden; /* hide overflowing text */
        text-overflow: ellipsis; /* show ... */
        display: block; /* required for ellipsis */
        max-width: 100%; /* prevents expansion */
    }

    .tenant-text {
        min-width: 0; /* REQUIRED so text can shrink */
    }



    /* Top header row (badge + title + dashed line) */
    .info-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        position: relative;
    }

        .info-header::after {
            content: "";
            flex: 1;
            height: 1px;
            border-bottom: 2px dashed #1F365D;
            margin-left: 12px;
        }

    /* Number badge */
    .info-badge {
        width: 34px;
        height: 34px;
        background: #DDB156; /* yellow */
        color: #1F365D;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 700;
    }

    /* Header title */
    .info-title {
        font-family: Lato;
        font-weight: 700;
        font-size: 20px;
        line-height: 20px;
        letter-spacing: 0px;
        color: #1F365D;
        padding-left: 8px;
        padding-right: 8px;
    }




    .content-value {
        font-family: Lato;
        font-weight: 500;
        font-size: 14px;
        color: #0e1726;
        max-width: 60%;
    }

    .header-value {
        font-family: Lato;
        font-weight: 400;
        font-size: 14px;
        line-height: 100%;
        letter-spacing: 0px;
        vertical-align: middle;
        color: #1F365D !important;
    }

    /* .info-bar-title {
                    font-family: Inter;
                    font-weight: 600;
                    font-size: 16px;
                    line-height: 20px;
                    letter-spacing: 0px;
                    text-transform: capitalize;
                } */
    .info-bar-title {
        display: flex;
        align-items: center;
        font-family: Inter;
        font-weight: 600;
        font-size: 20px;
        line-height: 19.5px;
        letter-spacing: 0.65px;
        vertical-align: middle;
        text-transform: uppercase;
    }

    .info-bar {
        background: #fff; /* navy */
        border-bottom: 1px solid lightgrey;
        white-space: nowrap;
        color: #1f365d;
        padding: 10px 16px;
        border-radius: 12px 12px 0 0;
        font-family: Inter;
    }

    /* Table */
    .info-table {
        width: 100%;
        height: 100%;
        border: 1px solid lightgray;
        border-collapse: separate;
        border-radius: 12px;
        border-spacing: 0;
        background: white;
        overflow: hidden;
    }

    /* Alternating row backgrounds */
    /* .info-row:nth-child(even) {
                        background: #FAFAFF; /* your required alternate color *
                    }

                    .info-row:nth-child(odd) {
                        background: #FFFFFF;
                    } */

    /* Table rows */
    .info-row {
        /* height: 42px; */
        /* border-bottom: 1px solid #EEF1F8; */
        display: flex;
        flex-direction: column;
        background-color: white;
    }

    .info-row-court {
        /* height: 42px; */
        /* border-bottom: 1px solid #EEF1F8; */
        /* display: flex; */
        /* flex-direction: column; */
        background-color: white;
    }

    /*.info-row:last-child {
                            border-bottom: none;
                        } */

    /* Cells */
    .info-cell {
        padding: 8px 16px;
        vertical-align: middle;
        font-family: Inter;
    }

        /* Label column */
        /* .info-cell.label {
                        width: 0%;
                        font-family: Inter;
                        font-weight: 500;
                        font-size: 16px;
                        line-height: 100%;
                        letter-spacing: -3%;
                        text-transform: capitalize;
                        white-space: nowrap;
                        color: #1F365D;
                        padding-right: 0px;
                    } */
        .info-cell.label {
            font-family: Inter;
            font-weight: 600;
            color: #94A3B8;
            font-size: 1rem;
            line-height: 20px;
            letter-spacing: 1.2px;
            vertical-align: middle;
            /* text-transform: uppercase; */
            padding-bottom: 0px;
        }

        /* Value column */
        /* .info-cell.value {
                        font-family: Inter;
                        font-weight: 500;
                        font-size: 14px;
                        line-height: 100%;
                        letter-spacing: -2%;
                        text-align: right;
                        text-transform: capitalize;
                        color: #1F365D;
                        padding-top: 0px;
                    } */
        .info-cell.value {
            font-family: Inter;
            font-weight: 700;
            font-size: 1.2rem;
            line-height: 20px;
            letter-spacing: 1.2px;
            vertical-align: middle;
            color: #0F172A;
            padding-top: 0px;
        }

        .info-cell.span {
            font-family: Inter;
            font-weight: 400;
            font-size: 11.5px;
            line-height: 20px;
            letter-spacing: 0%;
            vertical-align: middle;
            color: #94A3B8;
            padding-top: 0px;
        }

    .info-block {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: baseline;
        width: 50%;
        padding: 10px 18px;
        vertical-align: middle;
    }

    .info-block-court {
        display: flex;
        flex-direction: column;
        align-items: baseline;
        padding: 10px 18px;
        vertical-align: middle;
    }

    .info-block-table {
        padding: 10px 18px;
        vertical-align: text-top;
        white-space: nowrap;
    }

        .info-block-table .value {
            font-family: Lato;
            font-size: 1rem;
            font-weight: 500;
            color: #1F365D;
        }

    /* Label */
    .info-block .label {
        font-family: Inter;
        font-weight: 600;
        font-size: 1rem;
        line-height: 20px;
        letter-spacing: 1.2px;
        /* text-transform: capitalize; */
        color: #94A3B8;
    }

    /* Value */
    .info-block .value {
        font-family: Inter;
        font-weight: 700;
        font-size: 1.2rem;
        line-height: 100%;
        letter-spacing: 1.2px;
        text-align: right;
        /* text-transform: capitalize; */
        color: #1F365D;
    }

    .info-block-court .label {
        font-family: Inter;
        font-weight: 600;
        font-size: 1rem;
        line-height: 20px;
        letter-spacing: 1.2px;
        /* text-transform: capitalize; */
        color: #94A3B8;
    }

    /* Value */
    .info-block-court .value {
        font-family: Inter;
        font-weight: 700;
        font-size: 1.2rem;
        line-height: 100%;
        letter-spacing: 1.2px;
        text-align: left;
        /* text-transform: capitalize; */
        color: #1F365D;
    }

    .para {
        font-family: Lato;
        font-size: 14px;
        font-weight: 500;
        margin-top: 10px;
        margin-left: 13px;
    }
    /* Ellipsis */
    .ellipsis {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .cols-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        column-gap: 15px;
    }

    .timeline {
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 5px;
        padding: 1rem 1rem 0rem 1rem;
        overflow-x: auto; /* allow scroll when many items */
    }

        /* Horizontal dashed line behind dots */
        .timeline::before {
            content: "";
            position: absolute;
            top: 9px; /* aligns with dots */
            left: 0;
            right: 0;
            height: 2px;
            border-top: 2px dashed #d7dce5; /* your line color */
            z-index: 1;
        }

        /* === INDIVIDUAL TIMELINE ITEM === */
        .timeline .item {
            position: relative;
            min-width: 140px; /* consistent item width */
            z-index: 2; /* Above the line */
        }

        /* Dot styling */
        .timeline .dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: inline-block;
            background: #E2A841;
            z-index: 3;
            border: 3px solid white; /* white ring around the dot */
            box-shadow: none; /* outer glow ring (match design) */
        }





        /* State colors */
        .timeline .item[data-status="completed"] .dot {
            background-color: #E2A841; /* golden/yellow like screenshot */
            box-shadow: none;
        }

        .timeline .item[data-status="current"] .dot {
            background-color: #1F365D;
            box-shadow: none;
        }

        .timeline .item[data-status="upcoming"] .dot {
            background-color: #c5cad6;
            box-shadow: none;
        }

        /* Typography alignment */
        .timeline .item .text-secondary {
            margin-top: 0.5rem;
            display: block;
        }

        /* ========== CONTENT BELOW DOT ========== */
        .timeline .content .date {
            margin-top: 12px;
            font-size: 0.85rem;
            color: #6c757d;
        }

        .timeline .content .title {
            margin-top: 4px;
            font-weight: 600;
            font-size: 1rem;
        }

        .timeline .content .desc {
            margin-top: 4px;
            font-size: 0.85rem;
            color: #6c757d;
        }

    .timeline {
        position: relative;
    }

        .timeline .dot {
            position: absolute;
            left: 5px;
            width: 16px;
            height: 16px;
        }

        .timeline .item {
            position: relative;
            padding-bottom: 1rem;
        }

            .timeline .item .dot {
                top: -15px;
            }


    .label {
        font-family: Lato;
        font-weight: 500;
        font-size: 1.1rem;
        line-height: 100%;
        letter-spacing: -3%;
        text-transform: capitalize;
        white-space: nowrap;
        color: #1F365D;
        padding-right: 0px;
    }

    #caseNumber {
        font-family: 'Lato';
        font-weight: 800 !important;
        font-size: 20px;
        line-height: 20px;
        color: #1F365D;
    }

    .form-control {
        font-family: Lato;
        font-weight: 500;
        font-size: 14px;
        line-height: 100%;
        letter-spacing: -3%;
        text-transform: capitalize;
        border-radius: 25px;
        padding: 16px 25px;
    }

    .btn {
        min-height: 45px !important;
    }

    .btn-base:hover {
        color: #1F365D;
    }

    .head-btn {
        font-family: Poppins;
        font-size: 14px;
        font-weight: 500;
    }

    .buttons {
        font-family: Poppins;
        font-size: 16px;
        font-weight: 500;
    }

    .edit-build {
        font-family: Lato;
        font-weight: 500;
        font-size: 16px;
    }

    .edit-tent {
        font-family: Lato;
        font-weight: 500;
        font-size: 16px;
    }

    .flex-col {
        display: flex;
        flex-direction: column;
    }
    /* Card Container */
    .vault-card {
        background: #F7F8FC;
        border-radius: 14px;
        padding: 14px;
        height: 260px;
        position: relative;
    }

    /* Header */
    .vault-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .vault-title {
        font-size: 11px;
        letter-spacing: 1.5px;
        color: #8A94A6;
        font-weight: 600;
    }

    /* Plus Button */
    .vault-add-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        background: #1F365D;
        color: white;
        box-shadow: 0 6px 14px rgba(31, 54, 93, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Body Center */
    .vault-body {
        background: #EEF1F7;
        border-radius: 12px;
        height: 200px;
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    /* File Icon Box */
    .vault-icon {
        width: 52px;
        height: 52px;
        background: #E4E8F1;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #7E8AA5;
        font-size: 22px;
        margin-bottom: 10px;
    }

    /* Empty Text */
    .vault-empty-text {
        font-size: 12px;
        letter-spacing: 1px;
        color: #7E8AA5;
        font-weight: 600;
        margin-bottom: 6px;
    }

    /* Cloud Sync */
    .vault-sync {
        font-size: 11px;
        color: #7E8AA5;
        font-weight: 600;
        cursor: pointer;
    }

</style>


<body class="bg-body-tertiary" style="background-color:#f6f5f2 !important;">

    @if (legalcaseDto != null)
    {
        <!-- Top Bar --
        <header class="position-sticky top-0 z-3 sticky-blur bg-body border-bottom">
            <div class="container py-3 d-flex align-items-center justify-content-between flex-wrap">
                <div class="d-flex align-items-center gap-3">
                    <div class="rounded-3 text-white d-grid" style="width:40px;height:40px;place-items:center; background-color: #1F365D !important;">
                        <i class="bi bi-gavel"></i>
                    </div>
                    <div>
                        <h1 class="h4 mb-0 fw-bold" id="caseNumber">@(string.IsNullOrWhiteSpace(legalcaseDto.Casecode) ? "--" : legalcaseDto.Casecode)</h1>
                        <div class="header-value" id="caseMeta">
                            Landlord &amp; Tenant • Created @(legalcaseDto.CreatedOn.ToString(DateFormats.Default) ?? "--")
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <span class="head-btn" id="substatusBadge" style="color:#DDB156;text-decoration:underline; cursor:default;margin-right: 10px;">@(string.IsNullOrWhiteSpace(legalcaseDto.CaseTypeName) ? "--" : legalcaseDto.CaseTypeName)</span>
                    <span  class="head-btn" id="statusBadge" style="color:#12BE45;text-decoration:underline;cursor:default;margin-right: 10px;">@(string.IsNullOrWhiteSpace(legalcaseDto.Status) ? "--" : legalcaseDto.Status)</span>

                    <button class="btn btn-outline-secondary btn-base head-btn" style="background-color:#E2A8411A;" @onclick="BackTocases">View Previous Cases</button>
                    <button class="btn  head-btn text-white" style="background-color:#1F365D;" @onclick="ShowCreateAction">New Action</button>
                </div>
            </div>
        </header>-->

        <main class="container-xxl  p-4" style="max-width:fit-content;">
            <!--header-->
            <div>
                <div class="container py-3 mb-4 d-flex align-items-center justify-content-between flex-wrap" style="background-color:white; border-radius:10px;">
                    <div class="d-flex align-items-center gap-3">
                        <div class="rounded-3 text-white d-grid" style="width:40px;height:40px;place-items:center; background-color: #1F365D !important;">
                            <i class="bi bi-gavel"></i>
                        </div>
                        <div>
                            <h1 class="h4 mb-0 fw-bold" id="caseNumber">@(string.IsNullOrWhiteSpace(legalcaseDto.Casecode) ? "--" : legalcaseDto.Casecode)</h1>
                            <div class="header-value" id="caseMeta">
                                Landlord &amp; Tenant • Created @(legalcaseDto.CreatedOn.ToString(DateFormats.Default) ?? "--")
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <span class="head-btn" id="substatusBadge" style="color:#DDB156;text-decoration:underline; cursor:default;margin-right: 10px;">@(string.IsNullOrWhiteSpace(legalcaseDto.CaseTypeName) ? "--" : legalcaseDto.CaseTypeName)</span>
                        <span class="head-btn" id="statusBadge" style="color:#12BE45;text-decoration:underline;cursor:default;margin-right: 10px;">@(string.IsNullOrWhiteSpace(legalcaseDto.Status) ? "--" : legalcaseDto.Status)</span>

                        <button class="btn btn-outline-secondary btn-base head-btn" style="background-color:#E2A8411A;" @onclick="BackTocases">View Previous Cases</button>
                        <button class="btn  head-btn text-white" style="background-color:#1F365D;" @onclick="ShowCreateAction">New Action</button>
                    </div>
                </div>
            </div>

            <!-- Overview Stats -->
            <div class="mt-4" style="border:none;">
                <section class="row g-3 g-lg-4">
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="card inner-card border-0 h-100" style="">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:42px;height:42px; background-color:#F6F7FB; border-radius:20px !important;">
                                    <div class="icon" style="font-size:22px;">💰</div>
                                </div>
                                <div>
                                    <div class="Overview-lbl">Monthly Rent</div>
                                    <div class="Overview-Value" id="monthlyRent">$@(legalcaseDto.MonthlyRent == null ? "--" : $"{legalcaseDto.MonthlyRent.Value:N2}")</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="card inner-card border-0 h-100" style="">
                            <div class="card-body d-flex align-items-center gap-3">
                                <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:42px;height:42px; background-color:#F6F7FB; border-radius:20px !important;">

                                    @* <i class="fa-solid fa-dice-d6" style="font-size:34px;color:#1F365D !important;"></i> *@
                                    <div class="icon" style="font-size:18px;">📅</div>


                                </div>
                                <div>
                                    <div class="Overview-lbl">Days Open</div>
                                    <div class="Overview-Value" id="daysOpen">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="card inner-card border-0 h-100" style="">
                            <div class="card-body d-flex align-items-center gap-3">

                                <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:42px;height:42px; background-color:#F6F7FB; border-radius:20px !important;">

                                    @* <i class="fa-solid fa-dice-d6" style="font-size:34px;color:#1F365D !important;"></i> *@
                                    <div class="icon" style="font-size:20px">👤</div>
                                </div>

                                <!-- THIS WRAPPER IS CRITICAL -->
                                <div class="tenant-text">
                                    <div class="Overview-lbl">Tenant</div>
                                    <div class="Overview-Value" id="tenantName">
                                        @(string.IsNullOrWhiteSpace(legalcaseDto.TenantName) ? "--" : legalcaseDto.TenantName)
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>



                    <div class="col-12 col-md-6 col-lg-3">
                        <div class="card inner-card border-0 h-100" style="">
                            <div class="card-body">
                                <div class="Overview-Value">Case Progress</div>

                                <div class="d-flex justify-content-end mb-1">
                                    <span class="progress-percent">@AnimatedProgress%</span>
                                </div>

                                <div class="progress custom-progress">
                                    <div class="progress-bar custom-progress-bar"
                                         style="width:@AnimatedProgress%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </section>
            </div>

            <!-- Two Column -->
            <section class="row g-4 mt-4">
                <!--
                <div class="col-12 col-lg-12 d-flex flex-column gap-4">

                    <div class="bg-transparent">
                        <div class="Details-header"> Tenant, Building &amp; Landlord Information</div>
                    </div>

                </div>-->
                <div class="col-12 col-lg-12 d-flex flex-column gap-4">
                    <!-- Tenant & Building & Landlord-->
                    <div class="">

                        <div class="card-body">
                            <div class="row g-3">


                                @* <div class="col-md-4 mt-0">

                                    <div class="info-table">
                                        <div class="info-bar">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="info-bar-title">
                                                    <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important; margin-right:10px;">

                                                        <i class="fa-regular fa-user" style="font-size:16px;color:#1F365D !important;"></i>
                                                    </div>
                                                    LandLord Details
                                                </div>
                                                <button type="button" class="btn btn-sm normal p-1" title="Edit Landlord" @onclick="ShowLandlordModal" style="color:white">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            </div>
                                        </div>
                                       

                                            <div class="info-row" style="padding-top:10px">
                                                <div class="info-cell label" style="text-transform: uppercase;">Enitiy Name</div>
                                                <div class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.FullName) ? "--" :legalcaseDto.FullName)</div>
                                            </div>
                                            <div class="info-row">
                                                <div class="info-cell label" style="text-transform: uppercase;">Authorized Rep</div>
                                                <div class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.ContactPersonName) ? "--" : legalcaseDto.ContactPersonName)</div>
                                            </div>

                                            <div class="info-row" style="padding-bottom:10px">
                                                <div class="info-cell label" style="text-transform: uppercase;">Legal Address</div>
                                                <div class="info-cell value ellipsis" style="white-space:normal">
                                                    @{
                                                        var partlandlord = new List<string>();

                                                    if (!string.IsNullOrWhiteSpace(legalcaseDto.LandlordAddress)) partlandlord.Add(legalcaseDto.LandlordAddress);


                                                        var fulllandlordAddress = partlandlord.Count() > 0 ? string.Join(", ", partlandlord) : "--";
                                                    }
                                                    @fulllandlordAddress
                                                </div>
                                            </div>
                                        
                                    </div> *@


                                <Landlord CurrentCaseId="@caseId" LandlordIdValue="HandleLandlord" />

                                @*     <div class="col-md-4 mt-0">

                                   
                                    <table class="info-table">
                                        <thead>
                                            <tr>
                                                <th colspan="2" class="info-bar">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="info-bar-title">
                                                            <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important;margin-right:10px;">

                                                                <i class="fa-regular fa-building" style="font-size:16px;color:#1F365D !important;"></i> 
                                                            </div>
                                                            Building Registry
                                                        </div>
                                                        <button type="button" class="btn btn-sm normal p-1" title="Edit Building" @onclick="ShowBuildingModal" style="color:white">
                                                            <i class="bi bi-pencil"></i>
                                                        </button>
                                                    </div>
                                                </th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            <tr class="info-row" style="padding-top:10px">
                                                <td class="info-cell label" style="text-transform: uppercase;">Inter Asset Id</td>
                                                <td class="info-cell value ellipsis" style="padding-bottom:0px;">--</td>
                                                <td class="info-cell span">Portfolio Aplha</td>
                                            </tr>

                                            <tr class="info-row">
                                                <td class="info-cell label" style="text-transform: uppercase;">MDR Number</td>
                                                <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.Mdr) ? "--" : legalcaseDto.Mdr)</td>
                                            </tr>

                                            <tr class="info-row" style="padding-bottom:10px">
                                                <td class="info-cell label" style="text-transform: uppercase;">Primary Address</td>
                                                <td class="info-cell value ellipsis" style="white-space:normal">
                                                    @{
                                                        var partbuilding = new List<string>();

                                                        if (!string.IsNullOrWhiteSpace(legalcaseDto.BuildingAddress)) partbuilding.Add(legalcaseDto.BuildingAddress);
                                                        // if (!string.IsNullOrWhiteSpace(legalcaseDto.Address2)) partlandlord.Add(legalcaseDto.Address2);
                                                        if (!string.IsNullOrWhiteSpace(legalcaseDto.Borough)) partbuilding.Add(legalcaseDto.Borough);
                                                        if (!string.IsNullOrWhiteSpace(legalcaseDto.BuildingState)) partbuilding.Add(legalcaseDto.BuildingState);
                                                        if (!string.IsNullOrWhiteSpace(legalcaseDto.BuildingZip)) partbuilding.Add(legalcaseDto.BuildingZip);

                                                        var fullbuildingAddress = partbuilding.Count() > 0 ? string.Join(", ", partbuilding) : "--";
                                                    }
                                                @fullbuildingAddress
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>


                            </div> *@

                                <Building CurrentCaseId="@caseId" LandlordId="@SelectedLandlordId" />


                                @*   <div class="col-md-4 mt-0">


                                <table class="info-table">
                                    <thead>
                                        <tr>
                                            <th colspan="2" class="info-bar">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="info-bar-title">
                                                        <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important;margin-right:10px;">

                                                           <i class="fa-regular fa-user" style="font-size:16px;color:#1F365D !important;"></i>
                                                        </div>
                                                        Tenant Profile
                                                    </div>
                                                    <button type="button" class="btn btn-sm normal p-1" title="Edit Tenant" @onclick="ShowTenantModal" style="color:white">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        <tr class="info-row" style="padding-top:10px">
                                            <td class="info-cell label" style="text-transform: uppercase;">Primary tenant</td>
                                            <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.TenantName) ? "--" : legalcaseDto.TenantName)</td>
                                        </tr>

                                        <tr class="info-row">
                                            <td class="info-cell label" style="text-transform: uppercase;">Occupied Unit</td>
                                            <td class="info-cell value ellipsis" style="padding-bottom:0px;">@(string.IsNullOrWhiteSpace(legalcaseDto.UnitOrApartmentNumber) ? "--" : legalcaseDto.UnitOrApartmentNumber)</td>
                                            <td class="info-cell span">2 Br / 1 Ba</td>

                                        </tr>

                                        <tr class="info-row" style="padding-bottom:10px">
                                            <td class="info-cell label" style="text-transform: uppercase;">Service Address</td>
                                            <td class="info-cell value ellipsis" style="white-space:normal">@(legalcaseDto.TenantId == null || legalcaseDto.TenantId == Guid.Empty ? "--" : fullbuildingAddress)</td>
                                        </tr>
                                    </tbody>
                                </table>


                            </div> *@

                                <Tenant CurrentCaseId="@caseId" />


                            </div>
                        </div>

                    </div>


                </div>
                <!-- Left -->
            </section>
            <section class="row g-4 mt-1">
                <div class="col-12 col-lg-12 d-flex flex-column gap-4">
                    <!-- Tenant & Building & Landlord-->

                    <div class="bg-transparent">
                        <div class="Details-header"> Stipulation &amp; Reminders</div>
                    </div>

                </div>
                <div class="col-12 col-lg-12 d-flexd-flex ">
                    <!-- Tenant & Building & Landlord-->
                    <div class="row mb-4">
                        <div class="col-4 " style="padding: 0px 10px;">
                            <div class="info-table p mb-4" style="border:none;">
                                <div class="info-bar">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="info-bar-title">
                                            <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important;margin-right:10px;">

                                                <i class="fa-regular fa-calendar" style="font-size:16px;color:#fff !important;"></i>
                                            </div>
                                            Motion Dates
                                        </div>
                                        <button type="button" class="btn btn-sm normal p-1" @onclick="ShowStipulationModal" title="Edit Motions" style="color:#1f365d">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="info-row" style="display:flex; flex-direction:row">
                                    <!-- Column 1 -->
                                    <div class="info-block">
                                        <div class="label">Motion Due:</div>
                                        <div class="value ellipsis">
                                            @(MotionJudgements.MotionDue.HasValue
                                                                                    ? MotionJudgements.MotionDue.Value.ToString(DateFormats.Default)
                                                                                    : "--")
                                                                                       </div>
                                                                                   </div>

                                    <!-- Column 2 -->
                                    <div class="info-block ps-0">
                                        <div class="label">Opposition Due:</div>
                                        <div class="value ellipsis">
                                            @(MotionJudgements.OppositionDue.HasValue
                                                                                    ? MotionJudgements.OppositionDue.Value.ToString(DateFormats.Default)
                                                                                    : "--")
                                                                                       </div>
                                                                                   </div>
                                                                               </div>

                                <!-- ROW 2 -->
                                <div class="info-row" style="display:flex; flex-direction:row">
                                    <!-- Column 1 -->
                                    <div class="info-block">
                                        <div class="label">Reply Due:</div>
                                        <div class="value ellipsis">
                                            @(MotionJudgements.ReplyDue.HasValue
                                                                                    ? MotionJudgements.ReplyDue.Value.ToString(DateFormats.Default)
                                                                                    : "--")
                                                                                       </div>
                                                                                   </div>

                                    <!-- Column 2 -->
                                    <div class="info-block ps-0">
                                        <div class="label">OSC / Return:</div>
                                        <div class="value ellipsis">
                                            @(MotionJudgements.ReturnDate.HasValue
                                                                                    ? MotionJudgements.ReturnDate.Value.ToString(DateFormats.Default)
                                                                                    : "--")
                                                                                       </div>
                                                                                   </div>
                                                                               </div>
                                                                               <hr />
                                                                               <div colspan="2" class="info-bar" style="background-color:transparent; color:#1F365D; padding-top:0px;">
                                                                                   <div class="d-flex justify-content-between align-items-center">
                                                                                       <div class="info-bar-title">Key Dates</div>
                                                                                       @* <button type="button" class="btn btn-sm normal p-1" @onclick="ShowTenantModal" style="color:white">
                                                <i class="bi bi-pencil"></i>
                                            </button>*@
                                    </div>
                                </div>
                                <div class="info-row" style="display:flex; flex-direction:row">
                                    <!-- Column 1 -->
                                    <div class="info-block">
                                        <div class="label">Vacate Date:</div>
                                        <div class="value ellipsis">
                                            @(legalcaseDto.RemainderDate.HasValue
                                                                                    ? legalcaseDto.RemainderDate.Value.ToString(DateFormats.Default)
                                                                                    : "--")
                                                                                       </div>
                                                                                   </div>

                                    <!-- Column 2 -->
                                    <div class="info-block">
                                        <div class="label">Next Reminder:</div>
                                        <div class="value ellipsis">
                                            @(legalcaseDto.RemainderDate.HasValue
                                                                                    ? legalcaseDto.RemainderDate.Value.ToString(DateFormats.Default)
                                                                                    : "--")
                                    </div>
                                </div>
                            </div>

                            </div>
                            @*
                        <table class="info-table mb-4" style="border:none;">
                            <thead>
                                <tr>
                                    <th colspan="2" class="info-bar">

                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                            </tbody>
                        </table>

                        <table class="info-table" style="border:none;">
                            <thead>
                                <tr>
                                    <th colspan="2" class="info-bar">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="info-bar-title">Key Dates</div>
                                            @* <button type="button" class="btn btn-sm normal p-1" @onclick="ShowTenantModal" style="color:white">
                                                <i class="bi bi-pencil"></i>
                                            </button>*
                                        </div>
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr class="info-row" style="display:flex;">
                                    <!-- Column 1 --
                                    <td class="info-block">
                                        <div class="label">Vacate Date:</div>
                                        <div class="value ellipsis">
                                            @(legalcaseDto.RemainderDate.HasValue
                                                                                        ? legalcaseDto.RemainderDate.Value.ToString(DateFormats.Default)
                                                                                        : "--")
                                                                                           </div>
                                                                                       </td>

                                    <!-- Column 2 --
                                    <td class="info-block">
                                        <div class="label">Next Reminder:</div>
                                        <div class="value ellipsis">
                                            @(legalcaseDto.RemainderDate.HasValue
                                                                                        ? legalcaseDto.RemainderDate.Value.ToString(DateFormats.Default)
                                                                                        : "--")
                                        </div>
                                    </td>
                                </tr>


                                </tbody>
                            </table>

                        *@
                        </div>
                        <div class="col-4" style="padding: 0px 10px;">
                            @* <table class="info-table " style="border:none;">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="info-bar" >
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="info-bar-title">
                                                    <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important;margin-right:10px;">

                                                         <i class="fa-regular fa-user" style="font-size:16px;color:#fff !important;"></i> 
                                                    </div>
                                                People & Contact</div>
                                                <button type="button" class="btn btn-sm normal p-1" @onclick="ShowClientModal" style="color:#1F365D">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr class="info-row">
                                        <td class="info-cell label">Email:</td>
                                        <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.ClientEmail) ? "--" : legalcaseDto.ClientEmail)</td>
                                    </tr>

                                    <tr class="info-row">
                                        <td class="info-cell label">Phone No.:</td>
                                        <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.ClientPhone) ? "--" : legalcaseDto.ClientPhone)</td>
                                    </tr>

                                    <tr class="info-row">
                                        <td class="info-cell label">Address:</td>
                                        <td class="info-cell value ellipsis">
                                        @{
                                                var partclient = new List<string>();

                                                if (!string.IsNullOrWhiteSpace(legalcaseDto.Address1)) partclient.Add(legalcaseDto.Address1);
                                                if (!string.IsNullOrWhiteSpace(legalcaseDto.Address2)) partclient.Add(legalcaseDto.Address2);
                                                if (!string.IsNullOrWhiteSpace(legalcaseDto.City)) partclient.Add(legalcaseDto.City);
                                                if (!string.IsNullOrWhiteSpace(legalcaseDto.StateName)) partclient.Add(legalcaseDto.StateName);
                                                if (!string.IsNullOrWhiteSpace(legalcaseDto.ZipCode)) partclient.Add(legalcaseDto.ZipCode);

                                                var fulllClientAddress = partclient.Count() > 0 ? string.Join(", ", partclient) : "--";
                                            }
                                            @fulllClientAddress
                                        </td>
                                    </tr>
                                </tbody>
                            </table>*@

                            <Client currentCaseId="@caseId" />

                        </div>



                        <!-- Marshal Info -->
                        <div class="col-4" style="padding: 0px 10px;">
                            @*<table class="info-table " style="border:none;">
                                <thead>
                                    <tr>
                                        <th colspan="2" class="info-bar">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="info-bar-title">
                                                    <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important;margin-right:10px;">

                                                        <i class="fa-regular fa-circle-check" style="font-size:16px;color:#fff !important;"></i>
                                                     </div>
                                                Marshal & Warrant</div>
                                                <button type="button" class="btn btn-sm normal p-1" @onclick="ShowMarshalModal" style="color:#1F365D">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            </div>
                                        </th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <tr class="info-row">
                                        <td class="info-cell label">Name:</td>
                                        <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.MarshalName) ? "--" : legalcaseDto.MarshalName)</td>
                                    </tr>

                                    <tr class="info-row">
                                        <td class="info-cell label">Phone No.:</td>
                                        <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.MarshalPhone) ? "--" : legalcaseDto.MarshalPhone)</td>
                                    </tr>

                                    <tr class="info-row">
                                        <td class="info-cell label">Docket No.:</td>
                                        <td class="info-cell value ellipsis">
                                            @(string.IsNullOrWhiteSpace(legalcaseDto.Docketno) ? "--" : legalcaseDto.Docketno)

                                        </td>
                                    </tr>
                                </tbody>
                            </table> *@
                            <Marshal CurrentCaseId="@caseId" isReload="@isLoadMarshal" loggedInUserId="@loggedInUserId" />


                        </div>

                    </div>


                    <div class="row mb-4">
                        <div class="col-4">
                            <div class="info-table mb-4" style="border:none;">
                                <div class="info-bar">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="info-bar-title">
                                            <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important;margin-right:10px;">

                                                <i class="fa-solid fa-building-columns" style="font-size:16px;color:#fff !important;"></i>
                                            </div>
                                            Court
                                        </div>
                                        <button type="button" class="btn btn-sm normal p-1" @onclick="ShowCourtModal" title="Edit Courts" style="color:#1F365D">
                                        @if (isNewCourt)
                                            {
                                                <i class="fa-solid fa-plus"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-pencil"></i>

                                            }
                                        </button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="info-row-court row" style="display:flex;">
                                        <!-- Column 1 -->
                                        <div class="info-block-court col-4 flex-col">
                                            <div class="label">Court:</div>
                                            <div class="value">
                                                @(string.IsNullOrWhiteSpace(legalcaseDto.Court) ? "--" : legalcaseDto.Court)
                                            </div>
                                        </div>
                                        <div class="info-block-court col-4 flex-col">
                                            <div class="label">Part:</div>
                                            <div class="value">
                                                @(string.IsNullOrWhiteSpace(legalcaseDto.CourtPart) ? "--" : legalcaseDto.CourtPart)
                                            </div>
                                        </div>
                                        <div class="info-block-court  col-4 flex-col">
                                            <div class="label">Room:</div>
                                            <div class="value">
                                                @(string.IsNullOrWhiteSpace(legalcaseDto.CourtRoomNo) ? "--" : legalcaseDto.CourtRoomNo)
                                            </div>
                                        </div>

                                        <!-- Column 2 -->

                                    </div>

                                    <!-- ROW 2 -->
                                    <div class="info-row-court row" style="display:flex;">
                                        <!-- Column 1 -->
                                        <div class="info-block-court col-4 flex-col">
                                            <div class="label">Judge:</div>
                                            <div class="value">
                                                @(string.IsNullOrWhiteSpace(legalcaseDto.Judge) ? "--" : legalcaseDto.Judge)
                                            </div>
                                        </div>

                                        <!-- Column 2 -->
                                        <div class="info-block-court col-4 flex-col">
                                            <div class="label">Next Court Date:</div>
                                            <div class="value">
                                                @(legalcaseDto.NextCourtDate == null ? "--" : legalcaseDto.NextCourtDate?.ToString(DateFormats.Default))
                                            </div>
                                        </div>

                                        <div class="info-block-court col-4 flex-col">
                                            <div class="label">Index No.:</div>
                                            <div class="value">
                                                @(string.IsNullOrWhiteSpace(legalcaseDto.Index) ? "--" : legalcaseDto.Index)
                                            </div>
                                        </div>

                                    </div>
                                    <div class="info-row col-4" style="display:flex;">
                                        <!-- Column 1 -->
                                        <!-- Column 2 -->

                                    </div>

                                </div>
                            </div>
                            @* <table class="info-table mb-4" style="border:none;">
                            <thead>
                                <tr>
                                    <th colspan="2" class="info-bar">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="info-bar-title">Court & Opposing</div>
                                            <button type="button" class="btn btn-sm normal p-1" @onclick="ShowCourtModal" title="Edit Courts" style="color:white">
                                                @if (isNewCourt)
                                                {
                                                    <i class="fa-solid fa-plus"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-pencil"></i>

                                                }
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr class="info-row" style="display:flex;">
                                    <!-- Column 1 -->
                                    <td class="info-block">
                                        <div class="label">Court:</div>
                                        <div class="value ellipsis">
                                            @(string.IsNullOrWhiteSpace(legalcaseDto.Court) ? "--" : legalcaseDto.Court)
                                        </div>
                                    </td>

                                    <!-- Column 2 -->
                                    <td class="info-block">
                                        <div class="label">Room:</div>
                                        <div class="value ellipsis">
                                            @(string.IsNullOrWhiteSpace(legalcaseDto.CourtRoomNo) ? "--" : legalcaseDto.CourtRoomNo)
                                        </div>
                                    </td>
                                </tr>

                                <!-- ROW 2 -->
                                <tr class="info-row" style="display:flex;">
                                    <!-- Column 1 -->
                                    <td class="info-block">
                                        <div class="label">Part:</div>
                                        <div class="value ellipsis">
                                            @(string.IsNullOrWhiteSpace(legalcaseDto.CourtPart) ? "--" : legalcaseDto.CourtPart)
                                        </div>
                                    </td>

                                    <!-- Column 2 -->
                                    <td class="info-block">
                                        <div class="label">Judge:</div>
                                        <div class="value ellipsis">
                                            @(string.IsNullOrWhiteSpace(legalcaseDto.Judge) ? "--" : legalcaseDto.Judge)
                                        </div>
                                    </td>
                                </tr>
                                <tr class="info-row" style="display:flex;">
                                    <!-- Column 1 -->
                                    <td class="info-block">
                                        <div class="label">Next Court Date:</div>
                                        <div class="value ellipsis">
                                            @(legalcaseDto.NextCourtDate == null ? "--" : legalcaseDto.NextCourtDate?.ToString(DateFormats.Default))
                                        </div>
                                    </td>

                                    <!-- Column 2 -->
                                    <td class="info-block">
                                        <div class="label">Index No.:</div>
                                        <div class="value ellipsis">
                                            @(string.IsNullOrWhiteSpace(legalcaseDto.Index) ? "--" : legalcaseDto.Index)
                                        </div>
                                    </td>
                                </tr>


                            </tbody>
                        </table>

                        *@
                        </div>

                        <div class="col-8">
                            @* <div class="info-table " style="border:none;">
                                <div class="info-bar">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="info-bar-title">
                                        <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d; border-radius:7px !important;margin-right:10px;">

                                                        <i class="fa-regular fa-circle-check" style="font-size:16px;color:#fff !important;"></i> 
                                                    </div>
                                        Marshal & Warrant </div>
                                        <button type="button" class="btn btn-sm normal p-1" @onclick="ShowMarshalModal" style="color:#1F365D">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="info-row col-4">
                                        <div class="info-cell label">Warrant Issued:</div>
                                        <div class="info-cell value ellipsis">
                                            @(caseWarrantDto.WarrantIssued?.ToString(DateFormats.Default) ?? "--")

                                        </div>
                                    </div>
                                    <div class="info-row col-4">
                                        <div class="info-cell label">Warrant Rejected:</div>
                                        <div class="info-cell value ellipsis">
                                            @(caseWarrantDto.WarrantRejected?.ToString(DateFormats.Default) ?? "--")

                                        </div>
                                    </div>

                                    <div class="info-row col-4">
                                        <div class="info-cell label">Notice Served: </div>
                                        <div class="info-cell value ellipsis">
                                            @(caseWarrantDto.NoticeServed?.ToString(DateFormats.Default) ?? "--")

                                        </div>
                                    </div>
                                    <div class="info-row col-4">
                                        <div class="info-cell label">Warrant Status:</div>
                                        <div class="info-cell value ellipsis">@(legalcaseDto.WarrantRequested ? "Requested" : "Not Requested")</div>
                                    </div>

                                    <div class="info-row col-4">
                                        <div class="info-cell label">Execution Eligible:</div>
                                        <div class="info-cell value ellipsis">
                                            @(caseWarrantDto.ExecutionEligible?.ToString(DateFormats.Default) ?? "--")

                                        </div>
                                    </div>
                                    <div class="info-row col-4">
                                        <div class="info-cell label">Warrant Requested:</div>
                                        <div class="info-cell value ellipsis">
                                            @(caseWarrantDto.WarrantIssued?.ToString(DateFormats.Default) ?? "--")

                                        </div>
                                    </div>
                                    <div class="info-row col-4">
                                        <div class="info-cell label">Eviction Executed:</div>
                                        <div class="info-cell value ellipsis">
                                            @(caseWarrantDto.EvictionExecuted?.ToString(DateFormats.Default) ?? "--")

                                        </div>
                                    </div>
                                    <div class="info-row col-4">
                                        <div class="info-cell label">Scheduled Eviction:</div>
                                        <div class="info-cell value ellipsis">--</div>
                                    </div>





                                    <div class="info-row col-4">
                                        <div class="info-cell label">Re-File:</div>
                                        <div class="info-cell value ellipsis">
                                            @(caseWarrantDto.ReFileDate?.ToString(DateFormats.Default) ?? "--")

                                        </div>
                                    </div>

                                </div>
                            </div> *@
                            <Warrant CurrentCaseId="@caseId" isReload="@isLoadMarshal" loggedInUserId="@loggedInUserId" SelectedMarshalId="legalcaseDto.MarshalId" WarrantRequested="@legalcaseDto.WarrantRequested" />
                            @* <table class="info-table " style="border:none;">
                            <thead>
                                <tr>
                                    <th colspan="2" class="info-bar" >
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="info-bar-title">Warrant</div>
                                            <button type="button" class="btn btn-sm normal p-1" @onclick="ShowMarshalModal" style="color:white">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr class="info-row">
                                    <td class="info-cell label">Warrant Status:</td>
                                    <td class="info-cell value ellipsis">@(legalcaseDto.WarrantRequested ? "Requested" : "Not Requested")</td>
                                </tr>

                                <tr class="info-row">
                                    <td class="info-cell label">Scheduled Eviction:</td>
                                    <td class="info-cell value ellipsis">--</td>
                                </tr>

                                <tr class="info-row">
                                    <td class="info-cell label">Warrant Requested:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.WarrantIssued?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Warrant Issued:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.WarrantIssued?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Warrant Rejected:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.WarrantRejected?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Notice Served: </td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.NoticeServed?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Execution Eligible:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.ExecutionEligible?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Eviction Executed:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.EvictionExecuted?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Re-File:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.ReFileDate?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        *@
                        </div>
                    </div>
                    <!-- Court Info -->

                    <div class="row mb-4">
                        <div class="col-4">
                            <div class="bg-transparent mb-4">
                                <div class="Details-header"> Case Documents</div>
                            </div>

                            <div class="mb-4">
                                <div class="table-responsive" style="height:205px;">
                                    <table class="info-table" style="border:none; ">
                                        <thead>
                                            <tr>

                                                <th scope="col" class="info-bar" style="border-radius:8px 0px 0px 0px;  display:flex;align-items:center;">

                                                    ID
                                                </th>
                                                <th scope="col" class="info-bar" style="border-radius: 0px;">Forms</th>


                                                <th scope="col" class="info-bar" style="border-radius: 0px;">Created By</th>

                                                <th scope="col" style="width:12%;border-radius:0px ;" class="text-nowrap info-bar">Actions</th>
                                                <th scope="col" class="info-bar" style="border-radius: 0px;">Created On</th>

                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (caseFormDto != null && caseFormDto.Count() > 0)
                                            {
                                                int index = 1;
                                                @foreach (var form in caseFormDto)
                                                {
                                                    <tr class="info-row" style="display:table-row">
                                                        <td class="info-block-table">
                                                            <div class="value">@index</div>

                                                        </td>
                                                        <td class="info-block-table"><div class="value">@form.FormTypeName</div></td>

                                                        <td class="info-block-table"><div class="value">@form.CreatedByName</div></td>

                                                        <td class="d-flex justify-content-between info-block-table" style="gap:2px">
                                                            <span class="action-icon value" @onclick="@(() => ViewPdf(form.File))"><i class="fa-solid fa-eye"></i></span>
                                                            <span class="action-icon value" @onclick="@(() => EditCaseDetail(form.Id))"><i class="fa-solid fa-pen-to-square"></i></span>
                                                            <span class="action-icon-danger value" @onclick="@(() => DeleteCaseDetail(form.Id))"><i class="fa-solid fa-trash"></i></span>
                                                        </td>
                                                        <td class="info-block-table"><div class="value">@form.CreatedOn?.ToString(DateFormats.Default)</div></td>

                                                    </tr>
                                                    index++;
                                                }
                                            }
                                            else
                                            {
                                                <tr class="info-row">
                                                    <td colspan="4" class="text-muted text-center info-block-table"> <div class="value">No notices generated yet.</div></td>
                                                </tr>
                                            }

                                        </tbody>
                                    </table>
                                </div>



                            </div>
                            <div class="">
                                <div class="table-responsive" style="height:160px;">
                                    <table class="info-table">
                                        <thead>
                                            <tr>

                                                <th scope="col" class="info-bar" style="border-radius:8px 0px 0px 0px; display:flex;align-items:center;">

                                                    Uploaded Documents
                                                </th>
                                                <th scope="col" style="width:12%;border-radius:0px ;" class="text-nowrap info-bar">Actions</th>
                                                <th scope="col" style="width:12%;border-radius:0px ;" class="text-nowrap info-bar">Type</th>
                                                <th scope="col" style="width:12%;border-radius:0px ;" class="text-nowrap info-bar">CreatedBy</th>
                                                <th scope="col" class="info-bar" style="border-radius:0px;">Created On</th>

                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (caseDocuments != null && caseDocuments.Count() > 0)
                                            {
                                                @foreach (var docs in caseDocuments)
                                                {
                                                    <tr class="info-row" style="display:table-row;">

                                                        <td class="info-block-table"><div class="value">@docs.Name</div></td>

                                                        <td class="d-flex justify-content-between info-block-table" style="gap:2px">

                                                            <span class="action-icon value">
                                                                <i class="fa-solid fa-eye text-navy me-2" style="cursor:pointer"
                                                                   @onclick="@(() => PreviewDocument(docs.Path))"
                                                                   title="Preview"></i>

                                                            </span>
                                                            <span class="action-icon-danger value">
                                                                <i class="fa-solid fa-trash text-navy me-2" style="cursor:pointer"
                                                                   @onclick="@(() => DeleteCaseDocument(docs.Id))"
                                                                   title="Delete"></i>
                                                            </span>
                                                        </td>
                                                        <td class="info-block-table"><div class="value">@(docs.DocumentTypes?.Name ?? "--")</div></td>
                                                        <td class="info-block-table"><div class="value">@(docs.User?.FirstName ?? "--")</div></td>
                                                        <td class="info-block-table"><div class="value">@docs.CreatedOn.ToString(DateFormats.Default)</div></td>

                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr class="info-row">
                                                    <td colspan="4" class="text-muted text-center info-block-table"> <div class="value">No Document uploaded yet.</div></td>
                                                </tr>
                                            }

                                        </tbody>
                                    </table>
                                </div>



                            </div>

                        </div>
                        <div class="col-8 row">
                            <div class="col-12 mb-4">
                                <div class="table-responsive" style="height:160px;">
                                    <table class="info-table">
                                        <thead>
                                            <tr>

                                                <th scope="col" class="info-bar" style="border-radius:8px 0px 0px 0px; display:flex;align-items:center;">

                                                    ID
                                                </th>
                                                <th scope="col" class="info-bar" style="border-radius:0px;">Notes</th>
                                                <th scope="col" style="width:12%;border-radius:0px ;" class="text-nowrap info-bar">Actions</th>


                                                <th scope="col" class="info-bar" style="border-radius:0px;">Created By</th>

                                                <th scope="col" class="info-bar" style="border-radius:0px;">Created On</th>

                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (CaseNotes != null && CaseNotes.Count() > 0)
                                            {
                                                int index = 1;
                                                @foreach (var notes in CaseNotes)
                                                {
                                                    <tr class="info-row" style="display:table-row;">
                                                        <td class="info-block-table">
                                                            <div class="value">@index</div>

                                                        </td>
                                                        <td class="info-block-table"><div class="value">@notes.Notes</div></td>
                                                        <td class="d-flex justify-content-around info-block-table" style="gap:2px">

                                                            <span class="action-icon value" @onclick=" () => OpenNotesTab(notes.Id)"><i class="fa-solid fa-pen-to-square"></i></span>
                                                            <span class="action-icon-danger value"><i class="fa-solid fa-trash"></i></span>
                                                        </td>

                                                        <td class="info-block-table">
                                                            <div class="value">
                                                                @notes.User.FirstName
                                                            </div>
                                                        </td>
                                                        <td class="info-block-table"><div class="value">@notes.CreatedOn.ToString(DateFormats.Default)</div></td>

                                                    </tr>
                                                    index++;
                                                }
                                            }
                                            else
                                            {
                                                <tr class="info-row">
                                                    <td colspan="4" class="text-muted text-center info-block-table"> <div class="value">No notes submitted yet.</div></td>
                                                </tr>
                                            }

                                        </tbody>
                                    </table>
                                </div>



                            </div>

                            <div class="col-9">
                                <div class="ps-2 pe-2" style="background-color:white;border-radius:20px;">
                                    <div class="info-bar" style="background-color:#fff;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="info-bar-title">
                                                <div class="rounded-3 text-brand-primary d-flex align-items-center justify-content-center" style="width:28px;height:28px; background-color:#1f365d ; border-radius:7px !important;margin-right:10px;">

                                                    <i class="fa-solid fa-stairs" style="font-size:16px;color:#fff !important;"></i>
                                                </div>Timeline
                                            </div>

                                        </div>
                                    </div>
                                    <div class=para>
                                        <p class="text-secondary">Filed<span class="arrow ms-1 me-1">→</span>Service<span class="arrow ms-1 me-1">→</span>Judgment<span class="arrow ms-1 me-1">→</span>Environment</p>
                                    </div>



                                    <div class="timeline" id="timelineList">
                                        <div class="item" data-status="completed">
                                            <span class="dot"></span>

                                            <div class="text-secondary field-label font14 mx-2">@legalcaseDto.CreatedOn.ToString(DateFormats.Default)</div>
                                            <div class="fw-semibold label mx-2">Case Created</div>
                                            <div class="text-secondary field-label font14 mx-2">Initial Intake And File Opened</div>


                                        </div>
                                        @if (caseFormDto.Count() > 0)
                                        {
                                            @foreach (var item in caseFormDto)
                                            {

                                                <div class="item" data-status="completed">
                                                    <span class="dot"></span>
                                                    <div class="text-secondary field-label font14 mx-2">@(item.CreatedOn?.ToString(DateFormats.Default) ?? "---")</div>
                                                    <div class="fw-semibold label mx-2">Notice Served</div>
                                                    <div class="text-secondary field-label font14 mx-2">@(item.FormTypeName ?? "---")</div>


                                                </div>
                                            }
                                        }
                                        else
                                        {

                                            <div class="item" data-status="upcoming">
                                                <span class="dot"></span>
                                                <div class="text-secondary field-label font14 mx-2">--</div>
                                                <div class="fw-semibold label mx-2">Notice Not Generated</div>
                                                <div class="text-secondary field-label font14 mx-2">Pending Notice</div>


                                            </div>
                                        }
                                        @if (CaseHearings.Count() > 0)
                                        {
                                            @foreach (var item in CaseHearings)
                                            {
                                                <div class="item" data-status="current">
                                                    <span class="dot"></span>
                                                    <div class="text-secondary field-label font14 mx-2">@(item.HearingDate?.ToString(DateFormats.Default))</div>
                                                    <div class="fw-semibold label mx-2">Hearing Scheduled</div>
                                                    <div class="text-secondary field-label font14 mx-2">Awaiting confirmation from court</div>


                                                </div>

                                            }
                                        }
                                        else
                                        {

                                            <div class="item" data-status="upcoming">
                                                <span class="dot"></span>

                                                <div class="text-secondary field-label font14 mx-2">--</div>
                                                <div class="fw-semibold label mx-2">Hearing Scheduled</div>
                                                <div class="text-secondary field-label font14 mx-2">Awaiting confirmation from court</div>

                                            </div>

                                        }

                                        @if (Judgements.Count() > 0)
                                        {
                                            @foreach (var item in Judgements)
                                            {
                                                <div class="item" data-status="current">
                                                    <span class="dot"></span>

                                                    <div class="text-secondary field-label font14 mx-2">@item.AppreanceDate?.ToString(DateFormats.Default)</div>
                                                    <div class="fw-semibold label mx-2">@item.CourtTodayName</div>
                                                    <div class="text-secondary field-label font14 mx-2"></div>


                                                </div>
                                            }
                                        }
                                        else
                                        {

                                            <div class="item" data-status="upcoming">
                                                <span class="dot"></span>

                                                <div class="text-secondary field-label font14 mx-2">--</div>
                                                <div class="fw-semibold label mx-2">Judgment</div>
                                                <div class="text-secondary field-label font14 mx-2">Pending hearing</div>


                                            </div>
                                        }
                                        <div class="item" data-status="upcoming">
                                            <span class="dot"></span>
                                            <div class="text-secondary field-label font14 mx-2">--</div>
                                            <div class="fw-semibold label mx-2">Warrant/Enforcement</div>
                                            <div class="text-secondary field-label font14 mx-2">To be requested if applicable</div>


                                        </div>

                                    </div>

                                </div>

                            </div>
                            <div class="col-3">
                                <div class="" style="background-color:white;border-radius:20px;">
                                    <div class="vault-card">
                                        <div class=" vault-header d-flex justify-content-between align-items-center">
                                            <span class="vault-title">UPLOADS</span>

                                            <button class="vault-add-btn">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>

                                        <div class="vault-body">
                                            <div class="vault-icon">
                                                <i class="fa-regular fa-file-lines"></i>
                                            </div>

                                            <div class="vault-empty-text">VAULT EMPTY</div>

                                            <div class="vault-sync">
                                                <i class="fa-solid fa-cloud-arrow-down me-1"></i>
                                                CLOUD SYNC
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>


                    <!-- Tabs: Activity / Timeline / Actions -->
                    @*  <div class="card shadow-sm border-0">
                        <div class="card-header bg-transparent">
                            <ul class="nav nav-tabs card-header-tabs" id="caseTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active font14" id="activity-tab" data-bs-toggle="tab" @onclick="@(() => selectedTimeline = false)" data-bs-target="#activity" type="button" role="tab" aria-controls="activity" aria-selected="true">Activity</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link font14" id="timeline-tab" data-bs-toggle="tab" @onclick="@(() => selectedTimeline = true)" data-bs-target="#timeline" type="button" role="tab" aria-controls="timeline" aria-selected="false">Timeline</button>
                                </li>

                                <li class="nav-item" role="presentation">
                                    <button class="nav-link font14" id="warrant-tab" data-bs-toggle="tab" @onclick="@(() => selectedTimeline = false)" data-bs-target="#warrant" type="button" role="tab" aria-controls="warrant" aria-selected="false">Warrant</button>
                                </li>

                            </ul>
                        </div>
                        <div class="card-body tab-content" style=@(selectedTimeline ? "height: 450px; overflow: auto;" : "")>
                            <!-- Activity -->
                            <div class="tab-pane fade show active" id="activity" role="tabpanel" aria-labelledby="activity-tab">
                                <div class="table-responsive font14">

                                    <table class="table table-hover align-middle text-center" id="activityTable" style="width:700px">
                                        <thead class="table-light">
                                            <tr>
                                                <th scope="col">ID</th>
                                                <th scope="col">Forms</th>
                                            @if (isAdmin)
                                                {

                                                    <th scope="col">Created By</th>
                                                }
                                                <th scope="col">Created On</th>
                                                <th scope="col" style="width:12%;" class="text-nowrap">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (caseFormDto != null && caseFormDto.Count() > 0)
                                            {
                                                int index = 1;
                                                @foreach (var form in caseFormDto)
                                                {
                                                    <tr>
                                                        <td>@index</td>
                                                        <td>@form.FormTypeName</td>
                                                        @if (isAdmin)
                                                        {
                                                            <td>@form.CreatedByName</td>
                                                        }
                                                        <td>@form.CreatedOn?.ToString(DateFormats.Default)</td>
                                                        <td class="d-flex justify-content-between" style="gap:2px">
                                                            <span class="action-icon" @onclick="@(() => ViewPdf(form.File))"><i class="fa-solid fa-eye"></i></span>
                                                            <span class="action-icon" @onclick="@(() => EditCaseDetail(form.Id))"><i class="fa-solid fa-pen-to-square"></i></span>
                                                            <span class="action-icon-danger" @onclick="@(() => DeleteCaseDetail(form.Id))"><i class="fa-solid fa-trash"></i></span>
                                                        </td>
                                                    </tr>
                                                    index++;
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="4" class="text-muted text-center">No notices generated yet.</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Timeline -->
                            <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab">
                                <div class="mb-3">
                                    <div class="progress" role="progressbar" aria-label="Timeline progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                        <div class="progress-bar bg-brand-primary" id="timelineProgress" style="width:0%">0%</div>
                                    </div>
                                    <div class="text-secondary field-label small1 mt-1">Filed → Service → Hearing → Judgment → Enforcement</div>
                                </div>
                                <div class="timeline" id="timelineList">
                                    <div class="item" data-status="completed">
                                        <span class="dot bg-success"></span>
                                        <div class="text-secondary field-label small1 mx-2">@legalcaseDto.CreatedOn.ToString(DateFormats.Default) </div>
                                        <div class="fw-semibold font14 mx-2">Case Created</div>
                                        <div class="text-secondary field-label small1 mx-2">Initial intake and file opened</div>
                                    </div>
                                    @if (caseFormDto.Count() > 0)
                                    {
                                        @foreach (var item in caseFormDto)
                                        {
                                            <div class="item" data-status="completed">
                                                <span class="dot bg-success"></span>
                                                <div class="text-secondary field-label small1 mx-2">@(item.CreatedOn?.ToString(DateFormats.Default) ?? "---")</div>
                                                <div class="fw-semibold font14 mx-2">Notice Served</div>
                                                <div class="text-secondary field-label small1 mx-2">@(item.FormTypeName ?? "---")</div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="item" data-status="upcoming">
                                            <span class="dot bg-brand-primary"></span>
                                            <div class="text-secondary field-label small1 mx-2">---</div>
                                            <div class="fw-semibold font14 mx-2">Notice Not Generated</div>
                                            <div class="text-secondary field-label small1 mx-2">Pending Notice</div>
                                        </div>
                                    }

                                    @if (CaseHearings.Count() > 0)
                                    {
                                        @foreach (var item in CaseHearings)
                                        {
                                            <div class="item" data-status="current">
                                                <span class="dot bg-brand-primary"></span>
                                                <div class="text-secondary field-label small1 mx-2">@(item.HearingDate?.ToString(DateFormats.Default))</div>
                                                <div class="fw-semibold font14 mx-2">Hearing Scheduled</div>
                                                <div class="text-secondary field-label small1 mx-2">Awaiting confirmation from court</div>
                                            </div>
                                        }
                                    }
                                    else
                                    {

                                        <div class="item" data-status="upcoming">
                                            <span class="dot"></span>
                                            <div class="text-secondary field-label small1 mx-2">--</div>
                                            <div class="fw-semibold font14 mx-2">Hearing Scheduled</div>
                                            <div class="text-secondary field-label small1 mx-2">Awaiting confirmation from court</div>
                                        </div>
                                    }

                                    @if (Judgements.Count() > 0)
                                    {
                                        @foreach (var item in Judgements)
                                        {
                                            <div class="item" data-status="current">
                                                <span class="dot bg-brand-primary"></span>
                                                <div class="text-secondary field-label small1 mx-2">@item.AppreanceDate?.ToString(DateFormats.Default)</div>
                                                <div class="fw-semibold font14 mx-2">@item.CourtTodayName</div>
                                                <div class="text-secondary field-label small1 mx-2"></div>
                                            </div>
                                        }
                                    }
                                    else
                                    {

                                        <div class="item" data-status="upcoming">
                                            <span class="dot"></span>
                                            <div class="text-secondary field-label small1 mx-2">--</div>
                                            <div class="fw-semibold font14 mx-2">Judgment</div>
                                            <div class="text-secondary field-label small1 mx-2">Pending hearing</div>
                                        </div>
                                    }

                                    <div class="item" data-status="upcoming">
                                        <span class="dot"></span>
                                        <div class="text-secondary field-label small1 mx-2">--</div>
                                        <div class="fw-semibold font14 mx-2">Warrant/Enforcement</div>
                                        <div class="text-secondary field-label small1 mx-2">To be requested if applicable</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Warrant -->
                            <div class="tab-pane fade" id="warrant" role="tabpanel" aria-labelledby="warrant-tab">
                                <div class="row mb-3 d-flex align-items-center">

                                    <div class="fw-semibold font14 col-12">Assign Marshal</div>
                                </div>
                                <div class="row mt-2">

                                    <div class="col-6 position-relative" @onfocusout="HideMarshalDropDown">

                                        @if (!isMarshalAssigned)
                                        {
                                            <!-- Search Box -->

                                            <InputText class="holdover-forms search-box" placeholder="Search by marshal name.." @bind-value="searchmarshalText" @oninput="OnSearchMarshalInput"
                                                       @onclick="ShowAllmarshal" />
                                            <button class="search-btn" type="button">
                                                <i class="fa fa-search"></i>
                                            </button>




                                            @if (filteredmarshal?.Any() == true)
                                            {
                                                <ul class="dropdown-menu show" style="position:absolute; width:94%; cursor:pointer;">
                                                    @foreach (var c in filteredmarshal)
                                                    {
                                                        <li class="dropdown-item" @onclick="() => Selectedmarshal(c)">
                                                            @c.FirstName  @c.LastName
                                                        </li>
                                                    }
                                                </ul>
                                            }

                                        }
                                        else
                                        {
                                            <!-- Selected Marshal -->
                                            <label class="holdover-form bg-light font14 fw-bold d-flex align-items-center">
                                                @(selectedmarshal != null ? selectedmarshal.FirstName + " " + selectedmarshal.LastName : "")
                                            </label>

                                        }

                                    </div>

                                    <div class="col-6 d-flex justify-content-between">
                                        @if (!isMarshalAssigned)
                                        {
                                            <button class="btn bg-brand-primary base font14 text-white" @onclick="SubmitMarshal">Assign</button>

                                        }
                                        else
                                        {
                                            <button class="btn bg-brand-primary base font14 text-white" @onclick="ResetMarshal">Reset</button>

                                        }


                                        <button class="btn bg-brand-primary font14 base text-white ms-2"
                                                @onclick="GenrateMarshalForm"
                                                disabled="@(isMarshalAssigned == false)">
                                            Generate
                                        </button>


                                    </div>


                                </div>
                                <div class="row mt-2">
                                    <div class="col-12">
                                        @if (showMarshalError)
                                        {
                                            <div class="text-danger small1 mt-1">Please select a marshal.</div>
                                        }
                                    </div>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="tab-pane fade" id="actions" role="tabpanel" aria-labelledby="actions-tab">
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button class="btn btn-secondary ">Send to Marshal</button>
                                    <button class="btn btn-secondary">Send to Process Server</button>
                                    <button class="btn btn-outline-secondary">Upload / View Documents</button>
                                    <button class="btn btn-outline-secondary">Add Notes</button>
                                    <button class="btn btn-outline-secondary" @onclick="OpenHearingPopup">Add Hearing</button>
                                </div>
                                <EditForm Model="noticeModel" FormName="NoticeForm" OnValidSubmit="GenerateNotice">
                                    <DataAnnotationsValidator />
                                    <div class="row g-2 align-items-end">
                                        <div class="col-12 col-md-6">
                                            <label for="formType" class="form-label">File a Motion</label>
                                            <select class="form-select" @bind="noticeModel.FormTypeId" @bind:after="FormTypeBindAfter">
                                                <option value="">-- Select --</option>
                                                @foreach (var formType in FilteredFormTypeList)
                                                {
                                                    <option value="@formType.Id">@formType.Name @(formType.Rate != null ? $"- (${formType.Rate}) " : "")</option>
                                                }
                                            </select>
                                            <ValidationMessage For="() => noticeModel.FormTypeId" />
                                        </div>
                                        <div class="col-auto">
                                            <div class=" input-group" style="width:140px">
                                                <span class="input-group-text">$</span>
                                                <input class="form-control" type="number" @bind="noticeModel.BillAmount">
                                            </div>
                                            <ValidationMessage For="() => noticeModel.BillAmount" />
                                        </div>
                                        <div class="col-auto">
                                            <button class="btn bg-brand-primary base">  @(isEditMode ? "Update" : "Generate")</button>
                                        </div>
                                    </div>

                                </EditForm>
                            </div>
                        </div>
                    </div>*@
                </div>

                <!-- Right -->
                <div class="col-12 col-lg-5 d-flex flex-column gap-4">
                    <!-- Payment Info -->
                    <!-- <div class="card shadow-sm border-0">
                        <div class="card-header bg-transparent">
                            <div class="fw-semibold d-flex align-items-center gap-2"><i class="bi bi-cash-coin"></i> Payment Information</div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 small1" id="paymentsGrid">
                                <div class="col-12 col-md-6 col-lg-6"><div class="border rounded-3 p-3"><div class="text-secondary field-label">Account Balance</div><div class="fw-medium field-value">--</div></div></div>
                                <div class="col-12 col-md-6 col-lg-6"><div class="border rounded-3 p-3"><div class="text-secondary field-label">Account Credit</div><div class="fw-medium field-value">--</div></div></div>

                            </div>
                            <div class="row g-3 mt-2 small1" id="paymentsGrid">

                                <div class="col-12 col-md-6 col-lg-6"><div class="border rounded-3 p-3"><div class="text-secondary field-label">Balance on Case</div><div class="fw-medium field-value">@(legalcaseDto.BillAmount ?? 0)</div></div></div>
                                <div class="col-12 col-md-6 col-lg-6"><div class="border rounded-3 p-3"><div class="text-secondary field-label">Last Payment</div><div class="fw-medium field-value">--</div></div></div>

                            </div>
                            <div class="row g-3 mt-2 small1" id="paymentsGrid">
                                <div class="col-12 col-md-6 col-lg-6"><div class="border rounded-3 p-3"><div class="text-secondary field-label">Open Receivables</div><div class="fw-medium field-value">--</div></div></div>
                            </div>
                        </div>
                    </div> -->
                    <!-- Stipulation & Reminders -->
                    @* <div class="card shadow-sm border-0">
                    <div class="card-header d-flex justify-content-between align-items-center bg-transparent">
                        <div class="fw-semibold d-flex font14 align-items-center gap-2"><i class="bi bi-cash-coin"></i>Stipulation & Reminders</div>
                        <button type="button" class="btn btn-sm normal p-1" title="Edit Client" @onclick="ShowStipulationModal">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                    <div class="card-body">

                        <div class="border rounded-3 p-3">
                            <h6 class="font14">Motion Schedule</h6>
                            <div class="row g-3 small1" id="paymentsGrid">
                                <div class="col-12 col-md-6 col-lg-6 mt-0"><div class=" pt-3 d-flex" style="align-items:baseline"><div class=" text-secondary field-label">Motion Due:</div><div class=" fw-medium field-value text-end1">@(MotionJudgements.MotionDue.HasValue? MotionJudgements.MotionDue.Value.ToString(DateFormats.Default) : "--")</div></div></div>
                                <div class="col-12 col-md-6 col-lg-6 mt-0"><div class=" pt-3 d-flex" style="align-items:baseline"><div class=" text-secondary field-label">Opposition Due:</div><div class=" fw-medium field-value text-end1">@(MotionJudgements.OppositionDue.HasValue? MotionJudgements.OppositionDue.Value.ToString(DateFormats.Default) : "--")</div></div></div>

                            </div>
                            <div class="row g-3 mt-2 small1" id="paymentsGrid">
                                <div class="col-12 col-md-6 col-lg-6 mt-0"><div class=" d-flex" style="align-items:baseline"><div class=" text-secondary field-label">Reply Due:</div><div class=" fw-medium field-value text-end1">@(MotionJudgements.ReplyDue.HasValue? MotionJudgements.ReplyDue.Value.ToString(DateFormats.Default) : "--")</div></div></div>
                                <div class="col-12 col-md-6 col-lg-6 mt-0"><div class=" d-flex" style="align-items:baseline"><div class=" text-secondary field-label">OSC / Return:</div><div class=" fw-medium field-value text-end1">@(MotionJudgements.ReturnDate.HasValue? MotionJudgements.ReturnDate.Value.ToString(DateFormats.Default) : "--")</div></div></div>

                            </div>
                        </div>

                        <div class="border rounded-3  p-3 mt-4 small1">
                            <h6 class="mt-0 font14">Key Dates</h6>
                            <div class="row g-3 mt-2" id="paymentsGrid">
                                <div class="col-12 col-md-6 col-lg-6 mt-0"><div class="d-flex pt-2" style="align-items:baseline"><div class=" text-secondary field-label">Vacate Dat</div><div class=" text-end1 fw-medium field-value">@(legalcaseDto.ExpirationDate.HasValue? legalcaseDto.ExpirationDate.Value.ToString(DateFormats.Default) : "--")</div></div></div>
                                <div class="col-12 col-md-6 col-lg-6 mt-0">
                                    <div class="pt-2 d-flex" style="align-items:baseline">
                                        <div class=" text-secondary field-label">Next Reminder</div><div class=" text-end1 fw-medium field-value">
                                            @(legalcaseDto.RemainderDate.HasValue
                                                                                        ? legalcaseDto.RemainderDate.Value.ToString(DateFormats.Default)
                                                                                        : "--")
                                        </div>
                                    </div>
                                </div>
                            </div>



                            </div>
                        </div>
                    </div>*@
                    <!-- Contact Info -->
                    @* <div class="card shadow-sm p-3 border-0">
                        <table class="info-table " style="border:none;">
                            <thead>
                                <tr>
                                    <th colspan="2" class="info-bar" style="background-color:#DDB156;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="info-bar-title">People & Contact</div>
                                            <button type="button" class="btn btn-sm normal p-1" @onclick="ShowClientModal" style="color:white">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr class="info-row">
                                    <td class="info-cell label">Email:</td>
                                    <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.ClientEmail) ? "--" : legalcaseDto.ClientEmail)</td>
                                </tr>

                                <tr class="info-row">
                                    <td class="info-cell label">Phone No.:</td>
                                    <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.ClientPhone) ? "--" : legalcaseDto.ClientPhone)</td>
                                </tr>

                                <tr class="info-row">
                                    <td class="info-cell label">Address:</td>
                                    <td class="info-cell value ellipsis">
                                        @{
                                            var partclient = new List<string>();

                                            if (!string.IsNullOrWhiteSpace(legalcaseDto.Address1)) partclient.Add(legalcaseDto.Address1);
                                            if (!string.IsNullOrWhiteSpace(legalcaseDto.Address2)) partclient.Add(legalcaseDto.Address2);
                                            if (!string.IsNullOrWhiteSpace(legalcaseDto.City)) partclient.Add(legalcaseDto.City);
                                            if (!string.IsNullOrWhiteSpace(legalcaseDto.StateName)) partclient.Add(legalcaseDto.StateName);
                                            if (!string.IsNullOrWhiteSpace(legalcaseDto.ZipCode)) partclient.Add(legalcaseDto.ZipCode);

                                            var fulllClientAddress = partclient.Count() > 0 ? string.Join(", ", partclient) : "--";
                                        }
                                        @fulllClientAddress
                                    </td>
                                </tr>
                            </tbody>
                        </table>



                    </div>

                    <!-- Marshal Info -->
                    <div class="card shadow-sm p-3 border-0">
                        <table class="info-table " style="border:none;">
                            <thead>
                                <tr>
                                    <th colspan="2" class="info-bar">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="info-bar-title">Marshal</div>
                                            <button type="button" class="btn btn-sm normal p-1" @onclick="ShowMarshalModal" style="color:white">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr class="info-row">
                                    <td class="info-cell label">Name:</td>
                                    <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.MarshalName) ? "--" : legalcaseDto.MarshalName)</td>
                                </tr>

                                <tr class="info-row">
                                    <td class="info-cell label">Phone No.:</td>
                                    <td class="info-cell value ellipsis">@(string.IsNullOrWhiteSpace(legalcaseDto.MarshalPhone) ? "--" : legalcaseDto.MarshalPhone)</td>
                                </tr>

                                <tr class="info-row">
                                    <td class="info-cell label">Docket No.:</td>
                                    <td class="info-cell value ellipsis">
                                        @(string.IsNullOrWhiteSpace(legalcaseDto.Docketno) ? "--" : legalcaseDto.Docketno)

                                    </td>
                                </tr>
                            </tbody>
                        </table>



                    </div>

                    *
                    <div class="card shadow-sm p-3 border-0 pb-4">
                        <table class="info-table " style="border:none;">
                            <thead>
                                <tr>
                                    <th colspan="2" class="info-bar" style="background-color: #DDB156;">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="info-bar-title">Warrant</div>
                                            <button type="button" class="btn btn-sm normal p-1" @onclick="ShowMarshalModal" style="color:white">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr class="info-row">
                                    <td class="info-cell label">Warrant Status:</td>
                                    <td class="info-cell value ellipsis">@(legalcaseDto.WarrantRequested ? "Requested" : "Not Requested")</td>
                                </tr>

                                <tr class="info-row">
                                    <td class="info-cell label">Scheduled Eviction:</td>
                                    <td class="info-cell value ellipsis">--</td>
                                </tr>

                                <tr class="info-row">
                                    <td class="info-cell label">Warrant Requested:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.WarrantIssued?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Warrant Issued:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.WarrantIssued?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Warrant Rejected:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.WarrantRejected?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Notice Served: </td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.NoticeServed?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Execution Eligible:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.ExecutionEligible?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Eviction Executed:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.EvictionExecuted?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                                <tr class="info-row">
                                    <td class="info-cell label">Re-File:</td>
                                    <td class="info-cell value ellipsis">
                                        @(caseWarrantDto.ReFileDate?.ToString(DateFormats.Default) ?? "--")

                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Rent Description -->
                    @*<div class="card shadow-sm border-0">
                        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
                            <div class="fw-semibold  gap-2"><i class="bi bi-hammer"></i> Rent Description</div>
                            <button type="button" class="btn btn-sm normal p-1" title="Edit Rent" @onclick="ShowRentModal">

                                <i class="bi bi-pencil"></i>


                            </button>
                        </div>

                        <div class="card-body">
                            <div class="row g-3 small1" id="rentGrid">
                                <div class="col-12 col-md-6 "><div class="border rounded-3 p-3"><div class="text-secondary field-label">Monthly Rent</div><div class="fw-medium field-value" id="rentMonthly">$@(legalcaseDto.MonthlyRent == null ? "--" : $"{legalcaseDto.MonthlyRent.Value:N2}")</div></div></div>
                                <div class="col-12 col-md-6 "><div class="border rounded-3 p-3"><div class="text-secondary field-label">Distribution Total</div><div class="fw-medium field-value" id="rentDist">--</div></div></div>
                                <div class="col-12 col-md-6"><div class="border rounded-3 p-3"><div class="text-secondary field-label">Additional Charges</div><div class="fw-medium field-value" id="rentAddtl">--</div></div></div>
                                <div class="col-12 col-md-6"><div class="border rounded-3 p-3"><div class="text-secondary field-label">Legal Print</div><div class="fw-medium field-value" id="rentLegal">--</div></div></div>
                            </div>
                        </div>
                    </div>
                    *
                    <div class="card shadow-sm p-3 border-0" style="height:180px;">
                        <div class="table-responsive">
                            <table class="info-table mb-4" style="border:none;">
                                <thead style="background-color:#ECF2FF;">
                                    <tr>
                                        <th scope="col" class="info-bar" style="border-radius:8px 0px 0px 0px;background: #ECF2FF;color: #1F365D">Uploaded Documents</th>
                                        <th scope="col" class="info-bar" style="border-radius:0px;background: #ECF2FF;color: #1F365D">Created On</th>
                                        <th scope="col" style="width:12%;border-radius:0px 8px 0px 0px;background: #ECF2FF;color: #1F365D" class="text-nowrap info-bar">Actions</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    @if (caseDocuments != null && caseDocuments.Count() > 0)
                                    {
                                        @foreach (var docs in caseDocuments)
                                        {
                                            <tr class="info-row">

                                                <td class="info-block-table"><div class="value">@docs.Name</div></td>

                                                <td class="info-block-table"><div class="value">@docs.CreatedOn.ToString(DateFormats.Default)</div></td>
                                                <td class="d-flex justify-content-between info-block-table" style="gap:2px">

                                                    <span class="action-icon value">
                                                        <i class="fa-solid fa-eye text-navy me-2" style="cursor:pointer"
                                                           @onclick="@(() => PreviewDocument(docs.Path))"
                                                           title="Preview"></i>

                                                    </span>
                                                    <span class="action-icon-danger value">
                                                        <i class="fa-solid fa-trash text-navy me-2" style="cursor:pointer"
                                                           @onclick="@(() => DeleteCaseDocument(docs.Id))"
                                                           title="Delete"></i>
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr class="info-row">
                                            <td colspan="4" class="text-muted text-center info-block-table"> <div class="value">No Document uploaded yet.</div></td>
                                        </tr>
                                    }

                                </tbody>
                            </table>
                        </div>



                    </div>

                    @*  <div class="card shadow-sm border-0">
                        <div class="card-header bg-transparent">
                            <div class="fw-semibold font14">Case Documents</div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive font14">
                                <table class="table  table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="nowrap">File Name</th>
                                            <th class="nowrap">Uploaded On</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        @if (caseDocuments is not null && caseDocuments.Count() > 0)
                                        {
                                            @foreach (var doc in caseDocuments)
                                            {
                                                <tr>
                                                    <td class="nowrap">@doc.Name</td>
                                                    <td class="nowrap">@doc.CreatedOn.ToString(DateFormats.Default)</td>

                                                    <td class="text-center" style="display:flex">

                                                        <i class="fa-solid fa-eye text-navy me-2" style="cursor:pointer"
                                                           @onclick="@(() => PreviewDocument(doc.Path))"
                                                           title="Preview"></i>

                                                        <i class="fa-solid fa-trash-can text-navy me-2" style="cursor:pointer"
                                                           @onclick="@(() => DeleteCaseDocument(doc.Id))"
                                                           title="Delete"></i>


                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">
                                                    No documents uploaded for this case.
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>*@
                </div>
            </section>
            @* <section class="row g-4 mt-1">

                <div class="col-12 col-lg-12 d-flex flex-column gap-4">
                    <div class="card shadow-sm border-0 p-3">
                        <div class="info-bar">Timeline</div>
                        <div class=para>
                            <p class="text-secondary">Filed<span class="arrow ms-1 me-1">→</span>Service<span class="arrow ms-1 me-1">→</span>Judgment<span class="arrow ms-1 me-1">→</span>Environment</p>
                        </div>



                        <div class="timeline" id="timelineList">
                            <div class="item" data-status="completed">
                                <span class="dot"></span>

                                <div class="text-secondary field-label font14 mx-2">@legalcaseDto.CreatedOn.ToString(DateFormats.Default)</div>
                                <div class="fw-semibold label mx-2">Case Created</div>
                                <div class="text-secondary field-label font14 mx-2">Initial Intake And File Opened</div>


                            </div>
                            @if (caseFormDto.Count() > 0)
                            {
                                @foreach (var item in caseFormDto)
                                {

                                    <div class="item" data-status="completed">
                                        <span class="dot"></span>
                                        <div class="text-secondary field-label font14 mx-2">@(item.CreatedOn?.ToString(DateFormats.Default) ?? "---")</div>
                                        <div class="fw-semibold label mx-2">Notice Served</div>
                                        <div class="text-secondary field-label font14 mx-2">@(item.FormTypeName ?? "---")</div>


                                    </div>
                                }
                            }
                            else
                            {

                                <div class="item" data-status="upcoming">
                                    <span class="dot"></span>
                                    <div class="text-secondary field-label font14 mx-2">--</div>
                                    <div class="fw-semibold label mx-2">Notice Not Generated</div>
                                    <div class="text-secondary field-label font14 mx-2">Pending Notice</div>


                                </div>
                            }
                            @if (CaseHearings.Count() > 0)
                            {
                                @foreach (var item in CaseHearings)
                                {
                                    <div class="item" data-status="current">
                                        <span class="dot"></span>
                                        <div class="text-secondary field-label font14 mx-2">@(item.HearingDate?.ToString(DateFormats.Default))</div>
                                        <div class="fw-semibold label mx-2">Hearing Scheduled</div>
                                        <div class="text-secondary field-label font14 mx-2">Awaiting confirmation from court</div>


                                    </div>

                                }
                            }
                            else
                            {

                                <div class="item" data-status="upcoming">
                                    <span class="dot"></span>

                                    <div class="text-secondary field-label font14 mx-2">--</div>
                                    <div class="fw-semibold label mx-2">Hearing Scheduled</div>
                                    <div class="text-secondary field-label font14 mx-2">Awaiting confirmation from court</div>

                                </div>

                            }

                            @if (Judgements.Count() > 0)
                            {
                                @foreach (var item in Judgements)
                                {
                                    <div class="item" data-status="current">
                                        <span class="dot"></span>

                                        <div class="text-secondary field-label font14 mx-2">@item.AppreanceDate?.ToString(DateFormats.Default)</div>
                                        <div class="fw-semibold label mx-2">@item.CourtTodayName</div>
                                        <div class="text-secondary field-label font14 mx-2"></div>


                                    </div>
                                }
                            }
                            else
                            {

                                <div class="item" data-status="upcoming">
                                    <span class="dot"></span>

                                    <div class="text-secondary field-label font14 mx-2">--</div>
                                    <div class="fw-semibold label mx-2">Judgment</div>
                                    <div class="text-secondary field-label font14 mx-2">Pending hearing</div>


                                </div>
                            }
                            <div class="item" data-status="upcoming">
                                <span class="dot"></span>
                                <div class="text-secondary field-label font14 mx-2">--</div>
                                <div class="fw-semibold label mx-2">Warrant/Enforcement</div>
                                <div class="text-secondary field-label font14 mx-2">To be requested if applicable</div>


                            </div>

                        </div>

                    </div>
                </div>
            </section>
            *@
        </main>
    }

    <script>
        window.showBootstrapTab = function (tabId) {
        var triggerEl = document.querySelector(tabId);
        if (triggerEl) {
        var tab = bootstrap.Tab.getOrCreateInstance(triggerEl);
        tab.show();
        }
        };
    </script>

    <!-- Tenant Edit Modal -->
    @* <div class="modal fade" id="tenantModal" tabindex="-1" aria-labelledby="tenantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 800px !important;">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title" id="tenantModalLabel">Edit Tenant Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body row ">
                    <div class="col-12">
                        <div class="p-3">

                            <div class="card-body">
                                <!-- Unit / Apt -->
                                <EditForm EditContext="_editContext">
                                    <div class="row position-relative">

                                        <div class="col-md-6" @onfocusout="HideTenantDropDown">
                                            <label class="form-label  required-label">Unit / Apt # (confirm)</label>
                                            <button type="button" class=" buttons position-absolute top-0 end-0 m-2 mt-0" style="background: transparent; border: none;"
                                                    aria-label="Clear"
                                                    @onclick="OnBindTenantCancel">
                                                <i class="fa-solid fa-xmark"></i> Clear
                                            </button>


                                            <input type="text" class="form-control"
                                                   placeholder="Enter Unit / Apt"
                                                   @bind-value="searchTenantText"
                                                   @oninput="OnSearchTenantInput" @onblur="SelectTenant" @onclick="ShowAllTenantForHoldover" />
                                            @if (filteredTenant?.Count() > 0)
                                            {
                                                <ul class="dropdown-menu show" style="position: absolute; width:94% !important; cursor:pointer;">
                                                    @foreach (var c in filteredTenant)
                                                    {
                                                        <li class="dropdown-item" @onclick="() => SelectedTenant(c)">
                                                            @c.UnitOrApartmentNumber / @c.FirstName @c.LastName
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="form-check form-switch" style="padding-left:10px">

                                            <label class="form-check-label form-label mb-0 me-2" for="primaryResidenceSwitch">
                                                <span class="required-label">Primary Residence?</span> :

                                            </label>
                                            <input class="form-check-input" style="float:none;"
                                                   type="checkbox"
                                                   id="ownerOccupiedSwitch"
                                                   @bind="legalcaseDto.PrimaryResidence" />
                                        </div>


                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-6 g-1 row">
                                            <label class="lbl edit-tent">Tenants</label>
                                            @if (Tenants.Count > 0)
                                            {

                                                @foreach (var tenant in Tenants.Select((t, i) => new { t, i }))
                                                {
                                                    <div class="col-10">
                                                        <input class="form-control"
                                                               placeholder="Tenant Full Name"
                                                               @bind-value="Tenants[tenant.i]"
                                                               @onblur="() => OnchangeAdditionalTenant(tenant.i)" />
                                                    </div>
                                                    if (tenant.i > 0)
                                                    {
                                                        <div class="col-2">
                                                            <button type="button"
                                                                    class="btn btn-delete" style="border :none;"
                                                                    @onclick="@(() => DeleteAdditionalTenant(tenant.i))">
                                                                <i class="fa-solid fa-xmark"></i>
                                                            </button>
                                                        </div>
                                                    }

                                                }

                                            }
                                            <div class="col-10">
                                                <button class="btn btn-sm btn-primary btn-tenant mt-2 edit-tent" @onclick="AddTenant">＋ Add Tenant</button>
                                            </div>

                                        </div>

                                        <div class="col-6 row g-1">
                                            <label class="lbl edit-tent">Undertenants / Other Occupants</label>
                                            @if (UnderTenants.Count > 0)
                                            {

                                                @foreach (var undertenant in UnderTenants.Select((t, i) => new { t, i }))
                                                {
                                                    <div class="col-10">
                                                        <input class="form-control"
                                                               placeholder="Other Occupant Name"
                                                               @bind-value="UnderTenants[undertenant.i]"
                                                               @onblur="() => OnchangeAdditionalOccupants(undertenant.i)" />
                                                    </div>
                                                    <div class="col-2">
                                                        <button type="button"
                                                                class="btn btn-delete" style="border :none;"
                                                                @onclick="@(() => DeleteAdditionalOccupant(undertenant.i))">
                                                            <i class="fa-solid fa-xmark"></i>
                                                        </button>
                                                    </div>

                                                }
                                            }
                                            <div class="col-10">
                                                <button class=" btn btn-sm btn-primary btn-tenant mt-2 edit-tent" @onclick="AddUnder">＋ Add Undertenant/Occupant</button>

                                            </div>

                                        </div>
                                    </div>

                                    <div class="row mt-3 g-3">
                                        <div class="col-md-4">
                                            <label class="form-label required-label">Rent Due Frequency</label>
                                            <InputSelect class="form-select" @bind-Value="legalcaseDto.RentDueEachMonthOrWeekId">
                                                <option value="">-- Select --</option>
                                                @foreach (var l in DateRentList)
                                                {
                                                    <option value="@l.Id">@l.Name</option>
                                                }
                                            </InputSelect>
                                            <ValidationMessage For="() => legalcaseDto.RentDueEachMonthOrWeekId" />
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label required-label">Monthly Rent ($)</label>
                                            <InputNumber class="form-control" @bind-Value="legalcaseDto.MonthlyRent" />
                                            <ValidationMessage For="() => legalcaseDto.MonthlyRent" />

                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label">Tenant's Share ($)</label>
                                            <InputNumber class="form-control" @bind-Value="legalcaseDto.TenantShare" />
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label required-label">Tenancy Type</label>
                                            <InputSelect class="form-select" @bind-Value="legalcaseDto.TenancyTypeId" @bind-Value:after="CalcNoticeDays">
                                                <option value="">-- Select --</option>
                                                @foreach (var t in TenancyTypeList)
                                                {
                                                    <option value="@t.Id">@t.Name</option>
                                                }
                                            </InputSelect>
                                            <ValidationMessage For="() => legalcaseDto.TenancyTypeId" />
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label">Last Payment Date</label>

                                            <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="legalcaseDto.LastPaymentDate" @bind-Value:after="GenerateMonths" />
                                        </div>

                                        <div class="col-md-4">
                                            <label class="form-label">Last Payment Amount ($)</label>
                                            <InputNumber class="form-control" @bind-Value="legalcaseDto.LastPayment" />
                                        </div>
                                        @if (legalcaseDto.CaseTypeName == "NonPayment")
                                        {
                                            <div class="col-md-4">
                                                <label class="form-label ">Lease Start </label>
                                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="legalcaseDto.LeaseStart" />

                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label ">Lease End </label>
                                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="legalcaseDto.LeaseEnd" />

                                            </div>
                                            // <div class="col-md-4">
                                            //     <label class="form-label" style="align-items: center;display: flex;height: 36px;">Written Lease?</label>
                                            //     <div class="d-flex justify-content-start align-items-center  gap-2">
                                            //         <InputRadioGroup @bind-Value="legalcaseDto.WrittenLease">
                                            //             <div class="form-check d-flex justify-content-center gap-2">
                                            //                 <InputRadio class="form-check-input" Value="true" style="font-size:15px" />
                                            //                 <label class="form-check-label">Yes</label>
                                            //             </div>
                                            //             <div class="form-check  d-flex justify-content-center gap-2">
                                            //                 <InputRadio class="form-check-input " Value="false" style="font-size:15px" />
                                            //                 <label class="form-check-label">No</label>
                                            //             </div>
                                            //         </InputRadioGroup>
                                            //     </div>
                                            // </div> 
                                        }

                                    </div>

                                    <div class="row g-2 mt-2">
                                        <div class="col">
                                            <label class="form-label edit-tent">Rent Breakup</label>
                                            <div class="total-box mt-1">
                                                <label class="form-label " style="font-size:14px; font-weight:300; margin-bottom:0px;">Total Owed: $ @(legalcaseDto.TotalOwed ?? 00)</label>
                                            </div>

                                            @foreach (var item in Rows)
                                            {
                                                <div class="row mb-3">
                                                    <div class="col-4">
                                                        <label class="form-label ">Month (YYYY-MM) </label>
                                                        <InputSelect class="form-select holdover-form"
                                                                     @bind-Value="item.Month"
                                                                     @bind-Value:after="(() => OnMonthChanged(item))">

                                                            <option value="">Select month</option>

                                                            @foreach (var m in MonthOptions)
                                                            {
                                                                <option value="@m.Value">@m.Display</option>
                                                            }

                                                        </InputSelect>
                                                    </div>
                                                    <div class="col-3">
                                                        <label class="form-label  ">Amount ($) </label>
                                                        <InputNumber @bind-Value="item.Amount" @bind-Value:after="RecalculateTotal"
                                                                     class="form-control" />
                                                    </div>

                                                    <div class="col-3">
                                                        <label class="form-label  ">Notes </label>
                                                        <InputText @bind-Value="item.Notes"
                                                                   class="form-control" placeholder="Partial, vouchers, etc." />
                                                    </div>

                                                    <div class="col-2" style="justify-content:end; display:flex;">
                                                        <button type="button" class="remove-btn " @onclick="(() => RemoveRow(item))">
                                                            <i class="fa-solid fa-xmark"></i>
                                                        </button>
                                                    </div>


                                                </div>
                                            }

                                            <button type="button" class="add-btn edit-tent" @onclick="AddRow">
                                                + Add Month
                                            </button>
                                        </div>
                                    </div>


                                </EditForm>

                            </div>
                        </div>



                    </div>
                </div>
                <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                    <button type="button" class="btn btn-secondary buttons" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary base buttons" @onclick="SaveTenantChanges">Save</button>
                </div>
            </div>

        </div>

    </div> *@

    <!-- Building Edit Modal -->
    @*
  <div class="modal fade" id="buildingModal" tabindex="-1" aria-labelledby="buildingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 55%;">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="buildingModalLabel">Edit Building Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <EditForm Model="@editBuildingModel">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class=" border-0">
                            <div class="card-body p-0">

                               
                                <div class="row mt-2">
                                    @if (!showBuildingFields)
                                    {
                                        <div class="col-md-6 position-relative" @onfocusout="HideBuildingDropdown">
                                            <label class="form-label  required-label">Building</label>
                                            <input type="text" class="form-control"
                                                   placeholder="Search by Building Address or code..."
                                                   @bind-value="searchBuildingText" @onclick="ShowAllBuildings"
                                                   @oninput="OnSearchBuildingInput" />
                                            @if (filteredBuildings?.Count() > 0)
                                            {
                                                <ul class="dropdown-menu show" style="position: absolute; width:94% !important; cursor:pointer;">
                                                    @foreach (var c in filteredBuildings)
                                                    {
                                                        <li class="dropdown-item" @onclick="() => SelectBuilding(c)">
                                                            @c.BuildingCode / @c.Address1
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                            <ValidationMessage For="() => legalcaseDto.BuildingId" />
                                        </div>
                                    }

                                    @if (!showBuildingFields)
                                    {
                                        <div class="col-md-1 d-flex justify-content-center align-items-end pb-2">
                                            <span>OR</span>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-primary base buttons" @onclick="OnBindBuildingAfter">+ Add</button>
                                        </div>
                                    }
                                </div>

                                <!-- Add/Edit Fields -->
                                @if (showBuildingFields)
                                {
                                    <div class=" rounded-3 p-3 position-relative">
                                        <button type="button" class="buttons"
                                                aria-label="Clear"
                                                style="background: transparent; border: none; z-index: 9999; position:absolute; top:-15px ; right:0px"
                                                @onclick="OnBindBuildingCancel">
                                            <i class="fa-solid fa-xmark"></i> Clear
                                        </button>

                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label required-label">Street Address </label>
                                                <InputText class="form-control" @bind-Value="editBuildingModel.Address1" placeholder="Enter Address" />
                                                <ValidationMessage For="() => editBuildingModel.Address1" />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label required-label">MDR Number </label>
                                                <InputText class="form-control" @bind-Value="editBuildingModel.MDRNumber" placeholder="Enter MDR Number" />


                                                <ValidationMessage For="() => editBuildingModel.MDRNumber" />

                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label required-label">No. of Units </label>
                                                <InputText class="form-control" @bind-Value="editBuildingModel.BuildingUnits" placeholder="Enter Units" />

                                                <ValidationMessage For="() => editBuildingModel.BuildingUnits" />

                                            </div>
                                           
                                        </div>
                                        <div class="row mt-4">

                                            <!-- County -->
                                            <div class="@ColumnClass" style=@(ShowExemptionOther ? "width:21%" : "")>
                                                <label class="form-label required-label">County</label>
                                                <InputSelect class="form-select"
                                                             @bind-Value="editBuildingModel.CityId">
                                                    <option value="">-- Select --</option>
                                                    @foreach (var s in CityList)
                                                    {
                                                        <option value="@s.Id">@s.Name</option>
                                                    }
                                                </InputSelect>
                                            </div>

                                            <!-- Rent Regulation -->
                                            <div class="@ColumnClass" style=@(ShowExemptionOther ? "width:22%" : "")>
                                                <label class="form-label required-label">Rent Regulation</label>
                                                <InputSelect class="form-select"
                                                             @bind-Value="editBuildingModel.RegulationStatusId">
                                                    <option value="">-- Select --</option>
                                                    @foreach (var l in RegulationList)
                                                    {
                                                        <option value="@l.Id">@l.Name</option>
                                                    }
                                                </InputSelect>
                                            </div>

                                            @if (ShowExemptionBasic)
                                            {
                                                <!-- Exemption Basic -->
                                                <div class="@ColumnClass" style=@(ShowExemptionOther ? "width:23%" : "")>
                                                    <label class="form-label ">
                                                        Exemption Basic
                                                    </label>
                                                    <InputSelect class="form-select"
                                                                 @bind-Value="editBuildingModel.ExemptionBasisId">
                                                        <option value="">-- Select --</option>
                                                        @foreach (var s in ExemptionBasicList)
                                                        {
                                                            <option value="@s.Id">@s.Name</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            }
                                            @if (ShowExemptionOther)
                                            {
                                                <!-- Exemption Basic -->
                                                <div class="col">
                                                    <label class="form-label ">
                                                        Exemption
                                                    </label>
                                                    <InputText class="form-control" @bind-Value="editBuildingModel.ExemptionBasisother" placeholder="Enter Exemption" />
                                                </div>
                                            }
                                            @if (ShowRentOther)
                                            {
                                                <!-- Exemption Basic -->
                                                <div class="col">
                                                    <label class="form-label ">
                                                        Other Regulation
                                                    </label>
                                                    <InputText class="form-control" @bind-Value="editBuildingModel.RentRegulationOther" placeholder="Enter Other Reulation" />
                                                </div>
                                            }
                                        </div>

                                      
                                        @if (IsNewBuilding)
                                        {
                                            <div class="row g-3 mt-3">
                                                <div class="col-md-6">
                                                    <label class="form-label required-label">State</label>
                                                    <InputSelect class="form-select" @bind-Value="editBuildingModel.StateId">
                                                        @foreach (var s in StateList)
                                                        {
                                                            <option value="@s.Id">@s.Name</option>
                                                        }
                                                    </InputSelect>
                                                    <ValidationMessage For="() => editBuildingModel.StateId" />
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label required-label">Zip Code</label>
                                                    <InputText class="form-control" @bind-Value="editBuildingModel.Zipcode" placeholder="Enter Zipcode" />
                                                </div>
                                            </div>
                                        }

                                       
                                        <div class="row mt-4 d-flex justify-content-between">
                                            <div class="col-md-4">
                                                <label class="form-label required-label ">
                                                    Building Type
                                                </label>
                                                <InputSelect class="form-select" @bind-Value="editBuildingModel.PremiseTypeId">
                                                    <option value="">-- Select --</option>
                                                    @foreach (var s in PremiseTypesList)
                                                    {
                                                        <option value="@s.Id">@s.Name</option>
                                                    }
                                                </InputSelect>

                                                <ValidationMessage For="() => editBuildingModel.PremiseTypeId" />


                                            </div>



                                            <div class="col-md-8">
                                                <label class="form-label required-label ">
                                                    Registration Status (HPD/DOF)
                                                </label>

                                                <div class="row mt-1">
                                                    @if (RegistrationstatusList != null && RegistrationstatusList.Any())
                                                    {
                                                        <div style="display: flex;flex-wrap: wrap; column-gap: 33px;">
                                                            <InputRadioGroup @bind-Value="editBuildingModel.RegistrationStatusId" class="d-flex flex-wrap">
                                                                @foreach (var Type in RegistrationstatusList)
                                                                {
                                                                    <div class="col-auto">
                                                                        <div class="form-check">
                                                                            <InputRadio class="form-check-input"
                                                                                        id="@($"RegStatus_{Type.Id}")"
                                                                                        Value="@Type.Id" disabled="@(editBuildingModel.OwnerOccupied == true)" />
                                                                            <label class="form-check-label edit-build" for="@($"RegStatus_{Type.Id}")">@Type.Name</label>
                                                                        </div>
                                                                    </div>
                                                                }
                                                            </InputRadioGroup>
                                                            <ValidationMessage For="() => editBuildingModel.RegistrationStatusId" />


                                                        </div>
                                                    }
                                                </div>
                                            </div>


                                        </div>
                                        <div class="row mb-3 mt-3">
                                            <div class="col-4">
                                                <div class="form-check form-switch" style="padding-left:0px; ">


                                                    <label class="form-check-label form-label mb-0 me-2 edit-build" for="ownerOccupiedSwitch">
                                                        Owner Occupied?
                                                       
                                                    </label>
                                                    <input class="form-check-input" style="float:none"
                                                           type="checkbox"
                                                           id="ownerOccupiedSwitch"
                                                           @bind="editBuildingModel.OwnerOccupied" @bind:after="SelectedOwnerOccupied" />
                                                </div>


                                            </div>

                                            <div class="col-4">

                                                <div class="form-check form-switch" style="padding-left:0px;">


                                                    <label class="form-check-label form-label mb-0 me-2 edit-build" for="goodCauseSwitch">
                                                        Does Good Cause Apply?:
                                                       
                                                    </label>
                                                    <input class="form-check-input" style="float:none"
                                                           type="checkbox"
                                                           id="GoodCauseSwitch"
                                                           @bind="editBuildingModel.GoodCause" />
                                                </div>


                                            </div>

                                            @if (editBuildingModel.GoodCause.Value != true)
                                            {
                                                <div class="col-md-4">
                                                    <label class="form-label required-label ">
                                                        Exemption Reason
                                                    </label>
                                                    <InputSelect class="form-select" @bind-Value="editBuildingModel.ExemptionreasonId">
                                                        <option value="">-- Select --</option>
                                                        @foreach (var s in ExemptionReasonList)
                                                        {
                                                            <option value="@s.Id">@s.Name</option>
                                                        }
                                                    </InputSelect>

                                                    <ValidationMessage For="() => editBuildingModel.ExemptionreasonId" />


                                                </div>
                                            }

                                        </div>
                                    </div>

                                }
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                        <button type="button" class="btn btn-secondary buttons " data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary base buttons" @onclick="SaveBuildingChanges">Save</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>   
    *@


    <!-- Landlord Edit Modal -->
    @* <div class="modal fade" id="landlordModal" tabindex="-1" aria-labelledby="landlordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="landlordModalLabel">Edit Landlord Details</h5>
                    <button type="button" class="btn-close " data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <EditForm Model="@editLandlordModel">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class=" border-0">
                            <div class="card-body p-0">

                             
                                <div class="row mt-2">
                                    @if (!showLandlordFields)
                                    {
                                        <div class="col-md-6 position-relative" @onfocusout="HideLandlordDropdown">
                                            <label class="form-label  required-label">Landlord</label>
                                            <input type="text" class="form-control"
                                                   placeholder="Search by Landlord name or code..."
                                                   @bind-value="searchLandlordText" @onclick="ShowAllLandlords"
                                                   @oninput="OnSearchLandlordInput" />
                                            @if (filteredlandlords?.Count() > 0)
                                            {
                                                <ul class="dropdown-menu show" style="position: absolute; width:94% !important; cursor:pointer;">
                                                    @foreach (var c in filteredlandlords)
                                                    {
                                                        <li class="dropdown-item" @onclick="() => SelectLandlord(c)">
                                                            @c.LandLordCode / @c.FirstName @c.LastName
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                            <ValidationMessage For="() => legalcaseDto.LandlordId" />
                                        </div>
                                    }

                                    @if (!showLandlordFields)
                                    {
                                        <div class="col-md-1 d-flex justify-content-center align-items-end pb-2">
                                            <span style="">OR</span>
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button type="button" class="btn btn-primary base buttons" @onclick="OnBindLandlordAfter">+ Add</button>
                                        </div>
                                    }
                                </div>

                              
                                @if (showLandlordFields)
                                {
                                    <div class=" rounded-3 p-3 position-relative">
                                        <button type="button" class="buttons"
                                                aria-label="Clear"
                                                style="background: transparent; border: none; z-index: 9999; position:absolute; top:-15px ; right:0px"
                                                @onclick="OnBindLandlordCancel">
                                            <i class="fa-solid fa-xmark"></i> Clear
                                        </button>

                                        <div class="row g-3">

                                            <div class="col-md-6">
                                                <label class="form-label required-label">First Name</label>
                                                <InputText class="form-control" @bind-Value="editLandlordModel.FirstName" placeholder="Enter First Name" />
                                                <ValidationMessage For="() => editLandlordModel.FirstName" />
                                            </div>

                                            <div class="col-md-6">
                                                <label class="form-label required-label">Last Name</label>
                                                <InputText class="form-control" @bind-Value="editLandlordModel.LastName" placeholder="Enter Last Name" />
                                            </div>

                                            <div class="col-md-6">
                                                <label class="form-label required-label">Contact Person Name </label>
                                                <InputText class="form-control" @bind-Value="editLandlordModel.ContactPersonName" placeholder="Enter Contact person" />
                                                <ValidationMessage For="() => editLandlordModel.ContactPersonName" />
                                            </div>

                                            <div class="col-md-6">
                                                <label class="form-label required-label">Address</label>
                                                <InputText class="form-control" @bind-Value="editLandlordModel.Address1" placeholder="Enter Address" />
                                            </div>



                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                        <button type="button" class="btn btn-secondary buttons" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary base buttons" @onclick="SaveLandlordChanges">Save</button>
                    </div>
                </EditForm>

              
            </div>
        </div>
    </div>
      *@
    <!-- Rent Edit Modal -->
    <div class="modal fade" id="rentModal" tabindex="-1" aria-labelledby="rentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="rentModalLabel">Edit Rent Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <EditForm Model="@legalcaseDto">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="card border-0">
                            <div class="card-body p-0">


                                <!-- Add/Edit Fields -->

                                <div class="border rounded-3 p-3 mt-4 position-relative">


                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label required-label">Monthly Rent </label>
                                            <InputNumber class="form-control" @bind-Value="legalcaseDto.MonthlyRent" placeholder="Enter Monthly rent" />
                                            <ValidationMessage For="() => legalcaseDto.MonthlyRent" />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label required-label">Distribution Total</label>
                                            <input class="form-control" placeholder="Enter Distribution Total" />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label required-label">Additional Charges</label>
                                            <input class="form-control" placeholder="Enter Additional Charges" />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label required-label">Legal Print</label>
                                            <input class="form-control" placeholder="Enter Legal Print" />
                                        </div>




                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary base" @onclick="SaveRentChanges">Save</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>

    <!-- client Edit Modal -->
     <div class="modal fade" id="stipulationModal" tabindex="-1" aria-labelledby="stipulationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="buildingModalLabel">Edit Stipulation Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <EditForm Model="@MotionJudgements">
                    <DataAnnotationsValidator />
                    <div class="modal-body py-0">
                        <div class="card border-0">
                            <div class="card-body">
                                <div class="row">
                                    <!-- Case Type Dropdown -->





                                    <div class="mt-3 position-relative">
                                        <!--<button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                                                aria-label="Clear"
                                                @onclick="ClearSelectedClient">
                                        </button> -->
                                        <div class="row">
                                            <div class="col-6">
                                                <label class="form-label required-label">Motion Due</label>
                                                <RadzenDatePicker DateFormat="@DateFormats.Default" class="edit-stip" @bind-Value="MotionJudgements.MotionDue" />


                                            </div>
                                            <div class="col-6">
                                                <label class="form-label required-label">Opposition Due</label>
                                                <RadzenDatePicker DateFormat="@DateFormats.Default" class="edit-stip" @bind-Value="MotionJudgements.OppositionDue" />
                                            </div>

                                        </div>
                                        <div class="row">
                                            <div class="col-6 mt-3">
                                                <label class="form-label required-label">Reply Due</label>
                                                <RadzenDatePicker DateFormat="@DateFormats.Default" class="edit-stip" @bind-Value="MotionJudgements.ReplyDue" />
                                            </div>

                                            <div class="col-6 mt-3">
                                                <label class="form-label required-label">Return Date</label>
                                                <RadzenDatePicker DateFormat="@DateFormats.Default" class="edit-stip" @bind-Value="MotionJudgements.ReturnDate" />
                                            </div>

                                        </div>
                                    </div>


                                </div>


                            </div>
                        </div>
                    </div>

                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                        <button type="button" class="btn btn-secondary buttons" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary base buttons" @onclick="SaveStipulationChanges">Save</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>

    @*<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="buildingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="buildingModalLabel">Edit Client Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <EditForm Model="@client">
                    <DataAnnotationsValidator />
                    <div class="modal-body py-0">
                        <div class="card border-0">
                            <div class="card-body">
                                <div class="row">
                                    <!-- Case Type Dropdown -->
                                    @if (!newClient)
                                    {


                                        <div class="col-5 position-relative">


                                            <label class="form-label required-label">Client</label>

                                            <InputText type="text" class="form-control"
                                                       placeholder="Search by client name or code..."
                                                       @bind-value="searchText"
                                                       @oninput="OnSearchInput" />

                                            @if (filteredClients?.Count() > 0)
                                            {
                                                <ul class="dropdown-menu show" style="position: absolute; width:94% !important; cursor:pointer;">
                                                    @foreach (var c in filteredClients)
                                                    {
                                                        <li class="dropdown-item" @onclick="() => SelectClient(c)">
                                                            @c.FirstName @c.LastName / @c.ClientCode
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                        </div>
                                        @if (!showClientTextbox)
                                        {
                                            <div class="col-3 row">
                                                <div class="col-md-3 d-flex justify-content-center align-items-end" style="padding-bottom:10px;">
                                                    <div>
                                                        OR
                                                    </div>
                                                </div>
                                                <div class="col-md-9 d-flex align-items-end">
                                                    <button type="button" class="btn" style="background-color:#1F365D !important;height:40px; color:white" @onclick="AddClient">+ ADD</button>
                                                </div>
                                            </div>
                                        }
                                    }
                                    @if (showClientTextbox)
                                    {



                                        <div class="card p-3 mt-3 position-relative">
                                            <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                                                    aria-label="Clear"
                                                    @onclick="ClearSelectedClient">
                                            </button>
                                            <div class="row">
                                                <div class="col-4">
                                                    <label class="form-label">First Name</label>
                                                    <InputText class="form-control" placeholder="Enter Name" @bind-Value="client.FirstName" />
                                                </div>
                                                <div class="col-4">
                                                    <label class="form-label">Last Name</label>
                                                    <InputText class="form-control" placeholder="Enter Name" @bind-Value="client.LastName" />
                                                </div>
                                                <div class="col-4">
                                                    <label class="form-label">Client Type</label>
                                                    <InputSelect class="form-select" @bind-Value="client.ClientTypeId" style="cursor:pointer;">
                                                        <option value="">-- Select --</option>
                                                        @foreach (var Own in ClientTypeList)
                                                        {
                                                            <option value="@Own.Id">@Own.Name</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-4 mt-3">
                                                    <label class="form-label">Email</label>
                                                    <InputText class="form-control" placeholder="Enter Email" @bind-Value="client.Email" />
                                                </div>

                                                <div class="col-4 mt-3">
                                                    <label class="form-label">Phone</label>
                                                    <InputText class="form-control" placeholder="Enter Number" @bind-Value="client.Phone" />
                                                </div>
                                                <div class="col-4 mt-3">
                                                    <label class="form-label">Reference #</label>
                                                    <InputText class="form-control" placeholder="Enter Reference" @bind-Value="client.Reference" />
                                                </div>
                                            </div>
                                        </div>
                                    }

                                </div>


                            </div>
                        </div>
                    </div>

                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                        <button type="button" class="btn btn-secondary buttons" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary base buttons" @onclick="SaveClientChanges">Save</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div> *@

    @* <div class="modal fade" id="marshalModal" tabindex="-1" aria-labelledby="buildingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="buildingModalLabel">Edit Marshal Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="p-3">
                    <div class="row mb-3 d-flex align-items-center">

                        <div class="fw-semibold col-12 required-label">Assign Marshal</div>
                    </div>
                    <div class="row mt-2">

                        <div class="col-6 position-relative" @onfocusout="HideMarshalDropDown">

                            @if (!isMarshalAssigned)
                            {
                                <!-- Search Box -->

                                <InputText class="form-control search-box" placeholder="Search by marshal name.." @bind-value="searchmarshalText" @oninput="OnSearchMarshalInput"
                                           @onclick="ShowAllmarshal" />
                                <button class="search-btn" type="button">
                                    <i class="fa fa-search"></i>
                                </button>




                                @if (filteredmarshal?.Any() == true)
                                {
                                    <ul class="dropdown-menu show" style="position:absolute; width:94%; cursor:pointer;">
                                        @foreach (var c in filteredmarshal)
                                        {
                                            <li class="dropdown-item" @onclick="() => Selectedmarshal(c)">
                                                @c.FirstName  @c.LastName
                                            </li>
                                        }
                                    </ul>
                                }

                            }
                            else
                            {
                                <!-- Selected Marshal -->
                                <label class="form-control bg-light fw-bold d-flex align-items-center">
                                    @(selectedmarshal != null ? selectedmarshal.FirstName + " " + selectedmarshal.LastName : "")
                                </label>

                            }

                        </div>

                        <div class="col-6 d-flex justify-content-between">
                            @if (!isMarshalAssigned)
                            {
                                <button class="btn bg-brand-accent base text-white buttons" @onclick="SubmitMarshal">Assign</button>

                            }
                            else
                            {
                                <button class="btn btn-secondary" @onclick="ResetMarshal">Reset</button>

                            }


                            <!-- <button class="btn bg-brand-primary base text-white ms-2"
                                     @onclick="GenrateMarshalForm"
                                     disabled="@(isMarshalAssigned == false)">
                                 Generate
                             </button> -->


                        </div>


                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            @if (showMarshalError)
                            {
                                <div class="text-danger small mt-1">Please select a marshal.</div>
                            }
                        </div>
                    </div>

                    <hr />
                    <EditForm Model="@CaseWarranrDto">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="required-label">Warrant Requested</label>
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="CaseWarranrDto.WarrantRequested" @bind-Value:after="() => ToShow = true" />
                            </div>
                            <div class="col-md-4">
                                <label class="required-label">Warrant Issued</label>
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="CaseWarranrDto.WarrantIssued" @bind-Value:after="() => ToShow = true" />
                            </div>
                            <div class="col-md-4">
                                <label class="required-label">Warrant Rejected</label>
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="CaseWarranrDto.WarrantRejected" @bind-Value:after="() => ToShow = true" />
                            </div>

                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="required-label">Notice Served</label>
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="CaseWarranrDto.NoticeServed" @bind-Value:after="() => ToShow = true" />
                            </div>
                            <div class="col-md-4">
                                <label class="required-label">Execution Eligible</label>
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="CaseWarranrDto.ExecutionEligible" @bind-Value:after="() => ToShow = true" />
                            </div>
                            <div class="col-md-4">
                                <label class="required-label">Re-file / Re-mail</label>
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="CaseWarranrDto.ReFileDate" @bind-Value:after="() => ToShow = true" />
                            </div>
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="required-label">Eviction Executed</label>
                                <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="CaseWarranrDto.EvictionExecuted" @bind-Value:after="() => ToShow = true" />
                            </div>
                            <div class="col-md-4">
                                <label class="required-label">Status</label>
                                <InputSelect class="form-select" @bind-Value="CaseWarranrDto.Status">
                                    @foreach (var s in StatusList)
                                    {
                                        <option value="@s">@s</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                            <button type="button" class="btn btn-secondary buttons" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary base buttons" @onclick="() => SubmitMarshalDates(false)">Save</button>
                            <button type="submit" class="btn btn-primary base buttons" @onclick="() => SubmitMarshalDates(true)" disabled="@(isMarshalAssigned == false)">Save & Generate</button>
                        </div>
                    </EditForm>
                </div>

            </div>
        </div>
    </div> *@
    <div class="modal fade" id="courtModal" tabindex="-1" aria-labelledby="CourtModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="buildingModalLabel">Edit Court Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <EditForm EditContext="_editContext" OnValidSubmit="SaveCourtChanges">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="">
                            <div class=" p-0">

                                <!-- Search + Add Section -->
                                <!-- Add/Edit Fields -->

                                <div class=" rounded-3 p-3 position-relative">
                                    @if (ShowClearBtn)
                                    {
                                        <div>
                                            <button type="button"
                                                    class=" m-2 buttons"
                                                    style="background: transparent; border: none; z-index: 9999; position:absolute; top:-15px ; right:0px"
                                                    @onclick="OnBindCourtCancel">
                                                <i class="fa-solid fa-xmark"></i> Clear
                                            </button>
                                        </div>
                                    }



                                    <div class="row g-3" style="margin:0px;">
                                        <div class=@(showCountyDropdown ? "col-md-3" : "col-md-6")>
                                            <label class="form-label required-label ">Court Type </label>
                                            <InputSelect class="form-select" @bind-Value="legalcaseDto.CourtTypeId" style="cursor:pointer;" @bind-Value:after="SelectCourtType">
                                                @foreach (var l in CourtTypeList)
                                                {
                                                    <option value="@l.Id">@l.Name</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <!-- Court Location -->

                                        <div class=@(showCountyDropdown ? "col-md-3" : "d-none")>

                                            <label class="form-label required-label">County </label>
                                            <InputSelect class="form-select" @bind-Value="legalcaseDto.CountyId" style="cursor:pointer;" @bind-Value:after="SelectCounty">
                                                @foreach (var l in CountyList)
                                                {
                                                    <option value="@l.Id">@l.Name</option>
                                                }
                                            </InputSelect>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label required-label">Court </label>
                                            <InputSelect class="form-select" @bind-Value="legalcaseDto.CourtLocationId" style="cursor:pointer;" @onmousedown="ShowAllCourts" @bind-Value:after="SelectCourt">
                                                <option value="">-- Select --</option>
                                                @foreach (var l in filteredCourts)
                                                {
                                                    <option value="@l.Id">@l.Court</option>
                                                }
                                            </InputSelect>
                                            <ValidationMessage For="() => legalcaseDto.CourtLocationId" />
                                        </div>

                                        <!-- Part / Room # -->
                                        @if (!showCourtPartDropdown)
                                        {
                                            <div class="col-md-6">
                                                <label class="form-label required-label">Part / Room #</label>
                                                <InputText type="text" name="partRoom" class="form-control" @bind-Value="legalcaseDto.CourtRoom" />
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Judge</label>
                                                <InputText class="form-control" @bind-Value="legalcaseDto.Judge" placeholder="Enter Judge" />
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="col-md-6">
                                                <label class="form-label required-label">Part / Room #</label>
                                                <InputSelect class="form-select" @bind-Value="legalcaseDto.CourtPartId" style="cursor:pointer;" @bind-Value:after="SelectCourtPart">
                                                    @foreach (var l in CourtPartList)
                                                    {
                                                        <option value="@l.Id">@l.Part - @l.RoomNo</option>
                                                    }
                                                </InputSelect>
                                            </div>

                                            <div class="col-md-6">
                                                <label class="form-label required-label">Judge</label>
                                                <InputText class="form-control" @bind-Value="legalcaseDto.Judge" placeholder="Enter Judge" />
                                            </div>
                                        }


                                        <div class="col-md-6">
                                            <label class="form-label required-label ">Index</label>
                                            <InputText class="form-control" placeholder="Enter Index" @bind-Value="legalcaseDto.Index" />
                                        </div>


                                        @*<div class="col-md-6">
                                            <label class="form-label required-label">Docket No.</label>
                                            <InputText class="form-control" placeholder="Enter Docket No." @bind-Value="legalcaseDto.Docketno" readonly="@DocketReadonly" @onclick="CheckMarshal" />
                                        </div>*@

                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                        <button type="button" class="btn btn-secondary buttons" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary base buttons">Save</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
    <!-- Alert Modal (shown when no court info exists) -->
    @if (showCourtInfoAlert || IsFormGenerated)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header  text-white" style="background-color: #1F365D;">

                        @if (showCourtInfoAlert)
                        {
                            <h5 class="modal-title">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i> Missing Court Info
                            </h5>
                        }
                        else
                        {
                            <h5 class="modal-title">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i> Missing Notice
                            </h5>
                        }
                        <button type="button" class="btn-close btn-close-white" aria-label="Close" @onclick="CloseCourtInfoAlert"></button>
                    </div>
                    <div class="modal-body text-center">
                        @if (showCourtInfoAlert)
                        {
                            <p class="fw-semibold mb-2">Please add Court Information before adding a hearing.</p>
                        }
                        else
                        {
                            <p class="fw-semibold mb-2">Please Generate Notice before adding a hearing.</p>
                        }
                    </div>
                    @*<div class="modal-footer justify-content-center">
                        <button class="btn btn-primary" @onclick="ShowCourtModal">Add Court Info</button>
                        <button class="btn btn-outline-secondary" @onclick="CloseCourtInfoAlert">Close</button>
                    </div>*@
                </div>
            </div>
        </div>
    }
    @if (ShowMarshalPopup)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header  text-white" style="background-color: #1F365D;">


                        <h5 class="modal-title">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> Missing Marshal Info
                        </h5>

                        <button type="button" class="btn-close btn-close-white" aria-label="Close" @onclick="CancelCheckMarshal"></button>
                    </div>
                    <div class="modal-body text-center">

                        <p class="fw-semibold mb-2">Marshal is not assigned. Please assign a Marshal first.</p>

                    </div>
                    @*<div class="modal-footer justify-content-center">
                        <button class="btn btn-primary" @onclick="ShowCourtModal">Add Court Info</button>
                        <button class="btn btn-outline-secondary" @onclick="CloseCourtInfoAlert">Close</button>
                    </div>*@
                </div>
            </div>
        </div>
    }

    <div class="modal fade" id="hearingModal" tabindex="-1" aria-labelledby="HearingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header">
                    <h5 class="modal-title fw-semibold" id="buildingModalLabel">Add Hearing Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <EditForm Model="@caseHearing">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        <div class="card border-0">
                            <div class="card-body p-0">

                                <!-- Search + Add Section -->
                                <!-- Add/Edit Fields -->

                                <div class="border rounded-3 p-3 mt-4 position-relative">

                                    <button type="button" class="btn-close position-absolute top-0 end-0 m-2"
                                            aria-label="Clear"
                                            @onclick="OnBindHearingCancel">
                                    </button>

                                    <div class=" g-3">
                                        <div class="col-md-6">
                                            <label class="form-label required-label">Date </label>
                                            <RadzenDatePicker DateFormat="@DateFormats.Default" AllowInput="false" ShowButton="true" Style="width:100%; box-shadow:none; cursor:pointer; " @bind-Value="caseHearing.HearingDate" placeholder="Select Date" />
                                        </div>

                                        <div class="col-md-6 mt-2 ">
                                            <label class="form-label required-label">Time</label>
                                            <input type="time" class="form-control" @bind="caseHearing.HearingTime" />
                                        </div>



                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer" style="padding-top: 0px !important; border-top: none !important;">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary base" @onclick="SaveHearingChanges">Save</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>

    <div class="modal fade" id="attorneyModal" tabindex="-1" aria-labelledby="AttorneyDetailsModal" aria-hidden="true">
        <EvictionFiler.Client.Components.Cases.AttorneyDetails OnClose="CloseAttorneyModal" legalcaseDto="legalcaseDto" />
    </div>

    @if (_showCreateAction)
    {
        <GenrateAction createAction="noticeModel"
                       OnClose="HandleCloseCreateAction" CaseNotesId="@CaseNotesId" OpenTab="@OpenTab"
                       CurrentCaseId="CurrentCaseId" legalcaseDto="legalcaseDto" CaseForms="caseFormDto" OnFormCreate="HandleInvokeAction" OnNotesCreate="HandleNotesInvokeAction" />
    }



    <script>
        window.showModal = (id) => {
        const modal = new bootstrap.Modal(document.getElementById(id));
        if(modal){
        modal.show();

        }
        else{
            console.log("No modal found");
        }
        };
    </script>
    <script>
        function hideModal(id) {
        var modal = bootstrap.Modal.getInstance(document.getElementById(id));
        if (modal) modal.hide();
        }

    </script>
    <script>
            window.openTab = function (tabId) {
            const triggerEl = document.querySelector(`#${tabId}-tab`);
            if (triggerEl) {
                const tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }
        };


                window.downloadFile = (fileName, byteBase64, contentType) => {
            const link = document.createElement('a');
            link.download = fileName;

            const bytes = Uint8Array.from(atob(byteBase64), c => c.charCodeAt(0));
            const blob = new Blob([bytes], { type: contentType });

            link.href = URL.createObjectURL(blob);
            link.click();

            URL.revokeObjectURL(link.href);
        };


    </script>

</body>



@code {
    [Parameter]
    public Guid caseId { get; set; }
    private IntakeModel legalcaseDto = new IntakeModel();
    private List<FormAddEditViewModelDto> FilteredFormTypeList = new();
    private GenrateNoticeModel noticeModel = new GenrateNoticeModel();
    [Parameter] public Guid? CurrentCaseId { get; set; }
    private List<GenrateNoticeModel> caseFormDto = new();
    private GenrateNoticeModel caseForm = new();
    private List<FeesCatalogDto> feecatalogDto = new();
    private List<CaseHearingDto> CaseHearings = new();
    private List<CaseAppearanceDto> Judgements = new();
    private CaseNoticeInfoDto CaseNoticeInfos = new();
    private CaseAppearanceDto MotionJudgements = new();
    private IEnumerable<CaseDocument> caseDocuments = new List<CaseDocument>();
    private CaseHearingDto CaseHearing = new();
    private CaseWarrantDto CaseWarranrDto { get; set; } = new();
    private CaseForms CaseForm = new();
    private string? loggedInUserId;
    private string? OpenTab;
    private bool isAdmin = false;
    private bool ToShow = false;

    private bool isEditMode = false;
    private bool isNewCourt = false;
    private bool _showCreateAction = false;
    private bool _showCreateActionbtn = false;
    private bool _showCourtPartList = false;
    private bool _showCourtList = false;
    // private List<DateRent> DateRentList = new();
    private int FinalProgress { get; set; } = 0;     // Total calculated progress
    private int AnimatedProgress { get; set; } = 0;  // Animating value
    private System.Timers.Timer animationTimer;

    // private EditToBuildingDto editBuildingModel = new();
    // private EditToLandlordDto editLandlordModel = new();
    private IntakeModel editRentModel = new();
    // private bool showBuildingFields = false;
    // private bool showLandlordFields = false;
    private bool showCourtFields = false;
    // private bool IsNewBuilding = false;
    // private bool IsNewLandlord = false;
    private bool ShowCourtDropdown = false;
    private bool ShowCourtPartDropdown = false;
    // private string searchBuildingText;
    // private string searchLandlordText;
    private string searchCourtText;
    private string? searchCourtPartText;
    // private string searchTenantText;
    // private List<EditToBuildingDto> filteredBuildings = new();
    // private List<EditToLandlordDto> filteredlandlords = new();
    // private List<EditToTenantDto> filteredTenant = new();
    private List<State> StateList = new();
    private List<RegulationStatus> RegulationList = new();
    private IEnumerable<City> CityList = new List<City>();
    // private List<EditToBuildingDto> BuildingList = new();
    private List<EditToRemainderCenterDto> RemainderCenterList = new();
    // private List<EditToLandlordDto> LandlordList = new();
    // private List<EditToTenantDto> TenantList = new();
    // private List<string> Tenants = new();
    // private List<string> UnderTenants = new();
    // private List<AdditioanlTenants> AdditionalTenantfromDbList = new();
    // private List<CaseAdditionalTenants> CaseAdditionalTenantfromDbList = new();
    // private List<AddtionalTenantDto> AdditionalTenantList = new();
    // private List<AdditionalOccupantDto> AdditionalOccupantsList = new();
    // private List<AdditionalOccupantDto> AdditionalOccupantsFromDbList = new();
    private bool showCourtInfoAlert = false;
    private bool IsFormGenerated = false;
    private bool ShowMarshalPopup = false;
    private bool DocketReadonly = false;
    // public EditToTenantDto selectedTenant = new EditToTenantDto();
    // public EditToTenantDto ViewTenant = new EditToTenantDto();
    public CourtDto court = new CourtDto();
    public CaseHearingDto caseHearing = new CaseHearingDto();
    public CaseWarrantDto caseWarrantDto = new CaseWarrantDto();
    public List<CourtDto> courts = new();
    public List<CourtDto> filteredCourts = new List<CourtDto>();
    public List<CourtPartDto> filteredCourtsPart = new List<CourtPartDto>();
    // private List<MarshalDto> filteredmarshal = new();
    // private MarshalDto selectedmarshal;
    // private string searchmarshalText;
    private bool selectedTimeline = false;
    private bool PrimaryResidence = false;
    private Guid? TenancytypeId = Guid.Empty;
    private Guid? CaseNotesId = null;
    private CancellationTokenSource _cts;
    // private bool isMarshalAssigned = false;
    [Parameter] public GenrateNoticeModel createAction { get; set; } = new();
    private bool showMarshalError = false;
    [Parameter] public EventCallback OnFormCreate { get; set; } = new();

    private bool isLoadMarshal = false;

    private Guid? SelectedLandlordId;

    // private List<Registrationstatus> RegistrationstatusList = new List<Registrationstatus>();
    // private IEnumerable<ExemptionBasic> ExemptionBasicList = new List<ExemptionBasic>();
    // private IEnumerable<ExemptionReason> ExemptionReasonList = new List<ExemptionReason>();
    private IEnumerable<TenancyTypeForBuilding> TenancyTypeForBuildingList = new List<TenancyTypeForBuilding>();
    private string fullBuildingAddress = "";
    private readonly string[] StatusList =
    {
        "Pending", "Issued", "Rejected", "Served", "Scheduled", "Executed", "Stayed"
    };

    //    bool ShowExemptionBasic =>
    // RegulationList.Any(r =>
    //     r.Id == editBuildingModel.RegulationStatusId &&
    //     r.Name == "Exempt");

    //    bool ShowRentOther =>
    // RegulationList.Any(r =>
    //     r.Id == editBuildingModel.RegulationStatusId &&
    //     r.Name == "Other");

    //    bool ShowExemptionOther =>
    //    ExemptionBasicList.Any(r =>
    //        r.Id == editBuildingModel.ExemptionBasisId &&
    //        r.Name == "Other");

    // string ColumnClass => ShowExemptionBasic || ShowRentOther ? "col-md-4" : "col-md-6";
    // private async Task SelectedOwnerOccupied()
    // {
    //     if (editBuildingModel.OwnerOccupied == true)
    //     {
    //         editBuildingModel.RegistrationStatusId = RegistrationstatusList.Where(e => e.Name.Equals("Registered")).FirstOrDefault().Id;
    //     }
    // }


    protected override async Task OnInitializedAsync()
    {
        var flag = navmessage.ConsumeFlag();
        var page = navmessage.ConsumePage();
        var message = navmessage.ConsumeMessage();
        if (flag == true)
        {
            ToastService.ShowSuccess($"{message}");
        }

        await userContext.LoadAsync();

        if (!userContext.IsAuthenticated)
        {
            Navigation.NavigateTo("/", forceLoad: true);
            return;
        }

        loggedInUserId = userContext.UserId;
        isAdmin = userContext.IsAdmin;

        _editContext = new EditContext(legalcaseDto);
        messageStore = new ValidationMessageStore(_editContext);

        court.SelectedCourtPart ??= new CourtPartDto();

        ClientList = await _clientService.GetAllClient(loggedInUserId, isAdmin);
        // ExemptionBasicList = await ExemptionBasicRepository.GetAllAsync();
        // ExemptionReasonList = await ExemptionReasonRepository.GetAllAsync();
        TenancyTypeForBuildingList = await TenancyTypeForBuildingRepository.GetAllAsync();
        // RegistrationstatusList = await CaseTypeRepository.GetAllRegistrationstatus();
        if (!CityList.Any()) CityList = await _service.GetAllCitiesList();


        // spinnerservice.Show();
        await LoadCaseDetails();
        await LoadCaseForms();
        await LoadHearing();
        await LoadJudgement();
        await LoadCaseDocument();
        await LoadNotes();
        await LoadOthers();
        CalculateCaseProgress();
        StartProgressAnimation();
        StateHasChanged();
        // spinnerservice.Hide();
    }


    private async Task CheckMarshal()
    {
        if (legalcaseDto.MarshalId == null || legalcaseDto.MarshalId == Guid.Empty)
        {
            ShowMarshalPopup = true;
            DocketReadonly = true;
        }
        else
        {
            DocketReadonly = false;
        }
    }
    private async Task CancelCheckMarshal()
    {

        ShowMarshalPopup = false;

    }
    private void HandleLandlord(Guid? landlordId)
    {
        SelectedLandlordId = landlordId;
    }
    // async Task HideMarshalDropDown(FocusEventArgs e)
    // {

    //     await Task.Delay(500);
    //     if (filteredmarshal.Any())
    //     {
    //         filteredmarshal.Clear();

    //     }
    //     StateHasChanged();
    // }
    private async Task SelectCourtType()
    {
        var CourtType = CourtTypeList.FirstOrDefault(ty => ty.Id == legalcaseDto.CourtTypeId);
        var query = CourtLocationList.ToList();
        if (CourtType!.Name.Contains("NYC"))
        {
            legalcaseDto.CountyId = null;
            showCountyDropdown = true;
            // showCourtPartDropdown = true;
            filteredCourts = query.Where(x => !x.CountyName.Contains("Nassau") && !x.CountyName.Contains("Westchester"))
                                   .ToList();
        }
        else if (CourtType.Name.Contains("Nassau"))
        {
            showCountyDropdown = false;
            showCourtPartDropdown = false;
            var county = CountyList.Where(e => e.Name.Contains("Nassau")).FirstOrDefault();
            legalcaseDto.CountyId = county.Id;
            filteredCourts = query.Where(x => x.CountyName.Contains("Nassau"))
                                   .ToList();

        }
        else if (CourtType.Name.Contains("Westchester"))
        {
            showCountyDropdown = false;
            showCourtPartDropdown = false;
            var county = CountyList.Where(e => e.Name.Contains("Westchester")).FirstOrDefault();
            legalcaseDto.CountyId = county.Id;
            filteredCourts = query.Where(x => x.CountyName.Contains("Westchester"))
                                   .ToList();
        }

        ShowClearBtn = true;
        StateHasChanged();
    }
    private void SelectCounty()
    {

        if (legalcaseDto.CountyId != null && legalcaseDto.CountyId != Guid.Empty)
        {
            filteredCourts = CourtLocationList.Where(x => x.CountyId == legalcaseDto.CountyId)
                                .ToList();
        }
        ShowClearBtn = true;
        StateHasChanged();
    }
    private void SelectCourtPart()
    {

        if (legalcaseDto.CourtPartId != null && legalcaseDto.CourtPartId != Guid.Empty)
        {
            var courtpart = CourtPartList.Where(x => x.Id == legalcaseDto.CourtPartId)
                                .FirstOrDefault();
            legalcaseDto.Judge = courtpart.Judge;

            legalcaseDto.CourtRoom = courtpart.RoomNo;
            legalcaseDto.CourtRoomNo = courtpart.RoomNo;
            legalcaseDto.CourtPart = courtpart.Part;
        }
        ShowClearBtn = true;
        StateHasChanged();
    }
    @* private async Task OnSearchMarshalInput(ChangeEventArgs e)
    {
        searchmarshalText = e.Value?.ToString() ?? "";
        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        try
        {

            await Task.Delay(300, _cts.Token);
            // ⭐ Empty input → load all tenants (ONLY here)
            if (string.IsNullOrWhiteSpace(searchmarshalText))
            {
                await ShowAllmarshal();
                return;
            }

            // ⭐ 1st & 2nd character → DO NOTHING (keep list unchanged)
            if (searchmarshalText.Length < 3)
            {
                // ❗ No reload here (important)
                return;
            }

            else
            {
                // ⭐ 3+ characters → server search

                filteredmarshal = await _marshalService.SearchMarshalbyname(searchmarshalText);
            }

        }
        catch (TaskCanceledException)
        {
            // Old task cancelled → ignore
        }

    } *@

    private async Task OpenNotesTab(Guid NotesId)
    {
        try
        {
            CaseNotesId = NotesId;
            OpenTab = "Notes";
            _showCreateAction = true;
            StateHasChanged();
            await Task.Delay(100);
            await JS.InvokeVoidAsync("showModal", "generateActions");
        }
        catch (Exception ex)
        {

        }

    }

    @* private async Task SubmitMarshalDates(bool formgeneration)
    {
        showMarshalError = false; // reset old errors

        if (legalcaseDto.MarshalId == null || legalcaseDto.MarshalId == Guid.Empty)
        {
            showMarshalError = true;
            StateHasChanged();
            return;
        }
        // spinnerservice.Show();

        var result = await _service.UpdateMarshalAsync(legalcaseDto);

        if (result)
        {
            ToastService.ShowSuccess("Marshal Assign  successfully!");
            // await LoadCaseDetails();
            isMarshalAssigned = true;
        }
        else
        {
            if (!isMarshalAssigned)
            {
                ToastService.ShowError("Failed to asign Marshal .");
            }
        } 



        // var toadd = new CaseWarrantDto
        // {
        //     WarrantIssued = model.WarrantIssued,
        //     WarrantRejected = model.WarrantRejected,
        //     WarrantRequested = model.WarrantRejected,
        //     EvictionExecuted = model.EvictionExecuted,
        //     ExecutionEligible = model.ExecutionEligible,
        //     NoticeServed = model.NoticeServed,
        //     ReFileDate = model.ReFileDate,
        //     Status = model.Status,
        //     MarshalId = legalcaseDto.MarshalId,
        //     LegalcaseId = legalcaseDto.Id
        // };
        CaseWarranrDto.LegalcaseId = legalcaseDto.Id;
        var resultcasewarrant = await _casewarrantservice.AddCaseWarrant(CaseWarranrDto);

        if (resultcasewarrant)
        {
            ToastService.ShowSuccess("Case Warrant Added successfully!");
            await LoadOthers();
            await JS.InvokeVoidAsync("hideModal", "marshalModal");

        }
        else
        {
            ToastService.ShowError("Error occured in adding Case Warrant!");
        }

        if (formgeneration)
        {
            await GenrateMarshalForm();
        }

        StateHasChanged();
    } *@

    @* private async void Selectedmarshal(MarshalDto marshal)
    {

        selectedmarshal = marshal;
        // searchmarshalText = marshal.Name!;
        searchmarshalText = $"{marshal.FirstName} {marshal.LastName}";


        legalcaseDto.MarshalId = marshal.Id;
        // legalcaseDto.MarshalName = searchmarshalText;
        // legalcaseDto.MarshalPhone = marshal.Telephone;
        // legalcaseDto.Docketno = marshal.DocketNo;


        filteredmarshal?.Clear();
        // isMarshalAssigned = true;

        StateHasChanged();


    }*@



    // private void ResetMarshal()
    // {
    //     spinnerservice.Show();
    //     isMarshalAssigned = false;
    //     selectedmarshal = null;
    //     legalcaseDto.MarshalId = null;
    //     searchmarshalText = "";
    //     filteredmarshal?.Clear();
    //     showMarshalError = false;

    //     StateHasChanged();
    //     spinnerservice.Hide();
    // }

    private async Task GenrateMarshalForm()
    {

        spinnerservice.Show();
        if (CurrentCaseId.HasValue && CurrentCaseId.Value != Guid.Empty)
        {
            bool success = false;


            // CREATE new notice
            success = await CaseFormRepository.GenerateWarrantNoticeAsync(
                    CurrentCaseId.Value,
                    "Request for Warrant (CIV-LT-100)",
                       // "Written Demand to Terminate (move out)",
                       Guid.Parse(loggedInUserId)
                );

            if (success)
            {
                ToastService.ShowSuccess("Warrant Notice has been generated successfully!");
                legalcaseDto.WarrantRequested = true;
                var result = _service.UpdateWarrantRequested(legalcaseDto);
                await LoadCaseForms();
                await JS.InvokeVoidAsync("openTab", "activity");
            }
        }





        spinnerservice.Hide();

    }

    // private async Task SubmitMarshal()
    // {
    //     showMarshalError = false;

    //     if (legalcaseDto.MarshalId == null || legalcaseDto.MarshalId == Guid.Empty)
    //     {
    //         showMarshalError = true;
    //         StateHasChanged();
    //         return;
    //     }
    //     spinnerservice.Show();

    //     var result = await _service.UpdateMarshalAsync(legalcaseDto);

    //     if (result)
    //     {
    //         ToastService.ShowSuccess("Marshal Assign  successfully!");
    //         legalcaseDto.MarshalName = searchmarshalText;
    //         legalcaseDto.MarshalPhone = selectedmarshal.Telephone;
    //         legalcaseDto.Docketno = selectedmarshal.DocketNo;

    //         isMarshalAssigned = true;
    //     }
    //     else
    //     {
    //         ToastService.ShowError("Failed to asign Marshal .");
    //     }
    //     StateHasChanged();
    //     spinnerservice.Hide();

    // }

    // private async Task ShowAllmarshal()
    // {
    //     filteredmarshal = (await _marshalService.GetAllMarshalAsync()).ToList();
    //     StateHasChanged();
    // }
    private async Task OnFocusOutCourt(FocusEventArgs e)
    {
        await Task.Delay(200);
        ShowCourtDropdown = false;
    }
    private async Task BindPart()
    {

        court.SelectedCourtPart.Part = searchCourtPartText;
    }
    private async Task OnFocusOutCourtPart(FocusEventArgs e)
    {
        await Task.Delay(200);
        ShowCourtPartDropdown = false;
    }

    // public record MonthItem(string Value, string Display);
    // private List<MonthItem> MonthOptions = new();
    // private List<ArrearLedgerDto> Rows = new();
    // private List<ArrearLedgerDto> RowstoDelete = new();

    @*  private void OnMonthChanged(ArrearLedgerDto row)
    {
        StateHasChanged();
    }
    private void GenerateMonths()
    {
        MonthOptions.Clear();

        if (legalcaseDto.LastPaymentDate is null)
            return;

        DateTime start = new DateTime(
            legalcaseDto.LastPaymentDate.Value.Year,
            legalcaseDto.LastPaymentDate.Value.Month,
            1);

        DateTime end = new DateTime(
            DateTime.Today.Year,
            DateTime.Today.Month,
            1);

        var requiredMonths = new List<string>();
        // Iterate month-by-month
        for (DateTime dt = start.AddMonths(1); dt <= end; dt = dt.AddMonths(1))
        {
            string value = $"{dt:yyyy-MM}"; // stored value
            string display = $"{dt:yyyy}-{CultureInfo.CurrentCulture.DateTimeFormat.GetAbbreviatedMonthName(dt.Month)}";

            MonthOptions.Add(new MonthItem(value, display));
            requiredMonths.Add(value);
        }

        // ---- ADD MISSING ROWS ----
        foreach (var month in requiredMonths)
        {
            if (!Rows.Any(r => r.Month == month))
            {
                Rows.Add(new ArrearLedgerDto
                {
                    Month = month,
                    Amount= legalcaseDto.MonthlyRent.Value,
                    LegalCaseId = legalcaseDto.Id,
                });
            }
        }

        // ---- REMOVE EXTRA ROWS ----
        var rowsToRemove = Rows
            .Where(r => !requiredMonths.Contains(r.Month))
            .ToList();

        foreach (var row in rowsToRemove)
        {
            RemoveRow(row); // this will track delete correctly
        }
        RecalculateTotal();
    }
    private void RecalculateTotal()
    {
        legalcaseDto.TotalOwed = Rows.Sum(x => x.Amount);
        StateHasChanged();
    }

    private void AddRow()
    {
        Rows.Add(new ArrearLedgerDto());
    }

    private void RemoveRow(ArrearLedgerDto row)
    {
        Rows.Remove(row);
        if (row.Id != null && row.Id != Guid.Empty)
        {
            RowstoDelete.Add(row);
        }

    }

    private void OnAmountChanged(ArrearLedgerDto row, double value)
    {

        row.Amount = value;
        StateHasChanged();
    } *@

    private void CalculateCaseProgress()
    {
        int progress = 0;

        if (legalcaseDto != null && legalcaseDto.Id != Guid.Empty)
            progress += 10;

        if (caseFormDto.Any())
            progress += 10;

        if (legalcaseDto!.CourtLocationId != null && legalcaseDto.CourtLocationId != Guid.Empty)
            progress += 15;

        if (CaseHearings.Any())
            progress += 15;

        FinalProgress = progress;
    }
    private void StartProgressAnimation()
    {
        AnimatedProgress = 0;

        animationTimer = new System.Timers.Timer(40);
        animationTimer.Elapsed += (sender, args) =>
        {
            if (AnimatedProgress < FinalProgress)
            {
                AnimatedProgress += 1;
                InvokeAsync(StateHasChanged);
            }
            else
            {
                animationTimer.Stop();
                animationTimer.Dispose();
            }
        };

        animationTimer.Start();
    }

    private async Task ShowCreateAction()
    {
        _showCreateAction = true;
        OpenTab = "Notices";
        CaseNotesId = null;
        await Task.Delay(100);
        noticeModel = new GenrateNoticeModel();
        await JS.InvokeVoidAsync("showModal", "generateActions");
    }

    private async Task HandleCloseCreateAction()
    {
        await JS.InvokeVoidAsync("hideModal", "generateActions");
        _showCreateAction = false;
        await HandleInvokeAction();
    }
    private async Task HandleInvokeAction()
    {
        await LoadCaseForms();
        await LoadCaseDocument();
        await LoadCaseDetails();
        await LoadHearing();
        await LoadOthers();
        await JS.InvokeVoidAsync("hideModal", "generateActions");
        CaseNotesId = null;
        _showCreateAction = false;
        isLoadMarshal = true;
    }
    private async Task HandleNotesInvokeAction()
    {
        await LoadNotes();
        await JS.InvokeVoidAsync("hideModal", "generateActions");
        CaseNotesId = null;
        _showCreateAction = false;

    }
    private async Task LoadCaseDetails()
    {
        legalcaseDto = await _service.GetCaseByIdAsync(caseId);
        // if (legalcaseDto.MarshalId != null && legalcaseDto.MarshalId != Guid.Empty)
        // {
        //     selectedmarshal = await _marshalService.GetMarshalByIdAsync(legalcaseDto.MarshalId.Value);
        //     isMarshalAssigned = true;
        // }
        // else
        // {
        //     isMarshalAssigned = false;
        //     selectedmarshal = null;
        //     searchmarshalText = string.Empty;
        // }
        if (legalcaseDto != null && legalcaseDto.CaseTypeId != null)
        {
            FilteredFormTypeList = await FormTypesRepository.GetFormTypesByCaseTypeAsync(legalcaseDto.CaseTypeId);

        }

        // feecatalogDto = await _feeCatalogService.GetAllAsync();
        // var feeLookup = feecatalogDto.ToDictionary(f => f.Label.ToLower(), f => f.Rate);

        // foreach (var form in FilteredFormTypeList)
        // {
        //     if (feeLookup.TryGetValue(form.Name.ToLower(), out var rate))
        //     {
        //         form.BillAmount = rate;
        //     }
        // }

        CurrentCaseId = caseId;
        if (legalcaseDto != null)
        {

            legalcaseDto = new IntakeModel
            {
                Id = legalcaseDto.Id,
                ClientId = legalcaseDto.ClientId,
                Casecode = legalcaseDto.Casecode,
                CaseTypeId = legalcaseDto.CaseTypeId,
                CaseTypeName = legalcaseDto.CaseTypeName,
                IsERAPPaymentReceived = legalcaseDto.IsERAPPaymentReceived,
                MonthlyRent = legalcaseDto.MonthlyRent,
                TotalOwed = legalcaseDto.TotalOwed,
                TenantShare = legalcaseDto.TenantShare,
                RentDueEachMonthOrWeekId = legalcaseDto.RentDueEachMonthOrWeekId,
                OralStart = legalcaseDto.OralStart,
                OralEnd = legalcaseDto.OralEnd,
                WrittenLease = legalcaseDto.WrittenLease,
                DateTenantMoved = legalcaseDto.DateTenantMoved,
                TenancyTypeId = legalcaseDto.TenancyTypeId,
                CreatedOn = legalcaseDto.CreatedOn,
                Status = legalcaseDto.IsActive ? "Active" : "Inactive",
                RemainderDate = legalcaseDto.RemainderDate,

                // for client
                ClientCode = legalcaseDto.ClientCode,
                // FirstName = legalcaseDto.FirstName,
                // LastName = legalcaseDto.LastName,
                // Address1 = legalcaseDto.Address1,
                // Address2 = legalcaseDto.Address2,
                // StateName = legalcaseDto.StateName,
                // ZipCode = legalcaseDto.ZipCode,
                // ClientEmail = legalcaseDto.ClientEmail,
                // ClientPhone = legalcaseDto.ClientPhone,
                MarshalId = legalcaseDto.MarshalId,

                // Landlord
                LandlordId = legalcaseDto.LandlordId,
                // FullName = legalcaseDto.FullName,
                // Phone = legalcaseDto.Phone,
                // Email = legalcaseDto.Email,
                // LandLordTypeId = legalcaseDto.LandLordTypeId ?? Guid.Empty,

                // landlordName = legalcaseDto.landlordName,
                // ContactPersonName = legalcaseDto.ContactPersonName,
                // LandlordAddress = legalcaseDto.LandlordAddress,

                // Building
                BuildingId = legalcaseDto.BuildingId,
                // Mdr = legalcaseDto.Mdr,
                // Units = legalcaseDto.Units,
                // BuildingAddress = legalcaseDto.BuildingAddress,
                // RegulationStatusId = legalcaseDto.RegulationStatusId ?? Guid.Empty,
                Borough = legalcaseDto.Borough,
                // BuildingState = legalcaseDto.BuildingState,
                // BuildingZip = legalcaseDto.BuildingZip,
                // PrimaryResidence = legalcaseDto.PrimaryResidence,
                // RentRegulationOther = legalcaseDto.RentRegulationOther,
                // ExemptionBasisOther = legalcaseDto.ExemptionBasisOther,
                // ExemptionBasisId = legalcaseDto.ExemptionBasisId,
                // ExemptionReasonId = legalcaseDto.ExemptionReasonId,

                // RegulationStatusName = legalcaseDto.RegulationStatusName,


                // Tenant
                TenantId = legalcaseDto.TenantId,
                TenantName = legalcaseDto.TenantName,
                // UnitNumber = legalcaseDto.UnitNumber,
                // UnitOrApartmentNumber = legalcaseDto.UnitOrApartmentNumber,
                // IsUnitIllegalId = legalcaseDto.IsUnitIllegalId,
                // TenantRecord = legalcaseDto.TenantRecord,
                // HasPossession = legalcaseDto.HasPossession,
                // OtherOccupants = legalcaseDto.OtherOccupants,
                // ApartmentNumber = legalcaseDto.ApartmentNumber,
                // TenancyTypeForBuildingId = legalcaseDto.TenancyTypeForBuildingId,
                //WrittenLease = legalcaseDto.WrittenLease,
                OralAgreeMent = legalcaseDto.OralAgreeMent,
                CaseProgramId = legalcaseDto.CaseProgramId,
                GoodCauseApplies = legalcaseDto.GoodCauseApplies,
                //DateTenantMoved = legalcaseDto.DateTenantMoved,
                LeaseEnd = legalcaseDto.LeaseEnd,
                //TenancyTypeId = legalcaseDto.TenancyTypeId,
                DateNoticeServed = legalcaseDto.DateNoticeServed,
                CalculatedNoticeLength = legalcaseDto.CalculatedNoticeLength,
                ExpirationDate = legalcaseDto.ExpirationDate,
                PredicateNotice = legalcaseDto.PredicateNotice,
                //RentDueEachMonthOrWeekId = legalcaseDto.RentDueEachMonthOrWeekId,
                // MonthlyRent = legalcaseDto.MonthlyRent,
                //TotalOwed = legalcaseDto.TotalOwed,
                //TenantShare = legalcaseDto.TenantShare,
                SocialService = legalcaseDto.SocialService,
                LastRentPaid = legalcaseDto.LastRentPaid,

                CourtLocationId = legalcaseDto.CourtLocationId,
                CourtId = legalcaseDto.CourtId,
                Court = legalcaseDto.Court,
                CourtPartId = legalcaseDto.CourtPartId,
                CourtAddress = legalcaseDto.CourtAddress,
                CourtConferenceId = legalcaseDto.CourtConferenceId,
                CourtCallIn = legalcaseDto.CourtCallIn,
                CourtNotes = legalcaseDto.CourtNotes,
                CourtRoom = legalcaseDto.CourtRoom,
                CourtPart = legalcaseDto.CourtPart,
                CourtPhone = legalcaseDto.CourtPhone,
                CourtRoomNo = legalcaseDto.CourtRoomNo!,
                CourtVirtualLink = legalcaseDto.CourtVirtualLink,
                Judge = legalcaseDto.Judge,
                BillAmount = legalcaseDto.BillAmount,
                // Docketno = legalcaseDto.Docketno,
                // MarshalName = legalcaseDto.MarshalName,
                // MarshalPhone = legalcaseDto.MarshalPhone,

                LastPayment = legalcaseDto.LastPayment,
                Assistance = legalcaseDto.Assistance,
                NextBussinessday = legalcaseDto.NextBussinessday,
                leasedAttached = legalcaseDto.leasedAttached != null ? legalcaseDto.leasedAttached : false,
                ledgerAttached = legalcaseDto.ledgerAttached != null ? legalcaseDto.ledgerAttached : false,
                NoticeproofAttached = legalcaseDto.NoticeproofAttached != null ? legalcaseDto.NoticeproofAttached : false,
                RegistrationRentAttached = legalcaseDto.RegistrationRentAttached != null ? legalcaseDto.RegistrationRentAttached : false,
                GoodCauseExempt = legalcaseDto.GoodCauseExempt,
                CourtDraftNop = legalcaseDto.CourtDraftNop,
                LeaseStart = legalcaseDto.LeaseStart,
                PlannedServiceDate = legalcaseDto.PlannedServiceDate,
                LastPaymentDate = legalcaseDto.LastPaymentDate,
                DeemedService = legalcaseDto.DeemedService,
                Expiry = legalcaseDto.Expiry,
                AdditionalComments = legalcaseDto.AdditionalComments,
                AffidavitofService = legalcaseDto.AffidavitofService,
                PreferedFilingDate = legalcaseDto.PreferedFilingDate,
                FilingMethodId = legalcaseDto.FilingMethodId,
                NoticeId = legalcaseDto.NoticeId,
                ServiceMethodId = legalcaseDto.ServiceMethodId,
                CountyId = legalcaseDto.CountyId,
                CourtTypeId = legalcaseDto.CourtTypeId,
                CountyName = legalcaseDto.CountyName ?? string.Empty,
                Index = legalcaseDto.Index,
                WarrantRequested = legalcaseDto.WarrantRequested,
                ArrearLedgers = legalcaseDto.ArrearLedgers,

                OppAttorneyFirm = legalcaseDto.OppAttorneyFirm,
                OppAttorneyEmail = legalcaseDto.OppAttorneyEmail,
                OppAttorneyname = legalcaseDto.OppAttorneyname,
                OppAttorneyPhone = legalcaseDto.OppAttorneyPhone,
                Aps_Agl = legalcaseDto.Aps_Agl,

            };

        }
        ;

        courts = await _courtService.GetAllCourtDataAsync();
        //courts = new List<CourtDto>();
        if (!courts.Any())
        {
            isNewCourt = true;
            showCourtFields = true;
        }
    }

    public async Task EditCaseDetail(Guid id)
    {
        spinnerservice.Show();
        var result = await _CaseFormService.GetCaseFormByIdAsync(id);

        if (result != null)
        {
            noticeModel = new GenrateNoticeModel
            {
                Id = result.Id,
                FormTypeId = result.FormTypeId,
                File = result.File,
                HTML = result.HTML,
                CreatedOn = result.CreatedOn,
            };
            isEditMode = true;

        }
        spinnerservice.Hide();
        await JS.InvokeVoidAsync("showBootstrapTab", "#actions-tab");
    }
    private decimal? BillAmount = null;

    private void FormTypeBindAfter()
    {
        var selectedForm = FilteredFormTypeList
            .FirstOrDefault(f => f.Id == noticeModel.FormTypeId);

        if (selectedForm != null)
            noticeModel.BillAmount = Convert.ToDecimal(selectedForm.Rate);
        else
            noticeModel.BillAmount = null;

        StateHasChanged();
    }


    // private async Task GenerateNotice()
    // {
    //     spinnerservice.Show();

    //     legalcaseDto.BillAmount = (legalcaseDto.BillAmount ?? 0) + (noticeModel.BillAmount ?? 0);

    //     var successcase = await _service.UpdateCaseAsync(legalcaseDto);
    //     if (!successcase.HasValue)
    //     {
    //         return;
    //     }
    //     else
    //     {
    //         noticeModel.BillAmount = null;
    //     }

    //     if (CurrentCaseId.HasValue && CurrentCaseId.Value != Guid.Empty && noticeModel.FormTypeId.HasValue)
    //     {
    //         bool success = false;

    //         if (isEditMode)
    //         {
    //             // UPDATE existing notice
    //             success = await _CaseFormService.UpdateCaseFormAsync(new GenrateNoticeModel
    //             {
    //                 Id = noticeModel.Id,
    //                 LegalCaseId = CurrentCaseId.Value,
    //                 FormTypeId = noticeModel.FormTypeId,
    //                 File = noticeModel.File,
    //                 HTML = noticeModel.HTML,
    //                 CreatedOn = noticeModel.CreatedOn
    //             });

    //             if (success)
    //             {
    //                 ToastService.ShowSuccess("Notice has been updated successfully!");
    //             }
    //         }
    //         else
    //         {
    //             // CREATE new notice
    //             success = await CaseFormRepository.GenerateNoticeAsync(
    //                 CurrentCaseId.Value,
    //                 noticeModel.FormTypeId.Value,
    //                    Guid.Parse(loggedInUserId)
    //             );

    //             if (success)
    //             {
    //                 ToastService.ShowSuccess("Notice has been generated successfully!");
    //             }
    //         }

    //         if (success)
    //         {
    //             await LoadCaseForms();

    //             // Reset form
    //             noticeModel = new GenrateNoticeModel();
    //             isEditMode = false;
    //             CurrentCaseId = caseId;

    //             await JS.InvokeVoidAsync("openTab", "activity");
    //         }
    //     }
    //     else
    //     {

    //     }

    //     spinnerservice.Hide();
    // }


    private async Task ViewPdf(string filePath)
    {
        if (!string.IsNullOrWhiteSpace(filePath))
        {
            var fullUrl = Navigation.BaseUri.TrimEnd('/') + filePath;
            // Navigation.NavigateTo(fullUrl, forceLoad: true);
            await JS.InvokeVoidAsync("open", fullUrl, "_blank");
        }
    }


    private async Task LoadCaseForms()
    {
        caseFormDto = await _CaseFormService.GetCaseFormsByCaseId(CurrentCaseId.Value, loggedInUserId, isAdmin);
        if (caseFormDto.Any())
        {
            caseForm = caseFormDto.FirstOrDefault()!;
        }
        else
        {
            IsFormGenerated = false;
        }
        await JS.InvokeVoidAsync("openTab", "activity");
        StateHasChanged();
    }

    private async Task LoadHearing()
    {
        CaseHearings = await _caseHearingService.GetAllCaseHeariingByCaseIdAsync(CurrentCaseId.Value);
        if (CaseHearings.Any())
        {
            CaseHearing = CaseHearings.FirstOrDefault()!;
        }
        StateHasChanged();
    }
    private async Task LoadJudgement()
    {
        Judgements = await _caseAppreance.GetAllCaseAppreance(CurrentCaseId.Value);
        if (Judgements != null)
        {
            if (CaseHearings != null)
            {
                int count = Math.Min(Judgements.Count, CaseHearings.Count);

                for (int i = 0; i < count; i++)
                {
                    // Assign hearing date to judgement appearance date
                    Judgements[i].AppreanceDate = CaseHearings[i].HearingDate;
                }
            }

            MotionJudgements = Judgements!.Where(e => e.CourtTodayName!.Contains("Motion")).FirstOrDefault()! ?? new CaseAppearanceDto();
        }




        StateHasChanged();
    }
    private async Task LoadOthers()
    {
        var casenotice = await _caseNoticeinfo.GetAllCasenoticeInfo(legalcaseDto.Id);
        if (casenotice != null)
        {
            CaseNoticeInfos = casenotice.Where(e => e.FormTypeName.Contains("Demand")).FirstOrDefault() ?? new CaseNoticeInfoDto();
            legalcaseDto.ExpirationDate = CaseNoticeInfos.DateNoticeServed.HasValue ? CaseNoticeInfos.DateNoticeServed.Value.AddDays(CaseNoticeInfos.CalcNoticeLength ?? 0) : null;
        }
        legalcaseDto.NextCourtDate = CaseHearings.Where(e => e.HearingDate > DateTime.Now).OrderBy(ed => ed.HearingDate).Select(ab => ab.HearingDate).FirstOrDefault();

        var remainders = await _remainders.GetRemainderCenterByCaseIdAsync(legalcaseDto.Id);
        // remainders = remainders.OrderBy(e => e.When).ToList();
        if (remainders != null)
        {
            legalcaseDto.RemainderDate = remainders
        .Where(r => r.When > DateTime.Now)
        .OrderBy(r => r.When)
        .Select(r => r.When)
        .FirstOrDefault();
        }

        caseWarrantDto = await _casewarrantservice.GetWarrantDetails(legalcaseDto.Id);



        StateHasChanged();
    }

    private async Task LoadNotes()
    {
        CaseNotes = await _service.GetAllCaseNotes(legalcaseDto.Id);
        StateHasChanged();

    }

    private async Task LoadCaseDocument()
    {
        caseDocuments = await _service.CaseDocumentList(legalcaseDto.Id);
        StateHasChanged();
    }

    // private void Createcase()
    // {
    //     Navigation.NavigateTo("/cases");
    // }

    public void BackTocases()
    {
        Navigation.NavigateTo("/legalcases");
    }

    public async Task OpenAttorneyModal()
    {
        await JS.InvokeVoidAsync("showModal", "attorneyModal");
    }
    public async Task CloseAttorneyModal()
    {
        await JS.InvokeVoidAsync("hideModal", "attorneyModal");
    }

    public async Task DeleteCaseDetail(Guid id)
    {
        spinnerservice.Show();
        bool isDeleted = await _CaseFormService.DeleteDetailAsync(id);

        if (isDeleted)
        {
            caseFormDto = await _CaseFormService.GetCaseFormsByCaseId(CurrentCaseId.Value, loggedInUserId, isAdmin);
            ToastService.ShowSuccess("File  has been Deleted successfully!");
            StateHasChanged();
        }
        spinnerservice.Hide();
    }

    //private TenantModel tenantEditModel = new();
    //private BuildingModel buildingEditModel = new();
    // private List<TenancyType> TenancyTypeList = new();

    @*  private async void ShowTenantModal()
    {
       
        Tenants.Clear();
        UnderTenants.Clear();
        CaseAdditionalTenantfromDbList.Clear();
        TenantList = await _tenantService.GetTenantsByClientIdAsync(legalcaseDto.BuildingId!.Value);

        CaseTypeList = await CaseTypeRepository.GetAllCaseType();
        if (!TenancyTypeList.Any()) TenancyTypeList = await TenancyTypeRepository.GetAllTenancyType();
        if (!DateRentList.Any()) DateRentList = await DateRentRepository.GetAllDateRent();

        if (legalcaseDto.TenantId != null && legalcaseDto.TenantId != Guid.Empty)
        {
            ViewTenant = await _tenantService.GetByIdAsync(legalcaseDto.TenantId!.Value);
            if (!CaseAdditionalTenantfromDbList.Any()) CaseAdditionalTenantfromDbList = await _caseAdditionalTenant.GetAllAdditionalCaseTenantsAsync(legalcaseDto.Id);

            // AdditionalTenantfromDbList = await _additionalTenantService.GetAllAdditionalTenantsAsync(legalcaseDto.TenantId);
            AdditionalOccupantsFromDbList = await _additionalOccupantService.GetAllAdditionalOccupantsAsync(legalcaseDto.Id);
            AdditionalOccupantsList = AdditionalOccupantsFromDbList.ToList();
            searchTenantText = ViewTenant.UnitOrApartmentNumber!;
            Tenants.Add(legalcaseDto.TenantName);
            if (CaseAdditionalTenantfromDbList.Any())
            {
                Tenants.AddRange(CaseAdditionalTenantfromDbList.Select(e => $"{e.FirstName} {e.LastName}").ToList());
                AdditionalTenantList.AddRange(CaseAdditionalTenantfromDbList.Select(e => new AddtionalTenantDto
                {
                    FirstName = e.FirstName,
                    LastName = e.LastName,
                    Id = e.Id,
                    LegalCaseId = e.LegalCaseId
                }).ToList());
            }
            // Tenants.AddRange(CaseAdditionalTenantfromDbList.Select(e => $"{e.FirstName} {e.LastName}"));
            UnderTenants.AddRange(AdditionalOccupantsFromDbList.Select(e => $"{e.Name}"));

            GenerateMonths();
            Rows = legalcaseDto.ArrearLedgers;

        }

        var undertenaants = new List<string>() { "John Doe", "John Doe" };
        UnderTenants.AddRange(undertenaants);

        StateHasChanged();
        JS.InvokeVoidAsync("showModal", "tenantModal");
    } *@

    // public EditToClientDto client = new EditToClientDto();
    public List<EditToClientDto> ClientList = new List<EditToClientDto>();
    public IEnumerable<CaseNotes> CaseNotes = new List<CaseNotes>();
    // public List<EditToClientDto> filteredClients = new List<EditToClientDto>();
    // public List<ClientRole> ClientTypeList = new List<ClientRole>();
    // public string searchText { get; set; }
    // public bool showClientTextbox = false;
    // public bool newClient = false;
    bool showCountyDropdown = false;
    bool ShowClearBtn = false;
    bool showCourtPartDropdown = false;
    private IEnumerable<CourtType> CourtTypeList = new List<CourtType>();
    private List<EditToCountyDto> CountyList = new();
    private List<CourtPartDto> CourtPartList = new();
    private List<CourtDto> CourtLocationList = new();
    private ValidationMessageStore messageStore;
    private EditContext _editContext;
    private List<PremiseType> PremiseTypesList = new();
    // private async void ShowClientModal()
    // {


    //     client = await _clientService.GetClientByIdAsync(legalcaseDto.ClientId!.Value) ?? new EditToClientDto();

    //     ClientTypeList = await _clientRoleRepository.GetAllClientRole();
    //     showClientTextbox = true;
    //     searchText = $"{client.FirstName} {client.LastName}";
    //     StateHasChanged();
    //     JS.InvokeVoidAsync("showModal", "clientModal");
    // }
    private async void ShowStipulationModal()
    {

        await JS.InvokeVoidAsync("showModal", "stipulationModal");
    }
    private async void ShowMarshalModal()
    {

        CaseWarranrDto = new CaseWarrantDto
        {
            Id = caseWarrantDto.Id,
            WarrantRequested = caseWarrantDto.WarrantRequested,
            WarrantIssued = caseWarrantDto.WarrantIssued,
            WarrantRejected = caseWarrantDto.WarrantRejected,
            NoticeServed = caseWarrantDto.NoticeServed,
            ExecutionEligible = caseWarrantDto.ExecutionEligible,
            EvictionExecuted = caseWarrantDto.EvictionExecuted,
            ReFileDate = caseWarrantDto.ReFileDate,
            Status = caseWarrantDto.Status,

        };


        JS.InvokeVoidAsync("showModal", "marshalModal");
    }
    // private void OnSearchInput(ChangeEventArgs e)
    // {
    //     searchText = e.Value.ToString();
    //     filteredClients = ClientList
    //         .Where(c => c.FirstName.Contains(searchText, StringComparison.OrdinalIgnoreCase)
    //                     || c.LastName.Contains(searchText, StringComparison.OrdinalIgnoreCase)
    //                     || c.ClientCode.Contains(searchText, StringComparison.OrdinalIgnoreCase))
    //         .ToList();
    // }
    // private void SelectClient(EditToClientDto selectedclient)
    // {
    //     showClientTextbox = true;
    //     searchText = $"{client.FirstName} {client.LastName}";
    //     filteredClients.Clear();
    //     newClient = false;

    //     legalcaseDto.ClientId = selectedclient.Id;
    //     client.Id = selectedclient.Id;
    //     client.FirstName = $"{selectedclient.FirstName}";
    //     client.LastName = $"{selectedclient.LastName}";
    //     client.Email = selectedclient.Email;
    //     client.Phone = selectedclient.Phone;
    //     client.Address1 = selectedclient.Address1;
    //     client.Address2 = selectedclient.Address2;
    //     client.City = selectedclient.City;
    //     client.StateId = selectedclient.StateId;
    //     client.ZipCode = selectedclient.ZipCode;
    //     client.ClientTypeId = selectedclient.ClientTypeId;
    //     client.Reference = selectedclient.Reference;
    // }
    // private void ClearSelectedClient()
    // {
    //     searchText = string.Empty;

    //     newClient = false;
    //     showClientTextbox = false;
    //     searchText = null;
    //     client = new EditToClientDto();

    //     StateHasChanged();
    // }
    // private async void AddClient()
    // {
    //     showClientTextbox = true;
    //     searchText = null;
    //     newClient = true;
    //     client = new EditToClientDto();
    //     StateHasChanged();

    // }

    // private async Task ShowLandlordModal()
    // {

    //     editLandlordModel = await _landLordRepository.GetLandlordByIdAsync(legalcaseDto.LandlordId!.Value);
    //     BuildingList = await _buildingRepository.GetBuildingsByLandlordIdAsync(legalcaseDto.ClientId!.Value);
    //     searchLandlordText = editLandlordModel.LandLordCode;
    //     showLandlordFields = true;
    //     await JS.InvokeVoidAsync("showModal", "landlordModal");
    // }


    // private async Task ShowBuildingModal()
    // {
    //     if (!PremiseTypesList.Any()) PremiseTypesList = await PremiseTypeRepository.GetAllPremiseType();
    //     RegulationList = await _regulationStatusRepository.GetAllRegulationStatus();
    //     ExemptionBasicList = await ExemptionBasicRepository.GetAllAsync();
    //     StateList = await _stateRepository.GetAllState();
    //     IsNewBuilding = true;
    //     Prefill edit model from case
    //     editBuildingModel = await _buildingRepository.GetBuildingByIdAsync(legalcaseDto.BuildingId!.Value);
    //     BuildingList = await _buildingRepository.GetBuildingsByLandlordIdAsync(legalcaseDto.LandlordId!.Value);
    //     searchBuildingText = editBuildingModel.BuildingCode;
    //     if (editBuildingModel.GoodCause == null)
    //     {
    //         editBuildingModel.GoodCause = false;
    //     }
    //     showBuildingFields = true;
    //     await JS.InvokeVoidAsync("showModal", "buildingModal");
    // }
    private async Task ShowCourtModal()
    {
        // Load lists if empty
        if (!CourtTypeList.Any())
            CourtTypeList = await _service.CourtTypeList();

        if (!CountyList.Any())
            CountyList = await countyService.GetAllCounty();

        if (!CourtLocationList.Any())
            CourtLocationList = await _courtService.GetAllCourtDataAsync();

        // Load CourtPartList if CourtLocationId exists
        if (legalcaseDto.CourtLocationId != null && legalcaseDto.CourtLocationId != Guid.Empty)
        {
            var location = CourtLocationList.FirstOrDefault(e => e.Id == legalcaseDto.CourtLocationId);
            if (location != null)
                CourtPartList = location.CourtPart;
        }


        if (legalcaseDto.CourtTypeId != null && legalcaseDto.CourtTypeId != Guid.Empty)
        {
            var casetype = CourtTypeList.FirstOrDefault(e => e.Id == legalcaseDto.CourtTypeId);
            if (casetype != null && !string.IsNullOrEmpty(casetype.Name) && casetype.Name.Contains("NYC"))
            {
                showCountyDropdown = true;
                ShowClearBtn = true;
            }
        }
        else
        {
            var nycCourtType = CourtTypeList.FirstOrDefault(e => !string.IsNullOrEmpty(e.Name) && e.Name.Contains("NYC"));
            if (nycCourtType != null)
                legalcaseDto.CourtTypeId = nycCourtType.Id;

            showCountyDropdown = true;
            ShowClearBtn = true;


        }
        if (legalcaseDto.CountyId == null || legalcaseDto.CountyId == Guid.Empty)
        {
            if (!string.IsNullOrEmpty(legalcaseDto.Borough))
            {
                var county = CountyList.FirstOrDefault(e => !string.IsNullOrEmpty(e.Name) && e.Name.Contains(legalcaseDto.Borough));
                if (county != null)
                    legalcaseDto.CountyId = county.Id;
            }
        }
        if (legalcaseDto.CourtPartId != null && legalcaseDto.CourtPartId != Guid.Empty)
        {
            showCourtPartDropdown = true;
            var location = CourtLocationList.FirstOrDefault(e => e.Id == legalcaseDto.CourtLocationId);
            if (location != null)
                filteredCourtsPart = location.CourtPart?.ToList() ?? new List<CourtPartDto>();
        }

        await ShowAllCourts();
        await JS.InvokeVoidAsync("showModal", "courtModal");
    }


    private async Task ShowRentModal()
    {

        editRentModel = await _CaseService.GetCaseByIdAsync(legalcaseDto.Id);

        await JS.InvokeVoidAsync("showModal", "rentModal");
    }
    // async Task HideBuildingDropdown(FocusEventArgs e)
    // {
    //     await Task.Delay(500);
    //     if (filteredBuildings.Any())
    //     {
    //         filteredBuildings.Clear();
    //     }
    //     StateHasChanged();
    // }

    // async Task HideLandlordDropdown(FocusEventArgs e)
    // {
    //     await Task.Delay(500);
    //     if (filteredlandlords.Any())
    //     {
    //         filteredlandlords.Clear();
    //     }
    //     StateHasChanged();
    // }

    // private async Task ShowAllLandlords()
    // {
    //     if (legalcaseDto.ClientId == null || legalcaseDto.ClientId == Guid.Empty)
    //     {
    //         filteredlandlords = new List<EditToLandlordDto>();
    //         return;
    //     }
    //     else
    //     {

    //         filteredlandlords = await _landlordSevice.GetLandlordsByClientIdAsync(legalcaseDto.ClientId.Value);
    //     }

    // }

    // private async Task ShowAllBuildings()
    // {
    //     if (legalcaseDto.LandlordId == null || legalcaseDto.LandlordId == Guid.Empty)
    //     {
    //         filteredBuildings = new List<EditToBuildingDto>();
    //         return;
    //     }
    //     else
    //     {

    //         filteredBuildings = await _buildingService.GetBuildingsByLandlordIdAsync(legalcaseDto.LandlordId.Value);
    //     }

    // }
    // private async Task OnSearchLandlordInput(ChangeEventArgs e)
    // {
    //     searchLandlordText = e.Value.ToString();
    //     _cts?.Cancel();
    //     _cts = new CancellationTokenSource();

    //     try
    //     {

    //         await Task.Delay(300, _cts.Token);
    //         if (string.IsNullOrWhiteSpace(searchLandlordText))
    //         {
    //             await ShowAllLandlords();
    //             return;
    //         }


    //         if (searchBuildingText.Length < 3)
    //         {
    //             await ShowAllLandlords();
    //             return;
    //         }

    //         if (legalcaseDto.ClientId == null || legalcaseDto.ClientId == Guid.Empty)
    //         {
    //             filteredlandlords = new List<EditToLandlordDto>();
    //             return;
    //         }
    //         else
    //         {

    //             filteredlandlords = await _landlordSevice.SearchLandlordsAsync(
    //                 searchLandlordText,
    //                 legalcaseDto.ClientId.Value
    //             );
    //         }


    //     }
    //     catch (TaskCanceledException)
    //     {

    //     }
    // }
    // Search handler
    // private async Task OnSearchBuildingInput(ChangeEventArgs e)
    // {
    //     searchBuildingText = e.Value.ToString();
    //     _cts?.Cancel();
    //     _cts = new CancellationTokenSource();

    //     try
    //     {

    //         await Task.Delay(300, _cts.Token);
    //         if (string.IsNullOrWhiteSpace(searchBuildingText))
    //         {
    //             await ShowAllBuildings();
    //             return;
    //         }


    //         if (searchBuildingText.Length < 3)
    //         {
    //             await ShowAllBuildings();
    //             return;
    //         }

    //         if (legalcaseDto.LandlordId == null || legalcaseDto.LandlordId == Guid.Empty)
    //         {
    //             filteredBuildings = new List<EditToBuildingDto>();
    //             return;
    //         }
    //         else
    //         {

    //             filteredBuildings = await _buildingService.SearchBuilding(
    //                 searchBuildingText,
    //                 legalcaseDto.LandlordId.Value
    //             );
    //         }


    //     }
    //     catch (TaskCanceledException)
    //     {

    //     }
    // }
    private async Task OnSearchCourtInput(ChangeEventArgs e)
    {
        searchCourtText = e.Value?.ToString() ?? "";
        if (!string.IsNullOrWhiteSpace(searchCourtText) && searchCourtText.Length >= 3)
        {
            filteredCourts = await _courtService.SearchCourt(searchCourtText);
        }

        StateHasChanged();


    }
    private async Task OnSearchCourtPartInput(ChangeEventArgs e)
    {
        searchCourtPartText = e.Value?.ToString() ?? "";

        if (!string.IsNullOrWhiteSpace(searchCourtPartText))
        {
            filteredCourtsPart = court.CourtPart
                .Where(c => c.Judge.Contains(searchCourtText, StringComparison.OrdinalIgnoreCase)
                            || c.RoomNo.Contains(searchCourtText, StringComparison.OrdinalIgnoreCase)
                            || c.Part.Contains(searchCourtText, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
        else
        {
            // filteredCourtsPart = court.CourtPart.ToList();
            // ShowCourtPartDropdown = true;
            // StateHasChanged();
            // return;
            filteredCourtsPart.Clear();
        }
        StateHasChanged();

    }



    // private void SelectLandlord(EditToLandlordDto selected)
    // {
    //     editLandlordModel.Id = selected.Id;
    //     editLandlordModel.Address1 = selected.Address1;
    //     editLandlordModel.ContactPersonName = selected.ContactPersonName;
    //     editLandlordModel.FirstName = selected.FirstName;
    //     editLandlordModel.LastName = selected.LastName;


    //     filteredlandlords.Clear();
    //     searchLandlordText = selected.LandLordCode;
    //     showLandlordFields = true;

    //     legalcaseDto.ClientId = selected.ClientId;
    // }

    // Select building from list
    // private void SelectBuilding(EditToBuildingDto selected)
    // {
    //     editBuildingModel.Id = selected.Id;
    //     editBuildingModel.Address1 = selected.Address1;
    //     editBuildingModel.CityId = selected.CityId;
    //     editBuildingModel.MDRNumber = selected.MDRNumber;
    //     editBuildingModel.Zipcode = selected.Zipcode;
    //     editBuildingModel.ApartmentCode = selected.ApartmentCode;
    //     editBuildingModel.BuildingUnits = selected.BuildingUnits;
    //     editBuildingModel.RegulationStatusId = selected.RegulationStatusId;
    //     editBuildingModel.TenancyTypeForBuildingId = selected.TenancyTypeForBuildingId;
    //     editBuildingModel.ExemptionBasisId = selected.ExemptionBasisId;
    //     editBuildingModel.ExemptionreasonId = selected.ExemptionreasonId;
    //     editBuildingModel.PrimaryResidence = selected.PrimaryResidence;
    //     editBuildingModel.OwnerOccupied = selected.OwnerOccupied;
    //     editBuildingModel.RegistrationStatusId = selected.RegistrationStatusId;
    //     editBuildingModel.GoodCause = selected.GoodCause;
    //     editBuildingModel.RentRegulationOther = selected.RentRegulationOther;
    //     editBuildingModel.ExemptionBasisother = selected.ExemptionBasisother;

    //     filteredBuildings.Clear();
    //     searchBuildingText = selected.BuildingCode;
    //     showBuildingFields = true;
    //     IsNewBuilding = false;
    //     legalcaseDto.BuildingId = selected.Id;
    // }
    private async Task SelectCourt()
    {
        var selectedCourtId = legalcaseDto.CourtLocationId;

        var court = CourtLocationList.Where(ct => ct.Id == legalcaseDto.CourtLocationId).FirstOrDefault();
        var Courttype = CourtTypeList.Where(cts => cts.Name.Contains(court.CountyName)).FirstOrDefault();
        if (Courttype == null)
        {
            Courttype = CourtTypeList.Where(cts => cts.Name.Contains("NYC")).FirstOrDefault();
        }
        if (court.CourtPart.Any())
        {
            showCourtPartDropdown = true;
            CourtPartList = court.CourtPart.ToList();
        }




        if ((legalcaseDto.CourtTypeId == null || legalcaseDto.CourtTypeId == Guid.Empty) && legalcaseDto.CourtTypeId != Courttype.Id)
        {

            var CourtType = new CourtType();
            var query = CourtTypeList.ToList();
            if (court.CountyName.Contains("Nassau") || court.CountyName.Contains("Westchester"))
            {
                CourtType = query.Where(x => x.Name.Contains(legalcaseDto.County))
                                  .FirstOrDefault();
            }
            else
            {
                showCountyDropdown = true;
                CourtType = query.Where(x => !x.Name.Contains("Nassau") && !x.Name.Contains("Westchester"))
                                    .FirstOrDefault();
            }
            legalcaseDto.CourtTypeId = CourtType.Id;
            await SelectCourtType();
        }

        if ((legalcaseDto.CountyId == null || legalcaseDto.CountyId == Guid.Empty) && legalcaseDto.CountyId != court.CountyId)
        {
            var county = CountyList.FirstOrDefault(cts => cts.Id == court.CountyId);
            // if (court.CountyName.Contains("Nassau") || court.CountyName.Contains("Westchester"))
            // {
            legalcaseDto.CountyId = county.Id;
            legalcaseDto.County = county?.Name;

            // }
            SelectCounty();
        }

        await InvokeAsync(StateHasChanged);
        legalcaseDto.CourtLocationId = null;
        await Task.Delay(10);

        if (filteredCourts.Any(x => x.Id == selectedCourtId))
        {
            legalcaseDto.CourtLocationId = selectedCourtId;
            legalcaseDto.Court = court.Court;
            legalcaseDto.CourtLocation = court.Court;

            ShowClearBtn = true;
        }
        else
        {
            // Optional: clear the selection if invalid
            legalcaseDto.CourtLocationId = Guid.Empty;
        }

        StateHasChanged();
    }


    private async Task ShowAllCourts()
    {
        if (legalcaseDto.CountyId != null)
        {
            // Sirf selected county ke courts dikhao
            filteredCourts = CourtLocationList
                                .Where(x => x.CountyId == legalcaseDto.CountyId)
                                .ToList();
        }
        else
        {

            filteredCourts = await _courtService.GetAllCourtDataAsync();
        }

    }


    private void SelectCourtPart(CourtPartDto selected)
    {
        court.SelectedCourtPart = selected;
        filteredCourtsPart.Clear();
        searchCourtPartText = selected.Part;
        showCourtFields = true;
        // filteredCourtsPart = court.CourtPart;
        legalcaseDto.CourtPartId = selected.Id;

        StateHasChanged();

    }
    // Toggle "Add New" section
    // private void OnBindBuildingAfter()
    // {
    //     showBuildingFields = true;
    //     editBuildingModel.GoodCause = true;
    //     IsNewBuilding = true;
    // }

    // private void OnBindLandlordAfter()
    // {
    //     showLandlordFields = true;
    //     IsNewLandlord = true;
    // }

    // private void OnBindLandlordCancel()
    // {
    //     showLandlordFields = false;
    //     IsNewLandlord = true;
    //     searchLandlordText = null;
    //     editLandlordModel = new EditToLandlordDto();

    // }
    private void OnBindCourtAfter()
    {
        showCourtFields = true;

    }

    // Cancel "Add New"
    // private void OnBindBuildingCancel()
    // {
    //     showBuildingFields = false;
    //     IsNewBuilding = false;
    //     searchBuildingText = null;
    //     editBuildingModel = new EditToBuildingDto();
    //     editBuildingModel.StateId = StateList.Where(e => e.Name.Contains("New York")).FirstOrDefault()!.Id;
    // }

    private void OnBindRentCancel()
    {

        editRentModel = new IntakeModel();
    }
    private void OnBindCourtCancel()
    {
        legalcaseDto.CourtLocationId = null;
        legalcaseDto.CourtTypeId = null;
        legalcaseDto.CountyId = null;
        showCountyDropdown = false;
        showCourtPartDropdown = false;
        legalcaseDto.CourtPartId = null;
        legalcaseDto.Judge = null;
        legalcaseDto.Court = null;
        legalcaseDto.CourtRoom = null;
        legalcaseDto.CourtRoomNo = null;
        legalcaseDto.CourtPart = null;

        ShowClearBtn = false;

    }
    private void OnBindHearingCancel()
    {
        caseHearing = new CaseHearingDto();
        caseHearing.HearingDate = DateTime.Now;
        caseHearing.HearingTime = TimeOnly.FromTimeSpan(TimeSpan.FromHours(10));
    }

    // private void OnBindTenantCancel()
    // {
    //     Tenants.Clear();
    //     searchTenantText = null;
    //     legalcaseDto.TenantId = null;
    //     legalcaseDto.TenantName = null;
    //     legalcaseDto.MonthlyRent = null;
    //     legalcaseDto.TenancyTypeId = null;
    //     legalcaseDto.RentDueEachMonthOrWeekId = null;
    //     legalcaseDto.PrimaryResidence = false;
    //     legalcaseDto.LastPaymentDate = null;
    //     legalcaseDto.LastPayment = null;
    //     legalcaseDto.TotalOwed = null;
    //     RowstoDelete.AddRange(Rows.Where(e => e.Id != null && e.Id != Guid.Empty).ToList());
    //     AdditionalTenantfromDbList = new List<AdditioanlTenants>();
    //     AdditionalTenantList = new List<AddtionalTenantDto>();
    // }



    private async Task SaveRentChanges()
    {
        spinnerservice.Show();

        var addorupdate = false;
        if (legalcaseDto.Id != null)
        {



            var success = await _CaseService.UpdateCaseAsync(legalcaseDto);
            addorupdate = true;

            if (success != null)
            {
                ToastService.ShowSuccess("Rent details updated successfully!");
                await JS.InvokeVoidAsync("hideModal", "rentModal");

                // await LoadCaseDetails();
            }
            else
            {
                ToastService.ShowError("Failed to update building details.");
            }
        }
        // Map edited fields


        spinnerservice.Hide();
    }

    // Save
    // private async Task SaveBuildingChanges()
    // {
    //     spinnerservice.Show();

    //     var addorupdate = false;
    //     if (editBuildingModel.Id == null || editBuildingModel.Id == Guid.Empty)
    //     {
    //         var newBuilding = new CreateToBuildingDto()
    //         {
    //             Address1 = editBuildingModel.Address1,

    //             CityId = editBuildingModel.CityId,
    //             StateId = editBuildingModel.StateId,
    //             Zipcode = editBuildingModel.Zipcode,
    //             BuildingUnits = editBuildingModel.BuildingUnits,
    //             ApartmentCode = editBuildingModel.ApartmentCode,
    //             MDRNumber = editBuildingModel.MDRNumber,
    //             RegulationStatusId = editBuildingModel.RegulationStatusId,
    //             RegistrationStatusId = editBuildingModel.RegistrationStatusId,

    //             ExemptionBasisId = editBuildingModel.ExemptionBasisId,
    //             ExemptionreasonId = editBuildingModel.ExemptionreasonId,
    //             TenancyTypeForBuildingId = editBuildingModel.TenancyTypeForBuildingId,
    //             PrimaryResidence = editBuildingModel.PrimaryResidence,
    //             GoodCause = editBuildingModel.GoodCause,
    //             OwnerOccupied = editBuildingModel.OwnerOccupied,
    //             LandlordId = legalcaseDto.LandlordId,
    //             PremiseTypeId = editBuildingModel.PremiseTypeId,
    //             ExemptionBasisother = editBuildingModel.ExemptionBasisother,
    //             RentRegulationOther = editBuildingModel.RentRegulationOther,

    //         };

    //         var buildingId = await _buildingService.AddOnlyApartmentfromCase(newBuilding);
    //         addorupdate = true;
    //         legalcaseDto.BuildingId = buildingId;

    //     }
    //     else
    //     {
    //         if (editBuildingModel.Id != null)
    //         {

    //             var updateBuilding = new EditToBuildingDto()
    //             {
    //                 Id = editBuildingModel.Id,
    //                 Address1 = editBuildingModel.Address1,
    //                 BuildingCode = editBuildingModel.BuildingCode,

    //                 CityId = editBuildingModel.CityId,
    //                 StateId = editBuildingModel.StateId,
    //                 Zipcode = editBuildingModel.Zipcode,
    //                 BuildingUnits = editBuildingModel.BuildingUnits,
    //                 ApartmentCode = editBuildingModel.ApartmentCode,
    //                 RegistrationStatusId = editBuildingModel.RegistrationStatusId,
    //                 MDRNumber = editBuildingModel.MDRNumber,
    //                 RegulationStatusId = editBuildingModel.RegulationStatusId,
    //                 ExemptionBasisId = editBuildingModel.ExemptionBasisId,
    //                 ExemptionreasonId = editBuildingModel.ExemptionreasonId,
    //                 TenancyTypeForBuildingId = editBuildingModel.TenancyTypeForBuildingId,
    //                 PrimaryResidence = editBuildingModel.PrimaryResidence,
    //                 GoodCause = editBuildingModel.GoodCause,
    //                 PremiseTypeId = editBuildingModel.PremiseTypeId,
    //                 OwnerOccupied = editBuildingModel.OwnerOccupied,
    //                 ExemptionBasisother = editBuildingModel.ExemptionBasisother,
    //                 RentRegulationOther = editBuildingModel.RentRegulationOther,
    //             };

    //             await _buildingService.UpdateonlyBuildingfromCase(updateBuilding);
    //             addorupdate = true;
    //         }
    //     }

    //     if (addorupdate)
    //     {
    //         legalcaseDto.BuildingAddress = editBuildingModel.Address1;
    //         legalcaseDto.BoroughorCityId = editBuildingModel.CityId;
    //         legalcaseDto.Mdr = editBuildingModel.MDRNumber;
    //         legalcaseDto.BuildingZip = editBuildingModel.Zipcode;
    //         legalcaseDto.BuildingStateId = editBuildingModel.StateId;
    //         legalcaseDto.Units = editBuildingModel.BuildingUnits;
    //         legalcaseDto.RegulationStatusId = editBuildingModel.RegulationStatusId;
    //         legalcaseDto.PremiseTypeId = editBuildingModel.PremiseTypeId;
    //         legalcaseDto.UnitOrApartmentNumber = editBuildingModel.ApartmentCode;
    //         legalcaseDto.ExemptionBasisId = editBuildingModel.ExemptionBasisId;
    //         legalcaseDto.ExemptionReasonId = editBuildingModel.ExemptionreasonId;
    //         legalcaseDto.TenancyTypeForBuildingId = editBuildingModel.TenancyTypeForBuildingId;

    //         legalcaseDto.OwnerOccupied = editBuildingModel.OwnerOccupied != null ? editBuildingModel.OwnerOccupied.Value : false;
    //         legalcaseDto.GoodCause = editBuildingModel.GoodCause != null ? editBuildingModel.GoodCause.Value : false;
    //         legalcaseDto.RegistrationStatusTypeId = editBuildingModel.RegistrationStatusId;

    //         var success = await _service.UpdateCaseAsync(legalcaseDto);

    //         if (success.HasValue)
    //         {
    //             ToastService.ShowSuccess("Building details updated successfully!");
    //             await JS.InvokeVoidAsync("hideModal", "buildingModal");

    //             await LoadCaseDetails();
    //         }
    //         else
    //         {
    //             ToastService.ShowError("Failed to update building details.");
    //         }
    //     }



    //     spinnerservice.Hide();
    // }

    // private async Task SaveLandlordChanges()
    // {
    //     Console.WriteLine("legalcasedto", legalcaseDto);
    //     spinnerservice.Show();

    //     var addorupdate = false;
    //     if (editLandlordModel.Id == null || editLandlordModel.Id == Guid.Empty)
    //     {

    //         var newLandlord = new CreateToLandLordDto()
    //         {
    //             FirstName = editLandlordModel.FirstName,
    //             LastName = editLandlordModel.LastName,
    //             Address1 = editLandlordModel.Address1,
    //             ContactPersonName = editLandlordModel.ContactPersonName,
    //             ClientId = legalcaseDto.ClientId,
    //         };

    //         var landlordId = await _landlordSevice.AddOnlyLandLordfromCase(newLandlord);
    //         addorupdate = true;
    //         legalcaseDto.LandlordId = landlordId;

    //     }
    //     else
    //     {
    //         if (editLandlordModel.Id != null && editLandlordModel.Id != Guid.Empty)
    //         {

    //             var updateLandLord = new EditToLandlordDto()
    //             {
    //                 Id = editLandlordModel.Id,
    //                 FirstName = editLandlordModel.FirstName,
    //                 LastName = editLandlordModel.LastName,
    //                 Address1 = editLandlordModel.Address1,

    //                 ContactPersonName = editLandlordModel.ContactPersonName,

    //             };

    //             await _landlordSevice.UpdateLandLordsfromCase(updateLandLord);
    //             addorupdate = true;
    //         }
    //     }

    //     if (addorupdate)
    //     {
    //         legalcaseDto.LandlordAddress = editLandlordModel.Address1;
    //         legalcaseDto.ContactPersonName = editLandlordModel.ContactPersonName;
    //         legalcaseDto.FirstName = editLandlordModel.FirstName;
    //         legalcaseDto.LastName = editLandlordModel.LastName;
    //         legalcaseDto.landlordName = $"{editLandlordModel.FirstName} {editLandlordModel.LastName}";
    //         if (editLandlordModel.Id != null && editLandlordModel.Id != Guid.Empty)
    //         {

    //             legalcaseDto.LandlordId = editLandlordModel.Id;
    //         }


    //         var success = await _service.UpdateCaseAsync(legalcaseDto);

    //         if (success.HasValue)
    //         {
    //             ToastService.ShowSuccess("Landlord details updated successfully!");
    //             await JS.InvokeVoidAsync("hideModal", "landlordModal");

    //             await LoadCaseDetails();
    //         }
    //         else
    //         {
    //             ToastService.ShowError("Failed to update building details.");
    //         }
    //     }



    //     spinnerservice.Hide();
    // }
    private async Task SaveStipulationChanges()
    {
        spinnerservice.Show();

        if (MotionJudgements.Id == null || MotionJudgements.Id == Guid.Empty)
        {
            var CourtTodayType = await Courttodayrepo.GetAllAsync();
            MotionJudgements.LegalCaseId = legalcaseDto.Id;
            MotionJudgements.CourtTodayId = CourtTodayType.Where(e => e.Name.ToLower().Contains("motion")).FirstOrDefault()?.Id;
            var result = await _caseAppreance.AddCaseAppearance(MotionJudgements);
            if (result)
            {
                ToastService.ShowSuccess("Stipulation details added successfully!");
                int MotionOppDaysBeforeReturn = -1; // This is hordcoded and will be pick from config later.
                if (MotionJudgements.OppositionDue.HasValue)
                {
                    await _remainder.CreateNewReminder(legalcaseDto.Id, "Opposition Due (motion)", MotionJudgements.OppositionDue!.Value.AddDays(MotionOppDaysBeforeReturn));
                }
                if (MotionJudgements.ReplyDue.HasValue)
                {
                    await _remainder.CreateNewReminder(legalcaseDto.Id, "Reply Due (motion)", MotionJudgements.ReplyDue!.Value.AddDays(MotionOppDaysBeforeReturn));
                }
                await JS.InvokeVoidAsync("hideModal", "stipulationModal");

                await LoadJudgement();
            }
            else
            {
                ToastService.ShowError("Failed to add stipulation details.");
            }
        }
        else
        {
            var result = await _caseAppreance.UpdateCaseAppreance(MotionJudgements);
            if (result)
            {
                ToastService.ShowSuccess("Stipulation details updated successfully!");

                int MotionOppDaysBeforeReturn = -1; // This is hordcoded and will be pick from config later.
                if (MotionJudgements.OppositionDue.HasValue)
                {
                    await _remainder.UpdateReminder(legalcaseDto.Id, "Opposition Due (motion)", MotionJudgements.OppositionDue!.Value.AddDays(MotionOppDaysBeforeReturn));
                }
                if (MotionJudgements.ReplyDue.HasValue)
                {
                    await _remainder.UpdateReminder(legalcaseDto.Id, "Reply Due (motion)", MotionJudgements.ReplyDue!.Value.AddDays(MotionOppDaysBeforeReturn));
                }
                await JS.InvokeVoidAsync("hideModal", "stipulationModal");

                await LoadJudgement();
            }
            else
            {
                ToastService.ShowError("Failed to update stipulation details.");
            }
        }



        spinnerservice.Hide();
    }
    @* private async Task SaveClientChanges()
    {
        spinnerservice.Show();

        var addorupdate = false;
        if (client.Id == null || client.Id == Guid.Empty)
        {
            var newClient = new CreateToClientDto()
            {
                Address1 = client.Address1,
                //Address2 = address2,
                City = client.City,
                StateId = client.StateId,
                ZipCode = client.ZipCode,
                FirstName = client.FirstName,
                LastName = client.LastName,
                Reference = client.Reference,
                ClientTypeId = client.ClientTypeId,
                Phone = client.Phone,
                Email = client.Email,
            };

            var clientId = await _clientService.CreateOnlyClient(newClient);
            addorupdate = true;
            legalcaseDto.ClientId = clientId;

        }
        else
        {
            if (client.Id != null)
            {

                var updateBuilding = new EditToClientDto()
                {
                    Id = client.Id,
                    Address1 = client.Address1,
                    ClientCode = client.ClientCode,
                    //Address2 = address2,
                    ClientTypeId = client.ClientTypeId,
                    City = client.City,
                    StateId = client.StateId,
                    ZipCode = client.ZipCode,
                    Phone = client.Phone,
                    Email = client.Email,
                    Reference = client.Reference,
                    FirstName = client.FirstName,
                    LastName = client.LastName,

                };

                await _clientService.UpdateClientformCase(updateBuilding);
                addorupdate = true;
            }
        }

        if (addorupdate)
        {
            legalcaseDto.ClientEmail = client.Email;
            legalcaseDto.Reference = client.Reference;
            legalcaseDto.ClientTypeId = client.ClientTypeId;
            legalcaseDto.ClientPhone = client.Phone;
            legalcaseDto.ClientName = $"{client.FirstName} {client.LastName}";
            legalcaseDto.City = client.City;
            legalcaseDto.Address1 = client.Address1;
            legalcaseDto.ZipCode = client.ZipCode;
            legalcaseDto.StateId = client.StateId;

            var success = await _service.UpdateCaseAsync(legalcaseDto);

            if (success.HasValue)
            {
                ToastService.ShowSuccess("Client details updated successfully!");
                await JS.InvokeVoidAsync("hideModal", "clientModal");

                await LoadCaseDetails();
            }
            else
            {
                ToastService.ShowError("Failed to update client details.");
            }
        }
        // Map edited fields


        spinnerservice.Hide();
    }
    *@
    private List<CaseType> CaseTypeList = new();
    // private void CalcNoticeDays()
    // {
    //     if (CaseTypeList.FirstOrDefault(x => x.Id == legalcaseDto.CaseTypeId)?.Name == "Holdover")
    //     {
    //         Console.WriteLine("1");
    //         if (legalcaseDto.DateTenantMoved != null && legalcaseDto.TenancyTypeId != null)
    //         {
    //             Console.WriteLine("2");

    //             int length = 0;

    //             var type = TenancyTypeList
    //                 .Where(a => a.Id == legalcaseDto.TenancyTypeId)
    //                 .Select(e => e.Name?.ToLower())
    //                 .FirstOrDefault();


    //             if (new[] { "squatter", "licensee", "referee" }.Contains(type))
    //             {
    //                 length = 10;
    //             }
    //             else
    //             {

    //                 var yrs = DiffYears(legalcaseDto.DateTenantMoved?.ToDateTime(TimeOnly.MinValue), DateTime.Today);

    //                 if (yrs < 1)
    //                     length = 30;
    //                 else if (yrs < 2)
    //                     length = 60;
    //                 else
    //                     length = 90;
    //             }

    //             legalcaseDto.CalculatedNoticeLength = length;


    //             legalcaseDto.PredicateNotice = type switch
    //             {
    //                 "licensee" => "10 Days Notice - Tenant Of Record Vacated (Licensee)",
    //                 "referee" => "10 Days Notice - Referee Deed / Prior Owner",
    //                 "squatter" => "10 Days Notice - Squatter / Intruder",
    //                 "month-to-month" => $"{length} Days Notice - Month to Month",
    //                 _ => ""
    //             };
    //         }
    //     }
    // }
    // private int DiffYears(DateTime? from, DateTime? to)
    // {
    //     if (!from.HasValue || !to.HasValue) return 0;
    //     return (int)((to.Value - from.Value).TotalDays / 365);
    // }

    @* private async Task SaveTenantChanges()
    {
        if (!await ValidateCurrentStep("Tenant")) return;
        spinnerservice.Show();


        var addorupdate = false;

        if (selectedTenant == null)
        {
            var parts = Tenants[0].Split(' ', StringSplitOptions.RemoveEmptyEntries);

            var firstName = parts.FirstOrDefault() ?? "";
            var lastName = parts.Length > 1 ? parts.Last() : "";
            var newTenant = new CreateToTenantDto()
            {
                FirstName = firstName,
                LastName = lastName,
                UnitOrApartmentNumber = legalcaseDto.UnitOrApartmentNumber ?? searchTenantText,
                BuildingId = legalcaseDto.BuildingId,
                PrimaryResidence = legalcaseDto.PrimaryResidence,
                TenancyTypeId = legalcaseDto.TenancyTypeId,
                MonthlyRent = legalcaseDto.MonthlyRent,
                TenantShare = legalcaseDto.TenantShare,
                RentDueEachMonthOrWeekId = legalcaseDto.RentDueEachMonthOrWeekId,

            };
            var tenantId = await _tenantService.AddTenantfromCase(newTenant);
            // IsNewTenant = true;
            legalcaseDto.TenantId = tenantId;

        }
        else
        {
            if (Tenants.Count > 0 && selectedTenant != null)
            {
                var mainTenantName = Tenants[0]?.Trim();
                if (!string.IsNullOrWhiteSpace(mainTenantName))
                {
                    var parts = mainTenantName.Split(' ', 2, StringSplitOptions.RemoveEmptyEntries);
                    var firstName = parts.Length > 0 ? parts[0] : "";
                    var lastName = parts.Length > 1 ? parts[1] : "";

                    // Only update if anything actually changed
                    if (HasTenantChanged(selectedTenant, legalcaseDto, firstName, lastName))
                    {
                        var updateTenant = new EditToTenantDto
                        {
                            Id = legalcaseDto.TenantId ?? Guid.Empty,
                            FirstName = firstName,
                            LastName = lastName,
                            BuildingId = legalcaseDto.BuildingId,
                            UnitOrApartmentNumber = legalcaseDto.UnitOrApartmentNumber,
                            MonthlyRent = legalcaseDto.MonthlyRent,
                            TenantShare = legalcaseDto.TenantShare,
                            RentDueEachMonthOrWeekId = legalcaseDto.RentDueEachMonthOrWeekId,
                            TotalRentOwed = legalcaseDto.TotalOwed,
                            TenancyTypeId = legalcaseDto.TenancyTypeId,
                            PrimaryResidence = legalcaseDto.PrimaryResidence,
                            SocialServices = legalcaseDto.SocialService,
                            UpdatedOn = DateTime.Now
                        };

                        await _tenantService.UpdateTenantAsync(updateTenant);
                    }
                }
            }

        }

        if (AdditionalTenantList.Count > 0)
        {
            foreach (var t in AdditionalTenantList)
            {
                t.TenantId = legalcaseDto.TenantId;
            }

            var toadd = AdditionalTenantList.Where(e => e.Id == null || e.Id == Guid.Empty && e.IsDeleted == false).ToList();
            var toupdate = AdditionalTenantList.Where(e => e.Id != null && e.Id != Guid.Empty && e.IsDeleted == false).ToList();
            if (toadd.Any())
            {
                await _additionalTenantService.AddAdditionalTenantAsync(toadd);
            }
            if (toupdate.Any())
            {
                await _additionalTenantService.UpdateAdditionalTenantAsync(toupdate);
            }

        }


        var success = await _service.UpdateCaseAsync(legalcaseDto);

        if (success.HasValue)
        {
            if (AdditionalTenantList.Any())
            {


                var toAdd = AdditionalTenantList
                    .Where(o => o.IsDeleted != true && (o.LegalCaseId == null || o.LegalCaseId == Guid.Empty))
                    .ToList();

                var toUpdate = AdditionalTenantList
                .Where(o => o.IsDeleted != true && (o.LegalCaseId != null && o.LegalCaseId != Guid.Empty))
                .ToList();

                var toDelete = AdditionalTenantList
                    .Where(o => o.IsDeleted == true && (o.LegalCaseId != null && o.LegalCaseId != Guid.Empty))
                    .ToList();
                foreach (var occupant in toAdd)
                {
                    occupant.LegalCaseId = legalcaseDto.Id;
                }
                if (toUpdate.Any())
                    await _caseAdditionalTenant.UpdateAdditionalCaseTenantAsync(toUpdate);

                if (toAdd.Any())
                    await _caseAdditionalTenant.AddAdditionalCaseTenantAsync(toAdd);

                if (toDelete.Any())
                    await _caseAdditionalTenant.DeleteAdditionalCaseTenants(toDelete);
            }
            if (AdditionalOccupantsList.Any())
            {
                foreach (var occupant in AdditionalOccupantsList)
                {
                    occupant.LegalCaseId = success;
                }

                var toAdd = AdditionalOccupantsList
                    .Where(o => o.IsDeleted != true && (o.Id == null || o.Id == Guid.Empty))
                    .ToList();

                var toUpdate = AdditionalOccupantsList
                .Where(o => o.IsDeleted != true && (o.Id != null && o.Id != Guid.Empty))
                .ToList();

                var toDelete = AdditionalOccupantsList
                    .Where(o => o.IsDeleted == true)
                    .ToList();

                if (toUpdate.Any())
                    await _additionalOccupantService.UpdateAdditionalOccupantsAsync(toUpdate);

                if (toAdd.Any())
                    await _additionalOccupantService.AddAdditionalOccupantsAsync(toAdd);

                if (toDelete.Any())
                    await _additionalOccupantService.DeleteAdditionalOccupants(toDelete);
            }
            if (Rows.Count > 0)
            {
                var addrows = Rows.Where(e => (e.Id == null || e.Id == Guid.Empty) && (e.Amount != null || e.Month != null)).Select(e => new ArrearLedgerDto()
                {
                    LegalCaseId = legalcaseDto.Id,
                    CaseNoticeId = null,
                    Notes = e.Notes,
                    Amount = e.Amount,
                    Month = e.Month,
                }).ToList();
                if (addrows.Any())
                {
                    await _service.AddArrearLedgerAsync(addrows);
                }

                var updaterows = Rows.Where(e => e.Id != null && e.Id != Guid.Empty).Select(e => new ArrearLedgerDto()
                {
                    Id = e.Id,
                    LegalCaseId = legalcaseDto.Id,
                    CaseNoticeId = null,
                    Notes = e.Notes,
                    Amount = e.Amount,
                    Month = e.Month,
                    
                }).ToList();
                if (updaterows.Any())
                {
                    await _service.UpdateArrearLedgerAsync(updaterows);
                }
            }

            if (RowstoDelete.Any())
            {
                await _service.DeleteArrearLedger(RowstoDelete);
            }

            ToastService.ShowSuccess("Tenant details updated successfully!");
            await JS.InvokeVoidAsync("hideModal", "tenantModal");

            await LoadCaseDetails();
        }
        else
        {
            ToastService.ShowError("Failed to update tenant details.");
        }

        // Map edited fields


        spinnerservice.Hide();
    }  *@

    @* private bool HasTenantChanged(EditToTenantDto existing, IntakeModel current, string firstName, string lastName)
    {
        return existing.FirstName != firstName
            || existing.LastName != lastName
            || existing.UnitOrApartmentNumber != current.UnitOrApartmentNumber
            || existing.MonthlyRent != current.MonthlyRent
            || existing.TenantShare != current.TenantShare
            || existing.RentDueEachMonthOrWeekId != current.RentDueEachMonthOrWeekId
            || existing.TotalRentOwed != current.TotalOwed
            || existing.TenancyTypeId != current.TenancyTypeId
            || existing.SocialServices != current.SocialService;
    }

    private async Task<bool> ValidateCurrentStep(string modal)
    {
        messageStore.Clear();

        if (modal == "Tenant")
        {
            bool isTenantSelected = legalcaseDto.TenantId.HasValue && legalcaseDto.TenantId.Value != Guid.Empty;
            bool isTextEntered = !string.IsNullOrWhiteSpace(searchTenantText);

            // Tenant is required
            if (!isTenantSelected && !isTextEntered)
            {
                Require(() => legalcaseDto.TenantId, nameof(legalcaseDto.TenantId), "Unit/Apt is required");
            }

            Require(() => legalcaseDto.TenantName, nameof(legalcaseDto.TenantName), "Tenant Name is required");
            Require(() => legalcaseDto.RentDueEachMonthOrWeekId, nameof(legalcaseDto.RentDueEachMonthOrWeekId), "Select Date Rent due");
            Require(() => legalcaseDto.TenancyTypeId, nameof(legalcaseDto.TenancyTypeId), "Select Tenancy type");
            Require(() => legalcaseDto.MonthlyRent, nameof(legalcaseDto.MonthlyRent), "Monthly Rent is required");
            Require(() => legalcaseDto.PrimaryResidence, nameof(legalcaseDto.PrimaryResidence), "Primary Residence is required");
        }

        //Require(() => legalcaseDto.CourtLocationId, nameof(legalcaseDto.CourtLocationId), "Court Location is required");
        // Require(() => legalcaseDto.DateNoticeServed, nameof(legalcaseDto.DateNoticeServed), "Notice Serve Date required");



        _editContext.NotifyValidationStateChanged();

        // Get current validation messages (optional: for logging)
        var errors = _editContext.GetValidationMessages().ToList();
        Console.WriteLine($"Validation errors : {string.Join(", ", errors)}");

        // Check if form is valid
        bool isValid = !_editContext.GetValidationMessages().Any();

        // Return validity
        return isValid;
    }
    private void Require<T>(Expression<Func<T>> accessor, string fieldName, string message)
    {
        var value = accessor.Compile().Invoke();
        var fieldIdentifier = new FieldIdentifier(legalcaseDto, fieldName);

        // Clear old message first
        messageStore.Clear(fieldIdentifier);

        // Add message if invalid
        bool isEmpty = value == null ||
                       (value is string s && string.IsNullOrWhiteSpace(s)) ||
                       (value is Guid g && g == Guid.Empty);

        if (isEmpty)
        {
            messageStore.Add(fieldIdentifier, message);
        }

        _editContext.NotifyValidationStateChanged();
    } *@

    private async Task SaveCourtChanges()
    {
        // if (!await ValidateCurrentStep("Court")) return;
        spinnerservice.Show();

        // bool addOrUpdate = false;

        // // if (string.IsNullOrWhiteSpace(court.SelectedCourtPart.Part))
        // // {
        // //     await JS.InvokeVoidAsync("alert", "Part is Required");
        // //     await JS.InvokeVoidAsync("hideModal", "courtModal");
        // //     await JS.InvokeVoidAsync("showModal", "courtModal");
        // //     spinnerservice.Hide();
        // //     return;
        // // }

        // // ============= ADD COURT =============
        // if (court.Id == null || court.Id == Guid.Empty)
        // {
        //     var newCourt = new CourtDto
        //     {
        //         Court = court.Court,
        //         Address = court.Address,
        //         Phone = court.Phone,
        //         Notes = court.Notes
        //     };

        //     // 1️⃣ Insert Court
        //     var courtId = await _courtService.AddCourtAsync(newCourt);

        //     if (courtId != Guid.Empty)
        //     {
        //         // 2️⃣ Ensure CourtPart has CourtId
        //         court.SelectedCourtPart.CourtId = courtId;

        //         // 3️⃣ Insert CourtPart
        //         var courtPartIds = await courtpartService.AddCourtPartListAsync(
        //                                  new List<CourtPartDto> { court.SelectedCourtPart });

        //         if (courtPartIds != null)
        //         {
        //             legalcaseDto.CourtPartId = courtPartIds.First();
        //         }

        //         // 4️⃣ Assign CourtId to Case
        //         legalcaseDto.CourtId = courtId;

        //         addOrUpdate = true;
        //     }
        // }
        // // ============= UPDATE COURT =============
        // else
        // {
        //     // If NEW CourtPart added under existing COURT
        //     if (court.SelectedCourtPart.Id == Guid.Empty)
        //     {
        //         court.SelectedCourtPart.CourtId = court.Id;

        //         var newPartList = await courtpartService.AddCourtPartListAsync(
        //                               new List<CourtPartDto> { court.SelectedCourtPart });

        //         if (newPartList != null)
        //         {
        //             legalcaseDto.CourtPartId = newPartList.First();
        //         }
        //     }
        //     else
        //     {
        //         // Existing part selected
        //         legalcaseDto.CourtPartId = court.SelectedCourtPart.Id;
        //     }

        //     legalcaseDto.CourtRoomNo = court.SelectedCourtPart.RoomNo;
        //     legalcaseDto.CourtPart = court.SelectedCourtPart.Part;
        //     legalcaseDto.CourtId = court.Id;

        //     addOrUpdate = true;
        // }

        // ============= UPDATE CASE =============

        var success = await _service.UpdateCourtandIndex(legalcaseDto);

        if ((legalcaseDto.CourtLocationId == null || legalcaseDto.CourtLocationId == Guid.Empty || !CaseHearings.Any()) && !string.IsNullOrEmpty(legalcaseDto.Index))
        {
            await _remainder.CreateNewReminder(legalcaseDto.Id, "Court date not yet assigned", DateTime.Now.AddDays(7));
        }


        if (success)
        {
            ToastService.ShowSuccess("Court details updated successfully!");
            await JS.InvokeVoidAsync("hideModal", "courtModal");

            await LoadCaseDetails();
        }
        else
        {
            ToastService.ShowError("Failed to update Court details.");
        }
        spinnerservice.Hide();
    }


    private async Task SaveHearingChanges()
    {
        spinnerservice.Show();

        var newHearing = new CaseHearingDto()
        {
            Caption = caseHearing.Caption,
            LegalCaseId = legalcaseDto.Id,
            CourtId = legalcaseDto.CourtLocationId,
            HearingDate = caseHearing.HearingDate,
            HearingTime = caseHearing.HearingTime,
            CreatedBy = Guid.Parse(loggedInUserId),
            // CallIn = caseHearing.CallIn,
            // Phone = caseHearing.Phone,
            // VirtualLink = caseHearing.VirtualLink,
            // Notes = caseHearing.Notes
        };

        var CourtId = await _caseHearingService.AddHearing(newHearing);

        if (CourtId)
        {
            ToastService.ShowSuccess("Hearing details Added successfully!");
            await JS.InvokeVoidAsync("hideModal", "hearingModal");

            // await LoadCaseDetails();
        }
        else
        {
            ToastService.ShowError("Failed to create Hearing details.");
        }
        // Map edited fields
        LoadHearing();
        spinnerservice.Hide();
    }
    // private async Task ShowAllTenantForHoldover()
    // {
    //     if (legalcaseDto.BuildingId == null || legalcaseDto.BuildingId == Guid.Empty)
    //     {
    //         filteredTenant = new List<EditToTenantDto>();
    //         return;
    //     }
    //     else
    //     {
    //         filteredTenant = await _tenantService.GetTenantsByBuildingIdAsync(legalcaseDto.BuildingId.Value);

    //     }
    // }
    // async Task HideTenantDropDown(FocusEventArgs e)
    // {

    //     await Task.Delay(500);
    //     if (filteredTenant.Any())
    //     {
    //         filteredTenant.Clear();

    //     }
    //     StateHasChanged();
    // }
    @*
    private async Task OnSearchTenantInput(ChangeEventArgs e)
    {
        searchTenantText = e.Value?.ToString() ?? "";
        _cts?.Cancel();
        _cts = new CancellationTokenSource();
        try
        {

            await Task.Delay(300, _cts.Token);
            // ⭐ Empty input → load all tenants (ONLY here)
            if (string.IsNullOrWhiteSpace(searchTenantText))
            {
                await ShowAllTenantForHoldover();
                return;
            }

            // ⭐ 1st & 2nd character → DO NOTHING (keep list unchanged)
            if (searchTenantText.Length < 3)
            {
                // ❗ No reload here (important)
                return;
            }
            if (legalcaseDto.BuildingId == null || legalcaseDto.BuildingId == Guid.Empty)
            {
                filteredTenant = new List<EditToTenantDto>();
                return;
            }
            else
            {
                // ⭐ 3+ characters → server search
                filteredTenant = await _tenantService.SearchTenantsAsync(
                    searchTenantText,
                    legalcaseDto.BuildingId.Value);
            }




        }
        catch (TaskCanceledException)
        {
            // Old task cancelled → ignore
        }

    } *@


    // private void SelectTenant()
    // {
    //     legalcaseDto.ApartmentNumber = searchTenantText;
    // }

    // private async void SelectedTenant(EditToTenantDto tenant)
    // {

    //     selectedTenant = tenant;
    //     Tenants.Clear();
    //     foreach (var item in AdditionalTenantList)
    //     {
    //         item.IsDeleted = true;
    //     }
    //     Tenants.Add($"{tenant.FirstName} {tenant.LastName}");



    //     searchTenantText = $"{tenant.UnitOrApartmentNumber}";

    //     legalcaseDto.UnitOrApartmentNumber = tenant.UnitOrApartmentNumber;
    //     legalcaseDto.TenantName = tenant.FirstName + " " + tenant.LastName;
    //     legalcaseDto.TenantId = tenant.Id;
    //     TenancytypeId = tenant.TenancyTypeId;
    //     PrimaryResidence = tenant.PrimaryResidence;



    //     AdditionalTenantfromDbList = await _additionalTenantService.GetAllAdditionalTenantsAsync(legalcaseDto.TenantId);
    //     if (AdditionalTenantfromDbList.Count > 0)
    //     {
    //         Tenants.AddRange(AdditionalTenantfromDbList.Select(e => $"{e.FirstName} {e.LastName}").ToList());
    //         AdditionalTenantList.AddRange(AdditionalTenantfromDbList.Select(e => new AddtionalTenantDto
    //         {
    //             FirstName = e.FirstName,
    //             LastName = e.LastName,
    //             TenantId = e.TenantId,
    //             Id = e.Id
    //         }));
    //     }
    //     filteredTenant?.Clear();


    //     StateHasChanged();


    // }

    @*
    void DeleteAdditionalTenant(int index)
    {
        // Index 0 = primary tenant → never delete
        if (index <= 0 || index >= Tenants.Count)
            return;

        var name = Tenants[index]?.Trim();

        // Remove UI row
        Tenants.RemoveAt(index);

        if (string.IsNullOrWhiteSpace(name))
            return;

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        var firstName = parts.FirstOrDefault() ?? "";
        var lastName = parts.Length > 1 ? parts.Last() : "";

        var occupant = AdditionalTenantList
            .FirstOrDefault(x =>
                x.FirstName == firstName &&
                x.LastName == lastName &&
                x.IsDeleted != true);

        if (occupant == null)
            return;

        // Persisted → soft delete
        if (occupant.Id != Guid.Empty)
        {
            occupant.IsDeleted = true;
            occupant.IsActive = false;
            occupant.IsVisible = false;
        }
        else
        {
            // New → hard delete
            AdditionalTenantList.Remove(occupant);
        }
    }

    void OnchangeAdditionalTenant(int index)
    {
        // index 0 = primary tenant
        if (index <= 0 || index >= Tenants.Count)
        {
            if (legalcaseDto.TenantName == null)
            {
                legalcaseDto.TenantName = Tenants[0];
            }
            return;

        }

        var name = Tenants[index]?.Trim();
        if (string.IsNullOrWhiteSpace(name))
            return;

        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        var firstName = parts.FirstOrDefault() ?? "";
        var lastName = parts.Length > 1 ? parts.Last() : "";

        // Map UI row → ACTIVE additional tenants only
        int activeIndex = index - 1;

        var activeTenants = AdditionalTenantList
            .Where(x => x.IsDeleted != true)
            .ToList();

        if (activeIndex < activeTenants.Count)
        {
            // RENAME / UPDATE existing tenant
            var dto = activeTenants[activeIndex];

            dto.FirstName = firstName;
            dto.LastName = lastName;
            dto.BuildingId = legalcaseDto.BuildingId;
            dto.UnitorApartmentNumber = legalcaseDto.UnitOrApartmentNumber;
        }
        else
        {
            // NEW additional tenant
            AdditionalTenantList.Add(new AddtionalTenantDto
            {
                FirstName = firstName,
                LastName = lastName,
                TenantId = legalcaseDto?.TenantId ?? Guid.Empty,
                BuildingId = legalcaseDto.BuildingId,
                UnitorApartmentNumber = legalcaseDto.UnitOrApartmentNumber,
                CreatedOn = DateTime.Now,
                IsActive = true,
                IsDeleted = false,
                IsVisible = true
            });
        }
    }
    void AddTenant()
    {
        Tenants.Add(string.Empty);
    }


    int defaultCount = 2;
    void AddUnder()
    {
        int insertIndex = UnderTenants.Count - defaultCount;
        UnderTenants.Insert(insertIndex, string.Empty);
    }
    void DeleteAdditionalOccupant(int index)
    {
        // Safety check
        if (index < 0 || index >= UnderTenants.Count)
            return;

        // Remove from UI text list
        UnderTenants.RemoveAt(index);

        // Remove or mark deleted in DTO list
        if (index < AdditionalOccupantsList.Count)
        {
            var occupant = AdditionalOccupantsList[index];

            // If it already exists in DB → soft delete
            if (occupant.Id != Guid.Empty)
            {
                occupant.IsDeleted = true;
                occupant.IsActive = false;
                occupant.IsVisible = false;
            }
            else
            {
                // New, unsaved → remove completely
                AdditionalOccupantsList.RemoveAt(index);
            }
        }
    }


    void OnchangeAdditionalOccupants(int index)
    {
        var name = UnderTenants[index];

        // If cleared, remove from AdditionalTenantList
        if (string.IsNullOrWhiteSpace(name))
        {
            var existing = AdditionalOccupantsList.ElementAtOrDefault(index);
            if (existing != null)
            {
                AdditionalOccupantsList.RemoveAt(index);
                UnderTenants.RemoveAt(index);
            }
            return;
        }

        // Update or add
        if (index < AdditionalOccupantsList.Count)
        {
            AdditionalOccupantsList[index].Name = name;
        }
        else
        {
            var additional = new AdditionalOccupantDto()
            {
                Name = name,
                CreatedOn = DateTime.Now,
                IsActive = true,
                IsDeleted = false, // better to keep false
                IsVisible = true
            };

            AdditionalOccupantsList.Add(additional);
        }


    } *@
    private async Task OpenHearingPopup()
    {
        if (legalcaseDto.CourtLocationId == null || legalcaseDto.CourtLocationId == Guid.Empty)
        {
            showCourtInfoAlert = true;
            return;
        }
        else if (!caseFormDto.Any())
        {
            IsFormGenerated = true;
            return;
        }
        else
        {
            caseHearing.HearingDate = DateTime.Now;
            var timespan = TimeSpan.FromHours(10);
            caseHearing.HearingTime = TimeOnly.FromTimeSpan(timespan);
            await JS.InvokeVoidAsync("showModal", "hearingModal");
        }

    }
    // private async Task SaveHearingPopup()
    // {
    //     spinnerservice.Show();



    //     legalcaseDto.BuildingAddress = editBuildingModel.Address1;
    //     legalcaseDto.BoroughorCityId = editBuildingModel.CityId;
    //     legalcaseDto.Mdr = editBuildingModel.MDRNumber;
    //     legalcaseDto.BuildingZip = editBuildingModel.Zipcode;
    //     legalcaseDto.BuildingStateId = editBuildingModel.StateId;
    //     legalcaseDto.Units = editBuildingModel.BuildingUnits;
    //     legalcaseDto.RegulationStatusId = editBuildingModel.RegulationStatusId;
    //     legalcaseDto.UnitOrApartmentNumber = editBuildingModel.ApartmentCode;

    //     var success = await _service.UpdateCaseAsync(legalcaseDto);

    //     if (success.HasValue)
    //     {
    //         ToastService.ShowSuccess("Building details updated successfully!");
    //         await JS.InvokeVoidAsync("hideModal", "buildingModal");

    //         await LoadCaseDetails();
    //     }
    //     else
    //     {
    //         ToastService.ShowError("Failed to update building details.");
    //     }





    //     spinnerservice.Hide();
    // }
    private void CloseCourtInfoAlert()
    {
        showCourtInfoAlert = false;
        IsFormGenerated = false;
    }

    private async Task DownloadDocument(CaseDocument doc)
    {
        // 1. Read bytes from file path
        byte[] fileBytes = await File.ReadAllBytesAsync(doc.Path);

        // 2. Convert to Base64 for JS
        string base64 = Convert.ToBase64String(fileBytes);

        // 3. Detect MIME type (optional, safe fallback is octet-stream)
        string contentType = GetMimeType(doc.Path);

        await JS.InvokeVoidAsync(
            "downloadFile",
            doc.Name,      // file name
            base64,        // file bytes
            contentType    // MIME type
        );
    }
    private string GetMimeType(string filePath)
    {
        var ext = Path.GetExtension(filePath).ToLower();

        return ext switch
        {
            ".pdf" => "application/pdf",
            ".doc" => "application/msword",
            ".docx" => "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
            ".png" => "image/png",
            ".jpg" => "image/jpeg",
            ".jpeg" => "image/jpeg",
            ".txt" => "text/plain",
            _ => "application/octet-stream"
        };
    }


    private async Task PreviewDocument(string filePath)
    {
        if (!string.IsNullOrWhiteSpace(filePath))
        {
            var fullUrl = Navigation.BaseUri + filePath;
            // Navigation.NavigateTo(fullUrl, forceLoad: true);
            await JS.InvokeVoidAsync("open", fullUrl, "_blank");
        }
    }

    public async Task DeleteCaseDocument(Guid id)
    {
        spinnerservice.Show();
        bool isDeleted = await _service.DeleteCaseDocument(id);

        if (isDeleted)
        {
            await LoadCaseDocument();
            ToastService.ShowSuccess("File  has been Deleted successfully!");
            StateHasChanged();
        }
        spinnerservice.Hide();
    }

}
