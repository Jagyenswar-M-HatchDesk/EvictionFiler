@page "/signup"
@layout EmptyLayout
@using System.ComponentModel.DataAnnotations
@using EvictionFiler.Application.DTOs.FirmDtos
@using EvictionFiler.Application.DTOs.UserDto
@using EvictionFiler.Application.Interfaces.IServices
@using EvictionFiler.Server.Components.Layout
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq.Expressions
@inject IRegisterService _registerService

@inject NavigationManager Nav

<style>
    .stepper-container {
        width: 100%;
    }

    .stepper {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .step-item {
        text-align: center;
        flex: 1;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .stepper-container {
        position: relative;
        z-index: 50;
    }

    .card {
        position: relative;
        z-index: 1;
    }


    .stepper {
        position: relative;
        z-index: 60;
    }

    .step-item {
        position: relative;
        z-index: 70;
        cursor: pointer;
        padding: 6px 10px;
        user-select: none;
    }

    .progress {
        position: relative;
        z-index: 1;
        pointer-events: none; /* VERY IMPORTANT — allows clicks to pass through */
    }


    .step-circle {
        font-size: 14px;
        width: 25px;
        height: 25px;
        line-height: 25px;
        border-radius: 50%;
        background-color: #e9ecef;
        color: #1F365D;
        /* margin: 0 auto; */
        font-weight: 600;
        z-index: 2;
        transition: 0.25s ease-in-out;
    }

    .step-item:hover .step-circle {
        transform: scale(1.05);
    }

    .active-step {
        background-color: #1F365D;
        color: #fff;
        box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }

    .step-label {
        margin-left: 10px;
        font-size: 14px;
        font-weight: 500;
        color: #1F365D;
    }

    /* Dotted connector line */
    .step-line {
        flex: 1;
        border-top: 3px dotted #b8c4d4;
        margin: 0 10px;
        height: 0;
    }

    /* Active connector */
    .active-line {
        border-color: #1F365D;
    }

    .progress {
        margin-bottom: 1.1rem !important;
    }
    /* =========================================================
           Base / Reset
           ========================================================= */
    body {
        margin: 0;
        background-color: #f7f7f7;
    }

    /* =========================================================
           Typography Utilities
           ========================================================= */
    .display-sub {
        font-size: 26px;
        font-weight: 400;
        letter-spacing: -1px;
    }

    .body-medium {
        font-size: 16px;
        font-weight: 500;
        line-height: 18px;
        color: #1F365D;
    }

    .btn-company {
        width: 150px;
    }

    .title-h4-semi-bold {
        font-size: 16px;
        font-weight: 600;
        line-height: 1.5;
        text-align: center;
    }

    /* =========================================================
           Register Layout & Card
           ========================================================= */
    .register-container {
        width: 100%;
        max-width: 680px;
        border-radius: 8px;
        overflow:hidden;
    }

    .register-card {
        background-color: #fbf5e8;
        padding-top: 10px !important;
    }

    /* =========================================================
           Register Header
           ========================================================= */
    .register-header {
        display: flex;
        align-items: center;
        gap: 18px;
        height: 85px;
    }

    .register-head {
        display: flex;
        align-items: center;
        gap: 18px;
        height: 75px;
    }

    .register-logo {
        max-width: 145px;
        height: auto;
    }

    .register-title {
        font-size: 1.8rem;
        font-weight: 500;
        color: #1F365D;
        margin: 0;
        letter-spacing: -0.3px;
        text-align: center;
        width: 50%;
    }

    /* =========================================================
           Inputs – Enterprise Style
           ========================================================= */
    .form-input {
        width: 100%;
        min-height: 47px;
        padding: 12px 12px;
        font-size: 14px;
        color: #1F365D;
        background-color: #ffffff;
        border: 1px solid #cfd6e4;
        border-radius: 10px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-inputs {
        min-height: 42px;
        padding: 8px 12px;
    }


    .form-input:hover {
        border-color: #9fb0cf;
    }

    .form-input:focus {
        border-color: #1F365D;
        box-shadow: 0 0 0 3px rgba(31, 54, 93, 0.15);
        outline: none;
    }

    .form-input::placeholder {
        font-weight: 400;
        font-size: 14px
    }


    .form-input.invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.15);
    }

    /* Disabled */
    .form-input:disabled {
        background-color: #f2f4f8;
        color: #8a94a6;
    }

    /* Autofill Fix */
    input.form-input:-webkit-autofill {
        -webkit-text-fill-color: #1F365D;
        -webkit-box-shadow: 0 0 0 1000px #ffffff inset;
    }

    /* =========================================================
           Button
           ========================================================= */
    .register-btn-wrapper {
        background-color: #1F365D;
        border-radius: 7px;
    }

        .register-btn-wrapper button {
            background-color: #1F365D;
            border: none;
            height: 46px;
            border-radius: 7px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

            .register-btn-wrapper button:hover {
                background-color: #172b4a;
            }

            .register-btn-wrapper button:disabled {
                background-color: #7c8aa5;
                cursor: not-allowed;
            }

    .login-link {
        color: #1F365D;
        cursor: pointer;
    }

    .login-link {
        font-size: 16px;
    }


    .validation-message {
        color: #dc3545;
        font-size: 13px;
    }

    .back-btn {
        cursor: pointer;
        color: #1F365D;
        text-decoration:none;
    }

        .back-btn:hover {
            text-decoration: underline;
        }



    /* Autofill fix (Chrome / Edge) */
    input.form-input:-webkit-autofill,
    input.form-input:-webkit-autofill:hover,
    input.form-input:-webkit-autofill:focus {
        -webkit-text-fill-color: #1F365D;
        -webkit-box-shadow: 0 0 0 1000px #ffffff inset;
        transition: background-color 9999s ease-in-out 0s;
    }

    /* =========================================================
           Accessibility & Focus Helpers
           ========================================================= */
    .no-outline:focus {
        outline: none;
        box-shadow: none;
    }

    @@media (max-width: 768px) {
        .register-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .register-title {
            font-size: 1.3rem;
        }
    }

    .btn-company:hover{
        color: #1F365D;
    }
</style>


<div class="d-flex flex-column justify-content-center align-items-center vh-100">
    <div class="card p-5 pb-5 shadow mb-0 border-0 register-container register-card">



        @if (CurrentStep == 1)
        {
            <div class="register-header  mb-1 text-center">
                <img src="images/PHOTO-2025-06-18-02-45-29.jpg"
                     class="register-logo"
                     alt="Housing CourtFiler logo" />
                <h1 class="register-title">Create new account</h1>
            </div>
        }
        @if (CurrentStep == 2)
        {

            <div class="register-head  mb-1 text-center">
                <img src="images/PHOTO-2025-06-18-02-45-29.jpg"
                     class="register-logo"
                     alt="Housing CourtFiler logo" />
                <h1 class="register-title">Company Information</h1>
            </div>

        }

        <div class="stepper-container mb-4 ps-3 pe-3">

            <div class="stepper w-100">

                <!-- STEP 1 -->
                <div class="step-item"
                     onclick="@GoBackToStep1"
                     style="cursor:@(CurrentStep >= 1 ? "pointer" : "not-allowed")">
                    <div class="step-circle @(CurrentStep >= 1 ? "active-step" : "")">1</div>
                    <div class="step-label">Sign up</div>
                </div>


                <!-- STEP 2 -->
                <div class="step-item"
                     @onclick="() => { if (CurrentStep >= 2) GoToStep(2); }"
                     style="cursor:@(CurrentStep >= 2 ? "pointer" : "not-allowed")">
                    <div class="step-circle @(CurrentStep >= 2 ? "active-step" : "")">2</div>
                    <div class="step-label">company Info</div>
                </div>




            </div>
            <!-- SMOOTH PROGRESS BAR -->
            <div class="progress mt-2 " style="height: 10px; border-radius: 6px;">
                <div class="progress-bar"
                     role="progressbar"
                     style="width:@ProgressPercent; background-color:#1F365D; transition:width .4s ease;">
                </div>
            </div>

        </div>

        <EditForm EditContext="_editContext" OnValidSubmit="@Nextstep" autocomplete="off">
            <DataAnnotationsValidator />



            @if (CurrentStep == 1)
            {
                <!-- First Name -->

                <div class="row mb-3 ps-3 pe-3">

                    <!-- First Name -->
                    <div class="col-md-6">
                        <label class="form-label">First Name <span class="text-danger">*</span></label>
                        <InputText class="form-control form-control-lg form-input"
                                   @bind-Value="registerModel.FirstName"
                                   @bind-Value:after="@(() => ValidateField(() => registerModel.FirstName, nameof(registerModel.FirstName),"First name is required"))" placeholder="Firstname" />
                        <ValidationMessage For="@(() => registerModel.FirstName)" />
                    </div>

                    <!-- Last Name -->
                    <div class="col-md-6">
                        <label class="form-label">Last Name </label>
                        <InputText class="form-control form-control-lg form-input"
                                   @bind-Value="registerModel.LastName"
                                   placeholder="Lastname" />
                        <ValidationMessage For="@(() => registerModel.LastName)" />
                    </div>

                </div>




                <!-- Email -->
                <div class="mb-3 ps-3 pe-3">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <InputText class="form-control form-control-lg form-input"
                               @bind-Value="registerModel.Email"
                               @bind-Value:after="@(() => ValidateField(() => registerModel.Email, nameof(registerModel.Email),"Email  is required"))"
                               placeholder="E-mail" autocomplete="new-email" />
                    <ValidationMessage For="@(() => registerModel.Email)" />
                </div>

                <!-- Password -->
                <div class="mb-3 ps-3 pe-3">
                    <label class="form-label">Password <span class="text-danger">*</span></label>
                    <InputText type="password"
                               class="form-control form-control-lg form-input"
                               @bind-Value="registerModel.Password"
                               @bind-Value:after="@(() => ValidateField(() => registerModel.Password, nameof(registerModel.Password),"Password is required"))"
                               placeholder="Password" autocomplete="new-password" />
                    <ValidationMessage For="@(() => registerModel.Password)" />
                </div>

                <!-- Confirm Password -->
                <div class="mb-3 ps-3 pe-3">
                    <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                    <InputText type="password"
                               class="form-control form-control-lg form-input"
                               @bind-Value="registerModel.ConfirmPassword"
                               @bind-Value:after="@(() => ValidateField(() => registerModel.ConfirmPassword, nameof(registerModel.ConfirmPassword),"ConfirmPassword is required"))"
                               placeholder="Re-enter password" />
                    <ValidationMessage For="@(() => registerModel.ConfirmPassword)" />
                </div>

                <!-- Register Button -->
                <div class="d-grid">
                    <button type="button" class="btn" style="background-color:#1F365D;color:white;" onclick="@Nextstep" disabled="@isLoading">
                        @if (isLoading)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                            <span class="ms-2">Registering...</span>
                        }
                        else
                        {
                            <span>Next</span>
                        }
                    </button>
                </div>
            }
            @if (CurrentStep == 2)
            {
                <div class="input-form ps-3 pe-3">
                    <label class="form-label color-text">Company Name</label>
                    <InputText class="form-inputs form-input mb-3" @bind-Value="Firms.Name" placeholder="Companyname" />

                    <label class="form-label color-text">Company Email</label>
                    <InputText class="form-inputs form-input mb-3" @bind-Value="Firms.Email" placeholder="Email" />

                    <div class="row">
                        <div class="col-md-6">


                            <label class="form-label color-text">Phone</label>
                            <InputText class="form-inputs form-input  mb-3" @bind-Value="Firms.Phone" placeholder=" Phone number " />
                        </div>
                        <div class="col-md-6">

                            <label class="form-label color-text">FAX</label>
                            <InputText class="form-inputs form-input mb-3" @bind-Value="Firms.FAX" placeholder="  Fax number" />
                        </div>
                    </div>
                    <label class="form-label color-text">Address</label>
                    <InputText class="form-inputs form-input mb-3" @bind-Value="Firms.Address" placeholder=" Enter Address" />

                    <label class="form-label color-text">Website</label>
                    <InputText class="form-inputs form-input mb-3" @bind-Value="Firms.Website" placeholder="Enter website" />
                </div>

                <div class="d-flex gap-2  justify-content-between align-items-center mt-3">


                    <a onclick="@PreStep" class="back-btn" >
                        <i class="fa-solid fa-arrow-left"></i>
                        <span>Back</span>
                    </a>



                    <div>
                        <button type="button" class="btn btn-company btn-outline-secondary" style="background-color:white;"
                                onclick="@SkipCompany" disabled="@isSkipLoading">
                            @if (isSkipLoading)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                                <span class="ms-2">Registering...</span>
                            }
                            else
                            {
                                <span>Skip & Register</span>

                            }
                        </button>
                        <button type="button" class="btn btn-company" style="background-color:#1F365D;color:white;"
                                onclick="@HandleRegister"
                                disabled="@(!IsCompanyFormValid || @isLoading)">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                                <span class="ms-2">Registering...</span>
                            }
                            else
                            {
                                <span>Register</span>
                            }
                        </button>

                    </div>


                </div>
            }


        </EditForm>

    </div>
    @if (CurrentStep == 1)
    {
        <div class="text-center mt-3 body-medium">
            Already have an account?
            <a href="/" class="text-brand-100 login-link">Login</a>
        </div>
    }

</div>


@code {

    private RegisterDto registerModel = new();
    private FirmDto? Firms = new();
    private bool isLoading = false;
    private ValidationMessageStore messageStore;
    private EditContext _editContext;
    private string SubscriptionName = "PayAsYouGo";
    private int CurrentStep = 1;
    private bool isSkipLoading = false;


    protected override void OnInitialized()
    {
        _editContext = new EditContext(registerModel);
        messageStore = new ValidationMessageStore(_editContext);
    }
    private string ProgressPercent => CurrentStep switch
    {
        1 => "50%",
        2 => "100%",

        _ => "0%"
    };

    private string GetStepTitle()
    {
        return CurrentStep switch
        {
            1 => "User information",
            2 => "Company Information",
            _ => "Add New User"
        };
    }
    private async Task Nextstep()
    {
        if (!ValidateCurrentStep())
            return;

        if (CurrentStep < 2)
        {
            CurrentStep++;
        }
        StateHasChanged();
    }
    private async Task PreStep()
    {
        if (CurrentStep > 1)
        {
            CurrentStep--;
        }
        InvokeAsync(StateHasChanged);

    }
    void GoBackToStep1()
    {
        CurrentStep = 1;
        messageStore.Clear(); // clears validation errors
        _editContext.NotifyValidationStateChanged();
    }
    private void GoToStep(int step)
    {
        Console.WriteLine($"Switching to step {step}");

        if (step == 1)
        {
            CurrentStep = 1;
        }
        else if (step == 2)
        {
            if (ValidateCurrentStep())
                CurrentStep = 2;
        }

        InvokeAsync(StateHasChanged);
    }
    private async Task HandleRegister()
    {


        isLoading = true;

        await RegisterFirmAndUser();

        isLoading = false;


        Nav.NavigateTo("/", true);
    }
    private async Task SkipCompany()
    {
        isSkipLoading = true;
        var firmToSend = Firms;
        Firms = new();

        await _registerService.RegisterAsync(registerModel, null, SubscriptionName);



        isSkipLoading = false;
        Nav.NavigateTo("/", true);
    }
    private async Task RegisterFirmAndUser()
    {
        var result = await _registerService.RegisterAsync(registerModel, Firms, SubscriptionName);
        await Task.Delay(1500);
    }

    private bool IsCompanyFormValid =>
        Firms != null &&
        !string.IsNullOrWhiteSpace(Firms.Name);

    private Task ValidateField<T>(Expression<Func<T>> accessor, string fieldName, string message)
    {
        Require(accessor, fieldName, message);
        _editContext.NotifyValidationStateChanged();
        return Task.CompletedTask;
    }

    private bool ValidateCurrentStep()
    {
        messageStore.Clear();
        if (CurrentStep == 1)
        {

            Require(() => registerModel.FirstName, nameof(registerModel.FirstName), "First name is required");
            if (!string.IsNullOrWhiteSpace(registerModel.FirstName))
            {
                if (registerModel.FirstName.Length < 2 || registerModel.FirstName.Length > 20)
                {
                    AddError(nameof(registerModel.FirstName), "First name must be between 2 and 20 characters");
                }
            }

            Require(() => registerModel.Email, nameof(registerModel.Email), "Email is required");
            if (!string.IsNullOrWhiteSpace(registerModel.Email))
            {
                if (registerModel.Email.Length < 5 || registerModel.Email.Length > 100)
                {
                    AddError(nameof(registerModel.Email), "Email must be between 5 and 100 characters");
                }

                var emailRegex = new System.Text.RegularExpressions.Regex(
                    @"^[^@\s]+@[^@\s]+\.[^@\s]+$",
                    System.Text.RegularExpressions.RegexOptions.IgnoreCase);

                if (!emailRegex.IsMatch(registerModel.Email))
                {
                    AddError(nameof(registerModel.Email), "Invalid email format");
                }
            }
            Require(() => registerModel.Password, nameof(registerModel.Password), "Password is required");
            if (!string.IsNullOrWhiteSpace(registerModel.Password))
            {
                var password = registerModel.Password;

                if (password.Length < 6)
                    AddError(nameof(registerModel.Password), "Password must be at least 6 characters");

                if (!password.Any(char.IsLower))
                    AddError(nameof(registerModel.Password), "Password must contain a lowercase letter");

                if (!password.Any(char.IsDigit))
                    AddError(nameof(registerModel.Password), "Password must contain a number");

                // OPTIONAL (enable only if Identity requires)
                if (!password.Any(char.IsUpper))
                    AddError(nameof(registerModel.Password), "Password must contain an uppercase letter");

                if (!password.Any(ch => !char.IsLetterOrDigit(ch)))
                    AddError(nameof(registerModel.Password), "Password must contain a special character");
            }
            Require(() => registerModel.ConfirmPassword, nameof(registerModel.ConfirmPassword), "Confirm password is required");

            // Password match check
            if (registerModel.Password != registerModel.ConfirmPassword)
            {
                var field = new FieldIdentifier(registerModel, nameof(registerModel.ConfirmPassword));
                messageStore.Add(field, "Passwords do not match");
            }
        }

        _editContext.NotifyValidationStateChanged();

        return !_editContext.GetValidationMessages().Any();
    }
    private void AddError(string fieldName, string message)
    {
        var field = new FieldIdentifier(registerModel, fieldName);
        messageStore.Add(field, message);
    }


    private void Require<T>(Expression<Func<T>> accessor, string fieldName, string message)
    {
        var value = accessor.Compile().Invoke();
        var field = new FieldIdentifier(registerModel, fieldName);

        messageStore.Clear(field);

        bool empty =
            value == null ||
            (value is string s && string.IsNullOrWhiteSpace(s));

        if (empty)
            messageStore.Add(field, message);
    }


}

